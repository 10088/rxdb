{"version":3,"file":"plugin-helpers.js","names":["mergeMap","fastUnsecureHash","flatClone","getFromMapOrThrow","requestIdleCallbackIfAvailable","VALIDATOR_CACHE_BY_VALIDATOR_KEY","Map","wrappedValidateStorageFactory","getValidator","validatorKey","has","set","VALIDATOR_CACHE","initValidator","schema","hash","JSON","stringify","validator","args","Object","assign","storage","createStorageInstance","params","instance","validatorCached","oldBulkWrite","bulkWrite","bind","documentWrites","context","forEach","row","document","wrapRxStorageInstance","modifyToStorage","modifyFromStorage","errorFromStorage","error","fromStorage","ret","writeRow","previous","documentInDb","docData","toStorage","modifyAttachmentFromStorage","v","useRows","Promise","all","map","undefined","push","writeResult","success","promises","entries","k","then","v2","err","oldQuery","query","preparedQuery","queryResult","documents","doc","oldGetAttachmentData","getAttachmentData","documentId","attachmentId","data","oldFindDocumentsById","findDocumentsById","ids","deleted","findResult","key","oldGetChangedDocumentsSince","getChangedDocumentsSince","limit","checkpoint","result","d","oldChangeStream","changeStream","pipe","eventBulk","events","event","documentData","previousDocumentData","ev","operation","eventId","endTime","startTime","isLocal","useEvents","id","oldConflictResultionTasks","conflictResultionTasks","task","input","assumedMasterState","newDocumentState","realMasterState","oldResolveConflictResultionTask","resolveConflictResultionTask","taskSolution","output","isEqual","useSolution"],"sources":["../../src/plugin-helpers.ts"],"sourcesContent":["import { mergeMap } from 'rxjs/operators';\nimport type {\n    BulkWriteRow,\n    EventBulk,\n    RxChangeEvent,\n    RxDocumentData,\n    RxDocumentDataById,\n    RxDocumentWriteData,\n    RxJsonSchema,\n    RxStorage,\n    RxStorageBulkWriteError,\n    RxStorageBulkWriteResponse,\n    RxStorageChangeEvent,\n    RxStorageInstance,\n    RxStorageInstanceCreationParams\n} from './types';\nimport {\n    fastUnsecureHash,\n    flatClone,\n    getFromMapOrThrow,\n    requestIdleCallbackIfAvailable\n} from './util';\n\n\ntype WrappedStorageFunction = <Internals, InstanceCreationOptions>(\n    args: {\n        storage: RxStorage<Internals, InstanceCreationOptions>;\n    }\n) => RxStorage<Internals, InstanceCreationOptions>;\n\ntype ValidatorFunction = (docData: RxDocumentData<any>) => void;\n\n/**\n * cache the validators by the schema-hash\n * so we can reuse them when multiple collections have the same schema\n */\nconst VALIDATOR_CACHE_BY_VALIDATOR_KEY: Map<string, Map<string, ValidatorFunction>> = new Map();\n\n/**\n * This factory is used in the validation plugins\n * so that we can reuse the basic storage wrapping code.\n */\nexport function wrappedValidateStorageFactory(\n    /**\n     * Returns a method that can be used to validate\n     * documents and throws when the document is not valid.\n     */\n    getValidator: (schema: RxJsonSchema<any>) => ValidatorFunction,\n    /**\n     * A string to identify the validation library.\n     */\n    validatorKey: string\n): WrappedStorageFunction {\n    if (!VALIDATOR_CACHE_BY_VALIDATOR_KEY.has(validatorKey)) {\n        VALIDATOR_CACHE_BY_VALIDATOR_KEY.set(validatorKey, new Map());\n    }\n    const VALIDATOR_CACHE = getFromMapOrThrow(VALIDATOR_CACHE_BY_VALIDATOR_KEY, validatorKey);\n\n    function initValidator(\n        schema: RxJsonSchema<any>\n    ): ValidatorFunction {\n        const hash = fastUnsecureHash(JSON.stringify(schema));\n        if (!VALIDATOR_CACHE.has(hash)) {\n            const validator = getValidator(schema);\n            VALIDATOR_CACHE.set(hash, validator);\n            return validator;\n        }\n        return getFromMapOrThrow(VALIDATOR_CACHE, hash);\n    }\n\n    return (args) => {\n        return Object.assign(\n            {},\n            args.storage,\n            {\n                async createStorageInstance<RxDocType>(\n                    params: RxStorageInstanceCreationParams<RxDocType, any>\n                ) {\n                    const instance = await args.storage.createStorageInstance(params);\n                    /**\n                     * Lazy initialize the validator\n                     * to save initial page load performance.\n                     * Some libraries take really long to initialize the validator\n                     * from the schema.\n                     */\n                    let validatorCached: ValidatorFunction;\n                    requestIdleCallbackIfAvailable(() => validatorCached = initValidator(params.schema));\n\n                    const oldBulkWrite = instance.bulkWrite.bind(instance);\n                    instance.bulkWrite = (\n                        documentWrites: BulkWriteRow<RxDocType>[],\n                        context: string\n                    ) => {\n                        if (!validatorCached) {\n                            validatorCached = initValidator(params.schema);\n                        }\n                        documentWrites.forEach(row => {\n                            validatorCached(row.document);\n                        });\n                        return oldBulkWrite(documentWrites, context);\n                    };\n\n                    return instance;\n                }\n            }\n        );\n    };\n\n}\n\n\n\n/**\n * Used in plugins to easily modify all in- and outgoing\n * data of that storage instance.\n */\nexport function wrapRxStorageInstance<RxDocType>(\n    instance: RxStorageInstance<RxDocType, any, any>,\n    modifyToStorage: (docData: RxDocumentWriteData<RxDocType>) => Promise<RxDocumentData<any>> | RxDocumentData<any>,\n    modifyFromStorage: (docData: RxDocumentData<any>) => Promise<RxDocumentData<RxDocType>> | RxDocumentData<RxDocType>,\n    modifyAttachmentFromStorage: (attachmentData: string) => Promise<string> | string = (v) => v\n) {\n    async function toStorage(docData: RxDocumentWriteData<RxDocType>): Promise<RxDocumentData<any>> {\n        if (!docData) {\n            return docData;\n        }\n        return await modifyToStorage(docData);\n    }\n    async function fromStorage(docData: RxDocumentData<any> | null): Promise<RxDocumentData<RxDocType>> {\n        if (!docData) {\n            return docData;\n        }\n        return await modifyFromStorage(docData);\n    }\n    async function errorFromStorage(\n        error: RxStorageBulkWriteError<any>\n    ): Promise<RxStorageBulkWriteError<RxDocType>> {\n        const ret = flatClone(error);\n        ret.writeRow = flatClone(ret.writeRow);\n        if (ret.documentInDb) {\n            ret.documentInDb = await fromStorage(ret.documentInDb);\n        }\n        if (ret.writeRow.previous) {\n            ret.writeRow.previous = await fromStorage(ret.writeRow.previous);\n        }\n        ret.writeRow.document = await fromStorage(ret.writeRow.document);\n        return ret;\n    }\n\n    const oldBulkWrite = instance.bulkWrite.bind(instance);\n    instance.bulkWrite = async (\n        documentWrites: BulkWriteRow<RxDocType>[],\n        context: string\n    ) => {\n        const useRows: BulkWriteRow<any>[] = [];\n        await Promise.all(\n            documentWrites.map(async (row) => {\n                const [previous, document] = await Promise.all([\n                    row.previous ? toStorage(row.previous) : undefined,\n                    toStorage(row.document)\n                ]);\n                useRows.push({ previous, document });\n            })\n        );\n\n        const writeResult = await oldBulkWrite(useRows, context);\n        const ret: RxStorageBulkWriteResponse<RxDocType> = {\n            success: {},\n            error: {}\n        };\n        const promises: Promise<any>[] = [];\n        Object.entries(writeResult.success).forEach(([k, v]) => {\n            promises.push(\n                fromStorage(v).then(v2 => ret.success[k] = v2)\n            );\n        });\n        Object.entries(writeResult.error).forEach(([k, error]) => {\n            promises.push(\n                errorFromStorage(error).then(err => ret.error[k] = err)\n            );\n        });\n        await Promise.all(promises);\n        return ret;\n    };\n\n    const oldQuery = instance.query.bind(instance);\n    instance.query = (preparedQuery) => {\n        return oldQuery(preparedQuery)\n            .then(queryResult => {\n                return Promise.all(queryResult.documents.map(doc => fromStorage(doc)));\n            })\n            .then(documents => ({ documents: documents as any }));\n    };\n\n    const oldGetAttachmentData = instance.getAttachmentData.bind(instance);\n    instance.getAttachmentData = async (\n        documentId: string,\n        attachmentId: string\n    ) => {\n        let data = await oldGetAttachmentData(documentId, attachmentId);\n        data = await modifyAttachmentFromStorage(data);\n        return data;\n    };\n\n    const oldFindDocumentsById = instance.findDocumentsById.bind(instance);\n    instance.findDocumentsById = (ids, deleted) => {\n        return oldFindDocumentsById(ids, deleted).then(async (findResult) => {\n            const ret: RxDocumentDataById<RxDocType> = {};\n            await Promise.all(\n                Object.entries(findResult)\n                    .map(async ([key, doc]) => {\n                        ret[key] = await fromStorage(doc);\n                    })\n            );\n            return ret;\n        });\n    };\n\n    const oldGetChangedDocumentsSince = instance.getChangedDocumentsSince.bind(instance);\n    instance.getChangedDocumentsSince = (limit, checkpoint) => {\n        return oldGetChangedDocumentsSince(limit, checkpoint)\n            .then(async (result) => {\n                return {\n                    checkpoint: result.checkpoint,\n                    documents: await Promise.all(\n                        result.documents.map(d => fromStorage(d))\n                    )\n                };\n            });\n    };\n\n    const oldChangeStream = instance.changeStream.bind(instance);\n    instance.changeStream = () => {\n        return oldChangeStream().pipe(\n            mergeMap(async (eventBulk) => {\n                const useEvents = await Promise.all(\n                    eventBulk.events.map(async (event) => {\n                        const [\n                            documentData,\n                            previousDocumentData\n                        ] = await Promise.all([\n                            fromStorage(event.documentData),\n                            fromStorage(event.previousDocumentData)\n                        ]);\n                        const ev: RxChangeEvent<RxDocType> = {\n                            operation: event.operation,\n                            eventId: event.eventId,\n                            documentId: event.documentId,\n                            endTime: event.endTime,\n                            startTime: event.startTime,\n                            documentData: documentData as any,\n                            previousDocumentData: previousDocumentData as any,\n                            isLocal: false\n                        };\n                        return ev;\n                    })\n                );\n                const ret: EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, any> = {\n                    id: eventBulk.id,\n                    events: useEvents,\n                    checkpoint: eventBulk.checkpoint,\n                    context: eventBulk.context\n                };\n                return ret;\n            })\n        );\n    };\n\n    const oldConflictResultionTasks = instance.conflictResultionTasks.bind(instance);\n    instance.conflictResultionTasks = () => {\n        return oldConflictResultionTasks().pipe(\n            mergeMap(async (task) => {\n                const assumedMasterState = await fromStorage(task.input.assumedMasterState);\n                const newDocumentState = await fromStorage(task.input.newDocumentState);\n                const realMasterState = await fromStorage(task.input.realMasterState);\n                return {\n                    id: task.id,\n                    context: task.context,\n                    input: {\n                        assumedMasterState,\n                        realMasterState,\n                        newDocumentState\n                    }\n                };\n            })\n        );\n    };\n\n    const oldResolveConflictResultionTask = instance.resolveConflictResultionTask.bind(instance);\n    instance.resolveConflictResultionTask = (taskSolution) => {\n        if (taskSolution.output.isEqual) {\n            return oldResolveConflictResultionTask(taskSolution);\n        }\n        const useSolution = {\n            id: taskSolution.id,\n            output: {\n                isEqual: false,\n                documentData: taskSolution.output.documentData\n            }\n        };\n        return oldResolveConflictResultionTask(useSolution);\n    };\n\n    return instance;\n}\n"],"mappings":"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"}