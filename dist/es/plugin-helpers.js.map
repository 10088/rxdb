{"version":3,"file":"plugin-helpers.js","names":["mergeMap","fastUnsecureHash","flatClone","getFromMapOrThrow","requestIdleCallbackIfAvailable","VALIDATOR_CACHE_BY_VALIDATOR_KEY","Map","wrappedValidateStorageFactory","getValidator","validatorKey","has","set","VALIDATOR_CACHE","initValidator","schema","hash","JSON","stringify","validator","args","Object","assign","storage","createStorageInstance","params","instance","validatorCached","oldBulkWrite","bulkWrite","bind","documentWrites","context","forEach","row","document","wrapRxStorageInstance","modifyToStorage","modifyFromStorage","errorFromStorage","error","fromStorage","ret","writeRow","previous","documentInDb","docData","toStorage","modifyAttachmentFromStorage","v","useRows","Promise","all","map","undefined","push","writeResult","success","promises","entries","k","then","err","oldQuery","query","preparedQuery","queryResult","documents","doc","oldGetAttachmentData","getAttachmentData","documentId","attachmentId","data","oldFindDocumentsById","findDocumentsById","ids","deleted","findResult","key","oldGetChangedDocumentsSince","getChangedDocumentsSince","limit","checkpoint","result","d","oldChangeStream","changeStream","pipe","eventBulk","events","event","documentData","previousDocumentData","ev","operation","eventId","endTime","startTime","isLocal","useEvents","id","oldConflictResultionTasks","conflictResultionTasks","task","input","assumedMasterState","newDocumentState","realMasterState","oldResolveConflictResultionTask","resolveConflictResultionTask","taskSolution","output","isEqual","useSolution"],"sources":["../../src/plugin-helpers.ts"],"sourcesContent":["import { mergeMap } from 'rxjs/operators';\nimport type {\n    BulkWriteRow,\n    EventBulk,\n    RxChangeEvent,\n    RxDocumentData,\n    RxDocumentDataById,\n    RxJsonSchema,\n    RxStorage,\n    RxStorageBulkWriteError,\n    RxStorageBulkWriteResponse,\n    RxStorageChangeEvent,\n    RxStorageInstance,\n    RxStorageInstanceCreationParams\n} from './types';\nimport {\n    fastUnsecureHash,\n    flatClone,\n    getFromMapOrThrow,\n    requestIdleCallbackIfAvailable\n} from './util';\n\n\ntype WrappedStorageFunction = <Internals, InstanceCreationOptions>(\n    args: {\n        storage: RxStorage<Internals, InstanceCreationOptions>\n    }\n) => RxStorage<Internals, InstanceCreationOptions>;\n\ntype ValidatorFunction = (docData: RxDocumentData<any>) => void;\n\n/**\n * cache the validators by the schema-hash\n * so we can reuse them when multiple collections have the same schema\n */\nconst VALIDATOR_CACHE_BY_VALIDATOR_KEY: Map<string, Map<string, ValidatorFunction>> = new Map();\n\n/**\n * This factory is used in the validation plugins\n * so that we can reuse the basic storage wrapping code.\n */\nexport function wrappedValidateStorageFactory(\n    /**\n     * Returns a method that can be used to validate\n     * documents and throws when the document is not valid.\n     */\n    getValidator: (schema: RxJsonSchema<any>) => ValidatorFunction,\n    /**\n     * A string to identify the validation library.\n     */\n    validatorKey: string\n): WrappedStorageFunction {\n    if (!VALIDATOR_CACHE_BY_VALIDATOR_KEY.has(validatorKey)) {\n        VALIDATOR_CACHE_BY_VALIDATOR_KEY.set(validatorKey, new Map());\n    }\n    const VALIDATOR_CACHE = getFromMapOrThrow(VALIDATOR_CACHE_BY_VALIDATOR_KEY, validatorKey);\n\n    function initValidator(\n        schema: RxJsonSchema<any>\n    ): ValidatorFunction {\n        const hash = fastUnsecureHash(JSON.stringify(schema));\n        if (!VALIDATOR_CACHE.has(hash)) {\n            const validator = getValidator(schema);\n            VALIDATOR_CACHE.set(hash, validator);\n            return validator;\n        }\n        return getFromMapOrThrow(VALIDATOR_CACHE, hash);\n    }\n\n    return (args) => {\n        return Object.assign(\n            {},\n            args.storage,\n            {\n                async createStorageInstance<RxDocType>(\n                    params: RxStorageInstanceCreationParams<RxDocType, any>\n                ) {\n                    const instance = await args.storage.createStorageInstance(params);\n                    /**\n                     * Lazy initialize the validator\n                     * to save initial page load performance.\n                     * Some libraries take really long to initialize the validator\n                     * from the schema.\n                     */\n                    let validatorCached: ValidatorFunction;\n                    requestIdleCallbackIfAvailable(() => validatorCached = initValidator(params.schema));\n\n                    const oldBulkWrite = instance.bulkWrite.bind(instance);\n                    instance.bulkWrite = (\n                        documentWrites: BulkWriteRow<RxDocType>[],\n                        context: string\n                    ) => {\n                        if (!validatorCached) {\n                            validatorCached = initValidator(params.schema);\n                        }\n                        documentWrites.forEach(row => {\n                            validatorCached(row.document);\n                        });\n                        return oldBulkWrite(documentWrites, context);\n                    }\n\n                    return instance;\n                }\n            }\n        );\n    };\n\n}\n\n\n\n/**\n * Used in plugins to easily modify all in- and outgoing\n * data of that storage instance.\n */\nexport function wrapRxStorageInstance<RxDocType>(\n    instance: RxStorageInstance<RxDocType, any, any>,\n    modifyToStorage: (docData: RxDocumentData<RxDocType>) => Promise<RxDocumentData<any>> | RxDocumentData<any>,\n    modifyFromStorage: (docData: RxDocumentData<any>) => Promise<RxDocumentData<RxDocType>> | RxDocumentData<RxDocType>,\n    modifyAttachmentFromStorage: (attachmentData: string) => Promise<string> | string = (v) => v\n) {\n    async function toStorage(docData: RxDocumentData<RxDocType>): Promise<RxDocumentData<any>> {\n        if (!docData) {\n            return docData;\n        }\n        return await modifyToStorage(docData);\n    }\n    async function fromStorage(docData: RxDocumentData<any> | null): Promise<RxDocumentData<RxDocType>> {\n        if (!docData) {\n            return docData;\n        }\n        return await modifyFromStorage(docData);\n    }\n    async function errorFromStorage<RxDocType>(\n        error: RxStorageBulkWriteError<any>\n    ): Promise<RxStorageBulkWriteError<RxDocType>> {\n        const ret = flatClone(error);\n        ret.writeRow = flatClone(ret.writeRow);\n        if (ret.documentInDb) {\n            ret.documentInDb = await fromStorage(ret.documentInDb);\n        }\n        if (ret.writeRow.previous) {\n            ret.writeRow.previous = await fromStorage(ret.writeRow.previous);\n        }\n        ret.writeRow.document = await fromStorage(ret.writeRow.document);\n        return ret;\n    }\n\n    const oldBulkWrite = instance.bulkWrite.bind(instance);\n    instance.bulkWrite = async (\n        documentWrites: BulkWriteRow<RxDocType>[],\n        context: string\n    ) => {\n        const useRows: BulkWriteRow<any>[] = [];\n        await Promise.all(\n            documentWrites.map(async (row) => {\n                const [previous, document] = await Promise.all([\n                    row.previous ? toStorage(row.previous) : undefined,\n                    toStorage(row.document)\n                ]);\n                useRows.push({ previous, document });\n            })\n        );\n\n        const writeResult = await oldBulkWrite(useRows, context);\n        const ret: RxStorageBulkWriteResponse<RxDocType> = {\n            success: {},\n            error: {}\n        };\n        const promises: Promise<any>[] = [];\n        Object.entries(writeResult.success).forEach(([k, v]) => {\n            promises.push(\n                fromStorage(v).then(v => ret.success[k] = v)\n            );\n        });\n        Object.entries(writeResult.error).forEach(([k, error]) => {\n            promises.push(\n                errorFromStorage<RxDocType>(error).then(err => ret.error[k] = err)\n            );\n        });\n        await Promise.all(promises);\n        return ret;\n    }\n\n    const oldQuery = instance.query.bind(instance);\n    instance.query = (preparedQuery) => {\n        return oldQuery(preparedQuery)\n            .then(queryResult => {\n                return Promise.all(queryResult.documents.map(doc => fromStorage(doc)));\n            })\n            .then(documents => ({ documents: documents as any }));\n    }\n\n    const oldGetAttachmentData = instance.getAttachmentData.bind(instance);\n    instance.getAttachmentData = async (\n        documentId: string,\n        attachmentId: string\n    ) => {\n        let data = await oldGetAttachmentData(documentId, attachmentId);\n        data = await modifyAttachmentFromStorage(data);\n        return data;\n    }\n\n    const oldFindDocumentsById = instance.findDocumentsById.bind(instance);\n    instance.findDocumentsById = (ids, deleted) => {\n        return oldFindDocumentsById(ids, deleted).then(async (findResult) => {\n            const ret: RxDocumentDataById<RxDocType> = {};\n            await Promise.all(\n                Object.entries(findResult)\n                    .map(async ([key, doc]) => {\n                        ret[key] = await fromStorage(doc);\n                    })\n            );\n            return ret;\n        });\n    };\n\n    const oldGetChangedDocumentsSince = instance.getChangedDocumentsSince.bind(instance);\n    instance.getChangedDocumentsSince = (limit, checkpoint) => {\n        return oldGetChangedDocumentsSince(limit, checkpoint)\n            .then(async (result) => {\n                return {\n                    checkpoint: result.checkpoint,\n                    documents: await Promise.all(\n                        result.documents.map(d => fromStorage(d))\n                    )\n                };\n            });\n    };\n\n    const oldChangeStream = instance.changeStream.bind(instance);\n    instance.changeStream = () => {\n        return oldChangeStream().pipe(\n            mergeMap(async (eventBulk) => {\n                const useEvents = await Promise.all(\n                    eventBulk.events.map(async (event) => {\n                        const [\n                            documentData,\n                            previousDocumentData\n                        ] = await Promise.all([\n                            fromStorage(event.documentData),\n                            fromStorage(event.previousDocumentData)\n                        ]);\n                        const ev: RxChangeEvent<RxDocType> = {\n                            operation: event.operation,\n                            eventId: event.eventId,\n                            documentId: event.documentId,\n                            endTime: event.endTime,\n                            startTime: event.startTime,\n                            documentData: documentData as any,\n                            previousDocumentData: previousDocumentData as any,\n                            isLocal: false\n                        };\n                        return ev;\n                    })\n                );\n                const ret: EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, any> = {\n                    id: eventBulk.id,\n                    events: useEvents,\n                    checkpoint: eventBulk.checkpoint,\n                    context: eventBulk.context\n                };\n                return ret;\n            })\n        )\n    };\n\n    const oldConflictResultionTasks = instance.conflictResultionTasks.bind(instance);\n    instance.conflictResultionTasks = () => {\n        return oldConflictResultionTasks().pipe(\n            mergeMap(async (task) => {\n                const assumedMasterState = await fromStorage(task.input.assumedMasterState);\n                const newDocumentState = await fromStorage(task.input.newDocumentState);\n                const realMasterState = await fromStorage(task.input.realMasterState);\n                return {\n                    id: task.id,\n                    context: task.context,\n                    input: {\n                        assumedMasterState,\n                        realMasterState,\n                        newDocumentState\n                    }\n                };\n            })\n        );\n    }\n\n    const oldResolveConflictResultionTask = instance.resolveConflictResultionTask.bind(instance);\n    instance.resolveConflictResultionTask = (taskSolution) => {\n        if (taskSolution.output.isEqual) {\n            return oldResolveConflictResultionTask(taskSolution);\n        }\n        const useSolution = {\n            id: taskSolution.id,\n            output: {\n                isEqual: false,\n                documentData: taskSolution.output.documentData\n            }\n        };\n        return oldResolveConflictResultionTask(useSolution);\n    }\n\n    return instance;\n}\n"],"mappings":"AAAA,SAASA,QAAT,QAAyB,gBAAzB;AAeA,SACIC,gBADJ,EAEIC,SAFJ,EAGIC,iBAHJ,EAIIC,8BAJJ,QAKO,QALP;;AAgBA;AACA;AACA;AACA;AACA,IAAMC,gCAA6E,GAAG,IAAIC,GAAJ,EAAtF;AAEA;AACA;AACA;AACA;;AACA,OAAO,SAASC,6BAAT;AACH;AACJ;AACA;AACA;AACIC,YALG;AAMH;AACJ;AACA;AACIC,YATG,EAUmB;EACtB,IAAI,CAACJ,gCAAgC,CAACK,GAAjC,CAAqCD,YAArC,CAAL,EAAyD;IACrDJ,gCAAgC,CAACM,GAAjC,CAAqCF,YAArC,EAAmD,IAAIH,GAAJ,EAAnD;EACH;;EACD,IAAMM,eAAe,GAAGT,iBAAiB,CAACE,gCAAD,EAAmCI,YAAnC,CAAzC;;EAEA,SAASI,aAAT,CACIC,MADJ,EAEqB;IACjB,IAAMC,IAAI,GAAGd,gBAAgB,CAACe,IAAI,CAACC,SAAL,CAAeH,MAAf,CAAD,CAA7B;;IACA,IAAI,CAACF,eAAe,CAACF,GAAhB,CAAoBK,IAApB,CAAL,EAAgC;MAC5B,IAAMG,SAAS,GAAGV,YAAY,CAACM,MAAD,CAA9B;MACAF,eAAe,CAACD,GAAhB,CAAoBI,IAApB,EAA0BG,SAA1B;MACA,OAAOA,SAAP;IACH;;IACD,OAAOf,iBAAiB,CAACS,eAAD,EAAkBG,IAAlB,CAAxB;EACH;;EAED,OAAO,UAACI,IAAD,EAAU;IACb,OAAOC,MAAM,CAACC,MAAP,CACH,EADG,EAEHF,IAAI,CAACG,OAFF,EAGH;MACUC,qBADV,iCAEQC,MAFR;QAAA,IAGM;UAAA,uBACyBL,IAAI,CAACG,OAAL,CAAaC,qBAAb,CAAmCC,MAAnC,CADzB,iBACQC,QADR;YAEE;AACpB;AACA;AACA;AACA;AACA;YACoB,IAAIC,eAAJ;YACAtB,8BAA8B,CAAC;cAAA,OAAMsB,eAAe,GAAGb,aAAa,CAACW,MAAM,CAACV,MAAR,CAArC;YAAA,CAAD,CAA9B;YAEA,IAAMa,YAAY,GAAGF,QAAQ,CAACG,SAAT,CAAmBC,IAAnB,CAAwBJ,QAAxB,CAArB;;YACAA,QAAQ,CAACG,SAAT,GAAqB,UACjBE,cADiB,EAEjBC,OAFiB,EAGhB;cACD,IAAI,CAACL,eAAL,EAAsB;gBAClBA,eAAe,GAAGb,aAAa,CAACW,MAAM,CAACV,MAAR,CAA/B;cACH;;cACDgB,cAAc,CAACE,OAAf,CAAuB,UAAAC,GAAG,EAAI;gBAC1BP,eAAe,CAACO,GAAG,CAACC,QAAL,CAAf;cACH,CAFD;cAGA,OAAOP,YAAY,CAACG,cAAD,EAAiBC,OAAjB,CAAnB;YACH,CAXD;;YAaA,OAAON,QAAP;UAzBF;QA0BD,CA7BL;UAAA;QAAA;MAAA;IAAA,CAHG,CAAP;EAmCH,CApCD;AAsCH;AAID;AACA;AACA;AACA;;AACA,OAAO,SAASU,qBAAT,CACHV,QADG,EAEHW,eAFG,EAGHC,iBAHG,EAKL;EAAA,IAaiBC,gBAbjB,YAaiBA,gBAbjB,CAcMC,KAdN;IAAA,IAeiD;MAAA;QAAA;UAAA,uBASbC,WAAW,CAACC,GAAG,CAACC,QAAJ,CAAaR,QAAd,CATE;YAS3CO,GAAG,CAACC,QAAJ,CAAaR,QAAb;YACA,OAAOO,GAAP;UAV2C;QAAA;;QAAA;UAAA,IAMvCA,GAAG,CAACC,QAAJ,CAAaC,QAN0B;YAAA,uBAOTH,WAAW,CAACC,GAAG,CAACC,QAAJ,CAAaC,QAAd,CAPF;cAOvCF,GAAG,CAACC,QAAJ,CAAaC,QAAb;YAPuC;UAAA;QAAA;;QAAA;MAAA;;MAC3C,IAAMF,GAAG,GAAGvC,SAAS,CAACqC,KAAD,CAArB;MACAE,GAAG,CAACC,QAAJ,GAAexC,SAAS,CAACuC,GAAG,CAACC,QAAL,CAAxB;;MAF2C;QAAA,IAGvCD,GAAG,CAACG,YAHmC;UAAA,uBAIdJ,WAAW,CAACC,GAAG,CAACG,YAAL,CAJG;YAIvCH,GAAG,CAACG,YAAJ;UAJuC;QAAA;MAAA;;MAAA;IAW9C,CA1BH;MAAA;IAAA;EAAA;;EAAA,IAOiBJ,WAPjB,YAOiBA,WAPjB,CAO6BK,OAP7B;IAAA,IAOsG;MAChG,IAAI,CAACA,OAAL,EAAc;QACV,uBAAOA,OAAP;MACH;;MAH+F,uBAInFR,iBAAiB,CAACQ,OAAD,CAJkE;IAKnG,CAZH;MAAA;IAAA;EAAA;;EAAA,IACiBC,SADjB,YACiBA,SADjB,CAC2BD,OAD3B;IAAA,IAC6F;MACvF,IAAI,CAACA,OAAL,EAAc;QACV,uBAAOA,OAAP;MACH;;MAHsF,uBAI1ET,eAAe,CAACS,OAAD,CAJ2D;IAK1F,CANH;MAAA;IAAA;EAAA;;EAAA,IADEE,2BACF,uEADsF,UAACC,CAAD;IAAA,OAAOA,CAAP;EAAA,CACtF;EA4BE,IAAMrB,YAAY,GAAGF,QAAQ,CAACG,SAAT,CAAmBC,IAAnB,CAAwBJ,QAAxB,CAArB;;EACAA,QAAQ,CAACG,SAAT,aACIE,cADJ,EAEIC,OAFJ;IAAA,IAGK;MACD,IAAMkB,OAA4B,GAAG,EAArC;MADC,uBAEKC,OAAO,CAACC,GAAR,CACFrB,cAAc,CAACsB,GAAf,WAA0BnB,GAA1B;QAAA,IAAkC;UAAA,uBACKiB,OAAO,CAACC,GAAR,CAAY,CAC3ClB,GAAG,CAACU,QAAJ,GAAeG,SAAS,CAACb,GAAG,CAACU,QAAL,CAAxB,GAAyCU,SADE,EAE3CP,SAAS,CAACb,GAAG,CAACC,QAAL,CAFkC,CAAZ,CADL;YAAA,IACvBS,QADuB;YAAA,IACbT,QADa;YAK9Be,OAAO,CAACK,IAAR,CAAa;cAAEX,QAAQ,EAARA,QAAF;cAAYT,QAAQ,EAARA;YAAZ,CAAb;UAL8B;QAMjC,CAND;UAAA;QAAA;MAAA,EADE,CAFL;QAAA,uBAYyBP,YAAY,CAACsB,OAAD,EAAUlB,OAAV,CAZrC,iBAYKwB,WAZL;UAaD,IAAMd,GAA0C,GAAG;YAC/Ce,OAAO,EAAE,EADsC;YAE/CjB,KAAK,EAAE;UAFwC,CAAnD;UAIA,IAAMkB,QAAwB,GAAG,EAAjC;UACArC,MAAM,CAACsC,OAAP,CAAeH,WAAW,CAACC,OAA3B,EAAoCxB,OAApC,CAA4C,iBAAY;YAAA,IAAV2B,CAAU;YAAA,IAAPX,CAAO;YACpDS,QAAQ,CAACH,IAAT,CACId,WAAW,CAACQ,CAAD,CAAX,CAAeY,IAAf,CAAoB,UAAAZ,CAAC;cAAA,OAAIP,GAAG,CAACe,OAAJ,CAAYG,CAAZ,IAAiBX,CAArB;YAAA,CAArB,CADJ;UAGH,CAJD;UAKA5B,MAAM,CAACsC,OAAP,CAAeH,WAAW,CAAChB,KAA3B,EAAkCP,OAAlC,CAA0C,iBAAgB;YAAA,IAAd2B,CAAc;YAAA,IAAXpB,KAAW;YACtDkB,QAAQ,CAACH,IAAT,CACIhB,gBAAgB,CAAYC,KAAZ,CAAhB,CAAmCqB,IAAnC,CAAwC,UAAAC,GAAG;cAAA,OAAIpB,GAAG,CAACF,KAAJ,CAAUoB,CAAV,IAAeE,GAAnB;YAAA,CAA3C,CADJ;UAGH,CAJD;UAvBC,uBA4BKX,OAAO,CAACC,GAAR,CAAYM,QAAZ,CA5BL;YA6BD,OAAOhB,GAAP;UA7BC;QAAA;MAAA;IA8BJ,CAjCD;MAAA;IAAA;EAAA;;EAmCA,IAAMqB,QAAQ,GAAGrC,QAAQ,CAACsC,KAAT,CAAelC,IAAf,CAAoBJ,QAApB,CAAjB;;EACAA,QAAQ,CAACsC,KAAT,GAAiB,UAACC,aAAD,EAAmB;IAChC,OAAOF,QAAQ,CAACE,aAAD,CAAR,CACFJ,IADE,CACG,UAAAK,WAAW,EAAI;MACjB,OAAOf,OAAO,CAACC,GAAR,CAAYc,WAAW,CAACC,SAAZ,CAAsBd,GAAtB,CAA0B,UAAAe,GAAG;QAAA,OAAI3B,WAAW,CAAC2B,GAAD,CAAf;MAAA,CAA7B,CAAZ,CAAP;IACH,CAHE,EAIFP,IAJE,CAIG,UAAAM,SAAS;MAAA,OAAK;QAAEA,SAAS,EAAEA;MAAb,CAAL;IAAA,CAJZ,CAAP;EAKH,CAND;;EAQA,IAAME,oBAAoB,GAAG3C,QAAQ,CAAC4C,iBAAT,CAA2BxC,IAA3B,CAAgCJ,QAAhC,CAA7B;;EACAA,QAAQ,CAAC4C,iBAAT,aACIC,UADJ,EAEIC,YAFJ;IAAA,IAGK;MAAA,uBACgBH,oBAAoB,CAACE,UAAD,EAAaC,YAAb,CADpC,iBACGC,IADH;QAAA,uBAEYzB,2BAA2B,CAACyB,IAAD,CAFvC;UAEDA,IAAI,wBAAJ;UACA,OAAOA,IAAP;QAHC;MAAA;IAIJ,CAPD;MAAA;IAAA;EAAA;;EASA,IAAMC,oBAAoB,GAAGhD,QAAQ,CAACiD,iBAAT,CAA2B7C,IAA3B,CAAgCJ,QAAhC,CAA7B;;EACAA,QAAQ,CAACiD,iBAAT,GAA6B,UAACC,GAAD,EAAMC,OAAN,EAAkB;IAC3C,OAAOH,oBAAoB,CAACE,GAAD,EAAMC,OAAN,CAApB,CAAmChB,IAAnC,WAA+CiB,UAA/C;MAAA,IAA8D;QACjE,IAAMpC,GAAkC,GAAG,EAA3C;QADiE,uBAE3DS,OAAO,CAACC,GAAR,CACF/B,MAAM,CAACsC,OAAP,CAAemB,UAAf,EACKzB,GADL,kBAC+B;UAAA,IAAd0B,GAAc;UAAA,IAATX,GAAS;UAAA,uBACN3B,WAAW,CAAC2B,GAAD,CADL;YACvB1B,GAAG,CAACqC,GAAD,CAAH;UADuB;QAE1B,CAHL,CADE,CAF2D;UAQjE,OAAOrC,GAAP;QARiE;MASpE,CATM;QAAA;MAAA;IAAA,EAAP;EAUH,CAXD;;EAaA,IAAMsC,2BAA2B,GAAGtD,QAAQ,CAACuD,wBAAT,CAAkCnD,IAAlC,CAAuCJ,QAAvC,CAApC;;EACAA,QAAQ,CAACuD,wBAAT,GAAoC,UAACC,KAAD,EAAQC,UAAR,EAAuB;IACvD,OAAOH,2BAA2B,CAACE,KAAD,EAAQC,UAAR,CAA3B,CACFtB,IADE,WACUuB,MADV;MAAA,IACqB;QAAA,0BAEJA,MAAM,CAACD,UAFH;QAAA,uBAGChC,OAAO,CAACC,GAAR,CACbgC,MAAM,CAACjB,SAAP,CAAiBd,GAAjB,CAAqB,UAAAgC,CAAC;UAAA,OAAI5C,WAAW,CAAC4C,CAAD,CAAf;QAAA,CAAtB,CADa,CAHD;UACpB,OAAO;YACHF,UAAU,qBADP;YAEHhB,SAAS;UAFN,CAAP;QADoB;MAOvB,CARE;QAAA;MAAA;IAAA,EAAP;EASH,CAVD;;EAYA,IAAMmB,eAAe,GAAG5D,QAAQ,CAAC6D,YAAT,CAAsBzD,IAAtB,CAA2BJ,QAA3B,CAAxB;;EACAA,QAAQ,CAAC6D,YAAT,GAAwB,YAAM;IAC1B,OAAOD,eAAe,GAAGE,IAAlB,CACHvF,QAAQ,WAAQwF,SAAR;MAAA,IAAsB;QAAA,uBACFtC,OAAO,CAACC,GAAR,CACpBqC,SAAS,CAACC,MAAV,CAAiBrC,GAAjB,WAA4BsC,KAA5B;UAAA,IAAsC;YAAA,uBAIxBxC,OAAO,CAACC,GAAR,CAAY,CAClBX,WAAW,CAACkD,KAAK,CAACC,YAAP,CADO,EAElBnD,WAAW,CAACkD,KAAK,CAACE,oBAAP,CAFO,CAAZ,CAJwB;cAAA,IAE9BD,YAF8B;cAAA,IAG9BC,oBAH8B;cAQlC,IAAMC,EAA4B,GAAG;gBACjCC,SAAS,EAAEJ,KAAK,CAACI,SADgB;gBAEjCC,OAAO,EAAEL,KAAK,CAACK,OAFkB;gBAGjCzB,UAAU,EAAEoB,KAAK,CAACpB,UAHe;gBAIjC0B,OAAO,EAAEN,KAAK,CAACM,OAJkB;gBAKjCC,SAAS,EAAEP,KAAK,CAACO,SALgB;gBAMjCN,YAAY,EAAEA,YANmB;gBAOjCC,oBAAoB,EAAEA,oBAPW;gBAQjCM,OAAO,EAAE;cARwB,CAArC;cAUA,OAAOL,EAAP;YAlBkC;UAmBrC,CAnBD;YAAA;UAAA;QAAA,EADoB,CADE,iBACpBM,SADoB;UAuB1B,IAAM1D,GAAoE,GAAG;YACzE2D,EAAE,EAAEZ,SAAS,CAACY,EAD2D;YAEzEX,MAAM,EAAEU,SAFiE;YAGzEjB,UAAU,EAAEM,SAAS,CAACN,UAHmD;YAIzEnD,OAAO,EAAEyD,SAAS,CAACzD;UAJsD,CAA7E;UAMA,OAAOU,GAAP;QA7B0B;MA8B7B,CA9BO;QAAA;MAAA;IAAA,EADL,CAAP;EAiCH,CAlCD;;EAoCA,IAAM4D,yBAAyB,GAAG5E,QAAQ,CAAC6E,sBAAT,CAAgCzE,IAAhC,CAAqCJ,QAArC,CAAlC;;EACAA,QAAQ,CAAC6E,sBAAT,GAAkC,YAAM;IACpC,OAAOD,yBAAyB,GAAGd,IAA5B,CACHvF,QAAQ,WAAQuG,IAAR;MAAA,IAAiB;QAAA,uBACY/D,WAAW,CAAC+D,IAAI,CAACC,KAAL,CAAWC,kBAAZ,CADvB,iBACfA,kBADe;UAAA,uBAEUjE,WAAW,CAAC+D,IAAI,CAACC,KAAL,CAAWE,gBAAZ,CAFrB,iBAEfA,gBAFe;YAAA,uBAGSlE,WAAW,CAAC+D,IAAI,CAACC,KAAL,CAAWG,eAAZ,CAHpB,iBAGfA,eAHe;cAIrB,OAAO;gBACHP,EAAE,EAAEG,IAAI,CAACH,EADN;gBAEHrE,OAAO,EAAEwE,IAAI,CAACxE,OAFX;gBAGHyE,KAAK,EAAE;kBACHC,kBAAkB,EAAlBA,kBADG;kBAEHE,eAAe,EAAfA,eAFG;kBAGHD,gBAAgB,EAAhBA;gBAHG;cAHJ,CAAP;YAJqB;UAAA;QAAA;MAaxB,CAbO;QAAA;MAAA;IAAA,EADL,CAAP;EAgBH,CAjBD;;EAmBA,IAAME,+BAA+B,GAAGnF,QAAQ,CAACoF,4BAAT,CAAsChF,IAAtC,CAA2CJ,QAA3C,CAAxC;;EACAA,QAAQ,CAACoF,4BAAT,GAAwC,UAACC,YAAD,EAAkB;IACtD,IAAIA,YAAY,CAACC,MAAb,CAAoBC,OAAxB,EAAiC;MAC7B,OAAOJ,+BAA+B,CAACE,YAAD,CAAtC;IACH;;IACD,IAAMG,WAAW,GAAG;MAChBb,EAAE,EAAEU,YAAY,CAACV,EADD;MAEhBW,MAAM,EAAE;QACJC,OAAO,EAAE,KADL;QAEJrB,YAAY,EAAEmB,YAAY,CAACC,MAAb,CAAoBpB;MAF9B;IAFQ,CAApB;IAOA,OAAOiB,+BAA+B,CAACK,WAAD,CAAtC;EACH,CAZD;;EAcA,OAAOxF,QAAP;AACH"}