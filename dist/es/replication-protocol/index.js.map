{"version":3,"file":"index.js","names":["BehaviorSubject","combineLatest","filter","firstValueFrom","map","Subject","getPrimaryFieldOfPrimaryKey","ensureNotFalsy","PROMISE_RESOLVE_VOID","getCheckpointKey","startReplicationDownstream","docStateToWriteDoc","writeDocToDocState","startReplicationUpstream","pact","state","value","s","v","o","bind","then","observer","prototype","onFulfilled","onRejected","result","callback","e","_this","thenable","test","update","body","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","awaitRxStorageReplicationIdle","awaitRxStorageReplicationFirstInSync","streamQueue","down","up","Promise","all","replicateRxStorageInstance","input","checkpointKey","primaryPath","forkInstance","schema","primaryKey","downstreamBulkWriteFlag","events","canceled","active","processed","resolvedConflicts","error","stats","addNewTask","downstreamProcessChanges","downstreamResyncOnce","masterChangeStreamEmit","persistFromMaster","forkChangeStreamEmit","persistToMaster","persistToMasterConflictWrites","persistToMasterHadConflicts","processTasks","upstreamInitialSync","firstSyncDone","checkpointQueue","lastCheckpointDoc","pipe","awaitRxStorageReplicationInSync","replicationState","rxStorageInstanceToReplicationHandler","instance","conflictHandler","hashFunction","replicationHandler","masterChangeStream$","changeStream","eventBulk","ret","checkpoint","documents","event","documentData","masterChangesSince","batchSize","getChangedDocumentsSince","length","d","masterWrite","rows","rowById","forEach","row","docId","newDocumentState","ids","Object","keys","findDocumentsById","masterDocsState","conflicts","writeRows","entries","id","masterState","push","document","assumedMasterState","realMasterState","isEqual","previous","bulkWrite","values","err","status","Error","documentInDb","cancelRxStorageReplication","next","complete"],"sources":["../../../src/replication-protocol/index.ts"],"sourcesContent":["/**\n * These files contain the replication protocol.\n * It can be used to replicated RxStorageInstances or RxCollections\n * or even to do a client(s)-server replication.\n */\n\n\nimport {\n    BehaviorSubject,\n    combineLatest,\n    filter,\n    firstValueFrom,\n    map,\n    Subject\n} from 'rxjs';\nimport {\n    getPrimaryFieldOfPrimaryKey\n} from '../rx-schema-helper';\nimport type {\n    BulkWriteRow,\n    ById,\n    DocumentsWithCheckpoint,\n    HashFunction,\n    RxConflictHandler,\n    RxReplicationHandler,\n    RxReplicationWriteToMasterRow,\n    RxStorageInstance,\n    RxStorageInstanceReplicationInput,\n    RxStorageInstanceReplicationState,\n    WithDeleted\n} from '../types';\nimport {\n    ensureNotFalsy,\n    PROMISE_RESOLVE_VOID\n} from '../util';\nimport {\n    getCheckpointKey\n} from './checkpoint';\nimport { startReplicationDownstream } from './downstream';\nimport { docStateToWriteDoc, writeDocToDocState } from './helper';\nimport { startReplicationUpstream } from './upstream';\n\n\nexport * from './checkpoint';\nexport * from './downstream';\nexport * from './upstream';\nexport * from './meta-instance';\nexport * from './conflicts';\nexport * from './helper';\n\n\nexport function replicateRxStorageInstance<RxDocType>(\n    input: RxStorageInstanceReplicationInput<RxDocType>\n): RxStorageInstanceReplicationState<RxDocType> {\n    const checkpointKey = getCheckpointKey(input);\n    const state: RxStorageInstanceReplicationState<RxDocType> = {\n        primaryPath: getPrimaryFieldOfPrimaryKey(input.forkInstance.schema.primaryKey),\n        input,\n        checkpointKey,\n        downstreamBulkWriteFlag: 'replication-downstream-' + checkpointKey,\n        events: {\n            canceled: new BehaviorSubject<boolean>(false),\n            active: {\n                down: new BehaviorSubject<boolean>(true),\n                up: new BehaviorSubject<boolean>(true)\n            },\n            processed: {\n                down: new Subject(),\n                up: new Subject()\n            },\n            resolvedConflicts: new Subject(),\n            error: new Subject()\n        },\n        stats: {\n            down: {\n                addNewTask: 0,\n                downstreamProcessChanges: 0,\n                downstreamResyncOnce: 0,\n                masterChangeStreamEmit: 0,\n                persistFromMaster: 0\n            },\n            up: {\n                forkChangeStreamEmit: 0,\n                persistToMaster: 0,\n                persistToMasterConflictWrites: 0,\n                persistToMasterHadConflicts: 0,\n                processTasks: 0,\n                upstreamInitialSync: 0\n            }\n        },\n        firstSyncDone: {\n            down: new BehaviorSubject<boolean>(false),\n            up: new BehaviorSubject<boolean>(false)\n        },\n        streamQueue: {\n            down: PROMISE_RESOLVE_VOID,\n            up: PROMISE_RESOLVE_VOID\n        },\n        checkpointQueue: PROMISE_RESOLVE_VOID,\n        lastCheckpointDoc: {}\n    };\n\n    startReplicationDownstream(state);\n    startReplicationUpstream(state);\n    return state;\n}\n\nexport function awaitRxStorageReplicationFirstInSync(\n    state: RxStorageInstanceReplicationState<any>\n): Promise<void> {\n    return firstValueFrom(\n        combineLatest([\n            state.firstSyncDone.down.pipe(\n                filter(v => !!v)\n            ),\n            state.firstSyncDone.up.pipe(\n                filter(v => !!v)\n            )\n        ])\n    ).then(() => { });\n}\n\nexport function awaitRxStorageReplicationInSync(\n    replicationState: RxStorageInstanceReplicationState<any>\n) {\n    return Promise.all([\n        replicationState.streamQueue.up,\n        replicationState.streamQueue.down,\n        replicationState.checkpointQueue\n    ]);\n}\n\n\nexport async function awaitRxStorageReplicationIdle(\n    state: RxStorageInstanceReplicationState<any>\n) {\n    await awaitRxStorageReplicationFirstInSync(state);\n    while (true) {\n        const { down, up } = state.streamQueue;\n        await Promise.all([\n            up,\n            down\n        ]);\n        /**\n         * If the Promises have not been reasigned\n         * after awaiting them, we know that the replication\n         * is in idle state at this point in time.\n         */\n        if (\n            down === state.streamQueue.down &&\n            up === state.streamQueue.up\n        ) {\n            return;\n        }\n    }\n}\n\n\nexport function rxStorageInstanceToReplicationHandler<RxDocType, MasterCheckpointType>(\n    instance: RxStorageInstance<RxDocType, any, any, MasterCheckpointType>,\n    conflictHandler: RxConflictHandler<RxDocType>,\n    hashFunction: HashFunction\n): RxReplicationHandler<RxDocType, MasterCheckpointType> {\n    const primaryPath = getPrimaryFieldOfPrimaryKey(instance.schema.primaryKey);\n    const replicationHandler: RxReplicationHandler<RxDocType, MasterCheckpointType> = {\n        masterChangeStream$: instance.changeStream().pipe(\n            map(eventBulk => {\n                const ret: DocumentsWithCheckpoint<RxDocType, MasterCheckpointType> = {\n                    checkpoint: eventBulk.checkpoint,\n                    documents: eventBulk.events.map(event => {\n                        return writeDocToDocState(ensureNotFalsy(event.documentData) as any);\n                    })\n                };\n                return ret;\n            })\n        ),\n        masterChangesSince(\n            checkpoint,\n            batchSize\n        ) {\n            return instance.getChangedDocumentsSince(\n                batchSize,\n                checkpoint\n            ).then(result => {\n                return {\n                    checkpoint: result.documents.length > 0 ? result.checkpoint : checkpoint,\n                    documents: result.documents.map(d => writeDocToDocState(d))\n                };\n            });\n        },\n        async masterWrite(\n            rows\n        ) {\n            const rowById: ById<RxReplicationWriteToMasterRow<RxDocType>> = {};\n            rows.forEach(row => {\n                const docId: string = (row.newDocumentState as any)[primaryPath];\n                rowById[docId] = row;\n            });\n            const ids = Object.keys(rowById);\n\n            const masterDocsState = await instance.findDocumentsById(\n                ids,\n                true\n            );\n            const conflicts: WithDeleted<RxDocType>[] = [];\n            const writeRows: BulkWriteRow<RxDocType>[] = [];\n            await Promise.all(\n                Object.entries(rowById)\n                    .map(async ([id, row]) => {\n                        const masterState = masterDocsState[id];\n                        if (!masterState) {\n                            writeRows.push({\n                                document: docStateToWriteDoc(hashFunction, row.newDocumentState)\n                            });\n                        } else if (\n                            masterState &&\n                            !row.assumedMasterState\n                        ) {\n                            conflicts.push(writeDocToDocState(masterState));\n                        } else if (\n                            (await conflictHandler({\n                                realMasterState: writeDocToDocState(masterState),\n                                newDocumentState: ensureNotFalsy(row.assumedMasterState)\n                            }, 'rxStorageInstanceToReplicationHandler-masterWrite')).isEqual === true\n                        ) {\n                            writeRows.push({\n                                previous: masterState,\n                                document: docStateToWriteDoc(hashFunction, row.newDocumentState, masterState)\n                            });\n                        } else {\n                            conflicts.push(writeDocToDocState(masterState));\n                        }\n                    })\n            );\n\n\n            if (writeRows.length > 0) {\n                const result = await instance.bulkWrite(\n                    writeRows,\n                    'replication-master-write'\n                );\n                Object\n                    .values(result.error)\n                    .forEach(err => {\n                        if (err.status !== 409) {\n                            throw new Error('non conflict error');\n                        } else {\n                            conflicts.push(\n                                writeDocToDocState(ensureNotFalsy(err.documentInDb))\n                            );\n                        }\n                    });\n            }\n            return conflicts;\n        }\n    };\n\n    return replicationHandler;\n}\n\n\nexport function cancelRxStorageReplication(\n    replicationState: RxStorageInstanceReplicationState<any>\n) {\n    replicationState.events.canceled.next(true);\n    replicationState.events.active.up.complete();\n    replicationState.events.active.down.complete();\n    replicationState.events.processed.up.complete();\n    replicationState.events.processed.down.complete();\n    replicationState.events.resolvedConflicts.complete();\n    replicationState.events.canceled.complete();\n}\n"],"mappings":"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"}