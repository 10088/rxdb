{"version":3,"file":"rx-storage-replication.js","names":["BehaviorSubject","combineLatest","filter","firstValueFrom","map","Subject","getPrimaryFieldOfPrimaryKey","ensureNotFalsy","lastOfArray","PROMISE_RESOLVE_VOID","getCheckpointKey","startReplicationDownstream","docStateToWriteDoc","writeDocToDocState","startReplicationUpstream","pact","state","value","s","v","o","bind","then","observer","prototype","onFulfilled","onRejected","result","callback","e","_this","thenable","test","update","body","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","awaitRxStorageReplicationIdle","awaitRxStorageReplicationFirstInSync","streamQueue","down","up","Promise","all","firstSyncDone","pipe","replicateRxStorageInstance","input","checkpointKey","primaryPath","forkInstance","schema","primaryKey","downstreamBulkWriteFlag","events","canceled","active","processed","resolvedConflicts","stats","addNewTask","downstreamProcessChanges","downstreamResyncOnce","masterChangeStreamEmit","persistFromMaster","forkChangeStreamEmit","persistToMaster","persistToMasterConflictWrites","persistToMasterHadConflicts","processTasks","upstreamInitialSync","lastCheckpointDoc","rxStorageInstanceToReplicationHandler","instance","conflictHandler","replicationHandler","masterChangeStream$","changeStream","eventBulk","ret","id","checkpoint","event","change","doc","previous","context","masterChangesSince","bulkSize","getChangedDocumentsSince","length","documentsData","r","document","masterWrite","rows","rowById","forEach","row","docId","newDocumentState","ids","Object","keys","findDocumentsById","masterDocsState","conflicts","writeRows","entries","masterState","push","assumedMasterState","realMasterState","isEqual","bulkWrite","values","error","err","status","Error","documentInDb"],"sources":["../../../src/replication/rx-storage-replication.ts"],"sourcesContent":["/**\n * Replicates two RxStorageInstances\n * with each other.\n * \n * Compared to the 'normal' replication plugins,\n * this one is made for internal use where:\n * - No permission handling is needed.\n * - It is made so that the write amount on the master is less but might increase on the child.\n * - It does not have to be easy to implement a compatible backend.\n *   Here we use another RxStorageImplementation as replication goal\n *   so it has to exactly behave like the RxStorage interface defines.\n * \n * This is made to be used internally by plugins\n * to get a really fast replication performance.\n * \n * The replication works like git, where the fork contains all new writes\n * and must be merged with the master before it can push it's new state to the master.\n */\n\nimport {\n    BehaviorSubject,\n    combineLatest,\n    filter,\n    firstValueFrom,\n    map,\n    Subject\n} from 'rxjs';\nimport {\n    getPrimaryFieldOfPrimaryKey\n} from '../rx-schema-helper';\nimport type {\n    BulkWriteRow,\n    ById,\n    EventBulk,\n    RxConflictHandler,\n    RxDocumentData,\n    RxReplicationHandler,\n    RxReplicationWriteToMasterRow,\n    RxStorageInstance,\n    RxStorageInstanceReplicationInput,\n    RxStorageInstanceReplicationState,\n    WithDeleted\n} from '../types';\nimport {\n    ensureNotFalsy,\n    lastOfArray,\n    PROMISE_RESOLVE_VOID\n} from '../util';\nimport {\n    getCheckpointKey\n} from './checkpoint';\nimport { startReplicationDownstream } from './downstream';\nimport { docStateToWriteDoc, writeDocToDocState } from './helper';\nimport { startReplicationUpstream } from './upstream';\n\n\nexport function replicateRxStorageInstance<RxDocType>(\n    input: RxStorageInstanceReplicationInput<RxDocType>\n): RxStorageInstanceReplicationState<RxDocType> {\n    const checkpointKey = getCheckpointKey(input);\n    const state: RxStorageInstanceReplicationState<RxDocType> = {\n        primaryPath: getPrimaryFieldOfPrimaryKey(input.forkInstance.schema.primaryKey),\n        input,\n        checkpointKey,\n        downstreamBulkWriteFlag: 'replication-downstream-' + checkpointKey,\n        events: {\n            canceled: new BehaviorSubject<boolean>(false),\n            active: {\n                down: new BehaviorSubject<boolean>(true),\n                up: new BehaviorSubject<boolean>(true)\n            },\n            processed: {\n                down: new Subject(),\n                up: new Subject()\n            },\n            resolvedConflicts: new Subject()\n        },\n        stats: {\n            down: {\n                addNewTask: 0,\n                downstreamProcessChanges: 0,\n                downstreamResyncOnce: 0,\n                masterChangeStreamEmit: 0,\n                persistFromMaster: 0\n            },\n            up: {\n                forkChangeStreamEmit: 0,\n                persistToMaster: 0,\n                persistToMasterConflictWrites: 0,\n                persistToMasterHadConflicts: 0,\n                processTasks: 0,\n                upstreamInitialSync: 0\n            }\n        },\n        firstSyncDone: {\n            down: new BehaviorSubject<boolean>(false),\n            up: new BehaviorSubject<boolean>(false)\n        },\n        streamQueue: {\n            down: PROMISE_RESOLVE_VOID,\n            up: PROMISE_RESOLVE_VOID\n        },\n        lastCheckpointDoc: {}\n    };\n\n    startReplicationDownstream(state);\n    startReplicationUpstream(state);\n    return state;\n}\n\nexport async function awaitRxStorageReplicationFirstInSync(\n    state: RxStorageInstanceReplicationState<any>\n) {\n    return firstValueFrom(\n        combineLatest([\n            state.firstSyncDone.down.pipe(\n                filter(v => !!v)\n            ),\n            state.firstSyncDone.up.pipe(\n                filter(v => !!v)\n            )\n        ])\n    );\n}\n\nexport async function awaitRxStorageReplicationIdle(\n    state: RxStorageInstanceReplicationState<any>\n) {\n    await awaitRxStorageReplicationFirstInSync(state);\n    while (true) {\n        const { down, up } = state.streamQueue;\n        await Promise.all([\n            up,\n            down\n        ]);\n        /**\n         * If the Promises have not been reasigned\n         * after awaiting them, we know that the replication\n         * is in idle state at this point in time.\n         */\n        if (\n            down === state.streamQueue.down &&\n            up === state.streamQueue.up\n        ) {\n            return;\n        }\n    }\n}\n\n\nexport function rxStorageInstanceToReplicationHandler<RxDocType, MasterCheckpointType>(\n    instance: RxStorageInstance<RxDocType, any, any, MasterCheckpointType>,\n    conflictHandler: RxConflictHandler<RxDocType>\n): RxReplicationHandler<RxDocType, MasterCheckpointType> {\n\n    const primaryPath = getPrimaryFieldOfPrimaryKey(instance.schema.primaryKey);\n\n\n    const replicationHandler: RxReplicationHandler<RxDocType, MasterCheckpointType> = {\n        masterChangeStream$: instance.changeStream().pipe(\n            map(eventBulk => {\n                const ret: EventBulk<RxDocumentData<RxDocType>, MasterCheckpointType> = {\n                    id: eventBulk.id,\n                    checkpoint: eventBulk.checkpoint,\n                    events: eventBulk.events.map(event => {\n                        if (event.change.doc) {\n                            return writeDocToDocState(event.change.doc as any);\n                        } else {\n                            return writeDocToDocState(event.change.previous as any);\n                        }\n                    }),\n                    context: eventBulk.context\n                };\n                return ret;\n            })\n        ),\n        masterChangesSince(\n            checkpoint,\n            bulkSize\n        ) {\n            return instance.getChangedDocumentsSince(\n                bulkSize,\n                checkpoint\n            ).then(result => {\n                return {\n                    checkpoint: result.length > 0 ? lastOfArray(result).checkpoint : checkpoint,\n                    documentsData: result.map(r => writeDocToDocState(r.document))\n                }\n            })\n        },\n        async masterWrite(\n            rows\n        ) {\n            const rowById: ById<RxReplicationWriteToMasterRow<RxDocType>> = {};\n            rows.forEach(row => {\n                const docId: string = (row.newDocumentState as any)[primaryPath];\n                rowById[docId] = row;\n            });\n            const ids = Object.keys(rowById);\n\n            const masterDocsState = await instance.findDocumentsById(\n                ids,\n                true\n            );\n            const conflicts: WithDeleted<RxDocType>[] = [];\n            const writeRows: BulkWriteRow<RxDocType>[] = [];\n            await Promise.all(\n                Object.entries(rowById)\n                    .map(async ([id, row]) => {\n                        const masterState = masterDocsState[id];\n                        if (!masterState) {\n                            writeRows.push({\n                                document: docStateToWriteDoc(row.newDocumentState)\n                            });\n                        } else if (\n                            masterState &&\n                            !row.assumedMasterState\n                        ) {\n                            conflicts.push(writeDocToDocState(masterState));\n                        } else if (\n                            (await conflictHandler({\n                                realMasterState: writeDocToDocState(masterState),\n                                newDocumentState: ensureNotFalsy(row.assumedMasterState)\n                            }, 'rxStorageInstanceToReplicationHandler-masterWrite')).isEqual === true\n                        ) {\n                            writeRows.push({\n                                previous: masterState,\n                                document: docStateToWriteDoc(row.newDocumentState, masterState)\n                            });\n                        } else {\n                            conflicts.push(writeDocToDocState(masterState));\n                        }\n                    })\n            );\n\n\n            if (writeRows.length > 0) {\n                const result = await instance.bulkWrite(\n                    writeRows,\n                    'replication-master-write'\n                );\n                Object\n                    .values(result.error)\n                    .forEach(err => {\n                        if (err.status !== 409) {\n                            throw new Error('non conflict error');\n                        } else {\n                            conflicts.push(\n                                writeDocToDocState(ensureNotFalsy(err.documentInDb))\n                            );\n                        }\n                    });\n            }\n            return conflicts;\n        }\n    };\n\n    return replicationHandler;\n}\n"],"mappings":"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"}