{"version":3,"file":"cleanup.js","names":["PROMISE_RESOLVE_TRUE","REPLICATION_STATE_BY_COLLECTION","DEFAULT_CLEANUP_POLICY","pact","state","value","s","v","o","bind","then","observer","prototype","onFulfilled","onRejected","result","callback","e","_this","thenable","test","update","body","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","runCleanupAfterDelete","rxCollection","cleanupPolicy","destroyed","promiseWait","runEach","cleanupRxCollection","rxDatabase","database","storageInstance","isDone","requestIdlePromise","RXSOTRAGE_CLEANUP_QUEUE","cleanup","minimumDeletedTime","awaitReplicationsInSync","replicationStates","get","Promise","all","map","replicationState","isStopped","awaitInSync","startCleanupForRxCollection","Object","assign","minimumCollectionAge","waitForLeadership"],"sources":["../../../../src/plugins/cleanup/cleanup.ts"],"sourcesContent":["import type { RxCleanupPolicy, RxCollection } from '../../types';\nimport { PROMISE_RESOLVE_TRUE } from '../../util';\nimport { REPLICATION_STATE_BY_COLLECTION } from '../replication';\nimport { DEFAULT_CLEANUP_POLICY } from './cleanup-helper';\n\n/**\n * Even on multiple databases,\n * the calls to RxStorage().cleanup()\n * must never run in parallel.\n * The cleanup is a background task which should\n * not affect the performance of other, more important tasks.\n */\nlet RXSOTRAGE_CLEANUP_QUEUE: Promise<boolean> = PROMISE_RESOLVE_TRUE;\n\nexport async function startCleanupForRxCollection(\n    rxCollection: RxCollection\n) {\n    const rxDatabase = rxCollection.database;\n    const cleanupPolicy = Object.assign(\n        {},\n        DEFAULT_CLEANUP_POLICY,\n        rxDatabase.cleanupPolicy ? rxDatabase.cleanupPolicy : {}\n    );\n\n    /**\n     * Wait until minimumDatabaseInstanceAge is reached\n     * or collection is destroyed.\n     */\n    await rxCollection.promiseWait(cleanupPolicy.minimumCollectionAge);\n    if (rxCollection.destroyed) {\n        return;\n    }\n\n    await cleanupPolicy.waitForLeadership ? rxDatabase.waitForLeadership() : PROMISE_RESOLVE_TRUE;\n    if (rxCollection.destroyed) {\n        return;\n    }\n\n    // initially cleanup the collection\n    await cleanupRxCollection(rxCollection, cleanupPolicy);\n\n    /**\n     * Afterwards we listen to deletes\n     * and only re-run the cleanup after\n     * minimumDeletedTime is reached.\n     */\n    await runCleanupAfterDelete(rxCollection, cleanupPolicy);\n}\n\n/**\n * Runs the cleanup for a single RxCollection\n */\nexport async function cleanupRxCollection(\n    rxCollection: RxCollection,\n    cleanupPolicy: RxCleanupPolicy\n) {\n    const rxDatabase = rxCollection.database;\n    const storageInstance = rxCollection.storageInstance;\n\n    // run cleanup() until it returns true\n    let isDone = false;\n    while (!isDone && !rxCollection.destroyed) {\n        if (cleanupPolicy.awaitReplicationsInSync) {\n            const replicationStates = REPLICATION_STATE_BY_COLLECTION.get(rxCollection);\n            if (replicationStates) {\n                await Promise.all(\n                    replicationStates.map(replicationState => {\n                        if (!replicationState.isStopped()) {\n                            return replicationState.awaitInSync();\n                        }\n                    })\n                );\n            }\n        }\n\n        await rxDatabase.requestIdlePromise();\n        if (rxCollection.destroyed) {\n            return;\n        }\n        RXSOTRAGE_CLEANUP_QUEUE = RXSOTRAGE_CLEANUP_QUEUE\n            .then(() => {\n                if (rxCollection.destroyed) {\n                    return true;\n                }\n                return storageInstance.cleanup(cleanupPolicy.minimumDeletedTime);\n            });\n        isDone = await RXSOTRAGE_CLEANUP_QUEUE;\n    }\n}\n\nexport async function runCleanupAfterDelete(\n    rxCollection: RxCollection,\n    cleanupPolicy: RxCleanupPolicy\n) {\n    while (!rxCollection.destroyed) {\n        await rxCollection.promiseWait(cleanupPolicy.runEach);\n        if (rxCollection.destroyed) {\n            return;\n        }\n        await cleanupRxCollection(rxCollection, cleanupPolicy);\n    }\n}\n"],"mappings":"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"}