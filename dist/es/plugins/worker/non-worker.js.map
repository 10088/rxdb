{"version":3,"sources":["../../../../src/plugins/worker/non-worker.ts"],"names":["Subject","spawn","Worker","WORKER_BY_INPUT","Map","RxStorageWorker","settings","statics","name","workerInput","workerPromise","get","set","hash","data","prepareQuery","schema","mutateableQuery","getQueryMatcher","query","getSortComparator","createStorageInstance","params","worker","instanceId","RxStorageInstanceWorker","databaseName","collectionName","rxStorage","options","createKeyObjectStorageInstance","RxStorageKeyObjectInstanceWorker","internals","changes$","subs","push","changeStream","subscribe","ev","next","bulkWrite","documentWrites","bulkAddRevisions","documents","findDocumentsById","ids","deleted","preparedQuery","getAttachmentData","documentId","attachmentId","getChangedDocuments","asObservable","close","forEach","sub","unsubscribe","remove","bulkWriteLocal","findLocalDocumentsById","getRxStorageWorker","storage"],"mappings":"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","sourcesContent":["import { Observable, Subject, Subscription } from 'rxjs';\nimport { spawn, Worker } from 'threads';\nimport {\n    RxJsonSchema,\n    RxStorage,\n    RxStorageInstanceCreationParams,\n    MangoQuery,\n    RxStorageInstance,\n    BlobBuffer,\n    BulkWriteRow,\n    ChangeStreamOnceOptions,\n    RxDocumentData,\n    RxStorageBulkWriteResponse,\n    RxStorageChangedDocumentMeta,\n    RxStorageChangeEvent,\n    RxStorageQueryResult,\n    RxStorageKeyObjectInstance,\n    BulkWriteLocalRow,\n    RxLocalDocumentData,\n    RxLocalStorageBulkWriteResponse,\n    RxKeyObjectStorageInstanceCreationParams,\n    EventBulk,\n    RxStorageStatics\n} from '../../types';\nimport { InWorkerStorage } from './in-worker';\n\ndeclare type WorkerStorageInternals = {\n    rxStorage: RxStorageWorker;\n    instanceId: number;\n    worker: InWorkerStorage;\n}\ndeclare type RxStorageWorkerSettings = {\n    workerInput: any;\n}\n\n/**\n * We have no way to detect if a worker is no longer needed.\n * Instead we reuse open workers so that creating many databases,\n * does not flood the OS by opening many threads.\n */\nconst WORKER_BY_INPUT: Map<any, Promise<InWorkerStorage>> = new Map();\n\nexport class RxStorageWorker implements RxStorage<WorkerStorageInternals, any> {\n    public name = 'worker';\n\n    public readonly workerPromise: Promise<InWorkerStorage>;\n    constructor(\n        public readonly settings: RxStorageWorkerSettings,\n        public readonly statics: RxStorageStatics\n    ) {\n        const workerInput = this.settings.workerInput;\n        let workerPromise = WORKER_BY_INPUT.get(workerInput);\n        if (!workerPromise) {\n            workerPromise = spawn<InWorkerStorage>(new Worker(this.settings.workerInput)) as any;\n            WORKER_BY_INPUT.set(workerInput, workerPromise as any);\n        }\n        this.workerPromise = workerPromise as any;\n    }\n\n    hash(data: Buffer | Blob | string): Promise<string> {\n        return this.statics.hash(data);\n    }\n\n    prepareQuery<RxDocType>(\n        schema: RxJsonSchema<RxDocType>,\n        mutateableQuery: MangoQuery<RxDocType>\n    ) {\n        return this.statics.prepareQuery(schema, mutateableQuery);\n    }\n\n    getQueryMatcher<RxDocType>(\n        schema: RxJsonSchema<RxDocType>,\n        query: MangoQuery<RxDocType>\n    ) {\n        return this.statics.getQueryMatcher(schema, query);\n    }\n\n    getSortComparator<RxDocType>(\n        schema: RxJsonSchema<RxDocType>,\n        query: MangoQuery<RxDocType>\n    ) {\n        return this.statics.getSortComparator(schema, query);\n    }\n\n    async createStorageInstance<RxDocType>(\n        params: RxStorageInstanceCreationParams<RxDocType, any>\n    ): Promise<RxStorageInstanceWorker<RxDocType>> {\n        const worker = await this.workerPromise;\n        const instanceId = await worker.createStorageInstance(params);\n        return new RxStorageInstanceWorker(\n            params.databaseName,\n            params.collectionName,\n            params.schema,\n            {\n                rxStorage: this,\n                instanceId,\n                worker\n            },\n            params.options\n        );\n    }\n\n    public async createKeyObjectStorageInstance(\n        params: RxKeyObjectStorageInstanceCreationParams<any>\n    ): Promise<RxStorageKeyObjectInstanceWorker> {\n        const worker = await this.workerPromise;\n        const instanceId = await worker.createKeyObjectStorageInstance(params);\n        return new RxStorageKeyObjectInstanceWorker(\n            params.databaseName,\n            params.collectionName,\n            {\n                rxStorage: this,\n                worker,\n                instanceId\n            },\n            params.options\n        );\n    }\n}\n\n\nexport class RxStorageInstanceWorker<DocumentData> implements RxStorageInstance<DocumentData, WorkerStorageInternals, any> {\n\n    /**\n     * threads.js uses observable-fns instead of rxjs\n     * so we have to transform it.\n     */\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<DocumentData>>>> = new Subject();\n    private subs: Subscription[] = [];\n\n    constructor(\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<DocumentData>>,\n        public readonly internals: WorkerStorageInternals,\n        public readonly options: Readonly<any>\n    ) {\n        this.subs.push(\n            this.internals.worker.changeStream(\n                this.internals.instanceId\n            ).subscribe(ev => this.changes$.next(ev as any))\n        );\n\n    }\n\n    bulkWrite(documentWrites: BulkWriteRow<DocumentData>[]): Promise<RxStorageBulkWriteResponse<DocumentData>> {\n        return this.internals.worker.bulkWrite(\n            this.internals.instanceId,\n            documentWrites\n        );\n    }\n    bulkAddRevisions(documents: RxDocumentData<DocumentData>[]): Promise<void> {\n        return this.internals.worker.bulkAddRevisions(\n            this.internals.instanceId,\n            documents\n        );\n    }\n    findDocumentsById(ids: string[], deleted: boolean): Promise<{ [documentId: string]: RxDocumentData<DocumentData> }> {\n        return this.internals.worker.findDocumentsById(\n            this.internals.instanceId,\n            ids,\n            deleted\n        );\n    }\n    query(preparedQuery: any): Promise<RxStorageQueryResult<DocumentData>> {\n        return this.internals.worker.query(\n            this.internals.instanceId,\n            preparedQuery\n        );\n    }\n    getAttachmentData(documentId: string, attachmentId: string): Promise<BlobBuffer> {\n        return this.internals.worker.getAttachmentData(\n            this.internals.instanceId,\n            documentId,\n            attachmentId\n        );\n    }\n    getChangedDocuments(options: ChangeStreamOnceOptions): Promise<{ changedDocuments: RxStorageChangedDocumentMeta[]; lastSequence: number; }> {\n        return this.internals.worker.getChangedDocuments(\n            this.internals.instanceId,\n            options\n        );\n    }\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxDocumentData<DocumentData>>>> {\n        return this.changes$.asObservable();\n    }\n    close(): Promise<void> {\n        this.subs.forEach(sub => sub.unsubscribe());\n        return this.internals.worker.close(\n            this.internals.instanceId\n        );\n    }\n    remove(): Promise<void> {\n        return this.internals.worker.remove(\n            this.internals.instanceId\n        );\n    }\n}\n\n\nexport class RxStorageKeyObjectInstanceWorker implements RxStorageKeyObjectInstance<WorkerStorageInternals, any> {\n\n    /**\n     * threads.js uses observable-fns instead of rxjs\n     * so we have to transform it.\n     */\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxLocalDocumentData<{ [key: string]: any; }>>>> = new Subject();\n    private subs: Subscription[] = [];\n\n    constructor(\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly internals: WorkerStorageInternals,\n        public readonly options: Readonly<any>\n    ) {\n        this.subs.push(\n            this.internals.worker.changeStream(\n                this.internals.instanceId\n            ).subscribe(ev => this.changes$.next(ev as any))\n        );\n    }\n    bulkWrite<DocumentData>(\n        documentWrites: BulkWriteLocalRow<DocumentData>[]\n    ): Promise<RxLocalStorageBulkWriteResponse<DocumentData>> {\n        return this.internals.worker.bulkWriteLocal(\n            this.internals.instanceId,\n            documentWrites\n        );\n    }\n    findLocalDocumentsById<DocumentData>(\n        ids: string[]\n    ): Promise<{ [documentId: string]: RxLocalDocumentData<DocumentData> }> {\n        return this.internals.worker.findLocalDocumentsById(\n            this.internals.instanceId,\n            ids\n        );\n    }\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxLocalDocumentData<{ [key: string]: any; }>>>> {\n        return this.changes$.asObservable();\n    }\n    close(): Promise<void> {\n        this.subs.forEach(sub => sub.unsubscribe());\n        return this.internals.worker.close(\n            this.internals.instanceId\n        );\n    }\n    remove(): Promise<void> {\n        return this.internals.worker.remove(\n            this.internals.instanceId\n        );\n    }\n}\n\nexport function getRxStorageWorker(\n    statics: RxStorageStatics,\n    settings: RxStorageWorkerSettings\n): RxStorageWorker {\n    const storage = new RxStorageWorker(settings, statics);\n    return storage;\n}\n"],"file":"non-worker.js"}