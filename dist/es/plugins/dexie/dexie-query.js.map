{"version":3,"file":"dexie-query.js","names":["dexieReplaceIfStartsWithPipe","DEXIE_DOCS_TABLE_NAME","fromDexieToStorage","RxStorageDexieStatics","dexieQuery","instance","preparedQuery","internals","state","query","queryMatcher","getQueryMatcher","schema","sortComparator","getSortComparator","skip","limit","Infinity","skipPlusLimit","queryPlan","keyRange","getKeyRangeByQueryPlan","dexieDb","_options","IDBKeyRange","queryPlanFields","index","rows","transaction","dexieTable","dexieTx","tx","idbtrans","store","objectStore","length","primaryPath","indexName","map","field","join","cursorReq","openCursor","Promise","res","onsuccess","e","cursor","target","result","docData","value","push","sortFieldsSameAsIndexFields","sort","slice","documents","window","Error","bound","startKeys","endKeys","inclusiveStart","inclusiveEnd"],"sources":["../../../../src/plugins/dexie/dexie-query.ts"],"sourcesContent":["import type {\n    DexiePreparedQuery,\n    RxQueryPlan,\n    RxStorageQueryResult\n} from '../../types';\nimport {\n    dexieReplaceIfStartsWithPipe,\n    DEXIE_DOCS_TABLE_NAME,\n    fromDexieToStorage\n} from './dexie-helper';\nimport { RxStorageDexieStatics } from './rx-storage-dexie';\nimport type { RxStorageInstanceDexie } from './rx-storage-instance-dexie';\n\n\nexport function getKeyRangeByQueryPlan(\n    queryPlan: RxQueryPlan,\n    IDBKeyRange?: any\n) {\n    if (!IDBKeyRange) {\n        if (typeof window === 'undefined') {\n            throw new Error('IDBKeyRange missing');\n        } else {\n            IDBKeyRange = window.IDBKeyRange;\n        }\n    }\n\n    /**\n     * If index has only one field,\n     * we have to pass the keys directly, not the key arrays.\n     */\n    if (queryPlan.index.length === 1) {\n        return IDBKeyRange.bound(\n            queryPlan.startKeys[0],\n            queryPlan.endKeys[0],\n            queryPlan.inclusiveStart,\n            queryPlan.inclusiveEnd\n        );\n    }\n\n    return IDBKeyRange.bound(\n        queryPlan.startKeys,\n        queryPlan.endKeys,\n        queryPlan.inclusiveStart,\n        queryPlan.inclusiveEnd\n    );\n\n}\n\n\n/**\n * Runs mango queries over the Dexie.js database.\n */\nexport async function dexieQuery<RxDocType>(\n    instance: RxStorageInstanceDexie<RxDocType>,\n    preparedQuery: DexiePreparedQuery<RxDocType>\n): Promise<RxStorageQueryResult<RxDocType>> {\n    const state = await instance.internals;\n    const query = preparedQuery.query;\n    const queryMatcher = RxStorageDexieStatics.getQueryMatcher(\n        instance.schema,\n        preparedQuery\n    );\n    const sortComparator = RxStorageDexieStatics.getSortComparator(instance.schema, preparedQuery);\n\n    const skip = query.skip ? query.skip : 0;\n    const limit = query.limit ? query.limit : Infinity;\n    const skipPlusLimit = skip + limit;\n    const queryPlan = preparedQuery.queryPlan;\n\n    const keyRange = getKeyRangeByQueryPlan(\n        queryPlan,\n        (state.dexieDb as any)._options.IDBKeyRange\n    );\n\n    const queryPlanFields: string[] = queryPlan.index;\n\n    let rows: any[] = [];\n    await state.dexieDb.transaction(\n        'r',\n        state.dexieTable,\n        async (dexieTx) => {\n            /**\n             * TODO here we use the native IndexedDB transaction\n             * to get the cursor.\n             * Instead we should not leave Dexie.js API and find\n             * a way to create the cursor with Dexie.js.\n             */\n            const tx = (dexieTx as any).idbtrans;\n\n            // const nativeIndexedDB = state.dexieDb.backendDB();\n            // const trans = nativeIndexedDB.transaction([DEXIE_DOCS_TABLE_NAME], 'readonly');\n\n            const store = tx.objectStore(DEXIE_DOCS_TABLE_NAME);\n            let index: any;\n            if (\n                queryPlanFields.length === 1 &&\n                queryPlanFields[0] === instance.primaryPath\n            ) {\n                index = store;\n            } else {\n                let indexName: string;\n                if (queryPlanFields.length === 1) {\n                    indexName = dexieReplaceIfStartsWithPipe(queryPlanFields[0]);\n                } else {\n                    indexName = '[' +\n                        queryPlanFields\n                            .map(field => dexieReplaceIfStartsWithPipe(field))\n                            .join('+')\n                        + ']';\n                }\n                index = store.index(indexName);\n            }\n            const cursorReq = index.openCursor(keyRange);\n            await new Promise<void>(res => {\n                cursorReq.onsuccess = function (e: any) {\n                    const cursor = e.target.result;\n                    if (cursor) {\n                        // We have a record in cursor.value\n                        const docData = fromDexieToStorage(cursor.value);\n                        if (\n                            queryMatcher(docData)\n                        ) {\n                            rows.push(docData);\n                        }\n\n                        /**\n                         * If we do not have to manually sort\n                         * and have enough documents,\n                         * we can abort iterating over the cursor\n                         * because we already have every relevant document.\n                         */\n                        if (\n                            queryPlan.sortFieldsSameAsIndexFields &&\n                            rows.length === skipPlusLimit\n                        ) {\n                            res();\n                        } else {\n                            cursor.continue();\n                        }\n                    } else {\n                        // Iteration complete\n                        res();\n                    }\n                };\n            });\n\n\n        }\n    );\n\n\n    if (!queryPlan.sortFieldsSameAsIndexFields) {\n        rows = rows.sort(sortComparator);\n    }\n\n    // apply skip and limit boundaries.\n    rows = rows.slice(skip, skipPlusLimit);\n\n    /**\n     * Comment this in for debugging to check all fields in the database.\n     */\n    // const docsInDb = await state.dexieTable.filter(queryMatcher).toArray();\n    // let documents = docsInDb\n    //     .map(docData => stripDexieKey(docData))\n    //     .sort(sortComparator);\n    // if (preparedQuery.skip) {\n    //     documents = documents.slice(preparedQuery.skip);\n    // }\n    // if (preparedQuery.limit && documents.length > preparedQuery.limit) {\n    //     documents = documents.slice(0, preparedQuery.limit);\n    // }\n\n\n\n    return {\n        documents: rows\n    };\n}\n"],"mappings":"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"}