{"version":3,"sources":["../../../../src/plugins/dexie/dexie-helper.ts"],"names":["mingo","getPrimaryFieldOfPrimaryKey","Dexie","flatClone","getDocsInDb","internals","docIds","state","Promise","all","dexieTable","bulkGet","dexieDeletedTable","nonDeletedDocsInDb","deletedDocsInDb","docsInDb","slice","forEach","doc","idx","closeDexieDb","statePromise","prevCount","REF_COUNT_PER_DEXIE_DB","get","newCount","dexieDb","close","set","DEXIE_DOCS_TABLE_NAME","DEXIE_DELETED_DOCS_TABLE_NAME","DEXIE_CHANGES_TABLE_NAME","DEXIE_STATE_DB_BY_NAME","Map","getDexieDbWithTables","databaseName","collectionName","settings","schema","primaryPath","primaryKey","dexieDbName","useSettings","autoOpen","version","stores","getDexieStoreSchema","open","dexieChangesTable","sortDirectionToMingo","direction","getDexieSortComparator","query","mingoSortObject","wasPrimaryInSort","sort","sortBlock","key","Object","keys","values","fun","a","b","sorted","find","first","next","DEXIE_PIPE_SUBSTITUTE","dexieReplaceIfStartsWithPipe","str","startsWith","withoutFirst","substring","rxJsonSchema","parts","push","indexes","index","arIndex","Array","isArray","map","part","length","join","getDexieEventKey","isLocal","primary","revision","prefix","eventKey","stripDexieKey","docData","cloned","$lastWriteAt"],"mappings":"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","sourcesContent":["import type {\n    DeterministicSortComparator\n} from 'event-reduce-js';\nimport mingo from 'mingo';\nimport { getPrimaryFieldOfPrimaryKey } from '../../rx-schema';\nimport type {\n    DexieStorageInternals,\n    MangoQuery,\n    RxDocumentData,\n    RxJsonSchema\n} from '../../types';\nimport { Dexie } from 'dexie';\nimport { DexieSettings } from '../../types';\nimport { flatClone } from '../../util';\n\nexport const DEXIE_DOCS_TABLE_NAME = 'docs';\nexport const DEXIE_DELETED_DOCS_TABLE_NAME = 'deleted-docs';\nexport const DEXIE_CHANGES_TABLE_NAME = 'changes';\n\n\nconst DEXIE_STATE_DB_BY_NAME: Map<string, DexieStorageInternals> = new Map();\nconst REF_COUNT_PER_DEXIE_DB: Map<DexieStorageInternals, number> = new Map();\nexport function getDexieDbWithTables(\n    databaseName: string,\n    collectionName: string,\n    settings: DexieSettings,\n    schema: RxJsonSchema<any>\n): DexieStorageInternals {\n    const primaryPath: string = getPrimaryFieldOfPrimaryKey(schema.primaryKey) as any;\n    const dexieDbName = 'rxdb-dexie-' + databaseName + '--' + collectionName;\n    let state = DEXIE_STATE_DB_BY_NAME.get(dexieDbName);\n    if (!state) {\n        state = (async () => {\n            /**\n             * IndexedDB was not designed for dynamically adding tables on the fly,\n             * so we create one dexie database per RxDB storage instance.\n             * @link https://github.com/dexie/Dexie.js/issues/684#issuecomment-373224696\n             */\n            const useSettings = flatClone(settings);\n            useSettings.autoOpen = false;\n            const dexieDb = new Dexie(dexieDbName, useSettings);\n            dexieDb.version(1).stores({\n                [DEXIE_DOCS_TABLE_NAME]: getDexieStoreSchema(schema),\n                [DEXIE_CHANGES_TABLE_NAME]: '++sequence, id',\n                /**\n                 * Instead of adding {deleted: false} to every query we run over the document store,\n                 * we move deleted documents into a separate store where they can only be queried\n                 * by primary key.\n                 * This increases performance because it is way easier for the query planner to select\n                 * a good index and we also do not have to add the _deleted field to every index.\n                 */\n                [DEXIE_DELETED_DOCS_TABLE_NAME]: primaryPath + ',$lastWriteAt'\n            });\n            await dexieDb.open();\n            return {\n                dexieDb,\n                dexieTable: (dexieDb as any)[DEXIE_DOCS_TABLE_NAME],\n                dexieDeletedTable: (dexieDb as any)[DEXIE_DELETED_DOCS_TABLE_NAME],\n                dexieChangesTable: (dexieDb as any)[DEXIE_CHANGES_TABLE_NAME]\n            };\n        })();\n\n        DEXIE_STATE_DB_BY_NAME.set(dexieDbName, state);\n        REF_COUNT_PER_DEXIE_DB.set(state, 0);\n    }\n\n    return state;\n}\n\nexport async function closeDexieDb(statePromise: DexieStorageInternals) {\n    const state = await statePromise;\n    const prevCount = REF_COUNT_PER_DEXIE_DB.get(statePromise);\n    const newCount = (prevCount as any) - 1;\n    if (newCount === 0) {\n        state.dexieDb.close();\n        REF_COUNT_PER_DEXIE_DB.delete(statePromise);\n    } else {\n        REF_COUNT_PER_DEXIE_DB.set(statePromise, newCount);\n    }\n}\n\n\nfunction sortDirectionToMingo(direction: 'asc' | 'desc'): 1 | -1 {\n    if (direction === 'asc') {\n        return 1;\n    } else {\n        return -1;\n    }\n}\n\n/**\n * This function is at dexie-helper\n * because we need it in multiple places.\n */\nexport function getDexieSortComparator<RxDocType>(\n    schema: RxJsonSchema<RxDocType>,\n    query: MangoQuery<RxDocType>\n): DeterministicSortComparator<RxDocType> {\n    const primaryKey: string = getPrimaryFieldOfPrimaryKey(schema.primaryKey) as string;\n\n    const mingoSortObject: {\n        [fieldName: string]: 1 | -1;\n    } = {};\n    let wasPrimaryInSort = false;\n    if (query.sort) {\n        query.sort.forEach(sortBlock => {\n            const key = Object.keys(sortBlock)[0];\n            if (key === primaryKey) {\n                wasPrimaryInSort = true;\n            }\n            const direction = Object.values(sortBlock)[0];\n            mingoSortObject[key] = sortDirectionToMingo(direction);\n        });\n    }\n    // TODO ensuring that the primaryKey is in the sorting, should be done by RxDB, not by the storage.\n    if (!wasPrimaryInSort) {\n        mingoSortObject[primaryKey] = 1;\n    }\n\n\n    const fun: DeterministicSortComparator<RxDocType> = (a: RxDocType, b: RxDocType) => {\n        const sorted = mingo.find([a, b], {}).sort(mingoSortObject);\n        const first = sorted.next();\n        if (first === a) {\n            return -1;\n        } else {\n            return 1;\n        }\n    }\n\n    return fun;\n}\n\n\n\n\n/**\n * It is not possible to set non-javascript-variable-syntax\n * keys as IndexedDB indexes. So we have to substitute the pipe-char\n * which comes from the key-compression plugin.\n */\nexport const DEXIE_PIPE_SUBSTITUTE = 'RxDBSubstPIPE';\nexport function dexieReplaceIfStartsWithPipe(str: string): string {\n    if (str.startsWith('|')) {\n        const withoutFirst = str.substring(1);\n        return DEXIE_PIPE_SUBSTITUTE + withoutFirst;\n    } else {\n        return str;\n    }\n}\n\n/**\n * Creates a string that can be used to create the dexie store.\n * @link https://dexie.org/docs/API-Reference#quick-reference\n */\nexport function getDexieStoreSchema(\n    rxJsonSchema: RxJsonSchema<any>\n): string {\n    let parts: string[][] = [];\n\n    /**\n     * First part must be the primary key\n     * @link https://github.com/dexie/Dexie.js/issues/1307#issuecomment-846590912\n     */\n    const primaryKey: string = getPrimaryFieldOfPrimaryKey(rxJsonSchema.primaryKey) as string;\n    parts.push([primaryKey]);\n\n    // add other indexes\n    if (rxJsonSchema.indexes) {\n        rxJsonSchema.indexes.forEach(index => {\n            const arIndex = Array.isArray(index) ? index : [index];\n            parts.push(arIndex);\n        });\n    }\n\n\n    /**\n     * It is not possible to set non-javascript-variable-syntax\n     * keys as IndexedDB indexes. So we have to substitute the pipe-char\n     * which comes from the key-compression plugin.\n     */\n    parts = parts.map(part => {\n        return part.map(str => dexieReplaceIfStartsWithPipe(str))\n    });\n\n\n\n    return parts.map(part => {\n        if (part.length === 1) {\n            return part[0];\n        } else {\n            return '[' + part.join('+') + ']';\n        }\n    }).join(', ');\n}\n\nexport function getDexieEventKey(\n    isLocal: boolean,\n    primary: string,\n    revision: string\n): string {\n    const prefix = isLocal ? 'local' : 'non-local';\n    const eventKey = prefix + '|' + primary + '|' + revision;\n    return eventKey;\n}\n\n\n/**\n * Removes all internal fields from the document data\n */\nexport function stripDexieKey<T>(docData: T & { $lastWriteAt?: number; }): T {\n    const cloned = flatClone(docData);\n    delete cloned.$lastWriteAt;\n    return cloned;\n}\n\n\n/**\n * Returns all documents in the database.\n * Non-deleted plus deleted ones.\n */\nexport async function getDocsInDb<RxDocType>(\n    internals: DexieStorageInternals,\n    docIds: string[]\n): Promise<RxDocumentData<RxDocType>[]> {\n    const state = await internals;\n    const [\n        nonDeletedDocsInDb,\n        deletedDocsInDb\n    ] = await Promise.all([\n        state.dexieTable.bulkGet(docIds),\n        state.dexieDeletedTable.bulkGet(docIds)\n    ]);\n    const docsInDb = deletedDocsInDb.slice(0);\n    nonDeletedDocsInDb.forEach((doc, idx) => {\n        if (doc) {\n            docsInDb[idx] = doc;\n        }\n    });\n    return docsInDb;\n}\n"],"file":"dexie-helper.js"}