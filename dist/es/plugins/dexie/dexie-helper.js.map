{"version":3,"file":"dexie-helper.js","names":["Dexie","flatClone","newRxError","getPrimaryFieldOfPrimaryKey","getSchemaByObjectPath","getMingoQuery","getDocsInDb","internals","docIds","state","Promise","all","dexieTable","bulkGet","dexieDeletedTable","nonDeletedDocsInDb","deletedDocsInDb","docsInDb","slice","forEach","doc","idx","closeDexieDb","statePromise","prevCount","REF_COUNT_PER_DEXIE_DB","get","newCount","dexieDb","close","set","DEXIE_DOCS_TABLE_NAME","DEXIE_DELETED_DOCS_TABLE_NAME","DEXIE_CHANGES_TABLE_NAME","RX_STORAGE_NAME_DEXIE","DEXIE_STATE_DB_BY_NAME","Map","getDexieDbWithTables","databaseName","collectionName","settings","schema","primaryPath","primaryKey","dexieDbName","version","useSettings","autoOpen","dexieStoresSettings","getDexieStoreSchema","stores","open","sortDirectionToMingo","direction","getDexieSortComparator","_schema","query","mingoSortObject","sort","sortBlock","key","Object","keys","values","fun","a","b","sorted","find","first","next","ensureNoBooleanIndex","indexes","checkedFields","Set","index","fields","Array","isArray","field","has","add","schemaObj","type","DEXIE_PIPE_SUBSTITUTE","dexieReplaceIfStartsWithPipe","str","split","length","map","part","join","startsWith","withoutFirst","substring","dexieReplaceIfStartsWithPipeRevert","fromStorageToDexie","documentData","row","ret","entries","value","fromDexieToStorage","rxJsonSchema","parts","push","arIndex"],"sources":["../../../../src/plugins/dexie/dexie-helper.ts"],"sourcesContent":["import type {\n    DeterministicSortComparator\n} from 'event-reduce-js';\nimport type {\n    DexieStorageInternals,\n    MangoQuery,\n    RxDocumentData,\n    RxJsonSchema\n} from '../../types';\nimport { Dexie } from 'dexie';\nimport { DexieSettings } from '../../types';\nimport { flatClone } from '../../util';\nimport { newRxError } from '../../rx-error';\nimport {\n    getPrimaryFieldOfPrimaryKey,\n    getSchemaByObjectPath\n} from '../../rx-schema-helper';\nimport { getMingoQuery } from '../../rx-query-mingo';\n\nexport const DEXIE_DOCS_TABLE_NAME = 'docs';\nexport const DEXIE_DELETED_DOCS_TABLE_NAME = 'deleted-docs';\nexport const DEXIE_CHANGES_TABLE_NAME = 'changes';\n\nexport const RX_STORAGE_NAME_DEXIE = 'dexie';\n\nconst DEXIE_STATE_DB_BY_NAME: Map<string, DexieStorageInternals> = new Map();\nconst REF_COUNT_PER_DEXIE_DB: Map<DexieStorageInternals, number> = new Map();\nexport function getDexieDbWithTables(\n    databaseName: string,\n    collectionName: string,\n    settings: DexieSettings,\n    schema: RxJsonSchema<any>\n): DexieStorageInternals {\n    const primaryPath = getPrimaryFieldOfPrimaryKey(schema.primaryKey);\n    const dexieDbName = 'rxdb-dexie-' + databaseName + '--' + schema.version + '--' + collectionName;\n    let state = DEXIE_STATE_DB_BY_NAME.get(dexieDbName);\n    if (!state) {\n        state = (async () => {\n            /**\n             * IndexedDB was not designed for dynamically adding tables on the fly,\n             * so we create one dexie database per RxDB storage instance.\n             * @link https://github.com/dexie/Dexie.js/issues/684#issuecomment-373224696\n             */\n            const useSettings = flatClone(settings);\n            useSettings.autoOpen = false;\n            const dexieDb = new Dexie(dexieDbName, useSettings);\n            const dexieStoresSettings = {\n                [DEXIE_DOCS_TABLE_NAME]: getDexieStoreSchema(schema),\n                [DEXIE_CHANGES_TABLE_NAME]: '++sequence, id',\n                /**\n                 * Instead of adding {deleted: false} to every query we run over the document store,\n                 * we move deleted documents into a separate store where they can only be queried\n                 * by primary key.\n                 * This increases performance because it is way easier for the query planner to select\n                 * a good index and we also do not have to add the _deleted field to every index.\n                 *\n                 * We also need the [_meta.lwt+' + primaryPath + '] index for getChangedDocumentsSince()\n                 */\n                [DEXIE_DELETED_DOCS_TABLE_NAME]: primaryPath + ',_meta.lwt,[_meta.lwt+' + primaryPath + ']'\n            };\n\n            dexieDb.version(1).stores(dexieStoresSettings);\n            await dexieDb.open();\n            return {\n                dexieDb,\n                dexieTable: (dexieDb as any)[DEXIE_DOCS_TABLE_NAME],\n                dexieDeletedTable: (dexieDb as any)[DEXIE_DELETED_DOCS_TABLE_NAME]\n            };\n        })();\n\n        DEXIE_STATE_DB_BY_NAME.set(dexieDbName, state);\n        REF_COUNT_PER_DEXIE_DB.set(state, 0);\n    }\n\n    return state;\n}\n\nexport async function closeDexieDb(statePromise: DexieStorageInternals) {\n    const state = await statePromise;\n    const prevCount = REF_COUNT_PER_DEXIE_DB.get(statePromise);\n    const newCount = (prevCount as any) - 1;\n    if (newCount === 0) {\n        state.dexieDb.close();\n        REF_COUNT_PER_DEXIE_DB.delete(statePromise);\n    } else {\n        REF_COUNT_PER_DEXIE_DB.set(statePromise, newCount);\n    }\n}\n\n\nfunction sortDirectionToMingo(direction: 'asc' | 'desc'): 1 | -1 {\n    if (direction === 'asc') {\n        return 1;\n    } else {\n        return -1;\n    }\n}\n\n/**\n * This function is at dexie-helper\n * because we need it in multiple places.\n */\nexport function getDexieSortComparator<RxDocType>(\n    _schema: RxJsonSchema<RxDocumentData<RxDocType>>,\n    query: MangoQuery<RxDocType>\n): DeterministicSortComparator<RxDocType> {\n    const mingoSortObject: {\n        [fieldName: string]: 1 | -1;\n    } = {};\n\n    if (!query.sort) {\n        throw newRxError('SNH', { query });\n    }\n\n    query.sort.forEach(sortBlock => {\n        const key = Object.keys(sortBlock)[0];\n        const direction = Object.values(sortBlock)[0];\n        mingoSortObject[key] = sortDirectionToMingo(direction);\n    });\n\n    const fun: DeterministicSortComparator<RxDocType> = (a: RxDocType, b: RxDocType) => {\n        const sorted = getMingoQuery({}).find([a, b], {}).sort(mingoSortObject);\n        const first = sorted.next();\n        if (first === a) {\n            return -1;\n        } else {\n            return 1;\n        }\n    };\n\n    return fun;\n}\n\n\nexport function ensureNoBooleanIndex(schema: RxJsonSchema<any>) {\n    if (!schema.indexes) {\n        return;\n    }\n    const checkedFields = new Set<string>();\n    schema.indexes.forEach(index => {\n        const fields = Array.isArray(index) ? index : [];\n        fields.forEach(field => {\n            if (checkedFields.has(field)) {\n                return;\n            }\n            checkedFields.add(field);\n            const schemaObj = getSchemaByObjectPath(schema, field);\n            if (schemaObj.type === 'boolean') {\n                throw newRxError('DXE1', {\n                    schema,\n                    index,\n                    field\n                });\n            }\n        });\n    });\n}\n\n\n\n/**\n * It is not possible to set non-javascript-variable-syntax\n * keys as IndexedDB indexes. So we have to substitute the pipe-char\n * which comes from the key-compression plugin.\n */\nexport const DEXIE_PIPE_SUBSTITUTE = '__';\nexport function dexieReplaceIfStartsWithPipe(str: string): string {\n    const split = str.split('.');\n    if (split.length > 1) {\n        return split.map(part => dexieReplaceIfStartsWithPipe(part)).join('.');\n    }\n\n    if (str.startsWith('|')) {\n        const withoutFirst = str.substring(1);\n        return DEXIE_PIPE_SUBSTITUTE + withoutFirst;\n    } else {\n        return str;\n    }\n}\n\nexport function dexieReplaceIfStartsWithPipeRevert(str: string): string {\n    const split = str.split('.');\n    if (split.length > 1) {\n        return split.map(part => dexieReplaceIfStartsWithPipeRevert(part)).join('.');\n    }\n\n    if (str.startsWith(DEXIE_PIPE_SUBSTITUTE)) {\n        const withoutFirst = str.substring(DEXIE_PIPE_SUBSTITUTE.length);\n        return '|' + withoutFirst;\n    } else {\n        return str;\n    }\n}\n\n/**\n * @recursive\n */\nexport function fromStorageToDexie(documentData: RxDocumentData<any>): any {\n    if (!documentData || typeof documentData === 'string' || typeof documentData === 'number' || typeof documentData === 'boolean') {\n        return documentData;\n    } else if (Array.isArray(documentData)) {\n        return documentData.map(row => fromStorageToDexie(row));\n    } else if (typeof documentData === 'object') {\n        const ret: any = {};\n        Object.entries(documentData).forEach(([key, value]) => {\n            if (typeof value === 'object') {\n                value = fromStorageToDexie(value);\n            }\n            ret[dexieReplaceIfStartsWithPipe(key)] = value;\n        });\n        return ret;\n    }\n}\n\nexport function fromDexieToStorage(documentData: any): RxDocumentData<any> {\n    if (!documentData || typeof documentData === 'string' || typeof documentData === 'number' || typeof documentData === 'boolean') {\n        return documentData;\n    } else if (Array.isArray(documentData)) {\n        return documentData.map(row => fromDexieToStorage(row));\n    } else if (typeof documentData === 'object') {\n        const ret: any = {};\n        Object.entries(documentData).forEach(([key, value]) => {\n            if (typeof value === 'object' || Array.isArray(documentData)) {\n                value = fromDexieToStorage(value);\n            }\n            ret[dexieReplaceIfStartsWithPipeRevert(key)] = value;\n        });\n        return ret;\n    }\n}\n\n\n/**\n * Creates a string that can be used to create the dexie store.\n * @link https://dexie.org/docs/API-Reference#quick-reference\n */\nexport function getDexieStoreSchema(\n    rxJsonSchema: RxJsonSchema<any>\n): string {\n    let parts: string[][] = [];\n\n    /**\n     * First part must be the primary key\n     * @link https://github.com/dexie/Dexie.js/issues/1307#issuecomment-846590912\n     */\n    const primaryKey = getPrimaryFieldOfPrimaryKey(rxJsonSchema.primaryKey);\n    parts.push([primaryKey]);\n\n    // add other indexes\n    if (rxJsonSchema.indexes) {\n        rxJsonSchema.indexes.forEach(index => {\n            const arIndex = Array.isArray(index) ? index : [index];\n            parts.push(arIndex);\n        });\n    }\n\n    // we also need the _meta.lwt+primaryKey index for the getChangedDocumentsSince() method.\n    parts.push(['_meta.lwt', primaryKey]);\n\n    /**\n     * It is not possible to set non-javascript-variable-syntax\n     * keys as IndexedDB indexes. So we have to substitute the pipe-char\n     * which comes from the key-compression plugin.\n     */\n    parts = parts.map(part => {\n        return part.map(str => dexieReplaceIfStartsWithPipe(str));\n    });\n\n    return parts.map(part => {\n        if (part.length === 1) {\n            return part[0];\n        } else {\n            return '[' + part.join('+') + ']';\n        }\n    }).join(', ');\n}\n\n/**\n * Returns all documents in the database.\n * Non-deleted plus deleted ones.\n */\nexport async function getDocsInDb<RxDocType>(\n    internals: DexieStorageInternals,\n    docIds: string[]\n): Promise<RxDocumentData<RxDocType>[]> {\n    const state = await internals;\n    const [\n        nonDeletedDocsInDb,\n        deletedDocsInDb\n    ] = await Promise.all([\n        state.dexieTable.bulkGet(docIds),\n        state.dexieDeletedTable.bulkGet(docIds)\n    ]);\n    const docsInDb = deletedDocsInDb.slice(0);\n    nonDeletedDocsInDb.forEach((doc, idx) => {\n        if (doc) {\n            docsInDb[idx] = doc;\n        }\n    });\n    return docsInDb;\n}\n"],"mappings":"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"}