{"version":3,"file":"local-documents-helper.js","names":["filter","DocCache","newRxError","fillWithDefaultSettings","getWrappedStorageInstance","storageChangeEventToRxChangeEvent","randomCouchString","removeLocalDocumentsStorageInstance","storage","databaseName","collectionName","databaseInstanceToken","createLocalDocumentStorageInstance","storageInstance","remove","LOCAL_DOC_STATE_BY_PARENT","WeakMap","createLocalDocStateByParent","parent","database","name","statePromise","token","instanceCreationOptions","multiInstance","RX_LOCAL_DOCUMENT_SCHEMA","docCache","sub","$","pipe","cE","isLocal","subscribe","doc","get","documentId","_handleChangeEvent","_subs","push","storageToken","databaseStorageToken","subLocalDocs","changeStream","eventBulk","changeEventBulk","id","internal","undefined","events","map","ev","databaseToken","checkpoint","context","$emit","set","getLocalDocStateByParent","collection","createStorageInstance","getCollectionLocalInstanceName","schema","options","closeStateByParent","then","state","close","title","version","primaryKey","type","properties","maxLength","data","additionalProperties","required"],"sources":["../../../../src/plugins/local-documents/local-documents-helper.ts"],"sourcesContent":["import { filter } from 'rxjs/operators';\nimport { DocCache } from '../../doc-cache';\nimport { newRxError } from '../../rx-error';\nimport { fillWithDefaultSettings } from '../../rx-schema-helper';\nimport {\n    getWrappedStorageInstance,\n    storageChangeEventToRxChangeEvent\n} from '../../rx-storage-helper';\nimport type {\n    LocalDocumentParent,\n    LocalDocumentState,\n    RxChangeEvent,\n    RxChangeEventBulk,\n    RxDatabase,\n    RxDocumentData,\n    RxJsonSchema,\n    RxLocalDocument,\n    RxLocalDocumentData,\n    RxStorage\n} from '../../types';\nimport { randomCouchString } from '../../util';\n\nconst LOCAL_DOC_STATE_BY_PARENT: WeakMap<LocalDocumentParent, Promise<LocalDocumentState>> = new WeakMap();\n\n\nexport function createLocalDocStateByParent(parent: LocalDocumentParent): void {\n    const database: RxDatabase = parent.database ? parent.database : parent as any;\n    const collectionName = parent.database ? parent.name : '';\n    const statePromise = (async () => {\n        let storageInstance = await createLocalDocumentStorageInstance(\n            database.token,\n            database.storage,\n            database.name,\n            collectionName,\n            database.instanceCreationOptions,\n            database.multiInstance\n        );\n        storageInstance = getWrappedStorageInstance(\n            database,\n            storageInstance,\n            RX_LOCAL_DOCUMENT_SCHEMA\n        );\n        const docCache = new DocCache<RxLocalDocument<any, any>>();\n\n        /**\n         * Update cached local documents on events.\n         */\n        const sub = parent.$\n            .pipe(\n                filter(cE => (cE as RxChangeEvent<any>).isLocal)\n            )\n            .subscribe((cE: RxChangeEvent<any>) => {\n                const doc = docCache.get(cE.documentId);\n                if (doc) {\n                    doc._handleChangeEvent(cE);\n                }\n            });\n        parent._subs.push(sub);\n\n        /**\n         * Emit the changestream into the collections change stream\n         */\n        const databaseStorageToken = await database.storageToken;\n        const subLocalDocs = storageInstance.changeStream().subscribe(eventBulk => {\n            const changeEventBulk: RxChangeEventBulk<RxLocalDocumentData> = {\n                id: eventBulk.id,\n                internal: false,\n                collectionName: parent.database ? parent.name : undefined,\n                storageToken: databaseStorageToken,\n                events: eventBulk.events.map(ev => storageChangeEventToRxChangeEvent(\n                    true,\n                    ev,\n                    parent.database ? parent as any : undefined\n                )),\n                databaseToken: database.token,\n                checkpoint: eventBulk.checkpoint,\n                context: eventBulk.context\n            };\n            database.$emit(changeEventBulk);\n        });\n        parent._subs.push(subLocalDocs);\n\n        return {\n            database,\n            parent,\n            storageInstance,\n            docCache\n        }\n    })();\n    LOCAL_DOC_STATE_BY_PARENT.set(parent, statePromise);\n}\n\nexport function getLocalDocStateByParent(parent: LocalDocumentParent): Promise<LocalDocumentState> {\n    const statePromise = LOCAL_DOC_STATE_BY_PARENT.get(parent);\n    if (!statePromise) {\n        const database: RxDatabase = parent.database ? parent.database : parent as any;\n        const collectionName = parent.database ? parent.name : '';\n        throw newRxError('LD8', {\n            database: database.name,\n            collection: collectionName\n        });\n    }\n    return statePromise;\n}\n\n\nexport function createLocalDocumentStorageInstance(\n    databaseInstanceToken: string,\n    storage: RxStorage<any, any>,\n    databaseName: string,\n    collectionName: string,\n    instanceCreationOptions: any,\n    multiInstance: boolean\n) {\n    return storage.createStorageInstance<RxLocalDocumentData>({\n        databaseInstanceToken,\n        databaseName: databaseName,\n        /**\n         * Use a different collection name for the local documents instance\n         * so that the local docs can be kept while deleting the normal instance\n         * after migration.\n         */\n        collectionName: getCollectionLocalInstanceName(collectionName),\n        schema: RX_LOCAL_DOCUMENT_SCHEMA,\n        options: instanceCreationOptions,\n        multiInstance\n    });\n}\n\nexport function closeStateByParent(parent: LocalDocumentParent) {\n    const statePromise = LOCAL_DOC_STATE_BY_PARENT.get(parent);\n    if (statePromise) {\n        LOCAL_DOC_STATE_BY_PARENT.delete(parent);\n        return statePromise.then(state => state.storageInstance.close());\n    }\n}\n\nexport async function removeLocalDocumentsStorageInstance(\n    storage: RxStorage<any, any>,\n    databaseName: string,\n    collectionName: string\n) {\n    const databaseInstanceToken = randomCouchString(10);\n    const storageInstance = await createLocalDocumentStorageInstance(\n        databaseInstanceToken,\n        storage,\n        databaseName,\n        collectionName,\n        {},\n        false\n    );\n    await storageInstance.remove();\n}\n\n\nexport function getCollectionLocalInstanceName(collectionName: string): string {\n    return 'plugin-local-documents-' + collectionName;\n}\n\nexport const RX_LOCAL_DOCUMENT_SCHEMA: RxJsonSchema<RxDocumentData<RxLocalDocumentData>> = fillWithDefaultSettings({\n    title: 'RxLocalDocument',\n    version: 0,\n    primaryKey: 'id',\n    type: 'object',\n    properties: {\n        id: {\n            type: 'string',\n            maxLength: 128\n        },\n        data: {\n            type: 'object',\n            additionalProperties: true\n        }\n    },\n    required: [\n        'id',\n        'data'\n    ]\n});\n"],"mappings":"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"}