{"version":3,"file":"local-documents.js","names":["flatClone","getDefaultRevision","getDefaultRxDocumentMeta","filter","map","startWith","mergeMap","createRxLocalDocument","getLocalDocStateByParent","getSingleDocument","writeSingle","getLocal","id","state","docCache","found","get","Promise","resolve","storageInstance","then","docData","doc","insertLocal","data","_deleted","_meta","_rev","_attachments","document","res","newDoc","upsertLocal","existing","docPromise","atomicUpdate","getLocal$","$","pipe","cE","changeEvent","changeEventOrDoc","isLocal","documentId","use","filterFlagged"],"sources":["../../../../src/plugins/local-documents/local-documents.ts"],"sourcesContent":["import {\n    flatClone,\n    getDefaultRevision,\n    getDefaultRxDocumentMeta\n} from '../../util';\n\nimport type {\n    RxChangeEvent,\n    RxCollection,\n    RxDatabase,\n    RxDocument,\n    RxDocumentWriteData,\n    RxLocalDocument,\n    RxLocalDocumentData\n} from '../../types';\n\nimport {\n    filter,\n    map,\n    startWith,\n    mergeMap\n} from 'rxjs/operators';\nimport { Observable } from 'rxjs';\n\nimport { createRxLocalDocument } from './rx-local-document';\nimport { getLocalDocStateByParent } from './local-documents-helper';\nimport { getSingleDocument, writeSingle } from '../../rx-storage-helper';\n\n\n\n/**\n * save the local-document-data\n * throws if already exists\n */\nexport async function insertLocal<DocData extends Record<string, any> = any>(\n    this: RxDatabase | RxCollection,\n    id: string,\n    data: DocData\n): Promise<RxLocalDocument<DocData>> {\n    const state = await getLocalDocStateByParent(this);\n\n    // create new one\n    let docData: RxDocumentWriteData<RxLocalDocumentData<DocData>> = {\n        id: id,\n        data,\n        _deleted: false,\n        _meta: getDefaultRxDocumentMeta(),\n        _rev: getDefaultRevision(),\n        _attachments: {}\n    };\n\n    return writeSingle(\n        state.storageInstance,\n        {\n            document: docData\n        },\n        'local-document-insert'\n    ).then(res => {\n        docData = flatClone(docData);\n        docData._rev = res._rev;\n        const newDoc = createRxLocalDocument(id, docData as any, this, state);\n        return newDoc as any;\n    });\n}\n\n/**\n * save the local-document-data\n * overwrites existing if exists\n */\nexport function upsertLocal<DocData extends Record<string,any> = any>(\n    this: any,\n    id: string,\n    data: DocData\n): Promise<RxLocalDocument<DocData>> {\n    return this.getLocal(id)\n        .then((existing: RxDocument) => {\n            if (!existing) {\n                // create new one\n                const docPromise = this.insertLocal(id, data);\n                return docPromise;\n            } else {\n                // update existing\n                return existing.atomicUpdate(() => {\n                    return data;\n                }).then(() => existing);\n            }\n        });\n}\n\nexport async function getLocal<DocData = any>(this: any, id: string): Promise<RxLocalDocument<DocData> | null> {\n    const state = await getLocalDocStateByParent(this);\n    const docCache = state.docCache;\n\n    // check in doc-cache\n    const found = docCache.get(id);\n    if (found) {\n        return Promise.resolve(found as any);\n    }\n\n    // if not found, check in storage instance\n    return getSingleDocument(state.storageInstance, id)\n        .then((docData) => {\n            if (!docData) {\n                return null;\n            }\n            const doc = createRxLocalDocument(id, docData, this, state);\n            return doc as any;\n        })\n        .catch(() => null);\n}\n\nexport function getLocal$<DocData = any>(this: RxCollection, id: string): Observable<RxLocalDocument<DocData> | null> {\n    return this.$.pipe(\n        startWith(null),\n        mergeMap(async (cE: RxChangeEvent<RxLocalDocumentData> | null) => {\n            if (cE) {\n                return {\n                    changeEvent: cE\n                };\n            } else {\n                const doc = await this.getLocal(id);\n                return {\n                    doc: doc\n                };\n            }\n        }),\n        mergeMap(async (changeEventOrDoc) => {\n            if (changeEventOrDoc.changeEvent) {\n                const cE = changeEventOrDoc.changeEvent;\n                if (!cE.isLocal || cE.documentId !== id) {\n                    return {\n                        use: false\n                    };\n                } else {\n                    const doc = await this.getLocal(id);\n                    return {\n                        use: true,\n                        doc: doc\n                    };\n                }\n            } else {\n                return {\n                    use: true,\n                    doc: changeEventOrDoc.doc\n                };\n            }\n        }),\n        filter(filterFlagged => filterFlagged.use),\n        map(filterFlagged => {\n            return filterFlagged.doc as any;\n        })\n    );\n}\n"],"mappings":"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"}