{"version":3,"file":"rx-local-document.js","names":["objectPath","distinctUntilChanged","map","overwritable","basePrototype","createRxDocumentConstructor","isBulkWriteConflictError","newRxError","newRxTypeError","writeSingle","clone","createRevision","flatClone","getDefaultRevision","getDefaultRxDocumentMeta","getFromObjectOrThrow","getLocalDocStateByParent","_catch","body","recover","result","e","then","RxDocumentParent","_settle","pact","state","value","s","_Pact","v","o","bind","observer","RxLocalDocumentClass","id","jsonData","parent","prototype","onFulfilled","onRejected","callback","_this","_isSettledPact","thenable","_for","test","update","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","RxLocalDocumentPrototype","isLocal","_handleChangeEvent","changeEvent","documentId","primary","operation","newData","documentData","_dataSync$","next","docCache","_isDeleted$","allAttachments$","document","primaryPath","$","asObservable","$emit","get","objPath","_data","undefined","valueObj","deepFreezeWhenDevMode","get$","includes","pipe","data","atomicUpdate","mutationFunction","Promise","res","rej","_atomicQueue","done","oldDocData","getValue","newDocData","_saveData","err","isConflict","_rev","documentInDb","atomicPatch","patch","docData","Object","entries","forEach","k","oldData","storageInstance","bulkWrite","previous","docResult","success","error","remove","writeData","_deleted","_meta","_attachments","INIT_DONE","_init","docBaseProto","props","getOwnPropertyNames","key","exists","getOwnPropertyDescriptor","desc","defineProperty","getThrowingFun","functionName","createRxLocalDocument","newDoc","__proto__","set"],"sources":["../../../../src/plugins/local-documents/rx-local-document.ts"],"sourcesContent":["import objectPath from 'object-path';\nimport { distinctUntilChanged, map } from 'rxjs/operators';\nimport { overwritable } from '../../overwritable';\nimport { basePrototype, createRxDocumentConstructor } from '../../rx-document';\nimport { isBulkWriteConflictError, newRxError, newRxTypeError } from '../../rx-error';\nimport { writeSingle } from '../../rx-storage-helper';\nimport type {\n    LocalDocumentAtomicUpdateFunction,\n    LocalDocumentState,\n    RxChangeEvent,\n    RxCollection,\n    RxDatabase,\n    RxDocument,\n    RxDocumentData,\n    RxDocumentWriteData,\n    RxLocalDocument,\n    RxLocalDocumentData\n} from '../../types';\nimport { clone, createRevision, flatClone, getDefaultRevision, getDefaultRxDocumentMeta, getFromObjectOrThrow } from '../../util';\nimport { getLocalDocStateByParent } from './local-documents-helper';\n\nconst RxDocumentParent = createRxDocumentConstructor() as any;\n\nclass RxLocalDocumentClass<DocData = any> extends RxDocumentParent {\n    constructor(\n        public readonly id: string,\n        jsonData: DocData,\n        public readonly parent: RxCollection | RxDatabase,\n        public readonly state: LocalDocumentState\n    ) {\n        super(null, jsonData);\n    }\n}\n\n\n\nconst RxLocalDocumentPrototype: any = {\n    get isLocal() {\n        return true;\n    },\n\n    //\n    // overwrites\n    //\n\n    _handleChangeEvent(\n        this: any,\n        changeEvent: RxChangeEvent<RxLocalDocumentData>\n    ) {\n        if (changeEvent.documentId !== this.primary) {\n            return;\n        }\n        switch (changeEvent.operation) {\n            case 'UPDATE':\n                const newData = changeEvent.documentData;\n                this._dataSync$.next(newData);\n                break;\n            case 'DELETE':\n                // remove from docCache to assure new upserted RxDocuments will be a new instance\n                const docCache = this.state.docCache;\n                docCache.delete(this.primary);\n                this._isDeleted$.next(true);\n                break;\n        }\n    },\n\n    get allAttachments$() {\n        // this is overwritten here because we cannot re-set getters on the prototype\n        throw newRxError('LD1', {\n            document: this\n        });\n    },\n    get primaryPath() {\n        return 'id';\n    },\n    get primary() {\n        return this.id;\n    },\n    get $() {\n        return (this as RxDocument)._dataSync$.asObservable();\n    },\n    $emit(this: any, changeEvent: RxChangeEvent<RxLocalDocumentData>) {\n        return this.parent.$emit(changeEvent);\n    },\n    get(this: RxDocument, objPath: string) {\n        objPath = 'data.' + objPath;\n\n        if (!this._data) {\n            return undefined;\n        }\n        if (typeof objPath !== 'string') {\n            throw newRxTypeError('LD2', {\n                objPath\n            });\n        }\n\n        let valueObj = objectPath.get(this._data, objPath);\n        valueObj = overwritable.deepFreezeWhenDevMode(valueObj);\n        return valueObj;\n    },\n    get$(this: RxDocument, objPath: string) {\n        objPath = 'data.' + objPath;\n\n        if (objPath.includes('.item.')) {\n            throw newRxError('LD3', {\n                objPath\n            });\n        }\n        if (objPath === this.primaryPath) {\n            throw newRxError('LD4');\n        }\n\n        return this._dataSync$\n            .pipe(\n                map(data => objectPath.get(data, objPath)),\n                distinctUntilChanged()\n            );\n    },\n    atomicUpdate(mutationFunction: LocalDocumentAtomicUpdateFunction<any>) {\n        return new Promise((res, rej) => {\n            this._atomicQueue = this._atomicQueue\n                .then(async () => {\n                    let done = false;\n                    // we need a hacky while loop to stay incide the chain-link of _atomicQueue\n                    // while still having the option to run a retry on conflicts\n                    while (!done) {\n                        const oldDocData = this._dataSync$.getValue();\n                        const newData = await mutationFunction(clone(oldDocData.data), this);\n                        try {\n                            // always await because mutationFunction might be async\n\n                            const newDocData = flatClone(oldDocData);\n                            newDocData.data = newData;\n\n                            await this._saveData(newDocData, oldDocData);\n                            done = true;\n                        } catch (err) {\n                            /**\n                             * conflicts cannot happen by just using RxDB in one process\n                             * There are two ways they still can appear which is\n                             * replication and multi-tab usage\n                             * Because atomicUpdate has a mutation function,\n                             * we can just re-run the mutation until there is no conflict\n                             */\n                            const isConflict = isBulkWriteConflictError(err as any);\n                            if (isConflict) {\n                                // conflict error -> retrying\n                                newData._rev = createRevision(newData, isConflict.documentInDb);\n                            } else {\n                                rej(err);\n                                return;\n                            }\n                        }\n                    }\n                    res(this);\n                });\n        });\n    },\n    atomicPatch(patch: Partial<any>) {\n        return this.atomicUpdate((docData: any) => {\n            Object\n                .entries(patch)\n                .forEach(([k, v]) => {\n                    docData[k] = v;\n                });\n            return docData;\n        });\n    },\n    async _saveData(this: RxLocalDocument<any>, newData: RxDocumentData<RxLocalDocumentData>) {\n        const state = await getLocalDocStateByParent(this.parent);\n        const oldData: RxDocumentData<RxLocalDocumentData> = this._dataSync$.getValue() as any;\n        newData.id = (this as any).id;\n        newData._rev = createRevision(newData, oldData);\n        return state.storageInstance.bulkWrite([{\n            previous: oldData,\n            document: newData\n        }], 'local-document-save-data')\n            .then((res) => {\n                const docResult = res.success[newData.id];\n                if (!docResult) {\n                    throw getFromObjectOrThrow(res.error, newData.id);\n                }\n                newData = flatClone(newData);\n                newData._rev = docResult._rev;\n            });\n    },\n\n    async remove(this: any): Promise<void> {\n        const state = await getLocalDocStateByParent(this.parent);\n        const writeData: RxDocumentWriteData<RxLocalDocumentData> = {\n            id: this.id,\n            data: {},\n            _deleted: true,\n            _meta: getDefaultRxDocumentMeta(),\n            _rev: getDefaultRevision(),\n            _attachments: {}\n        };\n        writeData._rev = createRevision(writeData, this._data);\n        return writeSingle(state.storageInstance, {\n            previous: this._data,\n            document: writeData\n        }, 'local-document-remove')\n            .then(() => {\n                this.state.docCache.delete(this.id);\n            });\n    }\n};\n\n\n\nlet INIT_DONE = false;\nconst _init = () => {\n    if (INIT_DONE) return;\n    else INIT_DONE = true;\n\n    // add functions of RxDocument\n    const docBaseProto = basePrototype;\n    const props = Object.getOwnPropertyNames(docBaseProto);\n    props.forEach(key => {\n        const exists = Object.getOwnPropertyDescriptor(RxLocalDocumentPrototype, key);\n        if (exists) return;\n        const desc: any = Object.getOwnPropertyDescriptor(docBaseProto, key);\n        Object.defineProperty(RxLocalDocumentPrototype, key, desc);\n    });\n\n\n    /**\n     * Overwrite things that do not work on local documents\n     * with a throwing function.\n     */\n    const getThrowingFun = (k: string) => () => {\n        throw newRxError('LD6', {\n            functionName: k\n        });\n    };\n    [\n        'populate',\n        'update',\n        'putAttachment',\n        'getAttachment',\n        'allAttachments'\n    ].forEach((k: string) => RxLocalDocumentPrototype[k] = getThrowingFun(k));\n};\n\n\n\nexport function createRxLocalDocument<DocData>(\n    id: string,\n    data: RxDocumentData<RxLocalDocumentData<DocData>>,\n    parent: any,\n    state: LocalDocumentState\n): RxLocalDocument<DocData> {\n    _init();\n    const newDoc = new RxLocalDocumentClass(id, data, parent, state);\n    newDoc.__proto__ = RxLocalDocumentPrototype;\n    state.docCache.set(id, newDoc as any);\n    return newDoc as any;\n}\n"],"mappings":"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"}