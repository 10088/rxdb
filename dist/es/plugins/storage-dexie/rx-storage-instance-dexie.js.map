{"version":3,"file":"rx-storage-instance-dexie.js","names":["Subject","now","PROMISE_RESOLVE_VOID","RX_META_LWT_MINIMUM","sortDocumentsByLastWriteTime","lastOfArray","ensureNotFalsy","closeDexieDb","fromDexieToStorage","fromStorageToDexie","getDexieDbWithTables","getDocsInDb","RX_STORAGE_NAME_DEXIE","dexieCount","dexieQuery","getPrimaryFieldOfPrimaryKey","categorizeBulkWriteRows","getNewestOfDocumentStates","addRxStorageMultiInstanceSupport","newRxError","instanceId","RxStorageInstanceDexie","storage","databaseName","collectionName","schema","internals","options","settings","changes$","closed","primaryPath","primaryKey","bulkWrite","documentWrites","context","ensureNotClosed","forEach","row","document","_rev","previous","args","state","ret","success","error","documentKeys","map","writeRow","categorized","dexieDb","transaction","dexieTable","dexieDeletedTable","docsInDbMap","Map","docsInDbWithInternals","docWithDexieInternals","doc","set","errors","bulkPutDocs","bulkRemoveDocs","bulkPutDeletedDocs","bulkRemoveDeletedDocs","bulkInsertDocs","docId","push","bulkUpdateDocs","_deleted","Promise","all","length","bulkPut","d","bulkDelete","eventBulk","events","lastState","Object","values","checkpoint","id","lwt","_meta","endTime","event","next","findDocumentsById","ids","deleted","docsInDb","bulkGet","idx","documentInDb","query","preparedQuery","count","result","mode","getChangedDocumentsSince","limit","sinceLwt","sinceId","table","where","above","toArray","changedDocuments","changedDocsNormal","changedDocsDeleted","changedDocs","concat","slice","lastDoc","documents","remove","clear","close","changeStream","asObservable","cleanup","minimumDeletedTime","maxDeletionTime","below","toRemove","removeIds","getAttachmentData","_documentId","_attachmentId","Error","complete","conflictResultionTasks","resolveConflictResultionTask","_taskSolution","createDexieStorageInstance","params","instance","resolve"],"sources":["../../../../src/plugins/storage-dexie/rx-storage-instance-dexie.ts"],"sourcesContent":["import {\n    Subject,\n    Observable\n} from 'rxjs';\nimport {\n    now,\n    PROMISE_RESOLVE_VOID,\n    RX_META_LWT_MINIMUM,\n    sortDocumentsByLastWriteTime,\n    lastOfArray,\n    ensureNotFalsy\n} from '../utils';\nimport type {\n    RxStorageInstance,\n    RxStorageChangeEvent,\n    RxDocumentData,\n    BulkWriteRow,\n    RxStorageBulkWriteResponse,\n    RxStorageQueryResult,\n    RxJsonSchema,\n    RxStorageInstanceCreationParams,\n    EventBulk,\n    StringKeys,\n    RxDocumentDataById,\n    RxConflictResultionTask,\n    RxConflictResultionTaskSolution,\n    RxStorageDefaultCheckpoint,\n    CategorizeBulkWriteRowsOutput,\n    RxStorageCountResult\n} from '../../types';\nimport {\n    DexiePreparedQuery,\n    DexieSettings,\n    DexieStorageInternals\n} from '../../types/plugins/dexie';\nimport { RxStorageDexie } from './rx-storage-dexie';\nimport {\n    closeDexieDb,\n    fromDexieToStorage,\n    fromStorageToDexie,\n    getDexieDbWithTables,\n    getDocsInDb,\n    RX_STORAGE_NAME_DEXIE\n} from './dexie-helper';\nimport { dexieCount, dexieQuery } from './dexie-query';\nimport { getPrimaryFieldOfPrimaryKey } from '../../rx-schema-helper';\nimport { categorizeBulkWriteRows, getNewestOfDocumentStates } from '../../rx-storage-helper';\nimport { addRxStorageMultiInstanceSupport } from '../../rx-storage-multiinstance';\nimport { newRxError } from '../../rx-error';\n\nlet instanceId = now();\n\nexport class RxStorageInstanceDexie<RxDocType> implements RxStorageInstance<\n    RxDocType,\n    DexieStorageInternals,\n    DexieSettings,\n    RxStorageDefaultCheckpoint\n> {\n    public readonly primaryPath: StringKeys<RxDocumentData<RxDocType>>;\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, RxStorageDefaultCheckpoint>> = new Subject();\n    public readonly instanceId = instanceId++;\n    public closed = false;\n\n    constructor(\n        public readonly storage: RxStorageDexie,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<RxDocumentData<RxDocType>>>,\n        public readonly internals: DexieStorageInternals,\n        public readonly options: Readonly<DexieSettings>,\n        public readonly settings: DexieSettings\n    ) {\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\n    }\n\n    async bulkWrite(\n        documentWrites: BulkWriteRow<RxDocType>[],\n        context: string\n    ): Promise<RxStorageBulkWriteResponse<RxDocType>> {\n        ensureNotClosed(this);\n\n\n        /**\n         * Check some assumptions to ensure RxDB\n         * does not call the storage with an invalid write.\n         */\n        documentWrites.forEach(row => {\n            // ensure revision is set\n            if (\n                !row.document._rev ||\n                (\n                    row.previous &&\n                    !row.previous._rev\n                )\n            ) {\n                throw newRxError('SNH', { args: { row } });\n            }\n        });\n\n\n\n        const state = await this.internals;\n        const ret: RxStorageBulkWriteResponse<RxDocType> = {\n            success: {},\n            error: {}\n        };\n\n        const documentKeys: string[] = documentWrites.map(writeRow => writeRow.document[this.primaryPath] as any);\n        let categorized: CategorizeBulkWriteRowsOutput<RxDocType> | undefined = null as any;\n        await state.dexieDb.transaction(\n            'rw',\n            state.dexieTable,\n            state.dexieDeletedTable,\n            async () => {\n                const docsInDbMap = new Map<string, RxDocumentData<RxDocType>>();\n                const docsInDbWithInternals = await getDocsInDb<RxDocType>(this.internals, documentKeys);\n                docsInDbWithInternals.forEach(docWithDexieInternals => {\n                    const doc = docWithDexieInternals ? fromDexieToStorage(docWithDexieInternals) : docWithDexieInternals;\n                    if (doc) {\n                        docsInDbMap.set(doc[this.primaryPath], doc);\n                    }\n                    return doc;\n                });\n\n                categorized = categorizeBulkWriteRows<RxDocType>(\n                    this,\n                    this.primaryPath as any,\n                    docsInDbMap,\n                    documentWrites,\n                    context\n                );\n                ret.error = categorized.errors;\n\n                /**\n                 * Batch up the database operations\n                 * so we can later run them in bulk.\n                 */\n                const bulkPutDocs: any[] = [];\n                const bulkRemoveDocs: string[] = [];\n                const bulkPutDeletedDocs: any[] = [];\n                const bulkRemoveDeletedDocs: string[] = [];\n\n                categorized.bulkInsertDocs.forEach(row => {\n                    const docId: string = (row.document as any)[this.primaryPath];\n                    ret.success[docId] = row.document as any;\n                    bulkPutDocs.push(row.document);\n                });\n                categorized.bulkUpdateDocs.forEach(row => {\n                    const docId: string = (row.document as any)[this.primaryPath];\n                    ret.success[docId] = row.document as any;\n                    if (\n                        row.document._deleted &&\n                        (row.previous && !row.previous._deleted)\n                    ) {\n                        // newly deleted\n                        bulkRemoveDocs.push(docId);\n                        bulkPutDeletedDocs.push(row.document);\n                    } else if (\n                        row.document._deleted &&\n                        row.previous && row.previous._deleted\n                    ) {\n                        // deleted was modified but is still deleted\n                        bulkPutDeletedDocs.push(row.document);\n                    } else if (!row.document._deleted) {\n                        // non-deleted was changed\n                        bulkPutDocs.push(row.document);\n                    } else {\n                        throw newRxError('SNH', { args: { row } });\n                    }\n                });\n\n                await Promise.all([\n                    bulkPutDocs.length > 0 ? state.dexieTable.bulkPut(bulkPutDocs.map(d => fromStorageToDexie(d))) : PROMISE_RESOLVE_VOID,\n                    bulkRemoveDocs.length > 0 ? state.dexieTable.bulkDelete(bulkRemoveDocs) : PROMISE_RESOLVE_VOID,\n                    bulkPutDeletedDocs.length > 0 ? state.dexieDeletedTable.bulkPut(bulkPutDeletedDocs.map(d => fromStorageToDexie(d))) : PROMISE_RESOLVE_VOID,\n                    bulkRemoveDeletedDocs.length > 0 ? state.dexieDeletedTable.bulkDelete(bulkRemoveDeletedDocs) : PROMISE_RESOLVE_VOID\n                ]);\n            });\n\n        if (ensureNotFalsy(categorized).eventBulk.events.length > 0) {\n            const lastState = getNewestOfDocumentStates(\n                this.primaryPath as any,\n                Object.values(ret.success)\n            );\n            ensureNotFalsy(categorized).eventBulk.checkpoint = {\n                id: lastState[this.primaryPath],\n                lwt: lastState._meta.lwt\n            };\n            const endTime = now();\n            ensureNotFalsy(categorized).eventBulk.events.forEach(event => (event as any).endTime = endTime);\n            this.changes$.next(ensureNotFalsy(categorized).eventBulk);\n        }\n\n        return ret;\n    }\n\n    async findDocumentsById(\n        ids: string[],\n        deleted: boolean\n    ): Promise<RxDocumentDataById<RxDocType>> {\n        ensureNotClosed(this);\n        const state = await this.internals;\n        const ret: RxDocumentDataById<RxDocType> = {};\n\n        await state.dexieDb.transaction(\n            'r',\n            state.dexieTable,\n            state.dexieDeletedTable,\n            async () => {\n                let docsInDb: RxDocumentData<RxDocType>[];\n                if (deleted) {\n                    docsInDb = await getDocsInDb<RxDocType>(this.internals, ids);\n                } else {\n                    docsInDb = await state.dexieTable.bulkGet(ids);\n                }\n                ids.forEach((id, idx) => {\n                    const documentInDb = docsInDb[idx];\n                    if (\n                        documentInDb &&\n                        (!documentInDb._deleted || deleted)\n                    ) {\n                        ret[id] = fromDexieToStorage(documentInDb);\n                    }\n                });\n            });\n        return ret;\n    }\n\n    query(preparedQuery: DexiePreparedQuery<RxDocType>): Promise<RxStorageQueryResult<RxDocType>> {\n        ensureNotClosed(this);\n        return dexieQuery(\n            this,\n            preparedQuery\n        );\n    }\n    async count(\n        preparedQuery: DexiePreparedQuery<RxDocType>\n    ): Promise<RxStorageCountResult> {\n        const result = await dexieCount(this, preparedQuery);\n        return {\n            count: result,\n            mode: 'fast'\n        };\n    }\n\n    async getChangedDocumentsSince(\n        limit: number,\n        checkpoint?: RxStorageDefaultCheckpoint\n    ): Promise<{\n        documents: RxDocumentData<RxDocType>[];\n        checkpoint: RxStorageDefaultCheckpoint;\n    }> {\n        ensureNotClosed(this);\n        const sinceLwt = checkpoint ? checkpoint.lwt : RX_META_LWT_MINIMUM;\n        const sinceId = checkpoint ? checkpoint.id : '';\n        const state = await this.internals;\n\n\n        const [changedDocsNormal, changedDocsDeleted] = await Promise.all(\n            [\n                state.dexieTable,\n                state.dexieDeletedTable\n            ].map(async (table) => {\n                const query = table\n                    .where('[_meta.lwt+' + this.primaryPath + ']')\n                    .above([sinceLwt, sinceId])\n                    .limit(limit);\n                const changedDocuments: RxDocumentData<RxDocType>[] = await query.toArray();\n                return changedDocuments.map(d => fromDexieToStorage(d));\n            })\n        );\n        let changedDocs = changedDocsNormal.concat(changedDocsDeleted);\n\n        changedDocs = sortDocumentsByLastWriteTime(this.primaryPath as any, changedDocs);\n        changedDocs = changedDocs.slice(0, limit);\n\n        const lastDoc = lastOfArray(changedDocs);\n        return {\n            documents: changedDocs,\n            checkpoint: lastDoc ? {\n                id: lastDoc[this.primaryPath] as any,\n                lwt: lastDoc._meta.lwt\n            } : checkpoint ? checkpoint : {\n                id: '',\n                lwt: 0\n            }\n        };\n    }\n\n    async remove(): Promise<void> {\n        ensureNotClosed(this);\n        const state = await this.internals;\n        await Promise.all([\n            state.dexieDeletedTable.clear(),\n            state.dexieTable.clear()\n        ]);\n        return this.close();\n    }\n\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, RxStorageDefaultCheckpoint>> {\n        ensureNotClosed(this);\n        return this.changes$.asObservable();\n    }\n\n    async cleanup(minimumDeletedTime: number): Promise<boolean> {\n        ensureNotClosed(this);\n        const state = await this.internals;\n        await state.dexieDb.transaction(\n            'rw',\n            state.dexieDeletedTable,\n            async () => {\n                const maxDeletionTime = now() - minimumDeletedTime;\n                const toRemove = await state.dexieDeletedTable\n                    .where('_meta.lwt')\n                    .below(maxDeletionTime)\n                    .toArray();\n                const removeIds: string[] = toRemove.map(doc => doc[this.primaryPath]);\n                await state.dexieDeletedTable.bulkDelete(removeIds);\n            }\n        );\n\n        /**\n         * TODO instead of deleting all deleted docs at once,\n         * only clean up some of them and return false if there are more documents to clean up.\n         * This ensures that when many documents have to be purged,\n         * we do not block the more important tasks too long.\n         */\n        return true;\n    }\n\n    getAttachmentData(_documentId: string, _attachmentId: string): Promise<string> {\n        ensureNotClosed(this);\n        throw new Error('Attachments are not implemented in the dexie RxStorage. Make a pull request.');\n    }\n\n    close(): Promise<void> {\n        ensureNotClosed(this);\n        this.closed = true;\n        this.changes$.complete();\n        closeDexieDb(this.internals);\n        return PROMISE_RESOLVE_VOID;\n    }\n\n    conflictResultionTasks(): Observable<RxConflictResultionTask<RxDocType>> {\n        return new Subject();\n    }\n    async resolveConflictResultionTask(_taskSolution: RxConflictResultionTaskSolution<RxDocType>): Promise<void> { }\n\n}\n\n\nexport function createDexieStorageInstance<RxDocType>(\n    storage: RxStorageDexie,\n    params: RxStorageInstanceCreationParams<RxDocType, DexieSettings>,\n    settings: DexieSettings\n): Promise<RxStorageInstanceDexie<RxDocType>> {\n    const internals = getDexieDbWithTables(\n        params.databaseName,\n        params.collectionName,\n        settings,\n        params.schema\n    );\n\n    const instance = new RxStorageInstanceDexie(\n        storage,\n        params.databaseName,\n        params.collectionName,\n        params.schema,\n        internals,\n        params.options,\n        settings\n    );\n\n    addRxStorageMultiInstanceSupport(\n        RX_STORAGE_NAME_DEXIE,\n        params,\n        instance\n    );\n\n    return Promise.resolve(instance);\n}\n\n\n\nfunction ensureNotClosed(\n    instance: RxStorageInstanceDexie<any>\n) {\n    if (instance.closed) {\n        throw new Error('RxStorageInstanceDexie is closed ' + instance.databaseName + '-' + instance.collectionName);\n    }\n}\n"],"mappings":"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"}