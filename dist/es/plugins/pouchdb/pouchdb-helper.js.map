{"version":3,"file":"pouchdb-helper.js","names":["binaryMd5","blobBufferUtil","flatClone","getHeightOfRevision","newRxError","getAttachmentSize","writeAttachmentsToAttachments","attachments","ret","Promise","all","Object","entries","map","key","obj","type","args","data","dataAsBase64String","hashAttachmentData","hash","length","digest","asWrite","isBuffer","Buffer","Blob","toBase64String","RX_STORAGE_NAME_POUCHDB","OPEN_POUCHDB_STORAGE_INSTANCES","Set","OPEN_POUCH_INSTANCES","Map","openPouchId","databaseInstanceToken","databaseName","collectionName","schemaVersion","join","POUCHDB_LOCAL_PREFIX","POUCHDB_LOCAL_PREFIX_LENGTH","POUCHDB_DESIGN_PREFIX","POUCHDB_META_FIELDNAME","pouchSwapIdToPrimary","primaryKey","docData","_id","pouchSwapIdToPrimaryString","str","pouchDocumentDataToRxDocumentData","pouchDoc","useDoc","_revisions","_deleted","_attachments","forEach","value","content_type","_meta","rxDocumentDataToPouchDocumentData","doc","pouchSwapPrimaryToId","useValue","stub","idValue","pouchStripLocalFlagFromPrimary","substring","getEventKey","pouchDBInstance","primary","change","useRev","_rev","previous","eventKey","name","operation","pouchChangeRowToChangeEvent","id","revHeight","pouchChangeRowToChangeStreamEvent","pouchRow","deleted","previousDoc","ev","sequence","seq","primarySwapPouchDbQuerySelector","selector","Array","isArray","item","k","v","startsWith","pouchHash","res","attachmentBase64String","binary","atob","err","console","log","getPouchIndexDesignDocNameByIndex","index","indexName","RXDB_POUCH_DELETED_FLAG","POUCHDB_CHECKPOINT_SCHEMA","properties","required","additionalProperties"],"sources":["../../../../src/plugins/pouchdb/pouchdb-helper.ts"],"sourcesContent":["import type {\n    ChangeStreamEvent,\n    DeepReadonly,\n    JsonSchema,\n    MaybeReadonly,\n    PouchChangeRow,\n    PouchCheckpoint,\n    PouchDBInstance,\n    RxAttachmentData,\n    RxAttachmentWriteData,\n    RxDocumentData,\n    RxDocumentWriteData,\n    RxLocalDocumentData,\n    StringKeys,\n    WithAttachments\n} from '../../types';\nimport type { RxStorageInstancePouch } from './rx-storage-instance-pouch';\nimport { binaryMd5 } from 'pouchdb-md5';\nimport {\n    blobBufferUtil,\n    flatClone,\n    getHeightOfRevision\n} from '../../util';\nimport { newRxError } from '../../rx-error';\nimport type { ChangeEvent } from 'event-reduce-js';\nimport { getAttachmentSize } from '../../rx-storage-helper';\n\nexport type PouchStorageInternals = {\n    pouchInstanceId: string;\n    pouch: PouchDBInstance;\n};\n\n\nexport const RX_STORAGE_NAME_POUCHDB = 'pouchdb';\n\n/**\n * Used to check in tests if all instances have been cleaned up.\n */\nexport const OPEN_POUCHDB_STORAGE_INSTANCES: Set<RxStorageInstancePouch<any>> = new Set();\n\n/**\n * All open PouchDB instances are stored here\n * so that we can find them again when needed in the internals.\n */\nexport const OPEN_POUCH_INSTANCES: Map<string, PouchDBInstance> = new Map();\nexport function openPouchId(\n    databaseInstanceToken: string,\n    databaseName: string,\n    collectionName: string,\n    schemaVersion: number\n): string {\n    return [\n        databaseInstanceToken,\n        databaseName,\n        collectionName,\n        schemaVersion + ''\n    ].join('||');\n}\n\n\n/**\n * prefix of local pouchdb documents\n */\nexport const POUCHDB_LOCAL_PREFIX: '_local/' = '_local/';\nexport const POUCHDB_LOCAL_PREFIX_LENGTH = POUCHDB_LOCAL_PREFIX.length;\n\n/**\n * Pouchdb stores indexes as design documents,\n * we have to filter them out and not return the\n * design documents to the outside.\n */\nexport const POUCHDB_DESIGN_PREFIX: '_design/' = '_design/';\n\n\n/**\n * PouchDB does not allow to add custom properties\n * that start with lodash like RxDB's _meta field.\n * So we have to map this field into a non-lodashed field.\n */\nexport const POUCHDB_META_FIELDNAME = 'rxdbMeta';\n\nexport function pouchSwapIdToPrimary<T>(\n    primaryKey: StringKeys<RxDocumentData<T>>,\n    docData: any\n): any {\n\n    if (primaryKey === '_id' || docData[primaryKey]) {\n        return docData;\n    }\n\n    docData = flatClone(docData);\n    docData[primaryKey] = docData._id;\n    delete docData._id;\n\n    return docData;\n}\n\nexport function pouchSwapIdToPrimaryString<T>(\n    primaryKey: StringKeys<RxDocumentData<T>>,\n    str: keyof T\n): StringKeys<RxDocumentData<T>> {\n    if (str === '_id') {\n        return primaryKey;\n    } else {\n        return str as any;\n    }\n}\n\nexport function pouchDocumentDataToRxDocumentData<T>(\n    primaryKey: StringKeys<RxDocumentData<T>>,\n    pouchDoc: WithAttachments<T>\n): RxDocumentData<T> {\n    let useDoc: RxDocumentData<T> = pouchSwapIdToPrimary(primaryKey, pouchDoc);\n\n    // always flat clone because we mutate the _attachments property.\n    useDoc = flatClone(useDoc);\n    delete (useDoc as any)._revisions;\n\n    // ensure deleted flag is set.\n    useDoc._deleted = !!useDoc._deleted;\n\n    useDoc._attachments = {};\n    if (pouchDoc._attachments) {\n        Object.entries(pouchDoc._attachments).forEach(([key, value]) => {\n            if ((value as any).data) {\n                useDoc._attachments[key] = {\n                    data: (value as any).data,\n                    type: (value as any).type ? (value as any).type : (value as any).content_type\n                } as any;\n            } else {\n                useDoc._attachments[key] = {\n                    digest: value.digest,\n                    // TODO why do we need to access value.type?\n                    type: (value as any).type ? (value as any).type : value.content_type,\n                    length: value.length\n                };\n            }\n        });\n    }\n\n    useDoc._meta = (useDoc as any)[POUCHDB_META_FIELDNAME];\n    delete (useDoc as any)[POUCHDB_META_FIELDNAME];\n\n    return useDoc;\n}\n\nexport function rxDocumentDataToPouchDocumentData<T>(\n    primaryKey: StringKeys<RxDocumentData<T>>,\n    doc: RxDocumentData<T> | RxDocumentWriteData<T>\n): WithAttachments<T & { _id: string; }> {\n    let pouchDoc: WithAttachments<T> = pouchSwapPrimaryToId(primaryKey, doc);\n\n    // always flat clone because we mutate the _attachments property.\n    pouchDoc = flatClone(pouchDoc);\n\n    pouchDoc._attachments = {};\n    if (doc._attachments) {\n        Object.entries(doc._attachments).forEach(([key, value]) => {\n            const useValue: RxAttachmentWriteData & RxAttachmentData = value as any;\n            if (useValue.data) {\n                (pouchDoc as any)._attachments[key] = {\n                    data: useValue.data,\n                    content_type: useValue.type\n                };\n            } else {\n                (pouchDoc as any)._attachments[key] = {\n                    digest: useValue.digest,\n                    content_type: useValue.type,\n                    length: useValue.length,\n                    stub: true\n                };\n            }\n        });\n    }\n\n    (pouchDoc as any)[POUCHDB_META_FIELDNAME] = (pouchDoc as any)._meta;\n    delete (pouchDoc as any)._meta;\n\n    return pouchDoc as any;\n}\n\n\n/**\n * Swaps the primaryKey of the document\n * to the _id property.\n */\nexport function pouchSwapPrimaryToId<RxDocType>(\n    primaryKey: StringKeys<RxDocumentData<RxDocType>>,\n    docData: any\n): RxDocType & { _id: string } {\n    // optimisation shortcut\n    if (primaryKey === '_id') {\n        return docData;\n    }\n\n    const idValue = docData[primaryKey];\n    const ret = flatClone(docData);\n    delete ret[primaryKey];\n    ret._id = idValue;\n    return ret;\n}\n\n/**\n * in:  '_local/foobar'\n * out: 'foobar'\n */\nexport function pouchStripLocalFlagFromPrimary(str: string): string {\n    return str.substring(POUCHDB_LOCAL_PREFIX.length);\n}\n\nexport function getEventKey(\n    pouchDBInstance: PouchDBInstance,\n    primary: string,\n    change: ChangeEvent<RxDocumentData<any>>\n): string {\n    const useRev = change.doc ? change.doc._rev : change.previous._rev;\n    const eventKey = pouchDBInstance.name + '|' + primary + '|' + change.operation + '|' + useRev;\n    return eventKey;\n}\n\nexport function pouchChangeRowToChangeEvent<DocumentData>(\n    primaryKey: StringKeys<DocumentData>,\n    pouchDoc: any\n): ChangeEvent<RxDocumentData<DocumentData>> {\n    if (!pouchDoc) {\n        throw newRxError('SNH', { args: { pouchDoc } });\n    }\n    const id = pouchDoc._id;\n\n    const doc = pouchDocumentDataToRxDocumentData<DocumentData>(\n        primaryKey,\n        pouchDoc as any\n    );\n    const revHeight = doc._rev ? getHeightOfRevision(doc._rev) : 1;\n\n    if (pouchDoc._deleted) {\n        return {\n            operation: 'DELETE',\n            id,\n            doc: null,\n            previous: doc\n        };\n    } else if (revHeight === 1) {\n        return {\n            operation: 'INSERT',\n            id,\n            doc,\n            previous: null\n        };\n    } else {\n        return {\n            operation: 'UPDATE',\n            id,\n            doc: doc,\n            previous: 'UNKNOWN'\n        };\n    }\n}\n\nexport function pouchChangeRowToChangeStreamEvent<DocumentData>(\n    primaryKey: StringKeys<DocumentData>,\n    pouchRow: PouchChangeRow\n): ChangeStreamEvent<DocumentData> {\n    const doc = pouchRow.doc;\n    if (!doc) {\n        throw newRxError('SNH', { args: { pouchRow } });\n    }\n    const revHeight = getHeightOfRevision(doc._rev);\n\n    if (pouchRow.deleted) {\n        const previousDoc = flatClone(\n            pouchDocumentDataToRxDocumentData(\n                primaryKey,\n                pouchRow.doc as any\n            )\n        );\n        const ev: ChangeStreamEvent<DocumentData> = {\n            sequence: pouchRow.seq,\n            id: pouchRow.id,\n            operation: 'DELETE',\n            doc: null,\n            previous: previousDoc\n        };\n        return ev;\n    } else if (revHeight === 1) {\n        const ev: ChangeStreamEvent<DocumentData> = {\n            sequence: pouchRow.seq,\n            id: pouchRow.id,\n            operation: 'INSERT',\n            doc: pouchDocumentDataToRxDocumentData(\n                primaryKey,\n                pouchRow.doc as any\n            ),\n            previous: null\n        };\n        return ev;\n    } else {\n        const ev: ChangeStreamEvent<DocumentData> = {\n            sequence: pouchRow.seq,\n            id: pouchRow.id,\n            operation: 'UPDATE',\n            doc: pouchDocumentDataToRxDocumentData(\n                primaryKey,\n                pouchRow.doc as any\n            ),\n            previous: 'UNKNOWN'\n        };\n        return ev;\n    }\n}\n\n\n/**\n * Runs a primary swap with transform all custom primaryKey occurrences\n * into '_id'\n * @recursive\n */\nexport function primarySwapPouchDbQuerySelector<RxDocType>(\n    selector: any,\n    primaryKey: StringKeys<RxDocumentData<RxDocType>>\n): any {\n    if (primaryKey === '_id') {\n        return selector;\n    }\n    if (Array.isArray(selector)) {\n        return selector.map(item => primarySwapPouchDbQuerySelector(item, primaryKey));\n    } else if (typeof selector === 'object') {\n        const ret: any = {};\n        Object.entries(selector).forEach(([k, v]) => {\n            if (k === primaryKey) {\n                ret._id = v;\n            } else {\n                if (k.startsWith('$')) {\n                    ret[k] = primarySwapPouchDbQuerySelector(v, primaryKey);\n                } else {\n                    ret[k] = v;\n                }\n            }\n        });\n        return ret;\n    } else {\n        return selector;\n    }\n}\n\nexport function pouchHash(data: Buffer | Blob | string): Promise<string> {\n    return new Promise(res => {\n        binaryMd5(data, (digest: string) => {\n            res(digest);\n        });\n    });\n}\n\n\n/**\n * Runs the same hashing as PouchDB would do.\n * Used to pre-calculated the hashes which is required to emit the correct events.\n */\nexport function hashAttachmentData(\n    attachmentBase64String: string\n): Promise<string> {\n    let binary;\n    try {\n        binary = atob(attachmentBase64String);\n    } catch (err) {\n        console.log('hashAttachmentData() could not run b64DecodeUnicode() on ' + attachmentBase64String);\n        throw err;\n    }\n    return pouchHash(binary);\n}\n\nexport async function writeAttachmentsToAttachments(\n    attachments: { [attachmentId: string]: RxAttachmentData | RxAttachmentWriteData; }\n): Promise<{ [attachmentId: string]: RxAttachmentData; }> {\n    if (!attachments) {\n        return {};\n    }\n    const ret: { [attachmentId: string]: RxAttachmentData; } = {};\n    await Promise.all(\n        Object.entries(attachments)\n            .map(async ([key, obj]) => {\n                if (!obj.type) {\n                    throw newRxError('SNH', { args: { obj } });\n                }\n                /**\n                 * Is write attachment,\n                 * so we have to remove the data to have a\n                 * non-write attachment.\n                 */\n                if ((obj as RxAttachmentWriteData).data) {\n                    const asWrite = (obj as RxAttachmentWriteData);\n                    let data: any = asWrite.data;\n                    const isBuffer = typeof Buffer !== 'undefined' && Buffer.isBuffer(data);\n                    if (isBuffer) {\n                        data = new Blob([data]);\n                    }\n                    const dataAsBase64String = typeof data === 'string' ? data : await blobBufferUtil.toBase64String(data);\n                    const hash = await hashAttachmentData(dataAsBase64String);\n                    const length = getAttachmentSize(dataAsBase64String);\n                    ret[key] = {\n                        digest: 'md5-' + hash,\n                        length,\n                        type: asWrite.type\n                    };\n                } else {\n                    ret[key] = obj as RxAttachmentData;\n                }\n            })\n    );\n    return ret;\n}\n\nexport function getPouchIndexDesignDocNameByIndex(\n    index: MaybeReadonly<string[]>\n): string {\n    const indexName = 'idx-rxdb-index-' + index.join(',');\n    return indexName;\n}\n\n/**\n * PouchDB has not way to read deleted local documents\n * out of the database.\n * So instead of deleting them, we set a custom deleted flag.\n */\nexport const RXDB_POUCH_DELETED_FLAG = 'rxdb-pouch-deleted' as const;\n\n\nexport type RxLocalDocumentDataWithCustomDeletedField<D> = RxLocalDocumentData<D> & {\n    [k in typeof RXDB_POUCH_DELETED_FLAG]?: boolean;\n};\n\n\nexport const POUCHDB_CHECKPOINT_SCHEMA: DeepReadonly<JsonSchema<PouchCheckpoint>> = {\n    type: 'object',\n    properties: {\n        sequence: {\n            type: 'number'\n        }\n    },\n    required: [\n        'sequence'\n    ],\n    additionalProperties: false\n};\n"],"mappings":"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"}