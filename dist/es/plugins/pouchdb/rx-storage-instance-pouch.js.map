{"version":3,"file":"rx-storage-instance-pouch.js","names":["ObliviousSet","Subject","newRxError","OPEN_POUCHDB_STORAGE_INSTANCES","POUCHDB_DESIGN_PREFIX","pouchDocumentDataToRxDocumentData","pouchSwapIdToPrimary","rxDocumentDataToPouchDocumentData","writeAttachmentsToAttachments","blobBufferUtil","flatClone","getFromMapOrThrow","getFromObjectOrThrow","PROMISE_RESOLVE_VOID","getCustomEventEmitterByPouch","getPrimaryFieldOfPrimaryKey","_settle","pact","state","value","s","_Pact","v","o","bind","then","observer","lastId","prototype","onFulfilled","onRejected","result","callback","e","_this","thenable","test","update","body","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","RxStorageInstancePouch","storage","databaseName","collectionName","schema","internals","options","id","changes$","subs","add","primaryPath","primaryKey","emitter","pouch","emittedEventBulkIds","eventSub","subject","subscribe","ev","events","length","has","forEach","event","change","doc","previous","next","push","close","sub","unsubscribe","remove","destroy","bulkWrite","documentWrites","args","writeRowById","Map","insertDocsById","writeDocs","map","writeData","document","_meta","lwt","primary","set","storeDocumentData","previousDocsInDb","bulkDocs","new_edits","custom","pouchResult","ret","success","error","Promise","all","resultRow","writeRow","previousDoc","err","isError","status","documentId","documentInDb","pushObj","_rev","rev","_attachments","query","preparedQuery","find","findResult","documents","docs","pouchDoc","useDoc","getAttachmentData","attachmentId","getAttachment","attachmentData","toBase64String","findDocumentsById","ids","deleted","allDocs","include_docs","keys","rows","filter","row","docData","changes","live","since","doc_ids","style","viaChanges","retDocs","results","get","firstDoc","useFirstDoc","changeStream","asObservable","cleanup","_minimumDeletedTime","compact","getChangedDocumentsSince","limit","checkpoint","changedDocuments","documentsData","Object","sequence","lastSequence","Error","changeRow","pouchChangesOpts","descending","first","skippedDesignDocuments","pouchResults","addChangedDocuments","isDesignDoc","startsWith","seq","concat","last_seq"],"sources":["../../../../src/plugins/pouchdb/rx-storage-instance-pouch.ts"],"sourcesContent":["import { ObliviousSet } from 'oblivious-set';\nimport {\n    Observable,\n    Subject,\n    Subscription\n} from 'rxjs';\nimport { newRxError } from '../../rx-error';\nimport type {\n    BulkWriteRow,\n    EventBulk,\n    PouchBulkDocResultRow,\n    PouchChangedDocumentsSinceCheckpoint,\n    PouchChangesOptionsNonLive,\n    PouchSettings,\n    PouchWriteError,\n    PreparedQuery,\n    RxDocumentData,\n    RxJsonSchema,\n    RxStorage,\n    RxStorageBulkWriteError,\n    RxStorageBulkWriteResponse,\n    RxStorageChangeEvent,\n    RxStorageInstance,\n    RxStorageQueryResult\n} from '../../types';\nimport {\n    OPEN_POUCHDB_STORAGE_INSTANCES,\n    POUCHDB_DESIGN_PREFIX,\n    pouchDocumentDataToRxDocumentData,\n    PouchStorageInternals,\n    pouchSwapIdToPrimary,\n    rxDocumentDataToPouchDocumentData,\n    writeAttachmentsToAttachments\n} from './pouchdb-helper';\nimport {\n    blobBufferUtil,\n    flatClone,\n    getFromMapOrThrow,\n    getFromObjectOrThrow,\n    PROMISE_RESOLVE_VOID\n} from '../../util';\nimport {\n    getCustomEventEmitterByPouch\n} from './custom-events-plugin';\nimport { getPrimaryFieldOfPrimaryKey } from '../../rx-schema-helper';\n\n\nlet lastId = 0;\n\nexport class RxStorageInstancePouch<RxDocType> implements RxStorageInstance<\n    RxDocType,\n    PouchStorageInternals,\n    PouchSettings\n> {\n    public readonly id: number = lastId++;\n\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>>> = new Subject();\n    private subs: Subscription[] = [];\n    private primaryPath: keyof RxDocType;\n\n    constructor(\n        public readonly storage: RxStorage<PouchStorageInternals, PouchSettings>,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<RxDocumentData<RxDocType>>>,\n        public readonly internals: Readonly<PouchStorageInternals>,\n        public readonly options: Readonly<PouchSettings>\n    ) {\n        OPEN_POUCHDB_STORAGE_INSTANCES.add(this);\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey) as any;\n\n        /**\n         * Instead of listening to pouch.changes,\n         * we have overwritten pouchdbs bulkDocs()\n         * and create our own event stream, this will work more relyable\n         * and does not mix up with write events from other sources.\n         */\n        const emitter = getCustomEventEmitterByPouch<RxDocType>(this.internals.pouch);\n\n        /**\n         * Contains all eventIds that of emitted events,\n         * used because multi-instance pouchdbs often will reemit the same\n         * event on the other browser tab so we have to de-duplicate them.\n         */\n        const emittedEventBulkIds: ObliviousSet<string> = new ObliviousSet(60 * 1000);\n\n        const eventSub = emitter.subject.subscribe(async (ev) => {\n            if (\n                ev.events.length === 0 ||\n                emittedEventBulkIds.has(ev.id)\n            ) {\n                return;\n            }\n            emittedEventBulkIds.add(ev.id);\n\n            // rewrite primaryPath of all events\n            ev.events.forEach(event => {\n                if (event.change.doc) {\n                    event.change.doc = pouchSwapIdToPrimary(\n                        this.primaryPath,\n                        event.change.doc as any\n                    );\n                }\n                if (event.change.previous) {\n                    event.change.previous = pouchSwapIdToPrimary(\n                        this.primaryPath,\n                        event.change.previous as any\n                    );\n                }\n            });\n\n            this.changes$.next(ev);\n        });\n        this.subs.push(eventSub);\n    }\n\n    close() {\n        this.subs.forEach(sub => sub.unsubscribe());\n        OPEN_POUCHDB_STORAGE_INSTANCES.delete(this);\n\n        // TODO this did not work because a closed pouchdb cannot be recreated in the same process run\n        // await this.internals.pouch.close();\n        return PROMISE_RESOLVE_VOID;\n    }\n\n    async remove() {\n        this.subs.forEach(sub => sub.unsubscribe());\n\n        OPEN_POUCHDB_STORAGE_INSTANCES.delete(this);\n        await this.internals.pouch.destroy();\n    }\n    public async bulkWrite(\n        documentWrites: BulkWriteRow<RxDocType>[]\n    ): Promise<\n        RxStorageBulkWriteResponse<RxDocType>\n    > {\n        if (documentWrites.length === 0) {\n            throw newRxError('P2', {\n                args: {\n                    documentWrites\n                }\n            });\n        }\n\n        const writeRowById: Map<string, BulkWriteRow<RxDocType>> = new Map();\n        const insertDocsById: Map<string, any> = new Map();\n        const writeDocs: (RxDocType & { _id: string; _rev: string })[] = documentWrites.map(writeData => {\n\n            /**\n             * Ensure that _meta.lwt is set correctly\n             */\n            if (\n                writeData.document._meta.lwt < 1000 ||\n                (\n                    writeData.previous &&\n                    writeData.previous._meta.lwt >= writeData.document._meta.lwt\n                )\n            ) {\n                throw newRxError('SNH', {\n                    args: writeData\n                });\n            }\n\n            const primary: string = (writeData.document as any)[this.primaryPath];\n            writeRowById.set(primary, writeData);\n            const storeDocumentData: any = rxDocumentDataToPouchDocumentData<RxDocType>(\n                this.primaryPath,\n                writeData.document\n            );\n            insertDocsById.set(primary, storeDocumentData);\n            return storeDocumentData;\n        });\n\n        const previousDocsInDb: Map<string, RxDocumentData<any>> = new Map();\n        const pouchResult = await this.internals.pouch.bulkDocs(writeDocs, {\n            new_edits: false,\n            custom: {\n                primaryPath: this.primaryPath,\n                writeRowById,\n                insertDocsById,\n                previousDocsInDb\n            }\n        } as any);\n\n        const ret: RxStorageBulkWriteResponse<RxDocType> = {\n            success: {},\n            error: {}\n        };\n        await Promise.all(\n            pouchResult.map(async (resultRow) => {\n                const writeRow = getFromMapOrThrow(writeRowById, resultRow.id);\n                if ((resultRow as PouchWriteError).error) {\n                    const previousDoc = getFromMapOrThrow(previousDocsInDb, resultRow.id);\n                    const err: RxStorageBulkWriteError<RxDocType> = {\n                        isError: true,\n                        status: 409,\n                        documentId: resultRow.id,\n                        writeRow,\n                        documentInDb: pouchDocumentDataToRxDocumentData(\n                            this.primaryPath,\n                            previousDoc\n                        )\n                    };\n                    ret.error[resultRow.id] = err;\n                } else {\n                    let pushObj: RxDocumentData<RxDocType> = flatClone(writeRow.document) as any;\n                    pushObj = pouchSwapIdToPrimary(this.primaryPath, pushObj);\n                    pushObj._rev = (resultRow as PouchBulkDocResultRow).rev;\n\n                    // replace the inserted attachments with their diggest\n                    pushObj._attachments = {};\n                    if (!writeRow.document._attachments) {\n                        writeRow.document._attachments = {};\n                    } else {\n                        pushObj._attachments = await writeAttachmentsToAttachments(writeRow.document._attachments);\n                    }\n                    ret.success[resultRow.id] = pushObj;\n                }\n            })\n        );\n        return ret;\n    }\n\n    public async query(\n        preparedQuery: PreparedQuery<RxDocType>\n    ): Promise<RxStorageQueryResult<RxDocType>> {\n        const findResult = await this.internals.pouch.find<RxDocType>(preparedQuery);\n        const ret: RxStorageQueryResult<RxDocType> = {\n            documents: findResult.docs.map(pouchDoc => {\n                const useDoc = pouchDocumentDataToRxDocumentData(\n                    this.primaryPath,\n                    pouchDoc\n                );\n                return useDoc;\n            })\n        };\n        return ret;\n    }\n\n    async getAttachmentData(\n        documentId: string,\n        attachmentId: string\n    ): Promise<string> {\n        const attachmentData = await this.internals.pouch.getAttachment(\n            documentId,\n            attachmentId\n        );\n        const ret = await blobBufferUtil.toBase64String(attachmentData);\n        return ret;\n    }\n\n    async findDocumentsById(ids: string[], deleted: boolean): Promise<{ [documentId: string]: RxDocumentData<RxDocType> }> {\n        /**\n         * On deleted documents, PouchDB will only return the tombstone.\n         * So we have to get the properties directly for each document\n         * with the hack of getting the changes and then make one request per document\n         * with the latest revision.\n         * TODO create an issue at pouchdb on how to get the document data of deleted documents,\n         * when one past revision was written via new_edits=false\n         * @link https://stackoverflow.com/a/63516761/3443137\n         */\n        if (deleted) {\n            const viaChanges = await this.internals.pouch.changes({\n                live: false,\n                since: 0,\n                doc_ids: ids,\n                style: 'all_docs'\n            });\n\n            const retDocs: { [documentId: string]: RxDocumentData<RxDocType> } = {};\n            await Promise.all(\n                viaChanges.results.map(async (result) => {\n                    const firstDoc = await this.internals.pouch.get(\n                        result.id,\n                        {\n                            rev: result.changes[0].rev,\n                            deleted: 'ok',\n                            style: 'all_docs'\n                        }\n                    );\n                    const useFirstDoc = pouchDocumentDataToRxDocumentData(\n                        this.primaryPath,\n                        firstDoc\n                    );\n                    retDocs[result.id] = useFirstDoc;\n                })\n            );\n            return retDocs;\n        }\n\n\n        const pouchResult = await this.internals.pouch.allDocs({\n            include_docs: true,\n            keys: ids\n        });\n\n        const ret: { [documentId: string]: RxDocumentData<RxDocType> } = {};\n        pouchResult.rows\n            .filter(row => !!row.doc)\n            .forEach(row => {\n                let docData = row.doc;\n                docData = pouchDocumentDataToRxDocumentData(\n                    this.primaryPath,\n                    docData\n                );\n                ret[row.id] = docData;\n            });\n\n        return ret;\n    }\n\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>>> {\n        return this.changes$.asObservable();\n    }\n\n    cleanup(_minimumDeletedTime: number): Promise<boolean> {\n        /**\n         * PouchDB does not support purging documents.\n         * So instead we run a compaction that might at least help a bit\n         * in freeing up disc space.\n         * @link https://github.com/pouchdb/pouchdb/issues/802\n         */\n        return this.internals.pouch\n            .compact()\n            .then(() => true);\n    }\n\n    async getChangedDocumentsSince(\n        limit: number,\n        checkpoint?: PouchChangedDocumentsSinceCheckpoint\n    ): Promise<{\n        document: RxDocumentData<RxDocType>;\n        checkpoint: PouchChangedDocumentsSinceCheckpoint;\n    }[]> {\n        if (!limit || typeof limit !== 'number') {\n            throw new Error('wrong limit');\n        }\n\n        const pouchChangesOpts: PouchChangesOptionsNonLive = {\n            live: false,\n            limit: limit,\n            include_docs: false,\n            since: checkpoint ? checkpoint.sequence : 0,\n            descending: false\n        };\n\n        let lastSequence = 0;\n        let first = true;\n        let skippedDesignDocuments = 0;\n        let changedDocuments: { id: string; sequence: number; }[] = [];\n        /**\n         * Because PouchDB also returns changes of _design documents,\n         * we have to fill up the results with more changes if this happens.\n         */\n        while (first || skippedDesignDocuments > 0) {\n            first = false;\n            skippedDesignDocuments = 0;\n            const pouchResults = await this.internals.pouch.changes(pouchChangesOpts);\n            const addChangedDocuments = pouchResults.results\n                .filter(row => {\n                    const isDesignDoc = row.id.startsWith(POUCHDB_DESIGN_PREFIX);\n                    if (isDesignDoc) {\n                        skippedDesignDocuments = skippedDesignDocuments + 1;\n                        return false;\n                    } else {\n                        return true;\n                    }\n                })\n                .map(row => ({\n                    id: row.id,\n                    sequence: row.seq\n                }));\n            changedDocuments = changedDocuments.concat(addChangedDocuments);\n            lastSequence = pouchResults.last_seq;\n\n            // modify pouch options for next run of pouch.changes()\n            pouchChangesOpts.since = lastSequence;\n            pouchChangesOpts.limit = skippedDesignDocuments;\n        }\n\n        const documentsData = await this.findDocumentsById(\n            changedDocuments.map(o => o.id),\n            true\n        );\n\n        if (\n            Object.keys(documentsData).length > 0 &&\n            checkpoint && checkpoint.sequence === lastSequence\n        ) {\n            /**\n             * When documents are returned, it makes no sense\n             * if the sequence is equal to the one given at the checkpoint.\n             */\n            throw new Error('same sequence');\n        }\n\n        return changedDocuments.map(changeRow => {\n            return {\n                checkpoint: {\n                    sequence: changeRow.sequence\n                },\n                document: getFromObjectOrThrow(documentsData, changeRow.id)\n            };\n        });\n    }\n}\n"],"mappings":"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"}