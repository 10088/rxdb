{"version":3,"sources":["../../../../src/plugins/lokijs/loki-save-queue.ts"],"names":["IdleQueue","now","promiseWait","requestIdlePromise","LokiSaveQueue","lokiDatabase","databaseSettings","rxDatabaseIdleQueue","writesSinceLastRun","runningSavesIdleQueue","addWrite","run","t","Promise","all","isIdle","writeAmount","then","wrapCall","res","rej","saveDatabase","err","autosaveCallback"],"mappings":";;AAAA,SAASA,SAAT,QAA0B,mBAA1B;AAEA,SAASC,GAAT,EAAcC,WAAd,EAA2BC,kBAA3B,QAAqD,YAArD;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,WAAaC,aAAb;AAII,yBACoBC,YADpB,EAEoBC,gBAFpB,EAGoBC,mBAHpB,EAIE;AAAA,SAPKC,kBAOL,GAPkC,CAOlC;AAAA,SANcC,qBAMd,GANiD,IAAIT,SAAJ,CAAc,CAAd,CAMjD;AAAA,SAHkBK,YAGlB,GAHkBA,YAGlB;AAAA,SAFkBC,gBAElB,GAFkBA,gBAElB;AAAA,SADkBC,mBAClB,GADkBA,mBAClB;AAED;;AAVL;;AAAA,SAYWG,QAZX,GAYI,oBAAkB;AACd,SAAKF,kBAAL,GAA0B,KAAKA,kBAAL,GAA0B,CAApD;AACA,SAAKG,GAAL;AACH,GAfL;;AAAA,SAiBiBA,GAjBjB;AAAA,wEAiBI;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AACUC,cAAAA,CADV,GACcX,GAAG,EADjB;;AAAA,oBAEQ,KAAKO,kBAAL,KAA4B,CAFpC;AAAA;AAAA;AAAA;;AAAA,+CAGe,KAAKC,qBAAL,CAA2BN,kBAA3B,EAHf;;AAAA;AAAA;AAAA,qBAMUU,OAAO,CAACC,GAAR,CAAY,CACdX,kBAAkB,EADJ,EAEdD,WAAW,CAAC,GAAD,CAFG,CAAZ,CANV;;AAAA;AAAA,oBAWQ,CACI,CAAC,KAAKK,mBAAL,CAAyBQ,MAAzB,EAAD,IACA,CAAC,KAAKN,qBAAL,CAA2BM,MAA3B,EAFL,KAGK,KAAKP,kBAAL,KAA4B,CAdzC;AAAA;AAAA;AAAA;;AAAA;AAAA,qBAgBcL,kBAAkB,EAhBhC;;AAAA;AAAA;AAAA,qBAiBcU,OAAO,CAACC,GAAR,CAAY,CACd,KAAKP,mBAAL,CAAyBJ,kBAAzB,EADc,EAEd,KAAKM,qBAAL,CAA2BN,kBAA3B,EAFc,EAGdD,WAAW,CAAC,GAAD,CAHG,CAAZ,CAjBd;;AAAA;AAAA;AAAA;;AAAA;AAAA,oBAwBQ,KAAKM,kBAAL,KAA4B,CAxBpC;AAAA;AAAA;AAAA;;AAAA;;AAAA;AA2BUQ,cAAAA,WA3BV,GA2BwB,KAAKR,kBA3B7B;AA4BI,mBAAKA,kBAAL,GAA0B,CAA1B;AA5BJ,+CA8BW,KAAKC,qBAAL,CAA2BN,kBAA3B,GAAgDc,IAAhD,CAAqD,YAAM;AAC9D,uBAAO,KAAI,CAACR,qBAAL,CAA2BS,QAA3B,CACH,YAAM;AACF,yBAAO,IAAIL,OAAJ,CAAkB,UAACM,GAAD,EAAMC,GAAN,EAAc;AACnC,oBAAA,KAAI,CAACf,YAAL,CAAkBgB,YAAlB,CAA+B,UAAAC,GAAG,EAAI;AAClC,0BAAIA,GAAJ,EAAS;AACL,wBAAA,KAAI,CAACd,kBAAL,GAA0B,KAAI,CAACA,kBAAL,GAA0BQ,WAApD;AACAI,wBAAAA,GAAG,CAACE,GAAD,CAAH;AACH,uBAHD,MAGO;AACH,4BAAI,KAAI,CAAChB,gBAAL,CAAsBiB,gBAA1B,EAA4C;AACxC,0BAAA,KAAI,CAACjB,gBAAL,CAAsBiB,gBAAtB;AACH;;AACDJ,wBAAAA,GAAG;AACN;AACJ,qBAVD;AAWH,mBAZM,CAAP;AAaH,iBAfE,CAAP;AAiBH,eAlBM,CA9BX;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAjBJ;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA","sourcesContent":["import { IdleQueue } from 'custom-idle-queue';\nimport { LokiDatabaseSettings } from '../../types';\nimport { now, promiseWait, requestIdlePromise } from '../../util';\n\n/**\n * The autosave feature of lokijs has strange behaviors\n * and often runs a save in critical moments when other\n * more important tasks are running.\n * So instead we use a custom save queue that ensures we\n * only run loki.saveDatabase() when nothing else is running.\n */\nexport class LokiSaveQueue {\n    public writesSinceLastRun: number = 0;\n    public readonly runningSavesIdleQueue: IdleQueue = new IdleQueue(1);\n\n    constructor(\n        public readonly lokiDatabase: Loki,\n        public readonly databaseSettings: LokiDatabaseSettings,\n        public readonly rxDatabaseIdleQueue: IdleQueue\n    ) {\n\n    }\n\n    public addWrite() {\n        this.writesSinceLastRun = this.writesSinceLastRun + 1;\n        this.run();\n    }\n\n    public async run() {\n        const t = now();\n        if (this.writesSinceLastRun === 0) {\n            return this.runningSavesIdleQueue.requestIdlePromise();\n        }\n\n        await Promise.all([\n            requestIdlePromise(),\n            promiseWait(100)\n        ]);\n        while (\n            (\n                !this.rxDatabaseIdleQueue.isIdle() ||\n                !this.runningSavesIdleQueue.isIdle()\n            ) && this.writesSinceLastRun !== 0\n        ) {\n            await requestIdlePromise();\n            await Promise.all([\n                this.rxDatabaseIdleQueue.requestIdlePromise(),\n                this.runningSavesIdleQueue.requestIdlePromise(),\n                promiseWait(100)\n            ]);\n        }\n\n        if (this.writesSinceLastRun === 0) {\n            return;\n        }\n        const writeAmount = this.writesSinceLastRun;\n        this.writesSinceLastRun = 0;\n\n        return this.runningSavesIdleQueue.requestIdlePromise().then(() => {\n            return this.runningSavesIdleQueue.wrapCall(\n                () => {\n                    return new Promise<void>((res, rej) => {\n                        this.lokiDatabase.saveDatabase(err => {\n                            if (err) {\n                                this.writesSinceLastRun = this.writesSinceLastRun + writeAmount;\n                                rej(err);\n                            } else {\n                                if (this.databaseSettings.autosaveCallback) {\n                                    this.databaseSettings.autosaveCallback();\n                                }\n                                res();\n                            }\n                        });\n                    })\n                }\n            );\n        })\n    }\n}\n"],"file":"loki-save-queue.js"}