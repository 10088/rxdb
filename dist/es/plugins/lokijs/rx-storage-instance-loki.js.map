{"version":3,"sources":["../../../../src/plugins/lokijs/rx-storage-instance-loki.ts"],"names":["Subject","promiseWait","createRevision","getHeightOfRevision","parseRevision","lastOfArray","flatClone","now","ensureNotFalsy","randomCouchString","newRxError","getPrimaryFieldOfPrimaryKey","LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE","CHANGES_COLLECTION_SUFFIX","closeLokiCollections","getLokiDatabase","getLokiEventKey","OPEN_LOKIJS_STORAGE_INSTANCES","LOKIJS_COLLECTION_DEFAULT_OPTIONS","stripLokiKey","getLokiSortComparator","getLokiLeaderElector","removeLokiLeaderElectorReference","instanceId","RxStorageInstanceLoki","storage","databaseName","collectionName","schema","internals","options","databaseSettings","changes$","lastChangefeedSequence","closed","primaryPath","primaryKey","add","leaderElector","awaitLeadership","then","broadcastChannel","addEventListener","msg","type","requestId","response","operation","params","isError","result","postMessage","getLocalState","ret","localState","mustUseLocalState","hasLeader","applyOnce","isLeader","createLokiLocalState","multiInstance","requestRemoteInstance","responsePromise","Promise","res","rej","listener","removeEventListener","addChangeDocumentMeta","id","lastDoc","changesCollection","chain","simplesort","limit","data","sequence","nextFeedSequence","insert","bulkWrite","documentWrites","length","args","success","error","eventBulk","events","forEach","writeRow","startTime","document","documentInDb","collection","by","newRevision","insertedIsDeleted","_deleted","writeDoc","Object","assign","_rev","_attachments","push","eventId","documentId","change","doc","previous","endTime","revInDb","err","status","newRevHeight","isDeleted","$loki","update","databaseState","saveQueue","addWrite","next","bulkAddRevisions","documents","docData","newWriteRevision","oldRevision","mustUpdate","height","hash","storeAtLoki","findDocumentsById","ids","deleted","query","preparedQuery","find","selector","sort","skip","offset","foundDocuments","map","lokiDoc","getAttachmentData","_documentId","_attachmentId","Error","getChangedDocuments","desc","direction","operator","sinceSequence","changedDocuments","useForLastSequence","lastSequence","changeStream","asObservable","close","complete","dbState","run","remove","database","removeCollection","name","indices","indexes","idx","Array","isArray","collectionOptions","unique","addCollection","collections","changesCollectionName","changesCollectionOptions","createLokiStorageInstance","instance"],"mappings":"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","sourcesContent":["import type {\n    ChangeEvent\n} from 'event-reduce-js';\nimport {\n    Subject,\n    Observable\n} from 'rxjs';\nimport {\n    promiseWait,\n    createRevision,\n    getHeightOfRevision,\n    parseRevision,\n    lastOfArray,\n    flatClone,\n    now,\n    ensureNotFalsy,\n    randomCouchString\n} from '../../util';\nimport { newRxError } from '../../rx-error';\nimport { getPrimaryFieldOfPrimaryKey } from '../../rx-schema';\nimport type {\n    RxStorageInstance,\n    LokiSettings,\n    RxStorageChangeEvent,\n    RxDocumentData,\n    BulkWriteRow,\n    RxStorageBulkWriteResponse,\n    RxStorageBulkWriteError,\n    RxStorageQueryResult,\n    BlobBuffer,\n    ChangeStreamOnceOptions,\n    RxJsonSchema,\n    MangoQuery,\n    LokiStorageInternals,\n    RxStorageChangedDocumentMeta,\n    RxStorageInstanceCreationParams,\n    LokiRemoteResponseBroadcastMessage,\n    LokiDatabaseSettings,\n    LokiLocalDatabaseState,\n    EventBulk\n} from '../../types';\nimport {\n    LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE,\n    CHANGES_COLLECTION_SUFFIX,\n    closeLokiCollections,\n    getLokiDatabase,\n    getLokiEventKey,\n    OPEN_LOKIJS_STORAGE_INSTANCES,\n    LOKIJS_COLLECTION_DEFAULT_OPTIONS,\n    stripLokiKey,\n    getLokiSortComparator,\n    getLokiLeaderElector,\n    removeLokiLeaderElectorReference\n} from './lokijs-helper';\nimport type {\n    Collection\n} from 'lokijs';\nimport { RxStorageLoki } from './rx-storage-lokijs';\n\nlet instanceId = now();\n\nexport class RxStorageInstanceLoki<RxDocType> implements RxStorageInstance<\n    RxDocType,\n    LokiStorageInternals,\n    LokiSettings\n> {\n\n    public readonly primaryPath: keyof RxDocType;\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>>> = new Subject();\n    private lastChangefeedSequence: number = 0;\n    public readonly instanceId = instanceId++;\n\n    private closed = false;\n\n    constructor(\n        public readonly storage: RxStorageLoki,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<RxDocType>>,\n        public readonly internals: LokiStorageInternals,\n        public readonly options: Readonly<LokiSettings>,\n        public readonly databaseSettings: LokiDatabaseSettings\n    ) {\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\n        OPEN_LOKIJS_STORAGE_INSTANCES.add(this);\n        if (this.internals.leaderElector) {\n            this.internals.leaderElector.awaitLeadership().then(() => {\n                // this instance is leader now, so it has to reply to queries from other instances\n                ensureNotFalsy(this.internals.leaderElector).broadcastChannel.addEventListener('message', async (msg) => {\n                    if (\n                        msg.type === LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE &&\n                        msg.requestId &&\n                        msg.databaseName === this.databaseName &&\n                        msg.collectionName === this.collectionName &&\n                        !msg.response\n                    ) {\n\n                        const operation = (msg as any).operation;\n                        const params = (msg as any).params;\n                        let result: any;\n                        let isError = false;\n                        try {\n                            result = await (this as any)[operation](...params);\n                        } catch (err) {\n                            result = err;\n                            isError = true;\n                        }\n\n                        const response: LokiRemoteResponseBroadcastMessage = {\n                            response: true,\n                            requestId: msg.requestId,\n                            databaseName: this.databaseName,\n                            collectionName: this.collectionName,\n                            result,\n                            isError,\n                            type: msg.type\n                        };\n                        ensureNotFalsy(this.internals.leaderElector).broadcastChannel.postMessage(response);\n                    }\n                });\n            });\n        }\n    }\n\n    private getLocalState() {\n        const ret = ensureNotFalsy(this.internals.localState);\n        return ret;\n    }\n\n    /**\n     * If the local state must be used, that one is returned.\n     * Returns false if a remote instance must be used.\n     */\n    public async mustUseLocalState(): Promise<LokiLocalDatabaseState | false> {\n        if (this.closed) {\n            return false;\n        }\n\n        if (this.internals.localState) {\n            return this.internals.localState;\n        }\n        const leaderElector = ensureNotFalsy(this.internals.leaderElector);\n\n        while (\n            !leaderElector.hasLeader\n        ) {\n            await leaderElector.applyOnce();\n\n            // TODO why do we need this line to pass the tests?\n            // otherwise we somehow do never get a leader.\n            /**\n             * TODO why do we need this line to pass the tests?\n             * Without it, we somehow do never get a leader.\n             * Does applyOnce() fully block the cpu?\n             */\n            await promiseWait(0); // TODO remove this line\n        }\n\n        /**\n         * It might already have a localState after the applying\n         * because another subtask also called mustUSeLocalState()\n         */\n        if (this.internals.localState) {\n            return this.internals.localState;\n        }\n\n        if (\n            leaderElector.isLeader &&\n            !this.internals.localState\n        ) {\n\n            // own is leader, use local instance\n            this.internals.localState = createLokiLocalState<any>({\n                databaseName: this.databaseName,\n                collectionName: this.collectionName,\n                options: this.options,\n                schema: this.schema,\n                multiInstance: this.internals.leaderElector ? true : false\n            }, this.databaseSettings);\n            return this.getLocalState();\n        } else {\n            // other is leader, send message to remote leading instance\n            return false;\n        }\n    }\n\n    private async requestRemoteInstance(\n        operation: string,\n        params: any[]\n    ): Promise<any | any[]> {\n        const broadcastChannel = ensureNotFalsy(this.internals.leaderElector).broadcastChannel;\n        const requestId = randomCouchString(12);\n        const responsePromise = new Promise<any>((res, rej) => {\n            const listener = (msg: any) => {\n                if (\n                    msg.type === LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE &&\n                    msg.response === true &&\n                    msg.requestId === requestId\n                ) {\n                    if (msg.isError) {\n                        broadcastChannel.removeEventListener('message', listener);\n                        rej(msg.result);\n                    } else {\n                        broadcastChannel.removeEventListener('message', listener);\n                        res(msg.result);\n                    }\n                }\n            };\n            broadcastChannel.addEventListener('message', listener);\n        });\n\n        broadcastChannel.postMessage({\n            response: false,\n            type: LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE,\n            operation,\n            params,\n            requestId,\n            databaseName: this.databaseName,\n            collectionName: this.collectionName\n        });\n        const result = await responsePromise;\n        return result;\n    }\n\n    /**\n     * Adds an entry to the changes feed\n     * that can be queried to check which documents have been\n     * changed since sequence X.\n     */\n    private async addChangeDocumentMeta(id: string) {\n        const localState = await this.getLocalState();\n        if (!this.lastChangefeedSequence) {\n            const lastDoc = localState.changesCollection\n                .chain()\n                .simplesort('sequence', true)\n                .limit(1)\n                .data()[0];\n            if (lastDoc) {\n                this.lastChangefeedSequence = lastDoc.sequence;\n            }\n        }\n\n        const nextFeedSequence = this.lastChangefeedSequence + 1;\n        localState.changesCollection.insert({\n            id,\n            sequence: nextFeedSequence\n        });\n        this.lastChangefeedSequence = nextFeedSequence;\n    }\n\n    async bulkWrite(documentWrites: BulkWriteRow<RxDocType>[]): Promise<RxStorageBulkWriteResponse<RxDocType>> {\n        if (documentWrites.length === 0) {\n            throw newRxError('P2', {\n                args: {\n                    documentWrites\n                }\n            });\n        }\n\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('bulkWrite', [documentWrites]);\n        }\n\n        /**\n         * lokijs is in memory and non-async, so we emulate async behavior\n         * to ensure all RxStorage implementations behave equal.\n         */\n        await promiseWait(0);\n        const ret: RxStorageBulkWriteResponse<RxDocType> = {\n            success: {},\n            error: {}\n        };\n\n        const eventBulk: EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>> = {\n            id: randomCouchString(10),\n            events: []\n        };\n        documentWrites.forEach(writeRow => {\n            const startTime = now();\n            const id: string = writeRow.document[this.primaryPath] as any;\n            const documentInDb = localState.collection.by(this.primaryPath, id);\n\n            if (!documentInDb) {\n                // insert new document\n                const newRevision = '1-' + createRevision(writeRow.document);\n\n                /**\n                 * It is possible to insert already deleted documents,\n                 * this can happen on replication.\n                 */\n                const insertedIsDeleted = writeRow.document._deleted ? true : false;\n\n                const writeDoc = Object.assign(\n                    {},\n                    writeRow.document,\n                    {\n                        _rev: newRevision,\n                        _deleted: insertedIsDeleted,\n                        // TODO attachments are currently not working with lokijs\n                        _attachments: {} as any\n                    }\n                );\n                localState.collection.insert(flatClone(writeDoc));\n                if (!insertedIsDeleted) {\n                    this.addChangeDocumentMeta(id);\n                    eventBulk.events.push({\n                        eventId: getLokiEventKey(false, id, newRevision),\n                        documentId: id,\n                        change: {\n                            doc: writeDoc,\n                            id,\n                            operation: 'INSERT',\n                            previous: null\n                        },\n                        startTime,\n                        endTime: now()\n                    });\n                }\n                ret.success[id] = writeDoc;\n            } else {\n                // update existing document\n                const revInDb: string = documentInDb._rev;\n\n                // inserting a deleted document is possible\n                // without sending the previous data.\n                if (!writeRow.previous && documentInDb._deleted) {\n                    writeRow.previous = documentInDb;\n                }\n\n                if (\n                    (\n                        !writeRow.previous &&\n                        !documentInDb._deleted\n                    ) ||\n                    (\n                        !!writeRow.previous &&\n                        revInDb !== writeRow.previous._rev\n                    )\n                ) {\n                    // conflict error\n                    const err: RxStorageBulkWriteError<RxDocType> = {\n                        isError: true,\n                        status: 409,\n                        documentId: id,\n                        writeRow: writeRow\n                    };\n                    ret.error[id] = err;\n                } else {\n                    const newRevHeight = getHeightOfRevision(revInDb) + 1;\n                    const newRevision = newRevHeight + '-' + createRevision(writeRow.document);\n                    const isDeleted = !!writeRow.document._deleted;\n                    const writeDoc: any = Object.assign(\n                        {},\n                        writeRow.document,\n                        {\n                            $loki: documentInDb.$loki,\n                            _rev: newRevision,\n                            _deleted: isDeleted,\n                            // TODO attachments are currently not working with lokijs\n                            _attachments: {}\n                        }\n                    );\n                    localState.collection.update(writeDoc);\n                    this.addChangeDocumentMeta(id);\n\n                    let change: ChangeEvent<RxDocumentData<RxDocType>> | null = null;\n                    if (writeRow.previous && writeRow.previous._deleted && !writeDoc._deleted) {\n                        change = {\n                            id,\n                            operation: 'INSERT',\n                            previous: null,\n                            doc: stripLokiKey(writeDoc)\n                        };\n                    } else if (writeRow.previous && !writeRow.previous._deleted && !writeDoc._deleted) {\n                        change = {\n                            id,\n                            operation: 'UPDATE',\n                            previous: writeRow.previous,\n                            doc: stripLokiKey(writeDoc)\n                        };\n                    } else if (writeRow.previous && !writeRow.previous._deleted && writeDoc._deleted) {\n                        /**\n                         * On delete, we send the 'new' rev in the previous property,\n                         * to have the equal behavior as pouchdb.\n                         */\n                        const previous = flatClone(writeRow.previous);\n                        previous._rev = newRevision;\n                        change = {\n                            id,\n                            operation: 'DELETE',\n                            previous,\n                            doc: null\n                        };\n                    }\n                    if (!change) {\n                        throw newRxError('SNH', { args: { writeRow } });\n                    }\n                    eventBulk.events.push({\n                        eventId: getLokiEventKey(false, id, newRevision),\n                        documentId: id,\n                        change,\n                        startTime,\n                        endTime: now()\n                    });\n                    ret.success[id] = stripLokiKey(writeDoc);\n                }\n            }\n        });\n        localState.databaseState.saveQueue.addWrite();\n        this.changes$.next(eventBulk);\n        return ret;\n    }\n\n    async bulkAddRevisions(documents: RxDocumentData<RxDocType>[]): Promise<void> {\n        if (documents.length === 0) {\n            throw newRxError('P3', {\n                args: {\n                    documents\n                }\n            });\n        }\n\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('bulkAddRevisions', [documents]);\n        }\n\n        /**\n         * lokijs is in memory and non-async, so we emulate async behavior\n         * to ensure all RxStorage implementations behave equal.\n         */\n        await promiseWait(0);\n\n        const eventBulk: EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>> = {\n            id: randomCouchString(10),\n            events: []\n        };\n        documents.forEach(docData => {\n            const startTime = now();\n            const id: string = docData[this.primaryPath] as any;\n            const documentInDb = localState.collection.by(this.primaryPath, id);\n            if (!documentInDb) {\n                // document not here, so we can directly insert\n                localState.collection.insert(flatClone(docData));\n                eventBulk.events.push({\n                    documentId: id,\n                    eventId: getLokiEventKey(false, id, docData._rev),\n                    change: {\n                        doc: docData,\n                        id,\n                        operation: 'INSERT',\n                        previous: null\n                    },\n                    startTime,\n                    endTime: now()\n                });\n                this.addChangeDocumentMeta(id);\n            } else {\n                const newWriteRevision = parseRevision(docData._rev);\n                const oldRevision = parseRevision(documentInDb._rev);\n\n                let mustUpdate: boolean = false;\n                if (newWriteRevision.height !== oldRevision.height) {\n                    // height not equal, compare base on height\n                    if (newWriteRevision.height > oldRevision.height) {\n                        mustUpdate = true;\n                    }\n                } else if (newWriteRevision.hash > oldRevision.hash) {\n                    // equal height but new write has the 'winning' hash\n                    mustUpdate = true;\n                }\n                if (mustUpdate) {\n                    const storeAtLoki = flatClone(docData) as any;\n                    storeAtLoki.$loki = documentInDb.$loki;\n                    localState.collection.update(storeAtLoki);\n                    let change: ChangeEvent<RxDocumentData<RxDocType>> | null = null;\n                    if (documentInDb._deleted && !docData._deleted) {\n                        change = {\n                            id,\n                            operation: 'INSERT',\n                            previous: null,\n                            doc: docData\n                        };\n                    } else if (!documentInDb._deleted && !docData._deleted) {\n                        change = {\n                            id,\n                            operation: 'UPDATE',\n                            previous: stripLokiKey(documentInDb),\n                            doc: docData\n                        };\n                    } else if (!documentInDb._deleted && docData._deleted) {\n                        change = {\n                            id,\n                            operation: 'DELETE',\n                            previous: stripLokiKey(documentInDb),\n                            doc: null\n                        };\n                    } else if (documentInDb._deleted && docData._deleted) {\n                        change = null;\n                    }\n                    if (change) {\n                        eventBulk.events.push({\n                            documentId: id,\n                            eventId: getLokiEventKey(false, id, docData._rev),\n                            change,\n                            startTime,\n                            endTime: now()\n                        });\n                        this.addChangeDocumentMeta(id);\n                    }\n                }\n            }\n        });\n        localState.databaseState.saveQueue.addWrite();\n        this.changes$.next(eventBulk);\n    }\n    async findDocumentsById(ids: string[], deleted: boolean): Promise<{ [documentId: string]: RxDocumentData<RxDocType> }> {\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('findDocumentsById', [ids, deleted]);\n        }\n\n        const ret: { [documentId: string]: RxDocumentData<RxDocType> } = {};\n        ids.forEach(id => {\n            const documentInDb = localState.collection.by(this.primaryPath, id);\n            if (\n                documentInDb &&\n                (!documentInDb._deleted || deleted)\n            ) {\n                ret[id] = stripLokiKey(documentInDb);\n            }\n        });\n        return ret;\n    }\n    async query(preparedQuery: MangoQuery<RxDocType>): Promise<RxStorageQueryResult<RxDocType>> {\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('query', [preparedQuery]);\n        }\n\n        let query = localState.collection\n            .chain()\n            .find(preparedQuery.selector);\n\n        if (preparedQuery.sort) {\n            query = query.sort(getLokiSortComparator(this.schema, preparedQuery));\n        }\n\n        /**\n         * Offset must be used before limit in LokiJS\n         * @link https://github.com/techfort/LokiJS/issues/570\n         */\n        if (preparedQuery.skip) {\n            query = query.offset(preparedQuery.skip);\n        }\n\n        if (preparedQuery.limit) {\n            query = query.limit(preparedQuery.limit);\n        }\n\n        const foundDocuments = query.data().map(lokiDoc => stripLokiKey(lokiDoc));\n        return {\n            documents: foundDocuments\n        };\n    }\n    getAttachmentData(_documentId: string, _attachmentId: string): Promise<BlobBuffer> {\n        throw new Error('Attachments are not implemented in the lokijs RxStorage. Make a pull request.');\n    }\n    async getChangedDocuments(\n        options: ChangeStreamOnceOptions\n    ): Promise<{\n        changedDocuments: RxStorageChangedDocumentMeta[];\n        lastSequence: number;\n    }> {\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('getChangedDocuments', [options]);\n        }\n\n        const desc = options.direction === 'before';\n        const operator = options.direction === 'after' ? '$gt' : '$lt';\n\n        let query = localState.changesCollection\n            .chain()\n            .find({\n                sequence: {\n                    [operator]: options.sinceSequence\n                }\n            })\n            .simplesort(\n                'sequence',\n                desc\n            );\n        if (options.limit) {\n            query = query.limit(options.limit);\n        }\n        const changedDocuments: RxStorageChangedDocumentMeta[] = query\n            .data()\n            .map(result => ({\n                id: result.id,\n                sequence: result.sequence\n            }));\n\n        const useForLastSequence = !desc ? lastOfArray(changedDocuments) : changedDocuments[0];\n\n        const ret: {\n            changedDocuments: RxStorageChangedDocumentMeta[];\n            lastSequence: number;\n        } = {\n            changedDocuments,\n            lastSequence: useForLastSequence ? useForLastSequence.sequence : options.sinceSequence\n        }\n\n        return ret;\n    }\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>>> {\n        return this.changes$.asObservable();\n    }\n    async close(): Promise<void> {\n        this.closed = true;\n        this.changes$.complete();\n        OPEN_LOKIJS_STORAGE_INSTANCES.delete(this);\n\n        if (this.internals.localState) {\n            const localState = await this.internals.localState;\n            const dbState = await getLokiDatabase(\n                this.databaseName,\n                this.databaseSettings\n            );\n            await dbState.saveQueue.run();\n            await closeLokiCollections(\n                this.databaseName,\n                [\n                    localState.collection,\n                    localState.changesCollection\n                ]\n            );\n        }\n        removeLokiLeaderElectorReference(this.storage, this.databaseName);\n    }\n    async remove(): Promise<void> {\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('remove', []);\n        }\n        localState.databaseState.database.removeCollection(this.collectionName);\n        localState.databaseState.database.removeCollection(localState.changesCollection.name);\n        this.close();\n    }\n}\n\nexport async function createLokiLocalState<RxDocType>(\n    params: RxStorageInstanceCreationParams<RxDocType, LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<LokiLocalDatabaseState> {\n    if (!params.options) {\n        params.options = {};\n    }\n\n    const databaseState = await getLokiDatabase(\n        params.databaseName,\n        databaseSettings\n    );\n\n    /**\n     * Construct loki indexes from RxJsonSchema indexes.\n     * TODO what about compound indexes? Are they possible in lokijs?\n     */\n    const indices: string[] = [];\n    if (params.schema.indexes) {\n        params.schema.indexes.forEach(idx => {\n            if (!Array.isArray(idx)) {\n                indices.push(idx);\n            }\n        });\n    }\n    /**\n     * LokiJS has no concept of custom primary key, they use a number-id that is generated.\n     * To be able to query fast by primary key, we always add an index to the primary.\n     */\n    const primaryKey = getPrimaryFieldOfPrimaryKey(params.schema.primaryKey);\n    indices.push(primaryKey as string);\n\n    /**\n     * TODO disable stuff we do not need from CollectionOptions\n     */\n    const collectionOptions: Partial<CollectionOptions<RxDocumentData<RxDocType>>> = Object.assign(\n        {},\n        params.options.collection,\n        {\n            indices: indices as string[],\n            unique: [primaryKey]\n        } as any,\n        LOKIJS_COLLECTION_DEFAULT_OPTIONS\n    );\n\n    const collection: Collection = databaseState.database.addCollection(\n        params.collectionName,\n        collectionOptions as any\n    );\n    databaseState.collections[params.collectionName] = collection;\n\n    const changesCollectionName = params.collectionName + CHANGES_COLLECTION_SUFFIX;\n    const changesCollectionOptions = Object.assign({\n        unique: ['eventId'],\n        indices: ['sequence']\n    }, LOKIJS_COLLECTION_DEFAULT_OPTIONS)\n    const changesCollection: Collection = databaseState.database.addCollection(\n        changesCollectionName,\n        changesCollectionOptions\n    );\n    databaseState.collections[params.collectionName] = changesCollection;\n\n    const ret: LokiLocalDatabaseState = {\n        databaseState,\n        collection,\n        changesCollection\n    };\n\n    return ret;\n}\n\n\nexport async function createLokiStorageInstance<RxDocType>(\n    storage: RxStorageLoki,\n    params: RxStorageInstanceCreationParams<RxDocType, LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<RxStorageInstanceLoki<RxDocType>> {\n    const internals: LokiStorageInternals = {};\n\n    if (params.multiInstance) {\n        const leaderElector = getLokiLeaderElector(storage, params.databaseName);\n        internals.leaderElector = leaderElector;\n    } else {\n        // optimisation shortcut, directly create db is non multi instance.\n        internals.localState = createLokiLocalState(params, databaseSettings);\n        await internals.localState;\n    }\n\n    const instance = new RxStorageInstanceLoki(\n        storage,\n        params.databaseName,\n        params.collectionName,\n        params.schema,\n        internals,\n        params.options,\n        databaseSettings\n    );\n\n    /**\n     * Directly create the localState if the db becomes leader.\n     */\n    if (params.multiInstance) {\n        ensureNotFalsy(internals.leaderElector)\n            .awaitLeadership()\n            .then(() => {\n                instance.mustUseLocalState();\n            });\n    }\n\n\n    return instance;\n}\n"],"file":"rx-storage-instance-loki.js"}