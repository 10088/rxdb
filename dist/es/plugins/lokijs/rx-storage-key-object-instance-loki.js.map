{"version":3,"sources":["../../../../src/plugins/lokijs/rx-storage-key-object-instance-loki.ts"],"names":["Subject","newRxError","createRevision","ensureNotFalsy","flatClone","now","parseRevision","promiseWait","randomCouchString","CHANGES_COLLECTION_SUFFIX","closeLokiCollections","getLokiDatabase","getLokiEventKey","LOKIJS_COLLECTION_DEFAULT_OPTIONS","LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE","OPEN_LOKIJS_STORAGE_INSTANCES","stripLokiKey","getLeaderElectorByBroadcastChannel","instanceId","RxStorageKeyObjectInstanceLoki","databaseName","collectionName","internals","options","databaseSettings","idleQueue","broadcastChannel","changes$","add","leaderElector","awaitLeadership","then","addEventListener","msg","type","requestId","response","operation","params","isError","result","postMessage","getLocalState","ret","localState","mustUseLocalState","hasLeader","applyOnce","isLeader","createLokiKeyValueLocalState","requestRemoteInstance","responsePromise","Promise","res","rej","listener","removeEventListener","bulkWrite","documentWrites","length","args","startTime","success","Map","error","writeRowById","forEach","writeRow","id","document","_id","set","writeDoc","docInDb","collection","by","previous","newRevHeight","_rev","height","newRevision","err","status","documentId","toLoki","$loki","update","insert","endTime","event","doc","_deleted","previousDoc","eventId","storageChangeEvent","change","next","databaseState","saveQueue","addWrite","findLocalDocumentsById","ids","documentInDb","changeStream","asObservable","close","complete","changesCollection","remove","database","removeCollection","name","collectionOptions","Object","assign","indices","unique","addCollection","collections","changesCollectionName","changesCollectionOptions","createLokiKeyObjectStorageInstance","instance"],"mappings":"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","sourcesContent":["import type { ChangeEvent } from 'event-reduce-js';\nimport { Observable, Subject } from 'rxjs';\nimport { newRxError } from '../../rx-error';\nimport type { BroadcastChannel, LeaderElector } from 'broadcast-channel';\nimport type {\n    BulkWriteLocalRow,\n    LokiDatabaseSettings,\n    LokiLocalDatabaseState,\n    LokiRemoteRequestBroadcastMessage,\n    LokiRemoteResponseBroadcastMessage,\n    LokiSettings,\n    LokiStorageInternals,\n    RxKeyObjectStorageInstanceCreationParams,\n    RxLocalDocumentData,\n    RxLocalStorageBulkWriteResponse,\n    RxStorageBulkWriteLocalError,\n    RxStorageChangeEvent,\n    RxStorageKeyObjectInstance\n} from '../../types';\nimport {\n    createRevision,\n    ensureNotFalsy,\n    flatClone,\n    now,\n    parseRevision,\n    promiseWait,\n    randomCouchString\n} from '../../util';\nimport {\n    CHANGES_COLLECTION_SUFFIX,\n    closeLokiCollections,\n    getLokiDatabase,\n    getLokiEventKey,\n    LOKIJS_COLLECTION_DEFAULT_OPTIONS,\n    LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE,\n    OPEN_LOKIJS_STORAGE_INSTANCES,\n    stripLokiKey\n} from './lokijs-helper';\nimport type {\n    Collection\n} from 'lokijs';\nimport { getLeaderElectorByBroadcastChannel } from '../leader-election';\nimport { IdleQueue } from 'custom-idle-queue';\n\nlet instanceId = 1;\n\nexport class RxStorageKeyObjectInstanceLoki implements RxStorageKeyObjectInstance<LokiStorageInternals, LokiSettings> {\n\n    private changes$: Subject<RxStorageChangeEvent<RxLocalDocumentData>> = new Subject();\n    public readonly leaderElector?: LeaderElector;\n\n    public instanceId = instanceId++;\n\n    constructor(\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly internals: LokiStorageInternals,\n        public readonly options: Readonly<LokiSettings>,\n        public readonly databaseSettings: LokiDatabaseSettings,\n        public readonly idleQueue: IdleQueue,\n        public readonly broadcastChannel?: BroadcastChannel<LokiRemoteRequestBroadcastMessage | LokiRemoteResponseBroadcastMessage>\n    ) {\n        OPEN_LOKIJS_STORAGE_INSTANCES.add(this);\n        if (broadcastChannel) {\n            this.leaderElector = getLeaderElectorByBroadcastChannel(broadcastChannel);\n            this.leaderElector.awaitLeadership().then(() => {\n                // this instance is leader now, so it has to reply to queries from other instances\n                ensureNotFalsy(this.broadcastChannel).addEventListener('message', async (msg) => {\n                    if (\n                        msg.type === LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE &&\n                        msg.requestId &&\n                        msg.databaseName === this.databaseName &&\n                        msg.collectionName === this.collectionName &&\n                        !msg.response\n                    ) {\n                        const operation = (msg as any).operation;\n                        const params = (msg as any).params;\n                        let result: any;\n                        let isError = false;\n                        try {\n                            result = await (this as any)[operation](...params);\n                        } catch (err) {\n                            isError = true;\n                            result = err;\n                        }\n                        const response: LokiRemoteResponseBroadcastMessage = {\n                            response: true,\n                            requestId: msg.requestId,\n                            databaseName: this.databaseName,\n                            collectionName: this.collectionName,\n                            result,\n                            isError,\n                            type: msg.type\n                        };\n                        ensureNotFalsy(this.broadcastChannel).postMessage(response);\n                    }\n                });\n            });\n        }\n    }\n\n    private getLocalState() {\n        const ret = ensureNotFalsy(this.internals.localState);\n        return ret;\n    }\n\n    /**\n     * If the local state must be used, that one is returned.\n     * Returns false if a remote instance must be used.\n     */\n    private async mustUseLocalState(): Promise<LokiLocalDatabaseState | false> {\n        if (this.internals.localState) {\n            return this.internals.localState;\n        }\n        const leaderElector = ensureNotFalsy(this.leaderElector);\n        while (\n            !leaderElector.hasLeader\n        ) {\n            await leaderElector.applyOnce();\n\n            // TODO why do we need this line to pass the tests?\n            // otherwise we somehow do never get a leader.\n            /**\n             * TODO why do we need this line to pass the tests?\n             * Without it, we somehow do never get a leader.\n             * Does applyOnce() fully block the cpu?\n             */\n            await promiseWait(0); // TODO remove this line\n        }\n\n        if (\n            leaderElector.isLeader &&\n            !this.internals.localState\n        ) {\n            // own is leader, use local instance\n            this.internals.localState = createLokiKeyValueLocalState({\n                databaseName: this.databaseName,\n                collectionName: this.collectionName,\n                options: this.options,\n                idleQueue: this.idleQueue,\n                broadcastChannel: this.broadcastChannel\n            }, this.databaseSettings);\n            return this.getLocalState();\n        } else {\n            // other is leader, send message to remote leading instance\n            return false;\n        }\n    }\n\n    private async requestRemoteInstance(\n        operation: string,\n        params: any[]\n    ): Promise<any | any[]> {\n        const broadcastChannel = ensureNotFalsy(this.broadcastChannel);\n        const requestId = randomCouchString(12);\n        const responsePromise = new Promise<any>((res, rej) => {\n            const listener = (msg: any) => {\n                if (\n                    msg.type === LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE &&\n                    msg.response === true &&\n                    msg.requestId === requestId\n                ) {\n                    if (msg.isError) {\n                        broadcastChannel.removeEventListener('message', listener);\n                        rej(msg.result);\n                    } else {\n                        broadcastChannel.removeEventListener('message', listener);\n                        res(msg.result);\n                    }\n                }\n            };\n            broadcastChannel.addEventListener('message', listener);\n        });\n        broadcastChannel.postMessage({\n            response: false,\n            type: LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE,\n            operation,\n            params,\n            requestId,\n            databaseName: this.databaseName,\n            collectionName: this.collectionName\n        });\n        const result = await responsePromise;\n        return result;\n    }\n\n    async bulkWrite<RxDocType>(documentWrites: BulkWriteLocalRow<RxDocType>[]): Promise<RxLocalStorageBulkWriteResponse<RxDocType>> {\n        if (documentWrites.length === 0) {\n            throw newRxError('P2', {\n                args: {\n                    documentWrites\n                }\n            });\n        }\n\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('bulkWrite', [documentWrites]);\n        }\n\n        const startTime = now();\n        await promiseWait(0);\n\n        const ret: RxLocalStorageBulkWriteResponse<RxDocType> = {\n            success: new Map(),\n            error: new Map()\n        };\n        const writeRowById: Map<string, BulkWriteLocalRow<RxDocType>> = new Map();\n        documentWrites.forEach(writeRow => {\n            const id = writeRow.document._id;\n            writeRowById.set(id, writeRow);\n            const writeDoc = flatClone(writeRow.document);\n            const docInDb = localState.collection.by('_id', id);\n            const previous = writeRow.previous ? writeRow.previous : localState.collection.by('_id', id);\n            const newRevHeight = previous ? parseRevision(previous._rev).height + 1 : 1;\n            const newRevision = newRevHeight + '-' + createRevision(writeRow.document);\n            writeDoc._rev = newRevision;\n            if (docInDb) {\n                if (\n                    !writeRow.previous ||\n                    docInDb._rev !== writeRow.previous._rev\n                ) {\n                    // conflict error\n                    const err: RxStorageBulkWriteLocalError<RxDocType> = {\n                        isError: true,\n                        status: 409,\n                        documentId: id,\n                        writeRow: writeRow\n                    };\n                    ret.error.set(id, err);\n                    return;\n                } else {\n                    const toLoki: any = flatClone(writeDoc);\n                    toLoki.$loki = docInDb.$loki;\n                    localState.collection.update(toLoki);\n                }\n            } else {\n                localState.collection.insert(flatClone(writeDoc));\n            }\n\n            ret.success.set(id, stripLokiKey(writeDoc));\n\n            const endTime = now();\n\n            let event: ChangeEvent<RxLocalDocumentData<RxDocType>>;\n            if (!writeRow.previous) {\n                // was insert\n                event = {\n                    operation: 'INSERT',\n                    doc: writeDoc,\n                    id: id,\n                    previous: null\n                };\n            } else if (writeRow.document._deleted) {\n                // was delete\n\n                // we need to add the new revision to the previous doc\n                // so that the eventkey is calculated correctly.\n                // Is this a hack? idk.\n                const previousDoc = flatClone(writeRow.previous);\n                previousDoc._rev = newRevision;\n\n                event = {\n                    operation: 'DELETE',\n                    doc: null,\n                    id,\n                    previous: previousDoc\n                };\n            } else {\n                // was update\n                event = {\n                    operation: 'UPDATE',\n                    doc: writeDoc,\n                    id: id,\n                    previous: writeRow.previous\n                };\n            }\n\n            if (\n                writeRow.document._deleted &&\n                (\n                    !writeRow.previous ||\n                    writeRow.previous._deleted\n                )\n            ) {\n                /**\n                 * An already deleted document was added to the storage engine,\n                 * do not emit an event because it does not affect anything.\n                 */\n            } else {\n                const doc: RxLocalDocumentData<RxDocType> = event.operation === 'DELETE' ? event.previous as any : event.doc as any;\n                const eventId = getLokiEventKey(true, doc._id, doc._rev ? doc._rev : '');\n                const storageChangeEvent: RxStorageChangeEvent<RxLocalDocumentData<RxDocType>> = {\n                    eventId,\n                    documentId: id,\n                    change: event,\n                    startTime,\n                    endTime\n                };\n                this.changes$.next(storageChangeEvent);\n            }\n        });\n\n        localState.databaseState.saveQueue.addWrite();\n\n        return ret;\n    }\n    async findLocalDocumentsById<RxDocType = any>(ids: string[]): Promise<Map<string, RxLocalDocumentData<RxDocType>>> {\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('findLocalDocumentsById', [ids]);\n        }\n\n        await promiseWait(0);\n        const ret: Map<string, RxLocalDocumentData<RxDocType>> = new Map();\n        ids.forEach(id => {\n            const documentInDb = localState.collection.by('_id', id);\n            if (\n                documentInDb &&\n                !documentInDb._deleted\n            ) {\n                ret.set(id, stripLokiKey(documentInDb));\n            }\n        });\n        return ret;\n    }\n    changeStream(): Observable<RxStorageChangeEvent<RxLocalDocumentData<{ [key: string]: any; }>>> {\n        return this.changes$.asObservable();\n    }\n    async close(): Promise<void> {\n        this.changes$.complete();\n        OPEN_LOKIJS_STORAGE_INSTANCES.delete(this);\n        if (this.internals.localState) {\n            const localState = await this.getLocalState();\n            await closeLokiCollections(\n                this.databaseName,\n                [\n                    ensureNotFalsy(localState.collection),\n                    ensureNotFalsy(localState.changesCollection)\n                ]\n            );\n        }\n    }\n    async remove(): Promise<void> {\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('remove', []);\n        }\n        localState.databaseState.database.removeCollection(localState.collection.name);\n        localState.databaseState.database.removeCollection(localState.changesCollection.name);\n    }\n}\n\n\nexport async function createLokiKeyValueLocalState(\n    params: RxKeyObjectStorageInstanceCreationParams<LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<LokiLocalDatabaseState> {\n    if (!params.options) {\n        params.options = {};\n    }\n    const databaseState = await getLokiDatabase(\n        params.databaseName,\n        databaseSettings,\n        params.idleQueue\n    );\n\n    const collectionOptions: Partial<CollectionOptions<RxLocalDocumentData>> = Object.assign(\n        {},\n        params.options.collection,\n        {\n            indices: [],\n            unique: ['_id']\n        } as any,\n        LOKIJS_COLLECTION_DEFAULT_OPTIONS\n    );\n\n    const collection: Collection = databaseState.database.addCollection(\n        params.collectionName,\n        collectionOptions\n    );\n    databaseState.collections[params.collectionName] = collection;\n\n    const changesCollectionName = params.collectionName + CHANGES_COLLECTION_SUFFIX;\n    const changesCollectionOptions = Object.assign({\n        unique: ['eventId'],\n        indices: ['sequence']\n    }, LOKIJS_COLLECTION_DEFAULT_OPTIONS);\n    const changesCollection: Collection = databaseState.database.addCollection(\n        changesCollectionName,\n        changesCollectionOptions\n    );\n    databaseState.collections[changesCollectionName] = collection;\n\n    return {\n        changesCollection,\n        collection,\n        databaseState\n    }\n}\n\nexport async function createLokiKeyObjectStorageInstance(\n    params: RxKeyObjectStorageInstanceCreationParams<LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<RxStorageKeyObjectInstanceLoki> {\n    const internals: LokiStorageInternals = {};\n    // optimisation shortcut, directly create db is non multi instance.\n    if (!params.broadcastChannel) {\n        internals.localState = createLokiKeyValueLocalState(params, databaseSettings);\n        await internals.localState;\n    }\n\n    const instance = new RxStorageKeyObjectInstanceLoki(\n        params.databaseName,\n        params.collectionName,\n        internals,\n        params.options,\n        databaseSettings,\n        params.idleQueue,\n        params.broadcastChannel\n    );\n    return instance;\n}\n"],"file":"rx-storage-key-object-instance-loki.js"}