{"version":3,"sources":["../../../../src/plugins/lokijs/rx-storage-key-object-instance-loki.ts"],"names":["Subject","newRxError","createRevision","ensureNotFalsy","flatClone","now","parseRevision","randomCouchString","CHANGES_COLLECTION_SUFFIX","closeLokiCollections","getLokiDatabase","getLokiEventKey","getLokiLeaderElector","handleRemoteRequest","LOKIJS_COLLECTION_DEFAULT_OPTIONS","mustUseLocalState","OPEN_LOKIJS_STORAGE_INSTANCES","removeLokiLeaderElectorReference","requestRemoteInstance","stripLokiKey","createLokiKeyObjectStorageInstance","storage","params","databaseSettings","instance","RxStorageKeyObjectInstanceLoki","databaseName","collectionName","internals","options","multiInstance","leaderElector","awaitLeadership","then","closed","localState","createLokiKeyValueLocalState","databaseState","collectionOptions","Object","assign","collection","indices","unique","database","addCollection","collections","changesCollectionName","changesCollectionOptions","changesCollection","instanceId","changes$","add","broadcastChannel","addEventListener","msg","bulkWrite","documentWrites","length","args","startTime","ret","success","error","writeRowById","Map","eventBulk","id","events","forEach","writeRow","document","_id","set","writeDoc","docInDb","by","prevDocToGetRevision","previous","newRevHeight","_rev","height","newRevision","err","isError","status","documentId","toLoki","$loki","update","insert","endTime","event","operation","doc","_deleted","previousDoc","eventId","storageChangeEvent","change","push","saveQueue","addWrite","next","findLocalDocumentsById","ids","withDeleted","documentInDb","changeStream","asObservable","close","complete","remove","removeCollection","name"],"mappings":"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","sourcesContent":["import type { ChangeEvent } from 'event-reduce-js';\nimport { Observable, Subject } from 'rxjs';\nimport { newRxError } from '../../rx-error';\nimport type {\n    BulkWriteLocalRow,\n    EventBulk,\n    LokiDatabaseSettings,\n    LokiLocalDatabaseState,\n    LokiSettings,\n    LokiStorageInternals,\n    RxKeyObjectStorageInstanceCreationParams,\n    RxLocalDocumentData,\n    RxLocalStorageBulkWriteResponse,\n    RxStorageBulkWriteLocalError,\n    RxStorageChangeEvent,\n    RxStorageKeyObjectInstance\n} from '../../types';\nimport {\n    createRevision,\n    ensureNotFalsy,\n    flatClone,\n    now,\n    parseRevision,\n    randomCouchString\n} from '../../util';\nimport {\n    CHANGES_COLLECTION_SUFFIX,\n    closeLokiCollections,\n    getLokiDatabase,\n    getLokiEventKey,\n    getLokiLeaderElector,\n    handleRemoteRequest,\n    LOKIJS_COLLECTION_DEFAULT_OPTIONS,\n    mustUseLocalState,\n    OPEN_LOKIJS_STORAGE_INSTANCES,\n    removeLokiLeaderElectorReference,\n    requestRemoteInstance,\n    stripLokiKey\n} from './lokijs-helper';\nimport type {\n    Collection\n} from 'lokijs';\nimport type { RxStorageLoki } from './rx-storage-lokijs';\n\nlet instanceId = 1;\n\nexport class RxStorageKeyObjectInstanceLoki implements RxStorageKeyObjectInstance<LokiStorageInternals, LokiSettings> {\n\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxLocalDocumentData>>> = new Subject();\n\n    public instanceId = instanceId++;\n    public closed = false;\n\n    constructor(\n        public readonly storage: RxStorageLoki,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly internals: LokiStorageInternals,\n        public readonly options: Readonly<LokiSettings>,\n        public readonly databaseSettings: LokiDatabaseSettings\n    ) {\n        OPEN_LOKIJS_STORAGE_INSTANCES.add(this);\n        if (this.internals.leaderElector) {\n            this.internals.leaderElector.awaitLeadership().then(() => {\n                // this instance is leader now, so it has to reply to queries from other instances\n                ensureNotFalsy(this.internals.leaderElector).broadcastChannel\n                    .addEventListener('message', async (msg) => handleRemoteRequest(this, msg));\n            });\n        }\n    }\n\n    async bulkWrite<RxDocType>(documentWrites: BulkWriteLocalRow<RxDocType>[]): Promise<RxLocalStorageBulkWriteResponse<RxDocType>> {\n        if (documentWrites.length === 0) {\n            throw newRxError('P2', {\n                args: {\n                    documentWrites\n                }\n            });\n        }\n\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'bulkWrite', [documentWrites]);\n        }\n\n        const startTime = now();\n        const ret: RxLocalStorageBulkWriteResponse<RxDocType> = {\n            success: {},\n            error: {}\n        };\n        const writeRowById: Map<string, BulkWriteLocalRow<RxDocType>> = new Map();\n        const eventBulk: EventBulk<RxStorageChangeEvent<RxLocalDocumentData>> = {\n            id: randomCouchString(10),\n            events: []\n        };\n        documentWrites.forEach(writeRow => {\n            const id = writeRow.document._id;\n            writeRowById.set(id, writeRow);\n            const writeDoc = flatClone(writeRow.document);\n            const docInDb = localState.collection.by('_id', id);\n\n            const prevDocToGetRevision = writeRow.previous ? writeRow.previous : docInDb;\n            const newRevHeight = prevDocToGetRevision ? parseRevision(prevDocToGetRevision._rev).height + 1 : 1;\n            const newRevision = newRevHeight + '-' + createRevision(writeRow.document);\n            writeDoc._rev = newRevision;\n            if (docInDb) {\n                if (\n                    !writeRow.previous ||\n                    docInDb._rev !== writeRow.previous._rev\n                ) {\n                    // conflict error\n                    const err: RxStorageBulkWriteLocalError<RxDocType> = {\n                        isError: true,\n                        status: 409,\n                        documentId: id,\n                        writeRow: writeRow\n                    };\n                    ret.error[id] = err;\n                    return;\n                } else {\n                    const toLoki: any = flatClone(writeDoc);\n                    toLoki.$loki = docInDb.$loki;\n                    localState.collection.update(toLoki);\n                }\n            } else {\n                localState.collection.insert(writeDoc);\n            }\n\n            ret.success[id] = stripLokiKey(writeDoc as any);\n\n            const endTime = now();\n\n            let event: ChangeEvent<RxLocalDocumentData<RxDocType>>;\n            if (!writeRow.previous) {\n                // was insert\n                event = {\n                    operation: 'INSERT',\n                    doc: writeDoc,\n                    id: id,\n                    previous: null\n                };\n            } else if (writeRow.document._deleted) {\n                // was delete\n\n                // we need to add the new revision to the previous doc\n                // so that the eventkey is calculated correctly.\n                // Is this a hack? idk.\n                const previousDoc = flatClone(writeRow.previous);\n                previousDoc._rev = newRevision;\n\n                event = {\n                    operation: 'DELETE',\n                    doc: null,\n                    id,\n                    previous: previousDoc\n                };\n            } else {\n                // was update\n                event = {\n                    operation: 'UPDATE',\n                    doc: writeDoc,\n                    id: id,\n                    previous: writeRow.previous\n                };\n            }\n\n            if (\n                writeRow.document._deleted &&\n                (\n                    !writeRow.previous ||\n                    writeRow.previous._deleted\n                )\n            ) {\n                /**\n                 * An already deleted document was added to the storage engine,\n                 * do not emit an event because it does not affect anything.\n                 */\n            } else {\n                const doc: RxLocalDocumentData<RxDocType> = event.operation === 'DELETE' ? event.previous as any : event.doc as any;\n                const eventId = getLokiEventKey(true, doc._id, doc._rev ? doc._rev : '');\n                const storageChangeEvent: RxStorageChangeEvent<RxLocalDocumentData<RxDocType>> = {\n                    eventId,\n                    documentId: id,\n                    change: event,\n                    startTime,\n                    endTime\n                };\n                eventBulk.events.push(storageChangeEvent);\n            }\n        });\n\n        localState.databaseState.saveQueue.addWrite();\n        this.changes$.next(eventBulk);\n        return ret;\n    }\n    async findLocalDocumentsById<RxDocType = any>(\n        ids: string[],\n        withDeleted: boolean\n    ): Promise<{ [documentId: string]: RxLocalDocumentData<RxDocType> }> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'findLocalDocumentsById', [ids]);\n        }\n        const ret: { [documentId: string]: RxLocalDocumentData<RxDocType> } = {};\n        ids.forEach(id => {\n            const documentInDb = localState.collection.by('_id', id);\n            if (\n                documentInDb &&\n                (\n                    withDeleted ||\n                    !documentInDb._deleted\n                )\n            ) {\n                ret[id] = stripLokiKey(documentInDb);\n            }\n        });\n        return ret;\n    }\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxLocalDocumentData<{ [key: string]: any; }>>>> {\n        return this.changes$.asObservable();\n    }\n    async close(): Promise<void> {\n        this.closed = true;\n        this.changes$.complete();\n        OPEN_LOKIJS_STORAGE_INSTANCES.delete(this);\n        if (this.internals.localState) {\n            const localState = await ensureNotFalsy(this.internals.localState);\n            await closeLokiCollections(\n                this.databaseName,\n                [\n                    ensureNotFalsy(localState.collection),\n                    ensureNotFalsy(localState.changesCollection)\n                ]\n            );\n        }\n        removeLokiLeaderElectorReference(this.storage, this.databaseName);\n    }\n    async remove(): Promise<void> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'remove', []);\n        }\n        localState.databaseState.database.removeCollection(localState.collection.name);\n        localState.databaseState.database.removeCollection(localState.changesCollection.name);\n        this.close();\n    }\n}\n\n\nexport async function createLokiKeyValueLocalState(\n    params: RxKeyObjectStorageInstanceCreationParams<LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<LokiLocalDatabaseState> {\n    if (!params.options) {\n        params.options = {};\n    }\n    const databaseState = await getLokiDatabase(\n        params.databaseName,\n        databaseSettings\n    );\n\n    const collectionOptions: Partial<CollectionOptions<RxLocalDocumentData>> = Object.assign(\n        {},\n        params.options.collection,\n        {\n            indices: [],\n            unique: ['_id']\n        } as any,\n        LOKIJS_COLLECTION_DEFAULT_OPTIONS\n    );\n\n    const collection: Collection = databaseState.database.addCollection(\n        params.collectionName,\n        collectionOptions\n    );\n    databaseState.collections[params.collectionName] = collection;\n\n    const changesCollectionName = params.collectionName + CHANGES_COLLECTION_SUFFIX;\n    const changesCollectionOptions = Object.assign({\n        unique: ['eventId'],\n        indices: ['sequence']\n    }, LOKIJS_COLLECTION_DEFAULT_OPTIONS);\n    const changesCollection: Collection = databaseState.database.addCollection(\n        changesCollectionName,\n        changesCollectionOptions\n    );\n    databaseState.collections[changesCollectionName] = collection;\n\n    return {\n        changesCollection,\n        collection,\n        databaseState\n    }\n}\n\nexport async function createLokiKeyObjectStorageInstance(\n    storage: RxStorageLoki,\n    params: RxKeyObjectStorageInstanceCreationParams<LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<RxStorageKeyObjectInstanceLoki> {\n    const internals: LokiStorageInternals = {};\n\n\n    if (params.multiInstance) {\n        const leaderElector = getLokiLeaderElector(storage, params.databaseName);\n        internals.leaderElector = leaderElector;\n    } else {\n        // optimisation shortcut, directly create db is non multi instance.\n        internals.localState = createLokiKeyValueLocalState(params, databaseSettings);\n        await internals.localState;\n    }\n\n    const instance = new RxStorageKeyObjectInstanceLoki(\n        storage,\n        params.databaseName,\n        params.collectionName,\n        internals,\n        params.options,\n        databaseSettings\n    );\n\n    /**\n     * Directly create the localState if the db becomes leader.\n     */\n    if (params.multiInstance) {\n        ensureNotFalsy(internals.leaderElector)\n            .awaitLeadership()\n            .then(() => {\n                if (!instance.closed) {\n                    mustUseLocalState(instance);\n                }\n            });\n    }\n\n\n    return instance;\n}\n"],"file":"rx-storage-key-object-instance-loki.js"}