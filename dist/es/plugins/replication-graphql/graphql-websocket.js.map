{"version":3,"file":"graphql-websocket.js","names":["createClient","getFromMapOrThrow","WebSocket","IsomorphicWebSocket","GRAPHQL_WEBSOCKET_BY_URL","Map","getGraphQLWebSocket","url","has","get","wsClient","shouldRetry","webSocketImpl","socket","refCount","set","removeGraphQLWebSocketRef","obj","dispose"],"sources":["../../../../src/plugins/replication-graphql/graphql-websocket.ts"],"sourcesContent":["import { Client, createClient } from 'graphql-ws';\nimport { getFromMapOrThrow } from '../../util';\nimport { WebSocket as IsomorphicWebSocket } from 'isomorphic-ws';\n\n\nexport type WebsocketWithRefCount = {\n    url: string;\n    socket: Client;\n    refCount: number;\n};\n\nexport const GRAPHQL_WEBSOCKET_BY_URL: Map<string, WebsocketWithRefCount> = new Map();\n\n\nexport function getGraphQLWebSocket(\n    url: string\n): Client {\n    let has = GRAPHQL_WEBSOCKET_BY_URL.get(url);\n    if (!has) {\n        const wsClient = createClient({\n            url,\n            shouldRetry: () => true,\n            webSocketImpl: IsomorphicWebSocket,\n        });\n        has = {\n            url,\n            socket: wsClient,\n            refCount: 1\n        };\n        GRAPHQL_WEBSOCKET_BY_URL.set(url, has);\n    } else {\n        has.refCount = has.refCount + 1;\n    }\n    return has.socket;\n}\n\n\nexport function removeGraphQLWebSocketRef(\n    url: string\n) {\n    const obj = getFromMapOrThrow(GRAPHQL_WEBSOCKET_BY_URL, url);\n    obj.refCount = obj.refCount - 1;\n    if (obj.refCount === 0) {\n        GRAPHQL_WEBSOCKET_BY_URL.delete(url);\n        obj.socket.dispose();\n    }\n}\n"],"mappings":"AAAA,SAAiBA,YAAjB,QAAqC,YAArC;AACA,SAASC,iBAAT,QAAkC,YAAlC;AACA,SAASC,SAAS,IAAIC,mBAAtB,QAAiD,eAAjD;AASA,OAAO,IAAMC,wBAA4D,GAAG,IAAIC,GAAJ,EAArE;AAGP,OAAO,SAASC,mBAAT,CACHC,GADG,EAEG;EACN,IAAIC,GAAG,GAAGJ,wBAAwB,CAACK,GAAzB,CAA6BF,GAA7B,CAAV;;EACA,IAAI,CAACC,GAAL,EAAU;IACN,IAAME,QAAQ,GAAGV,YAAY,CAAC;MAC1BO,GAAG,EAAHA,GAD0B;MAE1BI,WAAW,EAAE;QAAA,OAAM,IAAN;MAAA,CAFa;MAG1BC,aAAa,EAAET;IAHW,CAAD,CAA7B;IAKAK,GAAG,GAAG;MACFD,GAAG,EAAHA,GADE;MAEFM,MAAM,EAAEH,QAFN;MAGFI,QAAQ,EAAE;IAHR,CAAN;IAKAV,wBAAwB,CAACW,GAAzB,CAA6BR,GAA7B,EAAkCC,GAAlC;EACH,CAZD,MAYO;IACHA,GAAG,CAACM,QAAJ,GAAeN,GAAG,CAACM,QAAJ,GAAe,CAA9B;EACH;;EACD,OAAON,GAAG,CAACK,MAAX;AACH;AAGD,OAAO,SAASG,yBAAT,CACHT,GADG,EAEL;EACE,IAAMU,GAAG,GAAGhB,iBAAiB,CAACG,wBAAD,EAA2BG,GAA3B,CAA7B;EACAU,GAAG,CAACH,QAAJ,GAAeG,GAAG,CAACH,QAAJ,GAAe,CAA9B;;EACA,IAAIG,GAAG,CAACH,QAAJ,KAAiB,CAArB,EAAwB;IACpBV,wBAAwB,UAAxB,CAAgCG,GAAhC;IACAU,GAAG,CAACJ,MAAJ,CAAWK,OAAX;EACH;AACJ"}