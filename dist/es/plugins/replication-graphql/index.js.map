{"version":3,"file":"index.js","names":["GraphQLClient","objectPath","ensureNotFalsy","fastUnsecureHash","GRAPHQL_REPLICATION_PLUGIN_IDENTITY_PREFIX","RxDBLeaderElectionPlugin","RxReplicationState","startReplicationOnLeaderShip","addRxPlugin","removeGraphQLWebSocketRef","getGraphQLWebSocket","Subject","RxGraphQLReplicationState","url","clientState","replicationIdentifierHash","collection","deletedField","pull","push","live","retryTime","autoStart","setHeaders","headers","client","http","credentials","setCredentials","syncGraphQL","waitForLeadership","mutateableClientState","pullStream$","replicationPrimitivesPull","pullBatchSize","batchSize","handler","lastPulledCheckpoint","queryBuilder","pullGraphQL","query","variables","result","docsData","data","documents","newCheckpoint","checkpoint","errors","dataPath","Object","keys","get","responseModifier","modifier","stream$","asObservable","replicationPrimitivesPush","rows","pushObj","graphqlReplicationState","ws","mustUseSocket","streamQueryBuilder","startBefore","start","bind","wsClient","on","next","subscribe","streamResponse","firstField","error","complete","cancelBefore","cancel","RxDBReplicationGraphQLPlugin","name","init","rxdb","prototypes","RxCollection","proto"],"sources":["../../../../src/plugins/replication-graphql/index.ts"],"sourcesContent":["/**\n * this plugin adds the RxCollection.syncGraphQl()-function to rxdb\n * you can use it to sync collections with remote graphql endpoint\n */\n\nimport GraphQLClient from 'graphql-client';\nimport objectPath from 'object-path';\nimport {\n    ensureNotFalsy,\n    fastUnsecureHash\n} from '../../util';\n\nimport {\n    GRAPHQL_REPLICATION_PLUGIN_IDENTITY_PREFIX\n} from './helper';\n\nimport { RxDBLeaderElectionPlugin } from '../leader-election';\nimport type {\n    RxCollection,\n    RxPlugin,\n    ReplicationPullOptions,\n    ReplicationPushOptions,\n    RxReplicationWriteToMasterRow,\n    GraphQLServerUrl,\n    RxReplicationPullStreamItem\n} from '../../types';\nimport {\n    RxReplicationState,\n    startReplicationOnLeaderShip\n} from '../replication';\nimport {\n    addRxPlugin,\n    SyncOptionsGraphQL,\n    WithDeleted\n} from '../../index';\n\nimport {\n    removeGraphQLWebSocketRef,\n    getGraphQLWebSocket\n} from './graphql-websocket';\nimport { Subject } from 'rxjs';\n\nexport class RxGraphQLReplicationState<RxDocType, CheckpointType> extends RxReplicationState<RxDocType, CheckpointType> {\n    constructor(\n        public readonly url: GraphQLServerUrl,\n        public readonly clientState: { headers: any; client: any, credentials: string | undefined },\n        public readonly replicationIdentifierHash: string,\n        public readonly collection: RxCollection<RxDocType>,\n        public readonly deletedField: string,\n        public readonly pull?: ReplicationPullOptions<RxDocType, CheckpointType>,\n        public readonly push?: ReplicationPushOptions<RxDocType>,\n        public readonly live?: boolean,\n        public retryTime?: number,\n        public autoStart?: boolean\n    ) {\n        super(\n            replicationIdentifierHash,\n            collection,\n            deletedField,\n            pull,\n            push,\n            live,\n            retryTime,\n            autoStart\n        );\n    }\n\n    setHeaders(headers: { [k: string]: string }): void {\n        this.clientState.headers = headers;\n        this.clientState.client = GraphQLClient({\n            url: this.url.http,\n            headers,\n            credentials: this.clientState.credentials\n        });\n    }\n\n    setCredentials(credentials: string | undefined) {\n        this.clientState.credentials = credentials\n        this.clientState.client = GraphQLClient({\n            url: this.url.http,\n            headers: this.clientState.headers,\n            credentials\n        });\n    }\n}\n\nexport function syncGraphQL<RxDocType, CheckpointType>(\n    this: RxCollection,\n    {\n        url,\n        headers = {},\n        credentials,\n        deletedField = '_deleted',\n        waitForLeadership = true,\n        pull,\n        push,\n        live = true,\n        retryTime = 1000 * 5, // in ms\n        autoStart = true,\n    }: SyncOptionsGraphQL<RxDocType, CheckpointType>\n): RxGraphQLReplicationState<RxDocType, CheckpointType> {\n    const collection = this;\n\n    /**\n     * We use this object to store the GraphQL client\n     * so we can later swap out the client inside of the replication handlers.\n     */\n    const mutateableClientState = {\n        headers,\n        credentials,\n        client: GraphQLClient({\n            url: url.http,\n            headers,\n            credentials\n        })\n    };\n\n\n    const pullStream$: Subject<RxReplicationPullStreamItem<RxDocType, CheckpointType>> = new Subject();\n\n    let replicationPrimitivesPull: ReplicationPullOptions<RxDocType, CheckpointType> | undefined;\n    if (pull) {\n        const pullBatchSize = pull.batchSize ? pull.batchSize : 20;\n        replicationPrimitivesPull = {\n            async handler(\n                lastPulledCheckpoint: CheckpointType\n            ) {\n                const pullGraphQL = await pull.queryBuilder(lastPulledCheckpoint, pullBatchSize);\n                const result = await mutateableClientState.client.query(pullGraphQL.query, pullGraphQL.variables);\n                if (result.errors) {\n                    throw result.errors;\n                }\n\n                const dataPath = pull.dataPath || ['data', Object.keys(result.data)[0]];\n                let data: any = objectPath.get(result, dataPath);\n\n                if (pull.responseModifier) {\n                    data = await pull.responseModifier(\n                        data,\n                        'handler',\n                        lastPulledCheckpoint\n                    );\n                }\n\n                const docsData: WithDeleted<RxDocType>[] = data.documents;\n                const newCheckpoint = data.checkpoint;\n\n                return {\n                    documents: docsData,\n                    checkpoint: newCheckpoint\n                }\n            },\n            batchSize: pull.batchSize,\n            modifier: pull.modifier,\n            stream$: pullStream$.asObservable()\n        }\n    }\n    let replicationPrimitivesPush: ReplicationPushOptions<RxDocType> | undefined;\n    if (push) {\n        replicationPrimitivesPush = {\n            async handler(\n                rows: RxReplicationWriteToMasterRow<RxDocType>[]\n            ) {\n                const pushObj = await push.queryBuilder(rows);\n                const result = await mutateableClientState.client.query(pushObj.query, pushObj.variables);\n\n                if (result.errors) {\n                    throw result.errors;\n                }\n                const dataPath = Object.keys(result.data)[0];\n                const data: any = objectPath.get(result.data, dataPath);\n                return data;\n            },\n            batchSize: push.batchSize,\n            modifier: push.modifier\n        };\n    }\n\n    const graphqlReplicationState = new RxGraphQLReplicationState(\n        url,\n        mutateableClientState,\n        GRAPHQL_REPLICATION_PLUGIN_IDENTITY_PREFIX + fastUnsecureHash(url.http ? url.http : url.ws as any),\n        collection,\n        deletedField,\n        replicationPrimitivesPull,\n        replicationPrimitivesPush,\n        live,\n        retryTime,\n        autoStart\n    );\n\n    const mustUseSocket = url.ws &&\n        pull &&\n        pull.streamQueryBuilder &&\n        live;\n\n    const startBefore = graphqlReplicationState.start.bind(graphqlReplicationState);\n    graphqlReplicationState.start = () => {\n        if (mustUseSocket) {\n            const wsClient = getGraphQLWebSocket(ensureNotFalsy(url.ws));\n\n            wsClient.on('connected', () => {\n                pullStream$.next('RESYNC');\n            });\n\n            const query: any = ensureNotFalsy(pull.streamQueryBuilder)(mutateableClientState.headers);\n\n            wsClient.subscribe(\n                query,\n                {\n                    next: async (streamResponse: any) => {\n                        const firstField = Object.keys(streamResponse.data)[0];\n                        let data = streamResponse.data[firstField];\n                        if (pull.responseModifier) {\n                            data = await pull.responseModifier(\n                                data,\n                                'stream'\n                            );\n                        }\n                        pullStream$.next(data);\n                    },\n                    error: (error: any) => {\n                        pullStream$.error(error);\n                    },\n                    complete: () => {\n                        pullStream$.complete();\n                    }\n                });\n        }\n        return startBefore();\n    }\n\n    const cancelBefore = graphqlReplicationState.cancel.bind(graphqlReplicationState);\n    graphqlReplicationState.cancel = () => {\n        pullStream$.complete();\n        if (mustUseSocket) {\n            removeGraphQLWebSocketRef(ensureNotFalsy(url.ws));\n        }\n        return cancelBefore();\n    }\n\n    startReplicationOnLeaderShip(waitForLeadership, graphqlReplicationState);\n    return graphqlReplicationState;\n}\n\nexport * from './helper';\nexport * from './graphql-schema-from-rx-schema';\nexport * from './query-builder-from-rx-schema';\nexport * from './graphql-websocket';\n\nexport const RxDBReplicationGraphQLPlugin: RxPlugin = {\n    name: 'replication-graphql',\n    init() {\n        addRxPlugin(RxDBLeaderElectionPlugin);\n    },\n    rxdb: true,\n    prototypes: {\n        RxCollection: (proto: any) => {\n            proto.syncGraphQL = syncGraphQL;\n        }\n    }\n};\n"],"mappings":"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"}