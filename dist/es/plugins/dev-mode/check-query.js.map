{"version":3,"file":"check-query.js","names":["deepEqual","newRxError","newRxTypeError","massageSelector","checkQuery","args","isPlainObject","Object","prototype","toString","call","queryObj","op","collection","name","validKeys","keys","forEach","key","includes","checkMangoQuery","schema","rxQuery","jsonSchema","massagedSelector","mangoQuery","selector","schemaTopLevelFields","properties","filter","fieldOrOperator","startsWith","field","query","schemaIndexes","indexes","index","isInSchema","find","schemaIndex"],"sources":["../../../../src/plugins/dev-mode/check-query.ts"],"sourcesContent":["import type {\n    RxPluginPreCreateRxQueryArgs,\n    MangoQuery,\n    RxPluginPrePrepareQueryArgs\n} from '../../types';\nimport deepEqual from 'fast-deep-equal';\nimport { newRxError, newRxTypeError } from '../../rx-error';\nimport {\n    massageSelector\n} from 'pouchdb-selector-core';\n\n/**\n * accidentially passing a non-valid object into the query params\n * is very hard to debug especially when queries are observed\n * This is why we do some checks here in dev-mode\n */\nexport function checkQuery(args: RxPluginPreCreateRxQueryArgs) {\n    const isPlainObject = Object.prototype.toString.call(args.queryObj) === '[object Object]';\n    if (!isPlainObject) {\n        throw newRxTypeError('QU11', {\n            op: args.op,\n            collection: args.collection.name,\n            queryObj: args.queryObj\n        });\n    }\n\n    const validKeys: (keyof MangoQuery)[] = [\n        'selector',\n        'limit',\n        'skip',\n        'sort',\n        'index'\n    ];\n    Object.keys(args.queryObj).forEach(key => {\n        if (!(validKeys as string[]).includes(key)) {\n            throw newRxTypeError('QU11', {\n                op: args.op,\n                collection: args.collection.name,\n                queryObj: args.queryObj,\n                key,\n                args: {\n                    validKeys\n                }\n            });\n        }\n    });\n}\n\n\nexport function checkMangoQuery(args: RxPluginPrePrepareQueryArgs) {\n    const schema = args.rxQuery.collection.schema.jsonSchema;\n\n    /**\n     * Ensure that all top level fields are included in the schema.\n     * TODO this check can be augmented to also check sub-fields.\n     */\n    const massagedSelector = massageSelector(args.mangoQuery.selector);\n    const schemaTopLevelFields = Object.keys(schema.properties);\n    Object.keys(massagedSelector)\n        // do not check operators\n        .filter(fieldOrOperator => !fieldOrOperator.startsWith('$'))\n        // skip this check on non-top-level fields\n        .filter(field => !field.includes('.'))\n        .forEach(field => {\n            if (!schemaTopLevelFields.includes(field)) {\n                throw newRxError('QU13', {\n                    schema,\n                    field,\n                    query: args.mangoQuery,\n                });\n            }\n        });\n\n\n    /**\n     * ensure if custom index is set,\n     * it is also defined in the schema\n     */\n    const schemaIndexes = schema.indexes ? schema.indexes : [];\n    const index = args.mangoQuery.index;\n    if (index) {\n        const isInSchema = schemaIndexes.find(schemaIndex => deepEqual(schemaIndex, index));\n        if (!isInSchema) {\n            throw newRxError(\n                'QU12',\n                {\n                    collection: args.rxQuery.collection.name,\n                    query: args.mangoQuery,\n                    schema\n                }\n            );\n        }\n    }\n}\n"],"mappings":"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"}