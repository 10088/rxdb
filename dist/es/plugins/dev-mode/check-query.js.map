{"version":3,"sources":["../../../../src/plugins/dev-mode/check-query.ts"],"names":["deepEqual","newRxError","newRxTypeError","checkQuery","args","isPlainObject","Object","prototype","toString","call","queryObj","op","collection","name","validKeys","keys","forEach","key","includes","checkMangoQuery","schema","rxQuery","normalized","schemaIndexes","indexes","index","mangoQuery","isInSchema","find","schemaIndex","query"],"mappings":"AAKA,OAAOA,SAAP,MAAsB,iBAAtB;AACA,SAASC,UAAT,EAAqBC,cAArB,QAA2C,gBAA3C;AAEA;AACA;AACA;AACA;AACA;;AACA,OAAO,SAASC,UAAT,CAAoBC,IAApB,EAAwD;AAC3D,MAAMC,aAAa,GAAGC,MAAM,CAACC,SAAP,CAAiBC,QAAjB,CAA0BC,IAA1B,CAA+BL,IAAI,CAACM,QAApC,MAAkD,iBAAxE;;AACA,MAAI,CAACL,aAAL,EAAoB;AAChB,UAAMH,cAAc,CAAC,MAAD,EAAS;AACzBS,MAAAA,EAAE,EAAEP,IAAI,CAACO,EADgB;AAEzBC,MAAAA,UAAU,EAAER,IAAI,CAACQ,UAAL,CAAgBC,IAFH;AAGzBH,MAAAA,QAAQ,EAAEN,IAAI,CAACM;AAHU,KAAT,CAApB;AAKH;;AAED,MAAMI,SAA+B,GAAG,CACpC,UADoC,EAEpC,OAFoC,EAGpC,MAHoC,EAIpC,MAJoC,EAKpC,OALoC,CAAxC;AAOAR,EAAAA,MAAM,CAACS,IAAP,CAAYX,IAAI,CAACM,QAAjB,EAA2BM,OAA3B,CAAmC,UAAAC,GAAG,EAAI;AACtC,QAAI,CAAEH,SAAD,CAAwBI,QAAxB,CAAiCD,GAAjC,CAAL,EAA4C;AACxC,YAAMf,cAAc,CAAC,MAAD,EAAS;AACzBS,QAAAA,EAAE,EAAEP,IAAI,CAACO,EADgB;AAEzBC,QAAAA,UAAU,EAAER,IAAI,CAACQ,UAAL,CAAgBC,IAFH;AAGzBH,QAAAA,QAAQ,EAAEN,IAAI,CAACM,QAHU;AAIzBO,QAAAA,GAAG,EAAHA,GAJyB;AAKzBb,QAAAA,IAAI,EAAE;AACFU,UAAAA,SAAS,EAATA;AADE;AALmB,OAAT,CAApB;AASH;AACJ,GAZD;AAaH;AAGD,OAAO,SAASK,eAAT,CAAyBf,IAAzB,EAA4D;AAC/D;AACJ;AACA;AACA;AACI,MAAMgB,MAAM,GAAGhB,IAAI,CAACiB,OAAL,CAAaT,UAAb,CAAwBQ,MAAxB,CAA+BE,UAA9C;AACA,MAAMC,aAAa,GAAGH,MAAM,CAACI,OAAP,GAAiBJ,MAAM,CAACI,OAAxB,GAAkC,EAAxD;AACA,MAAMC,KAAK,GAAGrB,IAAI,CAACsB,UAAL,CAAgBD,KAA9B;;AACA,MAAIA,KAAJ,EAAW;AACP,QAAME,UAAU,GAAGJ,aAAa,CAACK,IAAd,CAAmB,UAAAC,WAAW;AAAA,aAAI7B,SAAS,CAAC6B,WAAD,EAAcJ,KAAd,CAAb;AAAA,KAA9B,CAAnB;;AACA,QAAI,CAACE,UAAL,EAAiB;AACb,YAAM1B,UAAU,CACZ,MADY,EAEZ;AACIW,QAAAA,UAAU,EAAER,IAAI,CAACiB,OAAL,CAAaT,UAAb,CAAwBC,IADxC;AAEIiB,QAAAA,KAAK,EAAE1B,IAAI,CAACsB,UAFhB;AAGIN,QAAAA,MAAM,EAANA;AAHJ,OAFY,CAAhB;AAQH;AACJ;AACJ","sourcesContent":["import type {\n    RxPluginPreCreateRxQueryArgs,\n    MangoQuery,\n    RxPluginPrePrepareQueryArgs\n} from '../../types';\nimport deepEqual from 'fast-deep-equal';\nimport { newRxError, newRxTypeError } from '../../rx-error';\n\n/**\n * accidentially passing a non-valid object into the query params\n * is very hard to debug especially when queries are observed\n * This is why we do some checks here in dev-mode\n */\nexport function checkQuery(args: RxPluginPreCreateRxQueryArgs) {\n    const isPlainObject = Object.prototype.toString.call(args.queryObj) === '[object Object]';\n    if (!isPlainObject) {\n        throw newRxTypeError('QU11', {\n            op: args.op,\n            collection: args.collection.name,\n            queryObj: args.queryObj\n        });\n    }\n\n    const validKeys: (keyof MangoQuery)[] = [\n        'selector',\n        'limit',\n        'skip',\n        'sort',\n        'index'\n    ];\n    Object.keys(args.queryObj).forEach(key => {\n        if (!(validKeys as string[]).includes(key)) {\n            throw newRxTypeError('QU11', {\n                op: args.op,\n                collection: args.collection.name,\n                queryObj: args.queryObj,\n                key,\n                args: {\n                    validKeys\n                }\n            });\n        }\n    });\n}\n\n\nexport function checkMangoQuery(args: RxPluginPrePrepareQueryArgs) {\n    /**\n     * ensure if custom index is set,\n     * it is also defined in the schema\n     */\n    const schema = args.rxQuery.collection.schema.normalized;\n    const schemaIndexes = schema.indexes ? schema.indexes : [];\n    const index = args.mangoQuery.index;\n    if (index) {\n        const isInSchema = schemaIndexes.find(schemaIndex => deepEqual(schemaIndex, index));\n        if (!isInSchema) {\n            throw newRxError(\n                'QU12',\n                {\n                    collection: args.rxQuery.collection.name,\n                    query: args.mangoQuery,\n                    schema\n                }\n            );\n        }\n    }\n}\n"],"file":"check-query.js"}