{"version":3,"file":"index.js","names":["ensureNotFalsy","fastUnsecureHash","flatClone","RxDBLeaderElectionPlugin","RxReplicationState","startReplicationOnLeaderShip","addRxPlugin","newRxError","Subject","couchDBDocToRxDocData","COUCHDB_NEW_REPLICATION_PLUGIN_IDENTITY_PREFIX","mergeUrlQueryParams","pouchSwapPrimaryToId","body","recover","result","e","then","pact","state","value","s","v","o","bind","observer","prototype","onFulfilled","onRejected","callback","_this","thenable","test","update","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","RxCouchDBNewReplicationState","url","fetch","replicationIdentifierHash","collection","pull","push","live","retryTime","autoStart","syncCouchDBNew","options","endsWith","waitForLeadership","pullStream$","replicationPrimitivesPull","handler","lastPulledCheckpoint","batchSize","style","feed","include_docs","since","sequence","heartbeat","limit","seq_interval","replicationState","response","json","jsonResponse","documents","results","map","row","schema","primaryPath","doc","checkpoint","last_seq","modifier","stream$","asObservable","replicationPrimitivesPush","rows","docs","sendDoc","newDocumentState","assumedMasterState","_rev","method","headers","JSON","stringify","responseJson","conflicts","filter","isConflict","error","ok","args","length","getConflictDocsUrl","keys","c","id","conflictResponse","conflictResponseJson","conflictDocsMasterState","r","startBefore","start","isStopped","next","err","RxDBReplicationCouchDBNewPlugin","name","init","rxdb","prototypes","RxCollection","proto"],"sources":["../../../../src/plugins/replication-couchdb-new/index.ts"],"sourcesContent":["/**\n * this plugin adds the RxCollection.syncCouchDBNew()-function to rxdb\n * you can use it to sync collections with a remote CouchDB endpoint.\n */\nimport {\n    ensureNotFalsy,\n    fastUnsecureHash,\n    flatClone\n} from '../../util';\n\nimport { RxDBLeaderElectionPlugin } from '../leader-election';\nimport type {\n    RxCollection,\n    RxPlugin,\n    ReplicationPullOptions,\n    ReplicationPushOptions,\n    RxReplicationWriteToMasterRow,\n    RxReplicationPullStreamItem,\n    PouchdbChangesResult,\n    PouchBulkDocResultRow,\n    PouchAllDocsResponse\n} from '../../types';\nimport {\n    RxReplicationState, startReplicationOnLeaderShip\n} from '../replication';\nimport {\n    addRxPlugin,\n    newRxError,\n    WithDeleted\n} from '../../index';\n\nimport { Subject } from 'rxjs';\nimport type {\n    CouchDBCheckpointType,\n    FetchMethodType,\n    SyncOptionsCouchDBNew\n} from './couchdb-types';\nimport {\n    couchDBDocToRxDocData,\n    COUCHDB_NEW_REPLICATION_PLUGIN_IDENTITY_PREFIX,\n    mergeUrlQueryParams\n} from './couchdb-helper';\nimport { pouchSwapPrimaryToId } from '../pouchdb';\n\nexport * from './couchdb-helper';\nexport * from './couchdb-types';\n\nexport class RxCouchDBNewReplicationState<RxDocType> extends RxReplicationState<RxDocType, CouchDBCheckpointType> {\n    constructor(\n        public readonly url: string,\n        public fetch: FetchMethodType,\n        public readonly replicationIdentifierHash: string,\n        public readonly collection: RxCollection<RxDocType>,\n        public readonly pull?: ReplicationPullOptions<RxDocType, CouchDBCheckpointType>,\n        public readonly push?: ReplicationPushOptions<RxDocType>,\n        public readonly live: boolean = true,\n        public retryTime: number = 1000 * 5,\n        public autoStart: boolean = true\n    ) {\n        super(\n            replicationIdentifierHash,\n            collection,\n            '_deleted',\n            pull,\n            push,\n            live,\n            retryTime,\n            autoStart\n        );\n    }\n}\n\nexport function syncCouchDBNew<RxDocType>(\n    this: RxCollection<RxDocType>,\n    options: SyncOptionsCouchDBNew<RxDocType>\n) {\n    options = flatClone(options);\n    if (!options.url.endsWith('/')) {\n        options.url = options.url + '/';\n    }\n    options.waitForLeadership = typeof options.waitForLeadership === 'undefined' ? true : options.waitForLeadership;\n\n    const collection = this;\n    const pullStream$: Subject<RxReplicationPullStreamItem<RxDocType, CouchDBCheckpointType>> = new Subject();\n    let replicationPrimitivesPull: ReplicationPullOptions<RxDocType, CouchDBCheckpointType> | undefined;\n    if (options.pull) {\n        replicationPrimitivesPull = {\n            async handler(\n                lastPulledCheckpoint: CouchDBCheckpointType | undefined,\n                batchSize: number\n            ) {\n                /**\n                 * @link https://docs.couchdb.org/en/3.2.2-docs/api/database/changes.html\n                 */\n                const url = options.url + '_changes?' + mergeUrlQueryParams({\n                    style: 'all_docs',\n                    feed: 'normal',\n                    include_docs: true,\n                    since: lastPulledCheckpoint ? lastPulledCheckpoint.sequence : 0,\n                    heartbeat: options.pull && options.pull.heartbeat ? options.pull.heartbeat : 60000,\n                    limit: batchSize,\n                    seq_interval: batchSize\n                });\n\n                const response = await replicationState.fetch(url);\n                const jsonResponse: PouchdbChangesResult = await response.json();\n                const documents: WithDeleted<RxDocType>[] = jsonResponse.results\n                    .map(row => couchDBDocToRxDocData(collection.schema.primaryPath, ensureNotFalsy(row.doc)));\n                return {\n                    documents,\n                    checkpoint: {\n                        sequence: jsonResponse.last_seq\n                    }\n                };\n            },\n            batchSize: ensureNotFalsy(options.pull).batchSize,\n            modifier: ensureNotFalsy(options.pull).modifier,\n            stream$: pullStream$.asObservable()\n        };\n    }\n\n    let replicationPrimitivesPush: ReplicationPushOptions<RxDocType> | undefined;\n    if (options.push) {\n        replicationPrimitivesPush = {\n            async handler(\n                rows: RxReplicationWriteToMasterRow<RxDocType>[]\n            ) {\n                /**\n                 * @link https://docs.couchdb.org/en/3.2.2-docs/api/database/bulk-api.html#db-bulk-docs\n                 */\n                const url = options.url + '_bulk_docs?' + mergeUrlQueryParams({});\n                const body = {\n                    docs: rows.map(row => {\n                        const sendDoc = flatClone(row.newDocumentState);\n                        if (row.assumedMasterState) {\n                            (sendDoc as any)._rev = ensureNotFalsy((row.assumedMasterState as any)._rev);\n                        }\n                        return pouchSwapPrimaryToId(collection.schema.primaryPath, sendDoc);\n                    })\n                };\n\n                const response = await replicationState.fetch(\n                    url,\n                    {\n                        method: 'POST',\n                        headers: {\n                            'content-type': 'application/json'\n                        },\n                        body: JSON.stringify(body)\n                    }\n                );\n                const responseJson: PouchBulkDocResultRow[] = await response.json();\n\n                const conflicts = responseJson.filter(row => {\n                    const isConflict = row.error === 'conflict';\n                    if (!row.ok && !isConflict) {\n                        throw newRxError('SNH', { args: { row } });\n                    }\n                    return isConflict;\n                });\n\n                if (conflicts.length === 0) {\n                    return [];\n                }\n\n                const getConflictDocsUrl = options.url + '_all_docs?' + mergeUrlQueryParams({\n                    include_docs: true,\n                    keys: JSON.stringify(conflicts.map(c => c.id))\n                });\n                const conflictResponse = await replicationState.fetch(getConflictDocsUrl);\n                const conflictResponseJson: PouchAllDocsResponse = await conflictResponse.json();\n                const conflictDocsMasterState: WithDeleted<RxDocType>[] = conflictResponseJson.rows\n                    .map(r => couchDBDocToRxDocData(collection.schema.primaryPath, r.doc));\n\n                return conflictDocsMasterState;\n            },\n            batchSize: options.push.batchSize,\n            modifier: options.push.modifier\n        };\n    }\n\n    const replicationState = new RxCouchDBNewReplicationState<RxDocType>(\n        options.url,\n        options.fetch ? options.fetch : fetch,\n        COUCHDB_NEW_REPLICATION_PLUGIN_IDENTITY_PREFIX + fastUnsecureHash(options.url),\n        collection,\n        replicationPrimitivesPull,\n        replicationPrimitivesPush,\n        options.live,\n        options.retryTime,\n        options.autoStart\n    );\n\n    /**\n     * Use long polling to get live changes for the pull.stream$\n     */\n    if (options.live && options.pull) {\n        const startBefore = replicationState.start.bind(replicationState);\n        replicationState.start = () => {\n            let since: string | number = 'now';\n            const batchSize = options.pull && options.pull.batchSize ? options.pull.batchSize : 20;\n\n            (async () => {\n                while (!replicationState.isStopped()) {\n                    const url = options.url + '_changes?' + mergeUrlQueryParams({\n                        style: 'all_docs',\n                        feed: 'longpoll',\n                        since,\n                        include_docs: true,\n                        heartbeat: options.pull && options.pull.heartbeat ? options.pull.heartbeat : 60000,\n                        limit: batchSize,\n                        seq_interval: batchSize\n                    });\n\n                    let jsonResponse: PouchdbChangesResult;\n                    try {\n                        jsonResponse = await (await replicationState.fetch(url)).json();\n                    } catch (err) {\n                        pullStream$.error(err);\n                        continue;\n                    }\n                    const documents: WithDeleted<RxDocType>[] = jsonResponse.results\n                        .map(row => couchDBDocToRxDocData(collection.schema.primaryPath, ensureNotFalsy(row.doc)));\n                    since = jsonResponse.last_seq;\n\n                    pullStream$.next({\n                        documents,\n                        checkpoint: {\n                            sequence: jsonResponse.last_seq\n                        }\n                    });\n                }\n            })();\n            return startBefore();\n        };\n    }\n\n    startReplicationOnLeaderShip(options.waitForLeadership, replicationState);\n\n    return replicationState;\n}\n\n\nexport const RxDBReplicationCouchDBNewPlugin: RxPlugin = {\n    name: 'replication-couchdb-new',\n    init() {\n        addRxPlugin(RxDBLeaderElectionPlugin);\n    },\n    rxdb: true,\n    prototypes: {\n        RxCollection: (proto: any) => {\n            proto.syncCouchDBNew = syncCouchDBNew;\n        }\n    }\n};\n"],"mappings":"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"}