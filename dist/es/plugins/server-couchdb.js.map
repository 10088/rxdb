{"version":3,"file":"server-couchdb.js","names":["os","nodePath","express","corsFn","addPouchPlugin","PouchDB","newRxError","RxDBReplicationCouchDBPlugin","PouchAdapterHttp","adapterObject","addRxPlugin","flatClone","PROMISE_RESOLVE_VOID","pact","state","value","s","v","o","bind","then","observer","prototype","onFulfilled","onRejected","result","callback","e","_this","thenable","test","update","body","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","recover","spawnServer","path","port","cors","startServer","pouchdbExpressOptions","db","collectionsPath","SERVERS_OF_DB","has","set","storage","adapter","Error","adapterObj","pouchDBOptions","Object","assign","prefix","getPrefix","log","pseudo","defaults","app","APP_OF_DB","keys","collections","forEach","colName","tunnelCollectionPath","DBS_WITH_SERVER","add","use","origin","originToSend","usePouchExpressOptions","inMemoryConfig","logPath","join","tmpdir","pouchApp","ExpressPouchDB","server","startupPromise","Promise","res","rej","answered","listen","on","err","get","push","all","values","map","collection","url","name","pingDb","info","close","response","require","error","console","PouchdbAllDbs","WeakMap","WeakSet","normalizeDbName","splitted","split","filter","str","pop","length","ret","startsWith","pathWithSlash","endsWith","collectionPath","req","next","baseUrl","to","schema","version","toFull","originalUrl","replace","res1","setTimeout","ensureNoMoreCollections","args","database","onDestroy","RxDBServerCouchDBPlugin","rxdb","init","prototypes","RxDatabase","proto","serverCouchDB","overwritable","hooks","preDestroyRxDatabase","after","preCreateRxCollection"],"sources":["../../../src/plugins/server-couchdb.ts"],"sourcesContent":["import * as os from 'os';\nimport * as nodePath from 'path';\n\nimport express from 'express';\nimport type { Express } from 'express';\nimport corsFn from 'cors';\n\nimport {\n    addPouchPlugin,\n    PouchDB,\n    RxStoragePouch\n} from '../plugins/pouchdb';\nimport {\n    newRxError\n} from '../rx-error';\nimport type {\n    PouchDBExpressServerOptions,\n    RxDatabase,\n    RxPlugin,\n    CouchDBServerResponse\n} from '../types';\n\nimport { RxDBReplicationCouchDBPlugin } from './replication-couchdb';\n\nimport PouchAdapterHttp from 'pouchdb-adapter-http';\nimport { adapterObject, addRxPlugin } from '../index';\nimport {\n    flatClone, PROMISE_RESOLVE_VOID\n} from '../util';\n\nlet ExpressPouchDB: any;\ntry {\n    ExpressPouchDB = require('express-pouchdb');\n} catch (error) {\n    console.error(\n        'Since version 8.4.0 the module \\'express-pouchdb\\' is not longer delivered with RxDB.\\n' +\n        'You can install it with \\'npm install express-pouchdb\\''\n    );\n}\n\n// we have to clean up after tests so there is no stupid logging\n// @link https://github.com/pouchdb/pouchdb-server/issues/226\nconst PouchdbAllDbs = require('pouchdb-all-dbs');\nPouchdbAllDbs(PouchDB);\n\nconst APP_OF_DB: WeakMap<RxDatabase, Express> = new WeakMap();\nconst SERVERS_OF_DB = new WeakMap();\nconst DBS_WITH_SERVER = new WeakSet();\n\n\nconst normalizeDbName = function (db: RxDatabase) {\n    const splitted = db.name.split('/').filter((str: string) => str !== '');\n    return splitted.pop();\n};\n\nconst getPrefix = function (db: RxDatabase) {\n    const splitted = db.name.split('/').filter((str: string) => str !== '');\n    splitted.pop(); // last was the name\n    if (splitted.length === 0) {\n        return '';\n    }\n    let ret = splitted.join('/') + '/';\n    if (db.name.startsWith('/')) {\n        ret = '/' + ret;\n    }\n    return ret;\n};\n\n/**\n * tunnel requests so collection-names can be used as paths\n */\nfunction tunnelCollectionPath(\n    db: RxDatabase,\n    path: string,\n    app: Express,\n    colName: string\n) {\n    const pathWithSlash = path.endsWith('/') ? path : path + '/';\n    const collectionPath = pathWithSlash + colName;\n    app.use(collectionPath, async function (req: any, res: any, next: any) {\n        if (req.baseUrl.endsWith(collectionPath)) {\n\n            while (!db[colName]) {\n                // if the collection is migrated,\n                // it can happen that it does not exist at this moment\n                await new Promise(res1 => setTimeout(res1, 50));\n            }\n            const to = normalizeDbName(db) + '-rxdb-' + db[colName].schema.version + '-' + colName;\n            const toFull = req.originalUrl.replace(collectionPath, pathWithSlash + to);\n            req.originalUrl = toFull;\n        }\n        next();\n    });\n}\n\nexport async function spawnServer(\n    this: RxDatabase,\n    {\n        path = '/db',\n        port = 3000,\n        cors = false,\n        startServer = true,\n        pouchdbExpressOptions = {}\n    }\n): Promise<CouchDBServerResponse> {\n    const db: RxDatabase = this;\n    const collectionsPath = startServer ? path : '/';\n    if (!SERVERS_OF_DB.has(db)) {\n        SERVERS_OF_DB.set(db, []);\n    }\n\n    const storage: RxStoragePouch = db.storage as any;\n    if (!storage.adapter) {\n        throw new Error('The RxDB server plugin only works with pouchdb storage.');\n    }\n\n    const adapterObj = adapterObject(storage.adapter);\n    const pouchDBOptions = Object.assign(\n        { prefix: getPrefix(db), log: false },\n        adapterObj,\n    );\n\n    const pseudo = PouchDB.defaults(pouchDBOptions);\n\n    const app = express();\n    APP_OF_DB.set(db, app);\n\n    Object.keys(db.collections).forEach(colName => {\n        // tunnel requests so collection-names can be used as paths\n        tunnelCollectionPath(db, collectionsPath, app, colName);\n    });\n\n\n\n    // remember to throw error if collection is created after the server is already there\n    DBS_WITH_SERVER.add(db);\n\n    if (cors) {\n        app.use(corsFn({\n            'origin': function (origin, callback) {\n                const originToSend: any = origin || '*';\n                callback(null, originToSend);\n            },\n            'credentials': true,\n            'methods': 'DELETE,GET,HEAD,OPTIONS,PATCH,POST,PUT',\n        }));\n    }\n\n    /**\n     * Overwrite the defaults of PouchDBExpressServerOptions.\n     * In RxDB the defaults should not polute anything with folders so we store the config in memory\n     * and the logs in the tmp folder of the os.\n     */\n    const usePouchExpressOptions: PouchDBExpressServerOptions = flatClone(pouchdbExpressOptions);\n    if (typeof usePouchExpressOptions.inMemoryConfig === 'undefined') {\n        usePouchExpressOptions.inMemoryConfig = true;\n    }\n    if (typeof usePouchExpressOptions.logPath === 'undefined') {\n        usePouchExpressOptions.logPath = nodePath.join(\n            os.tmpdir(),\n            'rxdb-server-log.txt'\n        );\n    }\n\n    const pouchApp = ExpressPouchDB(pseudo, usePouchExpressOptions);\n\n    app.use(collectionsPath, pouchApp);\n\n    let server = null;\n    let startupPromise: Promise<void> = PROMISE_RESOLVE_VOID;\n    if (startServer) {\n        /**\n         * Listen for errors on server startup.\n         * and properly handle the error instead of returning a startupPromise\n         */\n        startupPromise = new Promise((res, rej) => {\n            let answered = false;\n            server = app.listen(port, () => {\n                if (!answered) {\n                    answered = true;\n                    res();\n                }\n            });\n            server.on('error', (err) => {\n                if (!answered) {\n                    answered = true;\n                    rej(err);\n                }\n            });\n        });\n        SERVERS_OF_DB.get(db).push(server);\n\n        /**\n         * When the database has no documents, there is no db file\n         * and so the replication would not work.\n         * This is a hack which ensures that the couchdb instance exists\n         * and we can replicate even if there is no document in the beginning.\n         */\n        Promise.all(\n            Object.values(db.collections).map(async (collection) => {\n                const url = 'http://0.0.0.0:' + port + collectionsPath + '/' + collection.name;\n                try {\n                    const pingDb = new PouchDB(url);\n                    await pingDb.info();\n                    await pingDb.close();\n                } catch (_err) { }\n            })\n        );\n    }\n\n\n    await startupPromise;\n    const response: CouchDBServerResponse = {\n        app,\n        pouchApp,\n        server\n    };\n    return response;\n}\n\n/**\n * when a server is created, no more collections can be spawned\n */\nfunction ensureNoMoreCollections(args: any) {\n    if (DBS_WITH_SERVER.has(args.database)) {\n        const err = newRxError(\n            'S1', {\n            collection: args.name,\n            database: args.database.name\n        }\n        );\n        throw err;\n    }\n}\n\n/**\n * runs when the database gets destroyed\n */\nexport function onDestroy(db: RxDatabase) {\n    if (SERVERS_OF_DB.has(db)) {\n        SERVERS_OF_DB.get(db).forEach((server: any) => server.close());\n    }\n}\n\nexport const RxDBServerCouchDBPlugin: RxPlugin = {\n    name: 'server-couchdb',\n    rxdb: true,\n    init() {\n        addPouchPlugin(PouchAdapterHttp);\n        addRxPlugin(RxDBReplicationCouchDBPlugin);\n    },\n    prototypes: {\n        RxDatabase: (proto: any) => {\n            proto.serverCouchDB = spawnServer;\n        }\n    },\n    overwritable: {},\n    hooks: {\n        preDestroyRxDatabase: {\n            after: onDestroy\n        },\n        preCreateRxCollection: {\n            after: ensureNoMoreCollections\n        }\n    }\n};\n"],"mappings":"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"}