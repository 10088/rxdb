{"version":3,"file":"index.js","names":["BehaviorSubject","mergeMap","Subject","ensureNotFalsy","fastUnsecureHash","flatClone","PROMISE_RESOLVE_FALSE","PROMISE_RESOLVE_TRUE","awaitRxStorageReplicationFirstInSync","awaitRxStorageReplicationInSync","replicateRxStorageInstance","RX_REPLICATION_META_INSTANCE_SCHEMA","newRxError","DEFAULT_MODIFIER","swapDefaultDeletedTodeletedField","swapdeletedFieldToDefaultDeleted","addConnectedStorageToCollection","body","recover","result","e","then","pact","state","value","s","v","o","bind","observer","prototype","onFulfilled","onRejected","callback","_this","thenable","test","update","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","REPLICATION_STATE_BY_COLLECTION","WeakMap","RxReplicationState","replicationIdentifierHash","collection","deletedField","pull","push","live","retryTime","autoStart","subs","subjects","received","send","error","canceled","active","initialReplicationComplete","received$","asObservable","send$","error$","canceled$","active$","callOnStart","undefined","remoteEvents$","replicationStates","get","set","onDestroy","cancel","Object","keys","forEach","key","defineProperty","startPromise","Promise","res","start","isStopped","pullModifier","modifier","pushModifier","database","metaInstanceCollectionName","name","all","storage","createStorageInstance","databaseName","collectionName","databaseInstanceToken","token","multiInstance","options","schema","metaInstance","internalReplicationState","pushBatchSize","batchSize","pullBatchSize","forkInstance","storageInstance","hashFunction","identifier","conflictHandler","replicationHandler","masterChangeStream$","pipe","ev","useEv","documents","map","doc","d","masterChangesSince","checkpoint","useResult","done","handler","err","emitError","errors","Array","isArray","direction","next","promiseWait","masterWrite","rows","row","newDocumentState","assumedMasterState","useRows","conflicts","pushRows","events","subscribe","processed","down","document","up","writeToMasterRow","stream$","getValue","awaitInitialReplication","awaitInSync","requestIdlePromise","reSync","emitEvent","promises","checkpointQueue","close","sub","unsubscribe","complete","replicateRxCollection","replicationIdentifier","waitForLeadership","join","replicationState","startReplicationOnLeaderShip","mustWaitForLeadership","waitTillRun"],"sources":["../../../../src/plugins/replication/index.ts"],"sourcesContent":["/**\n * This plugin contains the primitives to create\n * a RxDB client-server replication.\n * It is used in the other replication plugins\n * but also can be used as standalone with a custom replication handler.\n */\n\nimport {\n    BehaviorSubject,\n    mergeMap,\n    Observable,\n    Subject,\n    Subscription\n} from 'rxjs';\nimport type {\n    ReplicationOptions,\n    ReplicationPullHandlerResult,\n    ReplicationPullOptions,\n    ReplicationPushOptions,\n    RxCollection,\n    RxDocumentData,\n    RxError,\n    RxReplicationPullStreamItem,\n    RxReplicationWriteToMasterRow,\n    RxStorageInstance,\n    RxStorageInstanceReplicationState,\n    RxStorageReplicationMeta,\n    RxTypeError,\n    WithDeleted\n} from '../../types';\nimport {\n    ensureNotFalsy,\n    fastUnsecureHash,\n    flatClone,\n    PROMISE_RESOLVE_FALSE,\n    PROMISE_RESOLVE_TRUE\n} from '../../util';\nimport {\n    awaitRxStorageReplicationFirstInSync,\n    awaitRxStorageReplicationInSync,\n    replicateRxStorageInstance,\n    RX_REPLICATION_META_INSTANCE_SCHEMA\n} from '../../replication-protocol';\nimport { newRxError } from '../../rx-error';\nimport {\n    DEFAULT_MODIFIER,\n    swapDefaultDeletedTodeletedField,\n    swapdeletedFieldToDefaultDeleted\n} from './replication-helper';\nimport { addConnectedStorageToCollection } from '../../rx-database-internal-store';\n\n\nexport const REPLICATION_STATE_BY_COLLECTION: WeakMap<RxCollection, RxReplicationState<any, any>[]> = new WeakMap();\n\nexport class RxReplicationState<RxDocType, CheckpointType> {\n    public readonly subs: Subscription[] = [];\n    public readonly subjects = {\n        received: new Subject<RxDocumentData<RxDocType>>(), // all documents that are received from the endpoint\n        send: new Subject<WithDeleted<RxDocType>>(), // all documents that are send to the endpoint\n        error: new Subject<RxError | RxTypeError>(), // all errors that are received from the endpoint, emits new Error() objects\n        canceled: new BehaviorSubject<boolean>(false), // true when the replication was canceled\n        active: new BehaviorSubject<boolean>(false), // true when something is running, false when not\n        initialReplicationComplete: new BehaviorSubject<boolean>(false) // true the initial replication-cycle is over\n    };\n\n\n    readonly received$: Observable<RxDocumentData<RxDocType>> = this.subjects.received.asObservable();\n    readonly send$: Observable<WithDeleted<RxDocType>> = this.subjects.send.asObservable();\n    readonly error$: Observable<RxError | RxTypeError> = this.subjects.error.asObservable();\n    readonly canceled$: Observable<any> = this.subjects.canceled.asObservable();\n    readonly active$: Observable<boolean> = this.subjects.active.asObservable();\n\n    private startPromise: Promise<void>;\n    constructor(\n        /**\n         * hash of the identifier, used to flag revisions\n         * and to identify which documents state came from the remote.\n         */\n        public readonly replicationIdentifierHash: string,\n        public readonly collection: RxCollection<RxDocType>,\n        public readonly deletedField: string,\n        public readonly pull?: ReplicationPullOptions<RxDocType, CheckpointType>,\n        public readonly push?: ReplicationPushOptions<RxDocType>,\n        public readonly live?: boolean,\n        public retryTime?: number,\n        public autoStart?: boolean,\n    ) {\n        let replicationStates = REPLICATION_STATE_BY_COLLECTION.get(collection);\n        if (!replicationStates) {\n            replicationStates = [];\n            REPLICATION_STATE_BY_COLLECTION.set(collection, replicationStates);\n        }\n        replicationStates.push(this);\n\n\n        // stop the replication when the collection gets destroyed\n        this.collection.onDestroy.push(() => this.cancel());\n\n        // create getters for the observables\n        Object.keys(this.subjects).forEach(key => {\n            Object.defineProperty(this, key + '$', {\n                get: function () {\n                    return this.subjects[key].asObservable();\n                }\n            });\n        });\n\n        const startPromise = new Promise<void>(res => {\n            this.callOnStart = res;\n        });\n        this.startPromise = startPromise;\n    }\n\n    private callOnStart: () => void = undefined as any;\n\n    public internalReplicationState?: RxStorageInstanceReplicationState<RxDocType>;\n    public metaInstance?: RxStorageInstance<RxStorageReplicationMeta, any, {}, any>;\n    public remoteEvents$: Subject<RxReplicationPullStreamItem<RxDocType, CheckpointType>> = new Subject();\n\n    public async start(): Promise<void> {\n        if (this.isStopped()) {\n            return;\n        }\n\n        // fill in defaults for pull & push\n        const pullModifier = this.pull && this.pull.modifier ? this.pull.modifier : DEFAULT_MODIFIER;\n        const pushModifier = this.push && this.push.modifier ? this.push.modifier : DEFAULT_MODIFIER;\n\n        const database = this.collection.database;\n\n        const metaInstanceCollectionName = this.collection.name + '-rx-replication-' + this.replicationIdentifierHash;\n\n        const [metaInstance] = await Promise.all([\n            this.collection.database.storage.createStorageInstance({\n                databaseName: database.name,\n                collectionName: metaInstanceCollectionName,\n                databaseInstanceToken: database.token,\n                multiInstance: database.multiInstance, // TODO is this always false?\n                options: {},\n                schema: RX_REPLICATION_META_INSTANCE_SCHEMA\n            }),\n            addConnectedStorageToCollection(\n                this.collection,\n                metaInstanceCollectionName,\n                RX_REPLICATION_META_INSTANCE_SCHEMA\n            )\n        ]);\n        this.metaInstance = metaInstance;\n\n\n        this.internalReplicationState = replicateRxStorageInstance({\n            pushBatchSize: this.push && this.push.batchSize ? this.push.batchSize : 100,\n            pullBatchSize: this.pull && this.pull.batchSize ? this.pull.batchSize : 100,\n            forkInstance: this.collection.storageInstance,\n            metaInstance: this.metaInstance,\n            hashFunction: database.hashFunction,\n            identifier: 'rx-replication-' + this.replicationIdentifierHash,\n            conflictHandler: this.collection.conflictHandler,\n            replicationHandler: {\n                masterChangeStream$: this.remoteEvents$.asObservable().pipe(\n                    mergeMap(async (ev) => {\n                        if (ev === 'RESYNC') {\n                            return ev;\n                        }\n                        const useEv = flatClone(ev);\n                        if (this.deletedField !== '_deleted') {\n                            useEv.documents = useEv.documents.map(doc => swapdeletedFieldToDefaultDeleted(this.deletedField, doc))\n                        }\n                        useEv.documents = await Promise.all(\n                            useEv.documents.map(d => pullModifier(d))\n                        );\n                        return useEv;\n                    })\n                ),\n                masterChangesSince: async (\n                    checkpoint: CheckpointType,\n                    batchSize: number\n                ) => {\n                    if (!this.pull) {\n                        return {\n                            checkpoint: null,\n                            documents: []\n                        };\n                    }\n\n                    /**\n                     * Retries must be done here in the replication primitives plugin,\n                     * because the replication protocol itself has no\n                     * error handling.\n                     */\n                    let done = false;\n                    let result: ReplicationPullHandlerResult<RxDocType, CheckpointType> = {} as any;\n                    while (!done && !this.isStopped()) {\n                        try {\n                            result = await this.pull.handler(\n                                checkpoint,\n                                batchSize\n                            );\n                            done = true;\n                        } catch (err: any | Error | Error[]) {\n                            const emitError = newRxError('RC_PULL', {\n                                checkpoint,\n                                errors: Array.isArray(err) ? err : [err],\n                                direction: 'pull'\n                            });\n                            this.subjects.error.next(emitError);\n                            await this.collection.promiseWait(ensureNotFalsy(this.retryTime));\n                        }\n                    }\n\n                    if (this.isStopped()) {\n                        return {\n                            checkpoint: null,\n                            documents: []\n                        };\n                    }\n\n                    const useResult = flatClone(result);\n                    if (this.deletedField !== '_deleted') {\n                        useResult.documents = useResult.documents.map(doc => swapdeletedFieldToDefaultDeleted(this.deletedField, doc))\n                    }\n                    useResult.documents = await Promise.all(\n                        useResult.documents.map(d => pullModifier(d))\n                    );\n\n                    return useResult;\n                },\n                masterWrite: async (\n                    rows: RxReplicationWriteToMasterRow<RxDocType>[]\n                ) => {\n                    if (!this.push) {\n                        return [];\n                    }\n                    let done = false;\n                    const useRows = await Promise.all(\n                        rows.map(async (row) => {\n                            row.newDocumentState = await pushModifier(row.newDocumentState);\n                            if (row.assumedMasterState) {\n                                row.assumedMasterState = await pushModifier(row.assumedMasterState);\n                            }\n\n                            if (this.deletedField !== '_deleted') {\n                                row.newDocumentState = swapDefaultDeletedTodeletedField(this.deletedField, row.newDocumentState) as any;\n                                if (row.assumedMasterState) {\n                                    row.assumedMasterState = swapDefaultDeletedTodeletedField(this.deletedField, row.assumedMasterState) as any;\n                                }\n                            }\n\n                            return row;\n                        })\n                    );\n\n                    let result: WithDeleted<RxDocType>[] = {} as any;\n                    while (!done && !this.isStopped()) {\n                        try {\n                            result = await this.push.handler(useRows);\n                            done = true;\n                        } catch (err: any | Error | Error[]) {\n                            const emitError = newRxError('RC_PUSH', {\n                                pushRows: rows,\n                                errors: Array.isArray(err) ? err : [err],\n                                direction: 'push'\n                            });\n                            this.subjects.error.next(emitError);\n                            await this.collection.promiseWait(ensureNotFalsy(this.retryTime));\n                        }\n                    }\n\n                    if (this.isStopped()) {\n                        return [];\n                    }\n\n                    const conflicts = ensureNotFalsy(result).map(doc => swapdeletedFieldToDefaultDeleted(this.deletedField, doc));\n                    return conflicts;\n                }\n            }\n        });\n        this.subs.push(\n            this.internalReplicationState.events.error.subscribe(err => {\n                this.subjects.error.next(err);\n            })\n        );\n        this.subs.push(\n            this.internalReplicationState.events.processed.down\n                .subscribe(row => this.subjects.received.next(row.document))\n        );\n        this.subs.push(\n            this.internalReplicationState.events.processed.up\n                .subscribe(writeToMasterRow => {\n                    this.subjects.send.next(writeToMasterRow.newDocumentState);\n                })\n        );\n        if (\n            this.pull &&\n            this.pull.stream$ &&\n            this.live\n        ) {\n            this.subs.push(\n                this.pull.stream$.subscribe({\n                    next: ev => {\n                        this.remoteEvents$.next(ev);\n                    },\n                    error: err => {\n                        this.subjects.error.next(err);\n                    }\n                })\n            );\n        }\n\n        if (!this.live) {\n            await awaitRxStorageReplicationFirstInSync(this.internalReplicationState);\n            await this.cancel();\n        }\n        this.callOnStart();\n    }\n\n    isStopped(): boolean {\n        if (this.subjects.canceled.getValue()) {\n            return true;\n        }\n        return false;\n    }\n\n    async awaitInitialReplication(): Promise<void> {\n        await this.startPromise;\n        return awaitRxStorageReplicationFirstInSync(\n            ensureNotFalsy(this.internalReplicationState)\n        );\n    }\n\n    /**\n     * Returns a promise that resolves when:\n     * - All local data is replicated with the remote\n     * - No replication cycle is running or in retry-state\n     *\n     * WARNING: USing this function directly in a multi-tab browser application\n     * is dangerous because only the leading instance will ever be replicated,\n     * so this promise will not resolve in the other tabs.\n     * For multi-tab support you should set and observe a flag in a local document.\n     */\n    async awaitInSync(): Promise<true> {\n        await this.startPromise;\n        await awaitRxStorageReplicationFirstInSync(ensureNotFalsy(this.internalReplicationState));\n\n        /**\n         * Often awaitInSync() is called directly after a document write,\n         * like in the unit tests.\n         * So we first have to await the idleness to ensure that all RxChangeEvents\n         * are processed already.\n         */\n        await this.collection.database.requestIdlePromise();\n\n        await awaitRxStorageReplicationInSync(ensureNotFalsy(this.internalReplicationState));\n\n        return true;\n    }\n\n    reSync() {\n        this.remoteEvents$.next('RESYNC');\n    }\n    emitEvent(ev: RxReplicationPullStreamItem<RxDocType, CheckpointType>) {\n        this.remoteEvents$.next(ev);\n    }\n\n    cancel(): Promise<any> {\n        if (this.isStopped()) {\n            return PROMISE_RESOLVE_FALSE;\n        }\n\n        const promises: Promise<any>[] = [];\n\n        if (this.internalReplicationState) {\n            this.internalReplicationState.events.canceled.next(true);\n        }\n        if (this.metaInstance) {\n            promises.push(\n                ensureNotFalsy(this.internalReplicationState).checkpointQueue\n                    .then(() => ensureNotFalsy(this.metaInstance).close())\n            );\n        }\n\n        this.subs.forEach(sub => sub.unsubscribe());\n        this.subjects.canceled.next(true);\n\n        this.subjects.active.complete();\n        this.subjects.canceled.complete();\n        this.subjects.error.complete();\n        this.subjects.received.complete();\n        this.subjects.send.complete();\n\n        return Promise.all(promises);\n    }\n}\n\n\nexport function replicateRxCollection<RxDocType, CheckpointType>(\n    {\n        replicationIdentifier,\n        collection,\n        deletedField = '_deleted',\n        pull,\n        push,\n        live = true,\n        retryTime = 1000 * 5,\n        waitForLeadership = true,\n        autoStart = true,\n    }: ReplicationOptions<RxDocType, CheckpointType>\n): RxReplicationState<RxDocType, CheckpointType> {\n    const replicationIdentifierHash = fastUnsecureHash(\n        [\n            collection.database.name,\n            collection.name,\n            replicationIdentifier\n        ].join('|')\n    );\n    const replicationState = new RxReplicationState<RxDocType, CheckpointType>(\n        replicationIdentifierHash,\n        collection,\n        deletedField,\n        pull,\n        push,\n        live,\n        retryTime,\n        autoStart\n    );\n\n\n    startReplicationOnLeaderShip(waitForLeadership, replicationState);\n    return replicationState as any;\n}\n\n\nexport function startReplicationOnLeaderShip(\n    waitForLeadership: boolean,\n    replicationState: RxReplicationState<any, any>\n) {\n    /**\n     * Always await this Promise to ensure that the current instance\n     * is leader when waitForLeadership=true\n     */\n    const mustWaitForLeadership = waitForLeadership && replicationState.collection.database.multiInstance;\n    const waitTillRun: Promise<any> = mustWaitForLeadership ? replicationState.collection.database.waitForLeadership() : PROMISE_RESOLVE_TRUE;\n    return waitTillRun.then(() => {\n        if (replicationState.isStopped()) {\n            return;\n        }\n        if (replicationState.autoStart) {\n            replicationState.start();\n        }\n    });\n}\n"],"mappings":"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"}