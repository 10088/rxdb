{"version":3,"file":"rx-query-helper.js","names":["getPrimaryFieldOfPrimaryKey","firstPropertyNameOfObject","flatClone","normalizeMangoQuery","schema","mangoQuery","primaryKey","skip","sort","isPrimaryInSort","find","p","slice","push","index","indexAr","Array","isArray","includes"],"sources":["../../src/rx-query-helper.ts"],"sourcesContent":["import { getPrimaryFieldOfPrimaryKey } from './rx-schema-helper';\nimport type { FilledMangoQuery, MangoQuery, RxDocumentData, RxJsonSchema } from './types';\nimport { firstPropertyNameOfObject, flatClone } from './util';\n\n/**\n * Normalize the query to ensure we have all fields set\n * and queries that represent the same query logic are detected as equal by the caching.\n */\nexport function normalizeMangoQuery<RxDocType>(\n    schema: RxJsonSchema<RxDocumentData<RxDocType>>,\n    mangoQuery: MangoQuery<RxDocType>\n): FilledMangoQuery<RxDocType> {\n    const primaryKey: string = getPrimaryFieldOfPrimaryKey(schema.primaryKey);\n    mangoQuery = flatClone(mangoQuery);\n\n    if (typeof mangoQuery.skip !== 'number') {\n        mangoQuery.skip = 0;\n    }\n\n    /**\n     * To ensure a deterministic sorting,\n     * we have to ensure the primary key is always part\n     * of the sort query.\n     * Primary sorting is added as last sort parameter,\n     * similiar to how we add the primary key to indexes that do not have it.\n     */\n    if (!mangoQuery.sort) {\n        mangoQuery.sort = [{ [primaryKey]: 'asc' }] as any;\n    } else {\n        const isPrimaryInSort = mangoQuery.sort\n            .find(p => firstPropertyNameOfObject(p) === primaryKey);\n        if (!isPrimaryInSort) {\n            mangoQuery.sort = mangoQuery.sort.slice(0);\n            mangoQuery.sort.push({ [primaryKey]: 'asc' } as any);\n        }\n    }\n\n    /**\n     * Ensure that if an index is specified,\n     * the primaryKey is inside of it.\n     */\n    if (mangoQuery.index) {\n        const indexAr = Array.isArray(mangoQuery.index) ? mangoQuery.index.slice(0) : [mangoQuery.index];\n        if (!indexAr.includes(primaryKey)) {\n            indexAr.push(primaryKey);\n        }\n        mangoQuery.index = indexAr;\n    }\n\n    return mangoQuery as any;\n}\n"],"mappings":"AAAA,SAASA,2BAAT,QAA4C,oBAA5C;AAEA,SAASC,yBAAT,EAAoCC,SAApC,QAAqD,QAArD;AAEA;AACA;AACA;AACA;;AACA,OAAO,SAASC,mBAAT,CACHC,MADG,EAEHC,UAFG,EAGwB;EAC3B,IAAMC,UAAkB,GAAGN,2BAA2B,CAACI,MAAM,CAACE,UAAR,CAAtD;EACAD,UAAU,GAAGH,SAAS,CAACG,UAAD,CAAtB;;EAEA,IAAI,OAAOA,UAAU,CAACE,IAAlB,KAA2B,QAA/B,EAAyC;IACrCF,UAAU,CAACE,IAAX,GAAkB,CAAlB;EACH;EAED;AACJ;AACA;AACA;AACA;AACA;AACA;;;EACI,IAAI,CAACF,UAAU,CAACG,IAAhB,EAAsB;IAAA;;IAClBH,UAAU,CAACG,IAAX,GAAkB,kBAAIF,UAAJ,IAAiB,KAAjB,QAAlB;EACH,CAFD,MAEO;IACH,IAAMG,eAAe,GAAGJ,UAAU,CAACG,IAAX,CACnBE,IADmB,CACd,UAAAC,CAAC;MAAA,OAAIV,yBAAyB,CAACU,CAAD,CAAzB,KAAiCL,UAArC;IAAA,CADa,CAAxB;;IAEA,IAAI,CAACG,eAAL,EAAsB;MAAA;;MAClBJ,UAAU,CAACG,IAAX,GAAkBH,UAAU,CAACG,IAAX,CAAgBI,KAAhB,CAAsB,CAAtB,CAAlB;MACAP,UAAU,CAACG,IAAX,CAAgBK,IAAhB,oDAAwBP,UAAxB,IAAqC,KAArC;IACH;EACJ;EAED;AACJ;AACA;AACA;;;EACI,IAAID,UAAU,CAACS,KAAf,EAAsB;IAClB,IAAMC,OAAO,GAAGC,KAAK,CAACC,OAAN,CAAcZ,UAAU,CAACS,KAAzB,IAAkCT,UAAU,CAACS,KAAX,CAAiBF,KAAjB,CAAuB,CAAvB,CAAlC,GAA8D,CAACP,UAAU,CAACS,KAAZ,CAA9E;;IACA,IAAI,CAACC,OAAO,CAACG,QAAR,CAAiBZ,UAAjB,CAAL,EAAmC;MAC/BS,OAAO,CAACF,IAAR,CAAaP,UAAb;IACH;;IACDD,UAAU,CAACS,KAAX,GAAmBC,OAAnB;EACH;;EAED,OAAOV,UAAP;AACH"}