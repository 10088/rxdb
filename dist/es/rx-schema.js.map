{"version":3,"sources":["../../src/rx-schema.ts"],"names":["deepEqual","clone","hash","sortObject","overwriteGetterForCaching","flatClone","isMaybeReadonlyArray","newRxError","runPluginHooks","defineGetterSetter","getComposedPrimaryKeyOfDocumentData","getPrimaryFieldOfPrimaryKey","RxSchema","jsonSchema","indexes","getIndexes","primaryPath","primaryKey","finalFields","getFinalFields","required","concat","filter","field","includes","elem","pos","arr","indexOf","validateChange","dataBefore","dataAfter","forEach","fieldName","schema","validate","_obj","_schemaPath","fillObjectWithDefaults","obj","Object","entries","defaultValues","k","hasOwnProperty","v","getDocumentPrototype","proto","getPrimaryOfDocumentData","documentData","version","normalizeRxJsonSchema","values","normalized","properties","encrypted","length","attachments","map","index","getPreviousVersions","c","Array","fill","ret","keys","key","push","fields","normalizedSchema","from","arIndex","modifiedIndex","slice","RX_META_SCHEMA","type","lwt","minimum","additionalProperties","fillWithDefaultSettings","schemaObj","keyCompression","_rev","minLength","_attachments","_deleted","_meta","createRxSchema","runPreCreateHooks","isInstanceOf","toTypedRxJsonSchema"],"mappings":"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","sourcesContent":["import deepEqual from 'fast-deep-equal';\n\nimport {\n    clone,\n    hash,\n    sortObject,\n    overwriteGetterForCaching,\n    flatClone, isMaybeReadonlyArray\n} from './util';\nimport {\n    newRxError,\n} from './rx-error';\nimport {\n    runPluginHooks\n} from './hooks';\nimport {\n    defineGetterSetter\n} from './rx-document';\n\nimport type {\n    CompositePrimaryKey,\n    DeepMutable,\n    DeepReadonly, JsonSchema, MaybeReadonly,\n    RxJsonSchema\n} from './types';\nimport { getComposedPrimaryKeyOfDocumentData, getPrimaryFieldOfPrimaryKey } from './rx-schema-helper';\n\nexport class RxSchema<T = any> {\n    public indexes: MaybeReadonly<string[]>[];\n    public primaryPath: keyof T;\n    public finalFields: string[];\n\n    constructor(\n        public readonly jsonSchema: RxJsonSchema<T>\n    ) {\n        this.indexes = getIndexes(this.jsonSchema);\n\n        // primary is always required\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.jsonSchema.primaryKey);\n\n        // final fields are always required\n        this.finalFields = getFinalFields(this.jsonSchema);\n\n        this.jsonSchema.required = (this.jsonSchema as any).required\n            .concat(this.finalFields)\n            .filter((field: string) => !field.includes('.'))\n            .filter((elem: any, pos: any, arr: any) => arr.indexOf(elem) === pos); // unique;\n    }\n\n    public get version(): number {\n        return this.jsonSchema.version;\n    }\n\n    get normalized(): RxJsonSchema<T> {\n        return overwriteGetterForCaching(\n            this,\n            'normalized',\n            normalizeRxJsonSchema(this.jsonSchema)\n        );\n    }\n\n    public get defaultValues(): { [P in keyof T]: T[P] } {\n        const values = {} as { [P in keyof T]: T[P] };\n        Object\n            .entries(this.normalized.properties)\n            .filter(([, v]) => (v as any).hasOwnProperty('default'))\n            .forEach(([k, v]) => (values as any)[k] = (v as any).default);\n        return overwriteGetterForCaching(\n            this,\n            'defaultValues',\n            values\n        );\n    }\n\n    /**\n        * true if schema contains at least one encrypted path\n        */\n    get crypt(): boolean {\n        if (\n            !!this.jsonSchema.encrypted && this.jsonSchema.encrypted.length > 0 ||\n            this.jsonSchema.attachments && this.jsonSchema.attachments.encrypted\n        ) {\n            return true;\n        } else {\n            return false;\n        }\n    }\n\n    /**\n     * @overrides itself on the first call\n     */\n    public get hash(): string {\n        return overwriteGetterForCaching(\n            this,\n            'hash',\n            hash(this.normalized)\n        );\n    }\n\n    /**\n     * checks if a given change on a document is allowed\n     * Ensures that:\n     * - primary is not modified\n     * - final fields are not modified\n     * @throws {Error} if not valid\n     */\n    validateChange(dataBefore: any, dataAfter: any): void {\n        this.finalFields.forEach(fieldName => {\n            if (!deepEqual(dataBefore[fieldName], dataAfter[fieldName])) {\n                throw newRxError('DOC9', {\n                    dataBefore,\n                    dataAfter,\n                    fieldName,\n                    schema: this.jsonSchema\n                });\n            }\n        });\n    }\n\n    /**\n     * validate if the obj matches the schema\n     * @overwritten by plugin (required)\n     * @param schemaPath if given, validates agains deep-path of schema\n     * @throws {Error} if not valid\n     * @param obj equal to input-obj\n     */\n    public validate(_obj: any, _schemaPath?: string): void {\n        /**\n         * This method might be overwritten by a validation plugin,\n         * otherwise do nothing.\n         */\n    }\n\n    /**\n     * fills all unset fields with default-values if set\n     */\n    fillObjectWithDefaults(obj: any): any {\n        obj = flatClone(obj);\n        Object\n            .entries(this.defaultValues)\n            .filter(([k]) => !obj.hasOwnProperty(k) || typeof obj[k] === 'undefined')\n            .forEach(([k, v]) => obj[k] = v);\n        return obj;\n    }\n\n    /**\n     * creates the schema-based document-prototype,\n     * see RxCollection.getDocumentPrototype()\n     */\n    public getDocumentPrototype(): any {\n        const proto = {};\n        defineGetterSetter(this, proto, '');\n        overwriteGetterForCaching(\n            this,\n            'getDocumentPrototype',\n            () => proto\n        );\n        return proto;\n    }\n\n\n    getPrimaryOfDocumentData(\n        documentData: Partial<T>\n    ): string {\n        return getComposedPrimaryKeyOfDocumentData(\n            this.jsonSchema,\n            documentData\n        );\n    }\n}\n\nexport function getIndexes<T = any>(\n    jsonSchema: RxJsonSchema<T>\n): MaybeReadonly<string[]>[] {\n    return (jsonSchema.indexes || []).map(index => isMaybeReadonlyArray(index) ? index : [index]);\n}\n\n/**\n * array with previous version-numbers\n */\nexport function getPreviousVersions(schema: RxJsonSchema<any>): number[] {\n    const version = schema.version ? schema.version : 0;\n    let c = 0;\n    return new Array(version)\n        .fill(0)\n        .map(() => c++);\n}\n\n/**\n * returns the final-fields of the schema\n * @return field-names of the final-fields\n */\nexport function getFinalFields<T = any>(\n    jsonSchema: RxJsonSchema<T>\n): string[] {\n    const ret = Object.keys(jsonSchema.properties)\n        .filter(key => (jsonSchema as any).properties[key].final);\n\n    // primary is also final\n    const primaryPath = getPrimaryFieldOfPrimaryKey(jsonSchema.primaryKey);\n    ret.push(primaryPath as string);\n\n    // fields of composite primary are final\n    if (typeof jsonSchema.primaryKey !== 'string') {\n        (jsonSchema.primaryKey as CompositePrimaryKey<T>).fields\n            .forEach(field => ret.push(field as string));\n    }\n\n    return ret;\n}\n\n/**\n * Normalize the RxJsonSchema.\n * We need this to ensure everything is set up properly\n * and we have the same hash on schemas that represent the same value but\n * have different json.\n * \n * - Orders the schemas attributes by alphabetical order\n * - Adds the primaryKey to all indexes that do not contain the primaryKey\n *   - We need this for determinstic sort order on all queries, which is required for event-reduce to work.\n *\n * @return RxJsonSchema - ordered and filled\n */\nexport function normalizeRxJsonSchema<T>(jsonSchema: RxJsonSchema<T>): RxJsonSchema<T> {\n    const primaryPath: string = getPrimaryFieldOfPrimaryKey(jsonSchema.primaryKey) as string;\n    const normalizedSchema: RxJsonSchema<T> = sortObject(clone(jsonSchema));\n\n    // indexes must NOT be sorted because sort order is important here.\n    if (jsonSchema.indexes) {\n        normalizedSchema.indexes = Array.from(jsonSchema.indexes);\n    }\n\n    // primaryKey.fields must NOT be sorted because sort order is important here.\n    if (\n        typeof normalizedSchema.primaryKey === 'object' &&\n        typeof jsonSchema.primaryKey === 'object'\n    ) {\n        normalizedSchema.primaryKey.fields = jsonSchema.primaryKey.fields;\n    }\n\n\n    /**\n     * Add primary key to indexes that do not contain primaryKey.\n     */\n    if (normalizedSchema.indexes) {\n        normalizedSchema.indexes = normalizedSchema.indexes.map(index => {\n            const arIndex = isMaybeReadonlyArray(index) ? index : [index];\n            if (!arIndex.includes(primaryPath)) {\n                const modifiedIndex = arIndex.slice(0);\n                modifiedIndex.push(primaryPath);\n                return modifiedIndex;\n            }\n            return arIndex;\n        });\n    }\n\n\n    return normalizedSchema;\n}\n\n\nexport const RX_META_SCHEMA: JsonSchema = {\n    type: 'object',\n    properties: {\n        lwt: {\n            type: 'number',\n            minimum: 1\n        }\n    },\n    /**\n     * Additional properties are allowed\n     * and can be used by plugins to set various flags.\n     */\n    additionalProperties: true as any,\n    required: [\n        'lwt'\n    ]\n}\n\n/**\n * fills the schema-json with default-settings\n * @return cloned schemaObj\n */\nexport function fillWithDefaultSettings<T = any>(\n    schemaObj: RxJsonSchema<T>\n): RxJsonSchema<T> {\n    schemaObj = flatClone(schemaObj);\n    schemaObj.properties = flatClone(schemaObj.properties);\n\n    // additionalProperties is always false\n    schemaObj.additionalProperties = false;\n\n    // fill with key-compression-state ()\n    if (!schemaObj.hasOwnProperty('keyCompression')) {\n        schemaObj.keyCompression = false;\n    }\n\n    // indexes must be array\n    schemaObj.indexes = schemaObj.indexes ? schemaObj.indexes.slice(0) : [];\n\n    // required must be array\n    schemaObj.required = schemaObj.required ? schemaObj.required.slice(0) : [];\n\n    // encrypted must be array\n    schemaObj.encrypted = schemaObj.encrypted ? schemaObj.encrypted.slice(0) : [];\n\n    /**\n     * TODO we should not need to add the internal fields to the schema.\n     * Better remove the fields before validation.\n     */\n    // add _rev\n    (schemaObj.properties as any)._rev = {\n        type: 'string',\n        minLength: 1\n    };\n\n    // add attachments\n    (schemaObj.properties as any)._attachments = {\n        type: 'object'\n    };\n\n    // add deleted flag\n    (schemaObj.properties as any)._deleted = {\n        type: 'boolean'\n    };\n\n    // add meta property\n    (schemaObj.properties as any)._meta = RX_META_SCHEMA;\n\n    // version is 0 by default\n    schemaObj.version = schemaObj.version || 0;\n\n    return schemaObj;\n}\n\nexport function createRxSchema<T>(\n    jsonSchema: RxJsonSchema<T>,\n    runPreCreateHooks = true\n): RxSchema<T> {\n    if (runPreCreateHooks) {\n        runPluginHooks('preCreateRxSchema', jsonSchema);\n    }\n    const schema = new RxSchema(fillWithDefaultSettings(jsonSchema));\n    runPluginHooks('createRxSchema', schema);\n    return schema;\n}\n\nexport function isInstanceOf(obj: any): boolean {\n    return obj instanceof RxSchema;\n}\n\n/**\n * Used as helper function the generate the document type out of the schema via typescript.\n * @link https://github.com/pubkey/rxdb/discussions/3467\n */\nexport function toTypedRxJsonSchema<T extends DeepReadonly<RxJsonSchema<any>>>(schema: T): DeepMutable<T> {\n    return schema as any;\n}\n"],"file":"rx-schema.js"}