{"version":3,"file":"rx-database-internal-store.js","names":["fillWithDefaultSettings","getComposedPrimaryKeyOfDocumentData","writeSingle","createRevision","ensureNotFalsy","getDefaultRevision","getDefaultRxDocumentMeta","randomCouchString","body","recover","result","e","then","ensureStorageTokenDocumentExists","rxDatabase","storageTokenDocumentId","getPrimaryKeyOfInternalDocument","STORAGE_TOKEN_DOCUMENT_KEY","INTERNAL_CONTEXT_STORAGE_TOKEN","storageToken","docData","id","context","key","data","token","instanceToken","_deleted","_meta","_rev","_attachments","internalStore","document","err","isError","status","storageTokenDocInDb","documentInDb","getAllCollectionDocuments","storageInstance","storage","getAllQueryPrepared","statics","prepareQuery","schema","selector","INTERNAL_CONTEXT_COLLECTION","sort","skip","query","queryResult","allDocs","documents","INTERNAL_CONTEXT_ENCRYPTION","INTERNAL_CONTEXT_REPLICATION_PRIMITIVES","INTERNAL_STORE_SCHEMA","version","title","primaryKey","fields","separator","type","properties","maxLength","additionalProperties","indexes","required","sharding","shards","mode"],"sources":["../../src/rx-database-internal-store.ts"],"sourcesContent":["import { fillWithDefaultSettings, getComposedPrimaryKeyOfDocumentData } from './rx-schema-helper';\nimport { writeSingle } from './rx-storage-helper';\nimport type {\n    RxDatabase,\n    RxDocumentData,\n    RxJsonSchema,\n    RxStorage,\n    RxStorageBulkWriteError,\n    RxStorageInstance\n} from './types';\nimport {\n    createRevision,\n    ensureNotFalsy,\n    getDefaultRevision,\n    getDefaultRxDocumentMeta,\n    randomCouchString\n} from './util';\n\nexport const INTERNAL_CONTEXT_COLLECTION = 'collection';\nexport const INTERNAL_CONTEXT_STORAGE_TOKEN = 'storage-token';\nexport const INTERNAL_CONTEXT_ENCRYPTION = 'plugin-encryption';\nexport const INTERNAL_CONTEXT_REPLICATION_PRIMITIVES = 'plugin-replication-primitives';\n\nexport const INTERNAL_STORE_SCHEMA: RxJsonSchema<RxDocumentData<InternalStoreDocType<any>>> = fillWithDefaultSettings({\n    version: 0,\n    /**\n     * Do not change the title,\n     * we have to flag this schema so that\n     * some RxStorage implementations are able\n     * to detect if the created RxStorageInstance\n     * is from the internals or not,\n     * to do some optimizations in some cases.\n     */\n    title: 'RxInternalDocument',\n    primaryKey: {\n        key: 'id',\n        fields: [\n            'context',\n            'key'\n        ],\n        separator: '|'\n    },\n    type: 'object',\n    properties: {\n        id: {\n            type: 'string',\n            maxLength: 200\n        },\n        key: {\n            type: 'string'\n        },\n        context: {\n            type: 'string',\n            enum: [\n                INTERNAL_CONTEXT_COLLECTION,\n                INTERNAL_CONTEXT_STORAGE_TOKEN,\n                INTERNAL_CONTEXT_ENCRYPTION,\n                INTERNAL_CONTEXT_REPLICATION_PRIMITIVES,\n                'OTHER'\n            ]\n        },\n        data: {\n            type: 'object',\n            additionalProperties: true\n        }\n    },\n    indexes: [],\n    required: [\n        'key',\n        'context',\n        'data'\n    ],\n    additionalProperties: false,\n    /**\n     * If the sharding plugin is used,\n     * it must not shard on the internal RxStorageInstance\n     * because that one anyway has only a small amount of documents\n     * and also its creation is in the hot path of the initial page load,\n     * so we should spend less time creating multiple RxStorageInstances.\n     */\n    sharding: {\n        shards: 1,\n        mode: 'collection'\n    }\n});\n\nexport type InternalStoreDocType<Data = any> = {\n    id: string;\n    key: string;\n    context: string;\n    data: Data;\n}\n\n/**\n * Stores information about the collections.\n * The collection.name is the 'key' value.\n */\nexport type InternalStoreStorageTokenDocType = InternalStoreDocType<{\n    token: string;\n    instanceToken: string;\n}>;\n\n/**\n * Stores information about the collections.\n * The collection.name is the 'key' value.\n */\nexport type InternalStoreCollectionDocType = InternalStoreDocType<{\n    /**\n     * Plain name of the collection\n     */\n    name: string;\n    schema: RxJsonSchema<any>;\n    schemaHash: string;\n    version: number;\n}>;\n\n\nexport function getPrimaryKeyOfInternalDocument(\n    key: string,\n    context: string\n): string {\n    return getComposedPrimaryKeyOfDocumentData<InternalStoreDocType>(\n        INTERNAL_STORE_SCHEMA,\n        {\n            key,\n            context\n        }\n    )\n}\n\n/**\n * Returns all internal documents\n * with context 'collection'\n */\nexport async function getAllCollectionDocuments(\n    storageInstance: RxStorageInstance<InternalStoreDocType<any>, any, any>,\n    storage: RxStorage<any, any>\n): Promise<RxDocumentData<InternalStoreCollectionDocType>[]> {\n    const getAllQueryPrepared = storage.statics.prepareQuery(\n        storageInstance.schema,\n        {\n            selector: {\n                context: INTERNAL_CONTEXT_COLLECTION\n            },\n            sort: [{ id: 'asc' }],\n            skip: 0\n        }\n    );\n    const queryResult = await storageInstance.query(getAllQueryPrepared);\n    const allDocs = queryResult.documents;\n    return allDocs;\n}\n\n/**\n * to not confuse multiInstance-messages with other databases that have the same\n * name and adapter, but do not share state with this one (for example in-memory-instances),\n * we set a storage-token and use it in the broadcast-channel\n */\nexport const STORAGE_TOKEN_DOCUMENT_KEY = 'storageToken';\nexport async function ensureStorageTokenDocumentExists<Collections = any>(\n    rxDatabase: RxDatabase<Collections>\n): Promise<RxDocumentData<InternalStoreStorageTokenDocType>> {\n    const storageTokenDocumentId = getPrimaryKeyOfInternalDocument(\n        STORAGE_TOKEN_DOCUMENT_KEY,\n        INTERNAL_CONTEXT_STORAGE_TOKEN\n    );\n\n    /**\n     * To have less read-write cycles,\n     * we just try to insert a new document\n     * and only fetch the existing one if a conflict happened.\n     */\n    const storageToken = randomCouchString(10);\n    try {\n        const docData: RxDocumentData<InternalStoreStorageTokenDocType> = {\n            id: storageTokenDocumentId,\n            context: INTERNAL_CONTEXT_STORAGE_TOKEN,\n            key: STORAGE_TOKEN_DOCUMENT_KEY,\n            data: {\n                token: storageToken,\n                /**\n                 * We add the instance token here\n                 * to be able to detect if a given RxDatabase instance\n                 * is the first instance that was ever created\n                 * or if databases have existed earlier.\n                 */\n                instanceToken: rxDatabase.token\n            },\n            _deleted: false,\n            _meta: getDefaultRxDocumentMeta(),\n            _rev: getDefaultRevision(),\n            _attachments: {}\n        };\n        docData._rev = createRevision(docData);\n        await writeSingle<InternalStoreStorageTokenDocType>(\n            rxDatabase.internalStore,\n            {\n                document: docData\n            }\n        );\n        return docData;\n    } catch (err: RxStorageBulkWriteError<InternalStoreStorageTokenDocType> | any) {\n        /**\n         * If we get a 409 error,\n         * it means another instance already inserted the storage token.\n         * So we get that token from the database and return that one.\n         */\n        if (\n            err.isError &&\n            (err as RxStorageBulkWriteError<InternalStoreStorageTokenDocType>).status === 409\n        ) {\n            const storageTokenDocInDb = (err as RxStorageBulkWriteError<InternalStoreStorageTokenDocType>).documentInDb;\n            return ensureNotFalsy(storageTokenDocInDb);\n        }\n        throw err;\n    }\n}\n"],"mappings":"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"}