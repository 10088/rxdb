(()=>{var e={6313:e=>{var t=function(){"use strict";function e(e,t){return null!=t&&e instanceof t}var t,n,r;try{t=Map}catch(e){t=function(){}}try{n=Set}catch(e){n=function(){}}try{r=Promise}catch(e){r=function(){}}function i(o,a,l,c,u){"object"==typeof a&&(l=a.depth,c=a.prototype,u=a.includeNonEnumerable,a=a.circular);var h=[],d=[],f="undefined"!=typeof Buffer;return void 0===a&&(a=!0),void 0===l&&(l=1/0),function o(l,p){if(null===l)return null;if(0===p)return l;var y,v;if("object"!=typeof l)return l;if(e(l,t))y=new t;else if(e(l,n))y=new n;else if(e(l,r))y=new r((function(e,t){l.then((function(t){e(o(t,p-1))}),(function(e){t(o(e,p-1))}))}));else if(i.__isArray(l))y=[];else if(i.__isRegExp(l))y=new RegExp(l.source,s(l)),l.lastIndex&&(y.lastIndex=l.lastIndex);else if(i.__isDate(l))y=new Date(l.getTime());else{if(f&&Buffer.isBuffer(l))return y=Buffer.allocUnsafe?Buffer.allocUnsafe(l.length):new Buffer(l.length),l.copy(y),y;e(l,Error)?y=Object.create(l):void 0===c?(v=Object.getPrototypeOf(l),y=Object.create(v)):(y=Object.create(c),v=c)}if(a){var g=h.indexOf(l);if(-1!=g)return d[g];h.push(l),d.push(y)}for(var b in e(l,t)&&l.forEach((function(e,t){var n=o(t,p-1),r=o(e,p-1);y.set(n,r)})),e(l,n)&&l.forEach((function(e){var t=o(e,p-1);y.add(t)})),l){var m;v&&(m=Object.getOwnPropertyDescriptor(v,b)),m&&null==m.set||(y[b]=o(l[b],p-1))}if(Object.getOwnPropertySymbols){var w=Object.getOwnPropertySymbols(l);for(b=0;b<w.length;b++){var I=w[b];(!(S=Object.getOwnPropertyDescriptor(l,I))||S.enumerable||u)&&(y[I]=o(l[I],p-1),S.enumerable||Object.defineProperty(y,I,{enumerable:!1}))}}if(u){var k=Object.getOwnPropertyNames(l);for(b=0;b<k.length;b++){var S,O=k[b];(S=Object.getOwnPropertyDescriptor(l,O))&&S.enumerable||(y[O]=o(l[O],p-1),Object.defineProperty(y,O,{enumerable:!1}))}}return y}(o,l)}function o(e){return Object.prototype.toString.call(e)}function s(e){var t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),t}return i.clonePrototype=function(e){if(null===e)return null;var t=function(){};return t.prototype=e,new t},i.__objToStr=o,i.__isDate=function(e){return"object"==typeof e&&"[object Date]"===o(e)},i.__isArray=function(e){return"object"==typeof e&&"[object Array]"===o(e)},i.__isRegExp=function(e){return"object"==typeof e&&"[object RegExp]"===o(e)},i.__getRegExpFlags=s,i}();e.exports&&(e.exports=t)},5643:e=>{e.exports=!1},4063:e=>{"use strict";e.exports=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){if(t.constructor!==n.constructor)return!1;var r,i,o;if(Array.isArray(t)){if((r=t.length)!=n.length)return!1;for(i=r;0!=i--;)if(!e(t[i],n[i]))return!1;return!0}if(t.constructor===RegExp)return t.source===n.source&&t.flags===n.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===n.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===n.toString();if((r=(o=Object.keys(t)).length)!==Object.keys(n).length)return!1;for(i=r;0!=i--;)if(!Object.prototype.hasOwnProperty.call(n,o[i]))return!1;for(i=r;0!=i--;){var s=o[i];if(!e(t[s],n[s]))return!1}return!0}return t!=t&&n!=n}},9134:e=>{e.exports=function(){return"undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type||(!("undefined"==typeof process||"object"!=typeof process.versions||!process.versions.electron)||"object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent.indexOf("Electron")>=0)}},6898:e=>{"use strict";e.exports=e=>!!e&&("symbol"==typeof Symbol.observable&&"function"==typeof e[Symbol.observable]?e===e[Symbol.observable]():"function"==typeof e["@@observable"]&&e===e["@@observable"]())},8930:function(e,t){var n,r,i;r=[],void 0===(i="function"==typeof(n=function(){return function(){"use strict";var e="undefined"!=typeof window&&!!window.__loki_incremental_idb_debug;function t(e){if(this.mode="incremental",this.options=e||{},this.chunkSize=100,this.megachunkCount=this.options.megachunkCount||20,this.idb=null,this._prevLokiVersionId=null,this._prevCollectionVersionIds={},!(this.megachunkCount>=4&&this.megachunkCount%2==0))throw new Error("megachunkCount must be >=4 and divisible by 2")}function n(e){var t={};return e.forEach((function(e){var n=e.split(".");if(3===n.length&&"chunk"===n[1]){var r=n[0],i=parseInt(n[2])||0,o=t[r];(!o||i>o)&&(t[r]=i)}})),t}function r(e){try{return e&&JSON.parse(e.value).idbVersionId||null}catch(e){return console.error("Error while parsing loki chunk",e),null}}function i(e){var t,n={};if(c(e),e.forEach((function(e){var r=e.key,i=e.value;if("loki"!==r){if(r.includes(".")){var o=r.split(".");if(3===o.length&&"chunk"===o[1]){var s=o[0];return void(n[s]?n[s].dataChunks.push(i):n[s]={metadata:null,dataChunks:[i]})}if(2===o.length&&"metadata"===o[1]){var a=o[0];return void(n[a]?n[a].metadata=i:n[a]={metadata:i,dataChunks:[]})}}throw console.error("Unknown chunk "+r),new Error("Corrupted database - unknown chunk found")}t=i})),!t)throw new Error("Corrupted database - missing database metadata");return{loki:t,chunkMap:n}}function o(e,t){e.collections.forEach((function(n,r){var i=t[n.name];if(i){if(!i.metadata)throw new Error("Corrupted database - missing metadata chunk for "+n.name);var o=i.metadata;i.metadata=null,e.collections[r]=o;var s=i.dataChunks;s.forEach((function(e,t){e.forEach((function(e){o.data.push(e)})),s[t]=null}))}}))}function s(e,t){if(e.value=JSON.parse(e.value),t){var n=e.key.split(".");if(3===n.length&&"chunk"===n[1]){var r=n[0];e.value=t(r,e.value)}}}function a(){return Math.random().toString(36).substring(2)}function l(e){var t=e.key;if(t.includes(".")){var n=t.split(".");if(3===n.length&&"chunk"===n[1])return parseInt(n[2],10)}return-1}function c(e){e.sort((function(e,t){var n=l(e),r=l(t);return n<r?-1:n>r?1:0}))}function u(e,t){for(var n,r,i=Math.floor(e.length/t),o=[],s=0;s<t;s+=1)n=e[i*s],r=e[i*(s+1)],0===s?o.push(IDBKeyRange.upperBound(r,!0)):s===t-1?o.push(IDBKeyRange.lowerBound(n)):o.push(IDBKeyRange.bound(n,r,!1,!0));return o}function h(e,t,n){return e.onsuccess=function(e){try{return t(e)}catch(e){n(e)}},e.onerror=n,e}return t.prototype._getChunk=function(e,t){var n=t*this.chunkSize,r=n+this.chunkSize-1;e.ensureId();for(var i,o=e.idIndex,s=null,a=o.length-1,l=0;o[l]<o[a];)o[i=l+a>>1]<n?l=i+1:a=i;if(a===l&&o[l]>=n&&o[l]<=r&&(s=l),null===s)return[];for(var c=null,u=s+this.chunkSize-1;u>=s;u--)if(o[u]<=r){c=u;break}var h=e.data[s];if(!(h&&h.$loki>=n&&h.$loki<=r))throw new Error("broken invariant firstelement");var d=e.data[c];if(!(d&&d.$loki>=n&&d.$loki<=r))throw new Error("broken invariant lastElement");var f=e.data.slice(s,c+1);if(f.length>this.chunkSize)throw new Error("broken invariant - chunk size");return f},t.prototype.saveDatabase=function(t,i,o){var s=this;if(this.idb){if(this.operationInProgress)throw new Error("Error while saving to database - another operation is already in progress. Please use throttledSaves=true option on Loki object");this.operationInProgress=!0,e&&console.log("saveDatabase - begin"),e&&console.time("saveDatabase");try{var a=function(){console.error("Unexpected successful tx - cannot update previous version ids")},l=!1,c=this.idb.transaction(["LokiIncrementalData"],"readwrite");c.oncomplete=function(){a(),p(),l&&s.options.onDidOverwrite&&s.options.onDidOverwrite()},c.onerror=function(e){p(e)},c.onabort=function(e){p(e)};var u=c.objectStore("LokiIncrementalData"),d=function(e){try{var t=!e,n=s._putInChunks(u,i(),t,e);a=function(){s._prevLokiVersionId=n.lokiVersionId,n.collectionVersionIds.forEach((function(e){s._prevCollectionVersionIds[e.name]=e.versionId}))},c.commit&&c.commit()}catch(e){console.error("idb performSave failed: ",e),c.abort()}},f=function(){h(u.getAllKeys(),(function(e){var t=n(e.target.result);d(t)}),(function(e){console.error("Getting all keys failed: ",e),c.abort()}))};h(u.get("loki"),(function(t){r(t.target.result)===s._prevLokiVersionId?d():(e&&console.warn("Another writer changed Loki IDB, using slow path..."),l=!0,f())}),(function(e){console.error("Getting loki chunk failed: ",e),c.abort()}))}catch(e){p(e)}}else this._initializeIDB(t,o,(function(){s.saveDatabase(t,i,o)}));function p(t){e&&t&&console.error(t),e&&console.timeEnd("saveDatabase"),s.operationInProgress=!1,o(t)}},t.prototype._putInChunks=function(t,n,r,i){var o=this,s=[],l=0,c=function(c,u){var h=new Set;r&&c.dirtyIds.forEach((function(e){var t=e/o.chunkSize|0;h.add(t)})),c.dirtyIds=[];var d=function(n){var i=o._getChunk(c,n);o.options.serializeChunk&&(i=o.options.serializeChunk(c.name,i)),i=JSON.stringify(i),l+=i.length,e&&r&&console.log("Saving: "+c.name+".chunk."+n),t.put({key:c.name+".chunk."+n,value:i})};if(r)h.forEach(d);else{for(var f=c.maxId/o.chunkSize|0,p=0;p<=f;p+=1)d(p);for(var y=i[c.name]||0,v=f+1;v<=y;v+=1){var g=c.name+".chunk."+v;t.delete(g),e&&console.warn("Deleted chunk: "+g)}}if(c.dirty||h.size||!r){c.idIndex=[],c.data=[],c.idbVersionId=a(),s.push({name:c.name,versionId:c.idbVersionId});var b=JSON.stringify(c);l+=b.length,e&&r&&console.log("Saving: "+c.name+".metadata"),t.put({key:c.name+".metadata",value:b})}n.collections[u]={name:c.name}};n.collections.forEach(c),n.idbVersionId=a();var u=JSON.stringify(n);return l+=u.length,e&&r&&console.log("Saving: loki"),t.put({key:"loki",value:u}),e&&console.log("saved size: "+l),{lokiVersionId:n.idbVersionId,collectionVersionIds:s}},t.prototype.loadDatabase=function(t,n){var r=this;if(this.operationInProgress)throw new Error("Error while loading database - another operation is already in progress. Please use throttledSaves=true option on Loki object");this.operationInProgress=!0,e&&console.log("loadDatabase - begin"),e&&console.time("loadDatabase");var s=function(t){e&&console.timeEnd("loadDatabase"),r.operationInProgress=!1,n(t)};this._getAllChunks(t,(function(t){try{if(!Array.isArray(t))throw t;if(!t.length)return s(null);e&&console.log("Found chunks:",t.length);var n=(t=i(t)).loki;return t.loki=null,o(n,t.chunkMap),t=null,r._prevLokiVersionId=n.idbVersionId||null,r._prevCollectionVersionIds={},n.collections.forEach((function(e){r._prevCollectionVersionIds[e.name]=e.idbVersionId||null})),s(n)}catch(e){return r._prevLokiVersionId=null,r._prevCollectionVersionIds={},s(e)}}))},t.prototype._initializeIDB=function(t,n,r){var i=this;if(e&&console.log("initializing idb"),this.idbInitInProgress)throw new Error("Cannot open IndexedDB because open is already in progress");this.idbInitInProgress=!0;var o=indexedDB.open(t,1);o.onupgradeneeded=function(t){var n=t.target.result;if(e&&console.log("onupgradeneeded, old version: "+t.oldVersion),!(t.oldVersion<1))throw new Error("Invalid old version "+t.oldVersion+" for IndexedDB upgrade");n.createObjectStore("LokiIncrementalData",{keyPath:"key"})},o.onsuccess=function(o){i.idbInitInProgress=!1;var s=o.target.result;if(i.idb=s,!s.objectStoreNames.contains("LokiIncrementalData"))return n(new Error("Missing LokiIncrementalData")),void i.deleteDatabase(t);e&&console.log("init success"),s.onversionchange=function(t){i.idb===s&&(e&&console.log("IDB version change",t),i.idb.close(),i.idb=null,i.options.onversionchange&&i.options.onversionchange(t))},r()},o.onblocked=function(e){console.error("IndexedDB open is blocked",e),n(new Error("IndexedDB open is blocked by open connection"))},o.onerror=function(e){i.idbInitInProgress=!1,console.error("IndexedDB open error",e),n(e)}},t.prototype._getAllChunks=function(e,t){var n=this;if(this.idb){var r=this.idb.transaction(["LokiIncrementalData"],"readonly").objectStore("LokiIncrementalData"),i=this.options.deserializeChunk;l()}else this._initializeIDB(e,t,(function(){n._getAllChunks(e,t)}));function o(e){var o=n.megachunkCount,a=u(e,o),l=[],c=0;function d(e,n,r){var a=e.target.result;a.forEach((function(e,t){s(e,i),l.push(e),a[t]=null})),(c+=1)===o&&t(l)}function f(e){var n=a[e];h(r.getAll(n),(function(t){e<o/2&&f(e+o/2),d(t,e,n)}),(function(e){t(e)}))}for(var p=0;p<o/2;p+=1)f(p)}function a(){h(r.getAll(),(function(e){var n=e.target.result;n.forEach((function(e){s(e,i)})),t(n)}),(function(e){t(e)}))}function l(){h(r.getAllKeys(),(function(e){var t=e.target.result.sort();t.length>100?o(t):a()}),(function(e){t(e)})),n.options.onFetchStart&&n.options.onFetchStart()}},t.prototype.deleteDatabase=function(t,n){if(this.operationInProgress)throw new Error("Error while deleting database - another operation is already in progress. Please use throttledSaves=true option on Loki object");this.operationInProgress=!0;var r=this;e&&console.log("deleteDatabase - begin"),e&&console.time("deleteDatabase"),this._prevLokiVersionId=null,this._prevCollectionVersionIds={},this.idb&&(this.idb.close(),this.idb=null);var i=indexedDB.deleteDatabase(t);i.onsuccess=function(){r.operationInProgress=!1,e&&console.timeEnd("deleteDatabase"),n({success:!0})},i.onerror=function(e){r.operationInProgress=!1,console.error("Error while deleting database",e),n({success:!1})},i.onblocked=function(e){console.error("Deleting database failed because it's blocked by another connection",e)}},t}()})?n.apply(t,r):n)||(e.exports=i)},7996:function(e,t){var n,r,i;r=[],void 0===(i="function"==typeof(n=function(){return function(){function e(e,t){if(this.app="loki",this.options=t||{},void 0!==e&&(this.app=e),this.catalog=null,!this.checkAvailability())throw new Error("indexedDB does not seem to be supported for your environment")}function t(e){this.db=null,this.initializeLokiCatalog(e)}return e.prototype.closeDatabase=function(){this.catalog&&this.catalog.db&&(this.catalog.db.close(),this.catalog.db=null)},e.prototype.checkAvailability=function(){return!("undefined"==typeof indexedDB||!indexedDB)},e.prototype.loadDatabase=function(e,n){var r=this.app,i=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAppKey(r,e,(function(e){if("function"==typeof n){if(0===e.id)return void n(null);n(e.val)}else console.log(e.val)})):this.catalog=new t((function(t){i.catalog=t,i.loadDatabase(e,n)}))},e.prototype.loadKey=e.prototype.loadDatabase,e.prototype.saveDatabase=function(e,n,r){var i=this.app,o=this;function s(e){e&&!0===e.success?r(null):r(new Error("Error saving database")),o.options.closeAfterSave&&o.closeDatabase()}null!==this.catalog&&null!==this.catalog.db?this.catalog.setAppKey(i,e,n,s):this.catalog=new t((function(t){o.saveDatabase(e,n,s)}))},e.prototype.saveKey=e.prototype.saveDatabase,e.prototype.deleteDatabase=function(e,n){var r=this.app,i=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAppKey(r,e,(function(e){var t=e.id;0!==t?i.catalog.deleteAppKey(t,n):"function"==typeof n&&n({success:!0})})):this.catalog=new t((function(t){i.catalog=t,i.deleteDatabase(e,n)}))},e.prototype.deleteKey=e.prototype.deleteDatabase,e.prototype.deleteDatabasePartitions=function(e){var t=this;this.getDatabaseList((function(n){n.forEach((function(n){n.startsWith(e)&&t.deleteDatabase(n)}))}))},e.prototype.getDatabaseList=function(e){var n=this.app,r=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAppKeys(n,(function(t){for(var n=[],r=0;r<t.length;r++)n.push(t[r].key);"function"==typeof e?e(n):n.forEach((function(e){console.log(e)}))})):this.catalog=new t((function(t){r.catalog=t,r.getDatabaseList(e)}))},e.prototype.getKeyList=e.prototype.getDatabaseList,e.prototype.getCatalogSummary=function(e){this.app;var n=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAllKeys((function(t){for(var n,r,i,o,s,a=[],l=0;l<t.length;l++)i=(n=t[l]).app||"",o=n.key||"",s=n.val||"",r=2*i.length+2*o.length+s.length+1,a.push({app:n.app,key:n.key,size:r});"function"==typeof e?e(a):a.forEach((function(e){console.log(e)}))})):this.catalog=new t((function(t){n.catalog=t,n.getCatalogSummary(e)}))},t.prototype.initializeLokiCatalog=function(e){var t=indexedDB.open("LokiCatalog",1),n=this;t.onupgradeneeded=function(e){var t=e.target.result;if(t.objectStoreNames.contains("LokiAKV")&&t.deleteObjectStore("LokiAKV"),!t.objectStoreNames.contains("LokiAKV")){var n=t.createObjectStore("LokiAKV",{keyPath:"id",autoIncrement:!0});n.createIndex("app","app",{unique:!1}),n.createIndex("key","key",{unique:!1}),n.createIndex("appkey","appkey",{unique:!0})}},t.onsuccess=function(t){n.db=t.target.result,"function"==typeof e&&e(n)},t.onerror=function(e){throw e}},t.prototype.getAppKey=function(e,t,n){var r,i=e+","+t,o=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").index("appkey").get(i);o.onsuccess=(r=n,function(e){var t=e.target.result;null==t&&(t={id:0,success:!1}),"function"==typeof r?r(t):console.log(t)}),o.onerror=function(e){return function(t){if("function"!=typeof e)throw t;e({id:0,success:!1})}}(n)},t.prototype.getAppKeyById=function(e,t,n){this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").get(e).onsuccess=function(e,t){return function(n){"function"==typeof t?t(n.target.result,e):console.log(n.target.result)}}(n,t)},t.prototype.setAppKey=function(e,t,n,r){var i,o=this.db.transaction(["LokiAKV"],"readwrite").objectStore("LokiAKV"),s=o.index("appkey"),a=e+","+t,l=s.get(a);l.onsuccess=function(i){var s=i.target.result;null==s?s={app:e,key:t,appkey:e+","+t,val:n}:s.val=n;var a,c=o.put(s);c.onerror=(a=r,function(e){"function"==typeof a?a({success:!1}):(console.error("LokiCatalog.setAppKey (set) onerror"),console.error(l.error))}),c.onsuccess=function(e){return function(t){"function"==typeof e&&e({success:!0})}}(r)},l.onerror=(i=r,function(e){"function"==typeof i?i({success:!1}):(console.error("LokiCatalog.setAppKey (get) onerror"),console.error(l.error))})},t.prototype.deleteAppKey=function(e,t){var n,r=this.db.transaction(["LokiAKV"],"readwrite").objectStore("LokiAKV").delete(e);r.onsuccess=(n=t,function(e){"function"==typeof n&&n({success:!0})}),r.onerror=function(e){return function(t){"function"==typeof e?e({success:!1}):(console.error("LokiCatalog.deleteAppKey raised onerror"),console.error(r.error))}}(t)},t.prototype.getAppKeys=function(e,t){var n,r=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").index("app"),i=IDBKeyRange.only(e),o=r.openCursor(i),s=[];o.onsuccess=function(e,t){return function(n){var r=n.target.result;if(r){var i=r.value;e.push(i),r.continue()}else"function"==typeof t?t(e):console.log(e)}}(s,t),o.onerror=(n=t,function(e){"function"==typeof n?n(null):(console.error("LokiCatalog.getAppKeys raised onerror"),console.error(e))})},t.prototype.getAllKeys=function(e){var t,n=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").openCursor(),r=[];n.onsuccess=function(e,t){return function(n){var r=n.target.result;if(r){var i=r.value;e.push(i),r.continue()}else"function"==typeof t?t(e):console.log(e)}}(r,e),n.onerror=(t=e,function(e){"function"==typeof t&&t(null)})},e}()})?n.apply(t,r):n)||(e.exports=i)},3050:function(e,t,n){var r,i,o;i=[],r=function(){return function(){"use strict";var e=Object.prototype.hasOwnProperty;function t(e){var n,i;if(Array.isArray(e)){for(i=0;i<e.length;i++)t(e[i]);r(e)}else if(null!==e&&"object"==typeof e){for(n in e)e.hasOwnProperty(n)&&t(e[n]);r(e)}}function r(e){Object.isFrozen(e)||Object.freeze(e)}function i(e){return Object.isFrozen(e)?g(e,"shallow"):e}var o={copyProperties:function(e,t){var n;for(n in e)t[n]=e[n]},resolveTransformObject:function(e,t,n){var r,i;if("number"!=typeof n&&(n=0),++n>=10)return e;for(r in e)"string"==typeof e[r]&&0===e[r].indexOf("[%lktxp]")?(i=e[r].substring(8),t.hasOwnProperty(i)&&(e[r]=t[i])):"object"==typeof e[r]&&(e[r]=o.resolveTransformObject(e[r],t,n));return e},resolveTransformParams:function(e,t){var n,r,i=[];if(void 0===t)return e;for(n=0;n<e.length;n++)r=g(e[n],"shallow-recurse-objects"),i.push(o.resolveTransformObject(r,t));return i},getIn:function(e,t,n){if(null!=e){if(!n)return e[t];if("string"==typeof t&&(t=t.split(".")),!Array.isArray(t))throw new Error("path must be a string or array. Found "+typeof t);for(var r=0,i=t.length;null!=e&&r<i;)e=e[t[r++]];return r&&r==i?e:void 0}}},s={aeq:a,lt:l,gt:c};function a(e,t){var n,r,i,o;if(e===t)return!0;if(!e||!t||!0===e||!0===t||e!=e||t!=t){switch(e){case void 0:case null:i=1;break;case!1:i=3;break;case!0:i=4;break;case"":i=5;break;default:i=e==e?9:0}switch(t){case void 0:case null:o=1;break;case!1:o=3;break;case!0:o=4;break;case"":o=5;break;default:o=t==t?9:0}if(9!==i||9!==o)return i===o}return n=Number(e),r=Number(t),n==n||r==r?n===r:(n=e.toString())==(r=t.toString())}function l(e,t,n){var r,i,o,s;if(!e||!t||!0===e||!0===t||e!=e||t!=t){switch(e){case void 0:case null:o=1;break;case!1:o=3;break;case!0:o=4;break;case"":o=5;break;default:o=e==e?9:0}switch(t){case void 0:case null:s=1;break;case!1:s=3;break;case!0:s=4;break;case"":s=5;break;default:s=t==t?9:0}if(9!==o||9!==s)return o===s?n:o<s}return r=Number(e),i=Number(t),r==r&&i==i?r<i||!(r>i)&&n:r==r&&i!=i||(i!=i||r==r)&&(e<t||!(e>t)&&(e==t?n:(r=e.toString())<(i=t.toString())||r==i&&n))}function c(e,t,n){var r,i,o,s;if(!e||!t||!0===e||!0===t||e!=e||t!=t){switch(e){case void 0:case null:o=1;break;case!1:o=3;break;case!0:o=4;break;case"":o=5;break;default:o=e==e?9:0}switch(t){case void 0:case null:s=1;break;case!1:s=3;break;case!0:s=4;break;case"":s=5;break;default:s=t==t?9:0}if(9!==o||9!==s)return o===s?n:o>s}return r=Number(e),i=Number(t),r==r&&i==i?r>i||!(r<i)&&n:(r!=r||i==i)&&(i==i&&r!=r||e>t||!(e<t)&&(e==t?n:(r=e.toString())>(i=t.toString())||r==i&&n))}function u(e,t,n){return s.aeq(e,t)?0:s.lt(e,t,!1)?n?1:-1:s.gt(e,t,!1)?n?-1:1:0}function h(e,t,n){for(var r,i,s,a,l,c=0,h=0,d=e.length;h<d;h++)if(~(i=(r=e[h])[0]).indexOf(".")?(l=i.split("."),s=o.getIn(t,l,!0),a=o.getIn(n,l,!0)):(s=t[i],a=n[i]),0!==(c=u(s,a,r[1])))return c;return 0}function d(e,t,n,r,i,o){var s,a=o||0,l=t[a],c=!1;if("object"==typeof e&&l in e&&(s=e[l]),a+1>=t.length)c=n(s,r,i);else if(Array.isArray(s))for(var u=0,h=s.length;u<h&&!0!==(c=d(s[u],t,n,r,i,a+1));u+=1);else c=d(s,t,n,r,i,a+1);return c}function f(t){return"string"==typeof t||Array.isArray(t)?function(e){return-1!==t.indexOf(e)}:"object"==typeof t&&null!==t?function(n){return e.call(t,n)}:null}function p(t,n,r){for(var i in n)if(e.call(n,i))return y[i](t,n[i],r);return!1}var y={$eq:function(e,t){return e===t},$aeq:function(e,t){return e==t},$ne:function(e,t){return t!=t?e==e:e!==t},$dteq:function(e,t){return s.aeq(e,t)},$gt:function(e,t){return s.gt(e,t,!1)},$gte:function(e,t){return s.gt(e,t,!0)},$lt:function(e,t){return s.lt(e,t,!1)},$lte:function(e,t){return s.lt(e,t,!0)},$jgt:function(e,t){return e>t},$jgte:function(e,t){return e>=t},$jlt:function(e,t){return e<t},$jlte:function(e,t){return e<=t},$between:function(e,t){return null!=e&&s.gt(e,t[0],!0)&&s.lt(e,t[1],!0)},$jbetween:function(e,t){return null!=e&&e>=t[0]&&e<=t[1]},$in:function(e,t){return-1!==t.indexOf(e)},$inSet:function(e,t){return t.has(e)},$nin:function(e,t){return-1===t.indexOf(e)},$keyin:function(e,t){return e in t},$nkeyin:function(e,t){return!(e in t)},$definedin:function(e,t){return void 0!==t[e]},$undefinedin:function(e,t){return void 0===t[e]},$regex:function(e,t){return t.test(e)},$containsString:function(e,t){return"string"==typeof e&&-1!==e.indexOf(t)},$containsNone:function(e,t){return!y.$containsAny(e,t)},$containsAny:function(e,t){var n=f(e);return null!==n&&(Array.isArray(t)?t.some(n):n(t))},$contains:function(e,t){var n=f(e);return null!==n&&(Array.isArray(t)?t.every(n):n(t))},$elemMatch:function(e,t){return!!Array.isArray(e)&&e.some((function(e){return Object.keys(t).every((function(n){var r=t[n];return"object"==typeof r&&r||(r={$eq:r}),-1!==n.indexOf(".")?d(e,n.split("."),p,t[n],e):p(e[n],r,e)}))}))},$type:function(e,t,n){var r=typeof e;return"object"===r&&(Array.isArray(e)?r="array":e instanceof Date&&(r="date")),"object"!=typeof t?r===t:p(r,t,n)},$finite:function(e,t){return t===isFinite(e)},$size:function(e,t,n){return!!Array.isArray(e)&&("object"!=typeof t?e.length===t:p(e.length,t,n))},$len:function(e,t,n){return"string"==typeof e&&("object"!=typeof t?e.length===t:p(e.length,t,n))},$where:function(e,t){return!0===t(e)},$not:function(e,t,n){return!p(e,t,n)},$and:function(e,t,n){for(var r=0,i=t.length;r<i;r+=1)if(!p(e,t[r],n))return!1;return!0},$or:function(e,t,n){for(var r=0,i=t.length;r<i;r+=1)if(p(e,t[r],n))return!0;return!1},$exists:function(e,t){return t?void 0!==e:void 0===e}};["$eq","$aeq","$ne","$dteq","$gt","$gte","$lt","$lte","$jgt","$jgte","$jlt","$jlte","$type"].forEach((function(e){var t=y[e];y["$"+e]=function(e,n,r){if("string"==typeof n)return t(e,r[n]);if("function"==typeof n)return t(e,n(r));throw new Error("Invalid argument to $$ matcher")}}));var v={$eq:y.$eq,$aeq:!0,$dteq:!0,$gt:!0,$gte:!0,$lt:!0,$lte:!0,$in:!0,$between:!0};function g(e,t){if(null==e)return null;var n;switch(t||"parse-stringify"){case"parse-stringify":n=JSON.parse(JSON.stringify(e));break;case"jquery-extend-deep":n=jQuery.extend(!0,{},e);break;case"shallow":n=Object.create(e.constructor.prototype),Object.keys(e).map((function(t){n[t]=e[t]}));break;case"shallow-assign":n=Object.create(e.constructor.prototype),Object.assign(n,e);break;case"shallow-recurse-objects":n=g(e,"shallow"),Object.keys(e).forEach((function(t){"object"==typeof e[t]&&"Object"===e[t].constructor.name?n[t]=g(e[t],"shallow-recurse-objects"):Array.isArray(e[t])&&(n[t]=b(e[t],"shallow-recurse-objects"))}))}return n}function b(e,t){if("parse-stringify"==t)return g(e,t);for(var n=[],r=0,i=e.length;r<i;r++)n[r]=g(e[r],t);return n}function m(){try{return window&&void 0!==window.localStorage&&null!==window.localStorage}catch(e){return!1}}function w(){}function I(e,t){this.filename=e||"loki.db",this.collections=[],this.databaseVersion=1.5,this.engineVersion=1.5,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.throttledSaves=!0,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.throttledSavePending=!1,this.throttledCallbacks=[],this.verbose=!(!t||!t.hasOwnProperty("verbose"))&&t.verbose,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};var r=function(){return void 0!==n.g&&(n.g.android||n.g.NSObject)?"NATIVESCRIPT":"undefined"==typeof window||void 0!==n.g&&n.g.window&&"undefined"!=typeof process?"NODEJS":"undefined"!=typeof document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA"};t&&t.hasOwnProperty("env")?this.ENV=t.env:this.ENV=r(),"undefined"===this.ENV&&(this.ENV="NODEJS"),this.configureOptions(t,!0),this.on("init",this.clearChanges)}function k(e){this.hashStore={},this.options=e||{},this.options.hasOwnProperty("asyncResponses")||(this.options.asyncResponses=!1),this.options.hasOwnProperty("asyncTimeout")||(this.options.asyncTimeout=50)}function S(e,t){if(this.mode="reference",this.adapter=null,this.options=t||{},this.dbref=null,this.dbname="",this.pageIterator={},!e)throw new Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction");if("reference"===e.mode)throw new Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter");this.adapter=e,this.options.hasOwnProperty("paging")||(this.options.paging=!1),this.options.hasOwnProperty("pageSize")||(this.options.pageSize=26214400),this.options.hasOwnProperty("delimiter")||(this.options.delimiter="$<\n")}function O(){try{this.fs=n(693)}catch(e){this.fs=null}}function C(){}function x(e,t){return t=t||{},this.collection=e,this.filteredrows=[],this.filterInitialized=!1,this}function _(e,t){if("$regex"===e)Array.isArray(t)?t=new RegExp(t[0],t[1]):t instanceof RegExp||(t=new RegExp(t));else if("object"==typeof t)for(var n in t)"$regex"!==n&&"object"!=typeof t[n]||(t[n]=_(n,t[n]));return t}function P(e,t,n){this.collection=e,this.name=t,this.rebuildPending=!1,this.options=n||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.options.hasOwnProperty("minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new x(e),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.collection.disableFreeze||Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,this.events={rebuild:[],filter:[],sort:[]}}function D(t,n){this.name=t,this.data=[],this.idIndex=null,this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=t,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var r=this;(n=n||{}).hasOwnProperty("unique")&&(Array.isArray(n.unique)||(n.unique=[n.unique]),n.unique.forEach((function(e){r.uniqueNames.push(e)}))),n.hasOwnProperty("exact")&&n.exact.forEach((function(e){r.constraints.exact[e]=new F(e)})),this.adaptiveBinaryIndices=!n.hasOwnProperty("adaptiveBinaryIndices")||n.adaptiveBinaryIndices,this.transactional=!!n.hasOwnProperty("transactional")&&n.transactional,this.cloneObjects=!!n.hasOwnProperty("clone")&&n.clone,this.cloneMethod=n.hasOwnProperty("cloneMethod")?n.cloneMethod:"parse-stringify",this.asyncListeners=!!n.hasOwnProperty("asyncListeners")&&n.asyncListeners,this.disableMeta=!!n.hasOwnProperty("disableMeta")&&n.disableMeta,this.disableChangesApi=!n.hasOwnProperty("disableChangesApi")||n.disableChangesApi,this.disableDeltaChangesApi=!n.hasOwnProperty("disableDeltaChangesApi")||n.disableDeltaChangesApi,this.disableChangesApi&&(this.disableDeltaChangesApi=!0),this.autoupdate=!!n.hasOwnProperty("autoupdate")&&n.autoupdate,this.serializableIndices=!n.hasOwnProperty("serializableIndices")||n.serializableIndices,this.disableFreeze=!n.hasOwnProperty("disableFreeze")||n.disableFreeze,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(n.ttl||-1,n.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]},this.changes=[],this.dirtyIds=[];var i=[];if(n&&n.indices)if("[object Array]"===Object.prototype.toString.call(n.indices))i=n.indices;else{if("string"!=typeof n.indices)throw new TypeError("Indices needs to be a string or an array of strings");i=[n.indices]}for(var o=0;o<i.length;o++)this.ensureIndex(i[o]);function s(t){var n="function"==typeof Set?new Set:[];n.add||(n.add=function(e){return-1===this.indexOf(e)&&this.push(e),this}),t.forEach((function(e){n.add(e.object)})),n.forEach((function(t){if(!e.call(t,"$loki"))return r.removeAutoUpdateObserver(t);try{r.update(t)}catch(e){}}))}function a(e,t){return t?l(t,e):JSON.parse(JSON.stringify(e))}function l(e,t){var n=null!==t&&"object"==typeof t?Object.keys(t):null;if(n&&n.length&&["string","boolean","number"].indexOf(typeof t)<0){for(var i={},o=0;o<n.length;o++){var s=n[o];if(t.hasOwnProperty(s))if(!e.hasOwnProperty(s)||r.uniqueNames.indexOf(s)>=0||"$loki"==s||"meta"==s)i[s]=t[s];else{var a=l(e[s],t[s]);void 0!==a&&a!={}&&(i[s]=a)}}return 0===Object.keys(i).length?void 0:i}return e===t?void 0:t}function c(){r.changes=[]}this.observerCallback=s,this.getChangeDelta=a,this.getObjectDelta=l,this.getChanges=function(){return r.changes},this.flushChanges=c,this.setChangesApi=function(e){r.disableChangesApi=!e,e||(r.disableDeltaChangesApi=!1)},this.on("delete",(function(e){r.disableChangesApi||r.createChange(r.name,"R",e)})),this.on("warning",(function(e){r.lokiConsoleWrapper.warn(e)})),c()}function A(e){return-1!==e.indexOf(".")}function E(e){return parseFloat(e,10)}function j(e,t){return e+t}function M(e,t){return e-t}function L(e){return e.reduce(j,0)/e.length}function N(e){var t=L(e),n=L(e.map((function(e){var n=e-t;return n*n})));return Math.sqrt(n)}function $(e,t,n){if(!1===n)return e[t];for(var r=t.split("."),i=e;r.length>0;)i=i[r.shift()];return i}function z(e,t,n){for(var r,i,o=0,s=e.length;o<s;){if(i=o+s>>1,0===(r=n.apply(null,[t,e[i]])))return{found:!0,index:i};r<0?s=i:o=i+1}return{found:!1,index:s}}function B(e){return function(t,n){return z(t,n,e)}}function T(){}function q(e){this.field=e,this.keyMap=Object.create(null),this.lokiMap=Object.create(null)}function F(e){this.index=Object.create(null),this.field=e}function R(e){this.field=e}return w.prototype.events={},w.prototype.asyncListeners=!1,w.prototype.on=function(e,t){var n,r=this;return Array.isArray(e)?(e.forEach((function(e){r.on(e,t)})),t):((n=this.events[e])||(n=this.events[e]=[]),n.push(t),t)},w.prototype.emit=function(e){var t,n=this;if(!e||!this.events[e])throw new Error("No event "+e+" defined");this.events[e].length&&(t=Array.prototype.slice.call(arguments,1),this.events[e].forEach((function(e){n.asyncListeners?setTimeout((function(){e.apply(n,t)}),1):e.apply(n,t)})))},w.prototype.addListener=w.prototype.on,w.prototype.removeListener=function(e,t){var n=this;if(Array.isArray(e))e.forEach((function(e){n.removeListener(e,t)}));else if(this.events[e]){var r=this.events[e];r.splice(r.indexOf(t),1)}},I.prototype=new w,I.prototype.constructor=I,I.prototype.getIndexedAdapter=function(){return n(7996)},I.prototype.configureOptions=function(e,t){var n={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage",MEMORY:"memory"},r={fs:O,localStorage:C,memory:k};if(this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,void 0!==e){if(this.options=e,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof r[e.persistenceMethod]&&(this.persistenceMethod=e.persistenceMethod,this.persistenceAdapter=new r[e.persistenceMethod]),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=e.adapter,this.options.adapter=null,this.isIncremental="incremental"===this.persistenceAdapter.mode),e.autoload&&t){var i=this;setTimeout((function(){i.loadDatabase(e,e.autoloadCallback)}),1)}this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.options.hasOwnProperty("autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,this.options.hasOwnProperty("autosaveCallback")?this.autosaveEnable(e,e.autosaveCallback):this.autosaveEnable()),this.options.hasOwnProperty("throttledSaves")&&(this.throttledSaves=this.options.throttledSaves)}this.options.hasOwnProperty("serializationMethod")||(this.options.serializationMethod="normal"),this.options.hasOwnProperty("destructureDelimiter")||(this.options.destructureDelimiter="$<\n"),null===this.persistenceAdapter&&(this.persistenceMethod=n[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new r[this.persistenceMethod]))},I.prototype.copy=function(e){var t,n,r=new I(this.filename,{env:"NA"});if(e=e||{},r.loadJSONObject(this,{retainDirtyFlags:!0}),e.hasOwnProperty("removeNonSerializable")&&!0===e.removeNonSerializable)for(r.autosaveHandle=null,r.persistenceAdapter=null,t=r.collections.length,n=0;n<t;n++)r.collections[n].constraints=null,r.collections[n].ttl=null;return r},I.prototype.addCollection=function(e,t){var n,r=this.collections.length;if(t&&!0===t.disableMeta){if(!1===t.disableChangesApi)throw new Error("disableMeta option cannot be passed as true when disableChangesApi is passed as false");if(!1===t.disableDeltaChangesApi)throw new Error("disableMeta option cannot be passed as true when disableDeltaChangesApi is passed as false");if("number"==typeof t.ttl&&t.ttl>0)throw new Error("disableMeta option cannot be passed as true when ttl is enabled")}for(n=0;n<r;n+=1)if(this.collections[n].name===e)return this.collections[n];var i=new D(e,t);return i.isIncremental=this.isIncremental,this.collections.push(i),this.verbose&&(i.lokiConsoleWrapper=console),i},I.prototype.loadCollection=function(e){if(!e.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(e)},I.prototype.getCollection=function(e){var t,n=this.collections.length;for(t=0;t<n;t+=1)if(this.collections[t].name===e)return this.collections[t];return this.emit("warning","collection "+e+" not found"),null},I.prototype.renameCollection=function(e,t){var n=this.getCollection(e);return n&&(n.name=t),n},I.prototype.listCollections=function(){for(var e=this.collections.length,t=[];e--;)t.push({name:this.collections[e].name,type:this.collections[e].objType,count:this.collections[e].data.length});return t},I.prototype.removeCollection=function(e){var t,n=this.collections.length;for(t=0;t<n;t+=1)if(this.collections[t].name===e){var r=new D(e,{}),i=this.collections[t];for(var o in i)i.hasOwnProperty(o)&&r.hasOwnProperty(o)&&(i[o]=r[o]);return void this.collections.splice(t,1)}},I.prototype.getName=function(){return this.name},I.prototype.serializeReplacer=function(e,t){switch(e){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":case"lokiConsoleWrapper":return null;case"throttledSavePending":case"throttledCallbacks":return;default:return t}},I.prototype.serialize=function(e){switch((e=e||{}).hasOwnProperty("serializationMethod")||(e.serializationMethod=this.options.serializationMethod),e.serializationMethod){default:return JSON.stringify(this,this.serializeReplacer);case"pretty":return JSON.stringify(this,this.serializeReplacer,2);case"destructured":return this.serializeDestructured()}},I.prototype.toJson=I.prototype.serialize,I.prototype.serializeDestructured=function(e){var t,n,r,i,o,s=[];if((e=e||{}).hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),!0===e.partitioned&&e.hasOwnProperty("partition")&&e.partition>=0)return this.serializeCollection({delimited:e.delimited,delimiter:e.delimiter,collectionIndex:e.partition});for((o=new I(this.filename)).loadJSONObject(this),t=0;t<o.collections.length;t++)o.collections[t].data=[];if(!0===e.partitioned&&-1===e.partition)return o.serialize({serializationMethod:"normal"});for(s.push(o.serialize({serializationMethod:"normal"})),o=null,t=0;t<this.collections.length;t++)if(r=this.serializeCollection({delimited:e.delimited,delimiter:e.delimiter,collectionIndex:t}),!1===e.partitioned&&!1===e.delimited){if(!Array.isArray(r))throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array");for(i=r.length,n=0;n<i;n++)s.push(r[n]),r[n]=null;s.push("")}else s.push(r);return e.partitioned?(e.delimited,s):e.delimited?(s.push(""),s.join(e.delimiter)):(s.push(""),s)},I.prototype.serializeCollection=function(e){var t,n,r=[];if((e=e||{}).hasOwnProperty("delimited")||(e.delimited=!0),!e.hasOwnProperty("collectionIndex"))throw new Error("serializeCollection called without 'collectionIndex' option");for(t=this.collections[e.collectionIndex].data.length,r=[],n=0;n<t;n++)r.push(JSON.stringify(this.collections[e.collectionIndex].data[n]));return e.delimited?(r.push(""),r.join(e.delimiter)):r},I.prototype.deserializeDestructured=function(e,t){var n,r,i,o=[],s=0,a=1,l=!1;if((t=t||{}).hasOwnProperty("partitioned")||(t.partitioned=!1),t.hasOwnProperty("delimited")||(t.delimited=!0),t.hasOwnProperty("delimiter")||(t.delimiter=this.options.destructureDelimiter),t.partitioned){if(t.hasOwnProperty("partition"))return-1===t.partition?n=JSON.parse(e[0]):this.deserializeCollection(e[t.partition+1],t);for(r=(n=JSON.parse(e[0])).collections.length,s=0;s<r;s++)n.collections[s].data=this.deserializeCollection(e[s+1],t);return n}if(t.delimited){if(o=e.split(t.delimiter),e=null,0===o.length)return null}else o=e;for(r=(n=JSON.parse(o[0])).collections.length,o[0]=null;!l;)o[a],""===o[a]?++s>r&&(l=!0):(i=JSON.parse(o[a]),n.collections[s].data.push(i)),o[a++]=null;return n},I.prototype.deserializeCollection=function(e,t){var n,r,i=[];for((t=t||{}).hasOwnProperty("partitioned")||(t.partitioned=!1),t.hasOwnProperty("delimited")||(t.delimited=!0),t.hasOwnProperty("delimiter")||(t.delimiter=this.options.destructureDelimiter),t.delimited?(i=e.split(t.delimiter)).pop():i=e,r=i.length,n=0;n<r;n++)i[n]=JSON.parse(i[n]);return i},I.prototype.loadJSON=function(e,t){var n;n=0===e.length?{}:"destructured"===this.options.serializationMethod?this.deserializeDestructured(e):JSON.parse(e),this.loadJSONObject(n,t)},I.prototype.loadJSONObject=function(e,n){var r,i,s,a,l,c,u=0,h=e.collections?e.collections.length:0;function d(e){var t,r=n[e.name];return r.proto?(t=r.inflate||o.copyProperties,function(e){var n=new r.proto;return t(e,n),n}):r.inflate}for(this.name=e.name,e.hasOwnProperty("throttledSaves")&&n&&!n.hasOwnProperty("throttledSaves")&&(this.throttledSaves=e.throttledSaves),this.collections=[];u<h;u+=1){if(r=e.collections[u],(i=this.addCollection(r.name,{disableChangesApi:r.disableChangesApi,disableDeltaChangesApi:r.disableDeltaChangesApi,disableMeta:r.disableMeta,disableFreeze:!r.hasOwnProperty("disableFreeze")||r.disableFreeze})).adaptiveBinaryIndices=!!r.hasOwnProperty("adaptiveBinaryIndices")&&!0===r.adaptiveBinaryIndices,i.transactional=r.transactional,i.asyncListeners=r.asyncListeners,i.cloneObjects=r.cloneObjects,i.cloneMethod=r.cloneMethod||"parse-stringify",i.autoupdate=r.autoupdate,i.changes=r.changes,i.dirtyIds=r.dirtyIds||[],n&&!0===n.retainDirtyFlags?i.dirty=r.dirty:i.dirty=!1,s=r.data.length,a=0,n&&n.hasOwnProperty(r.name))for(l=d(r);a<s;a++)c=l(r.data[a]),i.data[a]=c,i.addAutoUpdateObserver(c),i.disableFreeze||t(i.data[a]);else for(;a<s;a++)i.data[a]=r.data[a],i.addAutoUpdateObserver(i.data[a]),i.disableFreeze||t(i.data[a]);if(i.maxId=void 0===r.maxId?0:r.maxId,void 0!==r.binaryIndices&&(i.binaryIndices=r.binaryIndices),void 0!==r.transforms&&(i.transforms=r.transforms),i.uniqueNames=[],r.hasOwnProperty("uniqueNames")&&(i.uniqueNames=r.uniqueNames),void 0!==r.DynamicViews){for(var f=0;f<r.DynamicViews.length;f++){var p=r.DynamicViews[f],y=i.addDynamicView(p.name,p.options);y.resultdata=p.resultdata,y.resultsdirty=p.resultsdirty,y.filterPipeline=p.filterPipeline,y.sortCriteriaSimple=p.sortCriteriaSimple,y.sortCriteria=p.sortCriteria,y.sortFunction=null,y.sortDirty=p.sortDirty,i.disableFreeze||(t(y.filterPipeline),y.sortCriteriaSimple?t(y.sortCriteriaSimple):y.sortCriteria&&t(y.sortCriteria)),y.resultset.filteredrows=p.resultset.filteredrows,y.resultset.filterInitialized=p.resultset.filterInitialized,y.rematerialize({removeWhereFilters:!0})}e.databaseVersion<1.5&&(i.ensureAllIndexes(!0),i.dirty=!0)}}},I.prototype.close=function(e){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(this.saveDatabase(e),e=void 0)),e&&this.on("close",e),this.emit("close")},I.prototype.generateChangesNotification=function(e){function t(e){return e.name}var n=[],r=e||this.collections.map(t);return this.collections.forEach((function(e){-1!==r.indexOf(t(e))&&(n=n.concat(e.getChanges()))})),n},I.prototype.serializeChanges=function(e){return JSON.stringify(this.generateChangesNotification(e))},I.prototype.clearChanges=function(){this.collections.forEach((function(e){e.flushChanges&&e.flushChanges()}))},k.prototype.loadDatabase=function(e,t){var n=this;this.options.asyncResponses?setTimeout((function(){n.hashStore.hasOwnProperty(e)?t(n.hashStore[e].value):t(null)}),this.options.asyncTimeout):this.hashStore.hasOwnProperty(e)?t(this.hashStore[e].value):t(null)},k.prototype.saveDatabase=function(e,t,n){var r,i=this;this.options.asyncResponses?setTimeout((function(){r=i.hashStore.hasOwnProperty(e)?i.hashStore[e].savecount:0,i.hashStore[e]={savecount:r+1,lastsave:new Date,value:t},n()}),this.options.asyncTimeout):(r=this.hashStore.hasOwnProperty(e)?this.hashStore[e].savecount:0,this.hashStore[e]={savecount:r+1,lastsave:new Date,value:t},n())},k.prototype.deleteDatabase=function(e,t){this.hashStore.hasOwnProperty(e)&&delete this.hashStore[e],"function"==typeof t&&t()},S.prototype.loadDatabase=function(e,t){var n=this;this.dbname=e,this.dbref=new I(e),this.adapter.loadDatabase(e,(function(e){if(e){"string"!=typeof e&&t(new Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()"));var r=JSON.parse(e);n.dbref.loadJSONObject(r),r=null,n.dbref.collections.length,0!==n.dbref.collections.length?(n.pageIterator={collection:0,pageIndex:0},n.loadNextPartition(0,(function(){t(n.dbref)}))):t(n.dbref)}else t(e)}))},S.prototype.loadNextPartition=function(e,t){var n=this.dbname+"."+e,r=this;if(!0===this.options.paging)return this.pageIterator.pageIndex=0,void this.loadNextPage(t);this.adapter.loadDatabase(n,(function(n){var i=r.dbref.deserializeCollection(n,{delimited:!0,collectionIndex:e});r.dbref.collections[e].data=i,++e<r.dbref.collections.length?r.loadNextPartition(e,t):t()}))},S.prototype.loadNextPage=function(e){var t=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,n=this;this.adapter.loadDatabase(t,(function(t){var r=t.split(n.options.delimiter);t="";var i,o=r.length,s=""===r[o-1];for(s&&(r.pop(),""===r[(o=r.length)-1]&&1===o&&(r.pop(),o=r.length)),i=0;i<o;i++)n.dbref.collections[n.pageIterator.collection].data.push(JSON.parse(r[i])),r[i]=null;r=[],s?++n.pageIterator.collection<n.dbref.collections.length?n.loadNextPartition(n.pageIterator.collection,e):e():(n.pageIterator.pageIndex++,n.loadNextPage(e))}))},S.prototype.exportDatabase=function(e,t,n){var r,i=t.collections.length;for(this.dbref=t,this.dbname=e,this.dirtyPartitions=[-1],r=0;r<i;r++)t.collections[r].dirty&&this.dirtyPartitions.push(r);this.saveNextPartition((function(e){n(e)}))},S.prototype.saveNextPartition=function(e){var t=this,n=this.dirtyPartitions.shift(),r=this.dbname+(-1===n?"":"."+n);if(this.options.paging&&-1!==n)return this.pageIterator={collection:n,docIndex:0,pageIndex:0},void this.saveNextPage((function(n){0===t.dirtyPartitions.length?e(n):t.saveNextPartition(e)}));var i=this.dbref.serializeDestructured({partitioned:!0,delimited:!0,partition:n});this.adapter.saveDatabase(r,i,(function(n){n?e(n):0===t.dirtyPartitions.length?e(null):t.saveNextPartition(e)}))},S.prototype.saveNextPage=function(e){var t=this,n=this.dbref.collections[this.pageIterator.collection],r=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,i=0,o=n.data.length,s=this.options.delimiter.length,a="",l="",c=!1,u=!1,h=function(n){l="",n&&e(n),c?e(null):(t.pageIterator.pageIndex++,t.saveNextPage(e))};for(0===n.data.length&&(c=!0);;)if(c||(a=JSON.stringify(n.data[this.pageIterator.docIndex]),l+=a,i+=a.length,++this.pageIterator.docIndex>=o&&(c=!0)),i>=this.options.pageSize&&(u=!0),u&&!c||(l+=this.options.delimiter,i+=s),c||u)return void this.adapter.saveDatabase(r,l,h)},O.prototype.loadDatabase=function(e,t){var n=this;this.fs.stat(e,(function(r,i){!r&&i.isFile()?n.fs.readFile(e,{encoding:"utf8"},(function(e,n){t(e?new Error(e):n)})):t(null)}))},O.prototype.saveDatabase=function(e,t,n){var r=this,i=e+"~";this.fs.writeFile(i,t,(function(t){t?n(new Error(t)):r.fs.rename(i,e,n)}))},O.prototype.deleteDatabase=function(e,t){this.fs.unlink(e,(function(e){e?t(new Error(e)):t()}))},C.prototype.loadDatabase=function(e,t){m()?t(localStorage.getItem(e)):t(new Error("localStorage is not available"))},C.prototype.saveDatabase=function(e,t,n){m()?(localStorage.setItem(e,t),n(null)):n(new Error("localStorage is not available"))},C.prototype.deleteDatabase=function(e,t){m()?(localStorage.removeItem(e),t(null)):t(new Error("localStorage is not available"))},I.prototype.throttledSaveDrain=function(e,t){var n=this,r=(new Date).getTime();if(this.throttledSaves||e(!0),(t=t||{}).hasOwnProperty("recursiveWait")||(t.recursiveWait=!0),t.hasOwnProperty("recursiveWaitLimit")||(t.recursiveWaitLimit=!1),t.hasOwnProperty("recursiveWaitLimitDuration")||(t.recursiveWaitLimitDuration=2e3),t.hasOwnProperty("started")||(t.started=(new Date).getTime()),this.throttledSaves&&this.throttledSavePending){if(!t.recursiveWait)return void this.throttledCallbacks.push(e);this.throttledCallbacks.push((function(){return n.throttledSavePending?t.recursiveWaitLimit&&r-t.started>t.recursiveWaitLimitDuration?void e(!1):void n.throttledSaveDrain(e,t):void e(!0)}))}else e(!0)},I.prototype.loadDatabaseInternal=function(e,t){var n=t||function(e,t){if(e)throw e},r=this;null!==this.persistenceAdapter?this.persistenceAdapter.loadDatabase(this.filename,(function(t){if("string"==typeof t){var i=!1;try{r.loadJSON(t,e||{}),i=!0}catch(e){n(e)}i&&(n(null),r.emit("loaded","database "+r.filename+" loaded"))}else{if(!t)return n(null),void r.emit("loaded","empty database "+r.filename+" loaded");if(t instanceof Error)return void n(t);if("object"==typeof t)return r.loadJSONObject(t,e||{}),n(null),void r.emit("loaded","database "+r.filename+" loaded");n("unexpected adapter response : "+t)}})):n(new Error("persistenceAdapter not configured"))},I.prototype.loadDatabase=function(e,t){var n=this;this.throttledSaves?this.throttledSaveDrain((function(r){if(r)return n.throttledSavePending=!0,void n.loadDatabaseInternal(e,(function(e){0===n.throttledCallbacks.length?n.throttledSavePending=!1:n.saveDatabase(),"function"==typeof t&&t(e)}));"function"==typeof t&&t(new Error("Unable to pause save throttling long enough to read database"))}),e):this.loadDatabaseInternal(e,t)},I.prototype.saveDatabaseInternal=function(e){var t,n=e||function(e){if(e)throw e},r=this;this.persistenceAdapter?"incremental"===this.persistenceAdapter.mode?(this.ignoreAutosave=!0,this.persistenceAdapter.saveDatabase(this.filename,(function(){if(r.ignoreAutosave=!1,!t){var e=r.copy({removeNonSerializable:!0});return t=r.collections.map((function(e){return[e.dirty,e.dirtyIds]})),r.collections.forEach((function(e){e.dirty=!1,e.dirtyIds=[]})),e}n(new Error("adapter error - getLokiCopy called more than once"))}),(function(e){r.ignoreAutosave=!1,e&&t&&r.collections.forEach((function(e,n){var r=t[n];e.dirty=e.dirty||r[0],e.dirtyIds=e.dirtyIds.concat(r[1])})),n(e)}))):"reference"===this.persistenceAdapter.mode&&"function"==typeof this.persistenceAdapter.exportDatabase?this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:!0}),(function(e){r.autosaveClearFlags(),n(e)})):(this.autosaveClearFlags(),this.persistenceAdapter.saveDatabase(this.filename,this.serialize(),(function(e){n(e)}))):n(new Error("persistenceAdapter not configured"))},I.prototype.saveDatabase=function(e){if(this.throttledSaves)if(this.throttledSavePending)this.throttledCallbacks.push(e);else{var t=this.throttledCallbacks;this.throttledCallbacks=[],t.unshift(e),this.throttledSavePending=!0;var n=this;this.saveDatabaseInternal((function(e){n.throttledSavePending=!1,t.forEach((function(t){"function"==typeof t&&setTimeout((function(){t(e)}),1)})),n.throttledCallbacks.length>0&&n.saveDatabase()}))}else this.saveDatabaseInternal(e)},I.prototype.save=I.prototype.saveDatabase,I.prototype.deleteDatabase=function(e,t){var n=t||function(e,t){if(e)throw e};"function"!=typeof e||t||(n=e),null!==this.persistenceAdapter?this.persistenceAdapter.deleteDatabase(this.filename,(function(e){n(e)})):n(new Error("persistenceAdapter not configured"))},I.prototype.autosaveDirty=function(){for(var e=0;e<this.collections.length;e++)if(this.collections[e].dirty)return!0;return!1},I.prototype.autosaveClearFlags=function(){for(var e=0;e<this.collections.length;e++)this.collections[e].dirty=!1},I.prototype.autosaveEnable=function(e,t){this.autosave=!0;var n=5e3,r=this;void 0!==this.autosaveInterval&&null!==this.autosaveInterval&&(n=this.autosaveInterval),this.autosaveHandle=setInterval((function(){r.autosaveDirty()&&!r.ignoreAutosave&&r.saveDatabase(t)}),n)},I.prototype.autosaveDisable=function(){void 0!==this.autosaveHandle&&null!==this.autosaveHandle&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)},x.prototype.reset=function(){return this.filteredrows.length>0&&(this.filteredrows=[]),this.filterInitialized=!1,this},x.prototype.toJSON=function(){var e=this.copy();return e.collection=null,e},x.prototype.limit=function(e){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var t=new x(this.collection);return t.filteredrows=this.filteredrows.slice(0,e),t.filterInitialized=!0,t},x.prototype.offset=function(e){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var t=new x(this.collection);return t.filteredrows=this.filteredrows.slice(e),t.filterInitialized=!0,t},x.prototype.copy=function(){var e=new x(this.collection);return this.filteredrows.length>0&&(e.filteredrows=this.filteredrows.slice()),e.filterInitialized=this.filterInitialized,e},x.prototype.branch=x.prototype.copy,x.prototype.transform=function(e,t){var n,r,i=this;if("string"==typeof e&&this.collection.transforms.hasOwnProperty(e)&&(e=this.collection.transforms[e]),"object"!=typeof e||!Array.isArray(e))throw new Error("Invalid transform");for(void 0!==t&&(e=o.resolveTransformParams(e,t)),n=0;n<e.length;n++)switch((r=e[n]).type){case"find":i.find(r.value);break;case"where":i.where(r.value);break;case"simplesort":i.simplesort(r.property,r.desc||r.options);break;case"compoundsort":i.compoundsort(r.value);break;case"sort":i.sort(r.value);break;case"limit":i=i.limit(r.value);break;case"offset":i=i.offset(r.value);break;case"map":i=i.map(r.value,r.dataOptions);break;case"eqJoin":i=i.eqJoin(r.joinData,r.leftJoinKey,r.rightJoinKey,r.mapFun,r.dataOptions);break;case"mapReduce":i=i.mapReduce(r.mapFunction,r.reduceFunction);break;case"update":i.update(r.value);break;case"remove":i.remove()}return i},x.prototype.sort=function(e){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var t,n,r=(t=e,n=this.collection.data,function(e,r){return t(n[e],n[r])});return this.filteredrows.sort(r),this},x.prototype.simplesort=function(e,t){var n,r=10,i=this.collection.data.length,s=this.filteredrows.length,a=this.collection.binaryIndices.hasOwnProperty(e);if(void 0!==t&&!1!==t||(t={desc:!1}),!0===t&&(t={desc:!0}),0===s){if(this.filterInitialized)return this;if(this.collection.binaryIndices.hasOwnProperty(e))return this.collection.ensureIndex(e),this.filteredrows=this.collection.binaryIndices[e].values.slice(0),t.desc&&this.filteredrows.reverse(),this;this.filteredrows=this.collection.prepareFullDocIndex()}else if(!t.disableIndexIntersect&&a&&(n=i/s,t.useJavascriptSorting&&(r=6),n<=r||t.forceIndexIntersect)){var l,c=this.filteredrows,h={};for(l=0;l<s;l++)h[c[l]]=!0;var d=this.collection.binaryIndices[e].values;return this.filteredrows=d.filter((function(e){return h[e]})),t.desc&&this.filteredrows.reverse(),this}if(t.useJavascriptSorting)return this.sort((function(t,n){return t[e]===n[e]?0:t[e]>n[e]?1:t[e]<n[e]?-1:void 0}));var f,p,y,v,g,b,m=(f=e,p=t.desc,y=this.collection.data,function(e,t){return~f.indexOf(".")?(b=f.split("."),v=o.getIn(y[e],b,!0),g=o.getIn(y[t],b,!0)):(v=y[e][f],g=y[t][f]),u(v,g,p)});return this.filteredrows.sort(m),this},x.prototype.compoundsort=function(e){if(0===e.length)throw new Error("Invalid call to compoundsort, need at least one property");var t;if(1===e.length)return t=e[0],Array.isArray(t)?this.simplesort(t[0],t[1]):this.simplesort(t,!1);for(var n=0,r=e.length;n<r;n+=1)t=e[n],Array.isArray(t)||(e[n]=[t,!1]);this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var i,o,s=(i=e,o=this.collection.data,function(e,t){return h(i,o[e],o[t])});return this.filteredrows.sort(s),this},x.prototype.findOr=function(e){for(var t=null,n=0,r=0,i=[],o=[],s=0,a=(this.count(),0),l=e.length;a<l;a++)for(r=(t=this.branch().find(e[a]).filteredrows).length,n=0;n<r;n++)void 0===o[s=t[n]]&&(o[s]=!0,i.push(s));return this.filteredrows=i,this.filterInitialized=!0,this},x.prototype.$or=x.prototype.findOr,x.prototype.findAnd=function(e){for(var t=0,n=e.length;t<n;t++){if(0===this.count())return this;this.find(e[t])}return this},x.prototype.$and=x.prototype.findAnd,x.prototype.find=function(t,n){if(0===this.collection.data.length)return this.filteredrows=[],this.filterInitialized=!0,this;var r,i,s,a,l,c,u,h=t||"getAll",f=!1,p=[],g=[],b=null;if(n=n||!1,"object"==typeof h){for(r in h)(a={})[r]=h[r],g.push(a),e.call(h,r)&&(i=r,s=h[r]);if(g.length>1)return this.find({$and:g},n)}if(!i||"getAll"===h)return n&&(this.filterInitialized?this.filteredrows=this.filteredrows.slice(0,1):(this.filteredrows=this.collection.data.length>0?[0]:[],this.filterInitialized=!0)),this;if("$and"===i||"$or"===i)return this[i](s),n&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this;if(null===s||"object"!=typeof s||s instanceof Date)l="$eq",c=s;else{if("object"!=typeof s)throw new Error("Do not know what you want to do.");for(u in s)if(e.call(s,u)){l=u,c=s[u];break}}"$regex"!==l&&"object"!=typeof c||(c=_(l,c));var m=-1!==i.indexOf(".");!this.filterInitialized&&this.collection.binaryIndices[i]&&v[l]&&(!0!==this.collection.adaptiveBinaryIndices&&this.collection.ensureIndex(i),f=!0,b=this.collection.binaryIndices[i]),!f&&"$in"===l&&Array.isArray(c)&&"undefined"!=typeof Set&&(c=new Set(c),l="$inSet");var w,I,k=y[l],S=this.collection.data,O=0,C=0,x=0;if(this.filterInitialized){if(C=(w=this.filteredrows).length,m){for(i=i.split("."),O=0;O<C;O++)if(d(I=S[x=w[O]],i,k,c,I)&&(p.push(x),n))return this.filteredrows=p,this}else for(O=0;O<C;O++)if(k((I=S[x=w[O]])[i],c,I)&&(p.push(x),n))return this.filteredrows=p,this}else if(f){var P=this.collection.calculateRange(l,i,c);if("$in"!==l){for(O=P[0];O<=P[1];O++)if(!0!==v[l]){if(v[l](o.getIn(S[b.values[O]],i,m),c)&&(p.push(b.values[O]),n))return this.filteredrows=p,this.filterInitialized=!0,this}else if(p.push(b.values[O]),n)return this.filteredrows=p,this.filterInitialized=!0,this}else for(O=0,C=P.length;O<C;O++)if(p.push(b.values[P[O]]),n)return this.filteredrows=p,this.filterInitialized=!0,this}else if(C=S.length,m){for(i=i.split("."),O=0;O<C;O++)if(d(I=S[O],i,k,c,I)&&(p.push(O),n))return this.filteredrows=p,this.filterInitialized=!0,this}else for(O=0;O<C;O++)if(k((I=S[O])[i],c,I)&&(p.push(O),n))return this.filteredrows=p,this.filterInitialized=!0,this;return this.filteredrows=p,this.filterInitialized=!0,this},x.prototype.where=function(e){var t,n=[];if("function"!=typeof e)throw new TypeError("Argument is not a stored view or a function");t=e;try{if(this.filterInitialized){for(var r=this.filteredrows.length;r--;)!0===t(this.collection.data[this.filteredrows[r]])&&n.push(this.filteredrows[r]);return this.filteredrows=n,this}for(var i=this.collection.data.length;i--;)!0===t(this.collection.data[i])&&n.push(i);return this.filteredrows=n,this.filterInitialized=!0,this}catch(e){throw e}},x.prototype.count=function(){return this.filterInitialized?this.filteredrows.length:this.collection.count()},x.prototype.data=function(e){var t,n,r,i,o=[],s=this.collection.data;if((e=e||{}).removeMeta&&!e.forceClones&&(e.forceClones=!0,e.forceCloneMethod=e.forceCloneMethod||"shallow"),!this.collection.disableDeltaChangesApi&&this.collection.disableFreeze&&(e.forceClones=!0,e.forceCloneMethod="parse-stringify"),!this.filterInitialized){if(0===this.filteredrows.length){if(this.collection.cloneObjects||e.forceClones){for(n=s.length,i=e.forceCloneMethod||this.collection.cloneMethod,r=0;r<n;r++)t=g(s[r],i),e.removeMeta&&(delete t.$loki,delete t.meta),o.push(t);return o}return s.slice()}this.filterInitialized=!0}var a=this.filteredrows;if(n=a.length,this.collection.cloneObjects||e.forceClones)for(i=e.forceCloneMethod||this.collection.cloneMethod,r=0;r<n;r++)t=g(s[a[r]],i),e.removeMeta&&(delete t.$loki,delete t.meta),o.push(t);else for(r=0;r<n;r++)o.push(s[a[r]]);return o},x.prototype.update=function(e){if("function"!=typeof e)throw new TypeError("Argument is not a function");this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());for(var t,n=this.filteredrows.length,r=this.collection.data,i=0;i<n;i++)this.disableFreeze&&!this.collection.cloneObjects&&this.collection.disableDeltaChangesApi?(e(r[this.filteredrows[i]]),this.collection.update(r[this.filteredrows[i]])):(e(t=g(r[this.filteredrows[i]],this.collection.cloneMethod)),this.collection.update(t));return this},x.prototype.remove=function(){return this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.removeBatchByPositions(this.filteredrows),this.filteredrows=[],this},x.prototype.mapReduce=function(e,t){try{return t(this.data().map(e))}catch(e){throw e}},x.prototype.eqJoin=function(e,t,n,r,i){var o,s,a,l=[],c=[],u=[],h="function"==typeof t,d="function"==typeof n,f={};if(o=(l=this.data(i)).length,e instanceof D)c=e.chain().data(i);else if(e instanceof x)c=e.data(i);else{if(!Array.isArray(e))throw new TypeError("joinData needs to be an array or result set");c=e}s=c.length;for(var p=0;p<s;p++)f[a=d?n(c[p]):c[p][n]]=c[p];r||(r=function(e,t){return{left:e,right:t}});for(var y=0;y<o;y++)a=h?t(l[y]):l[y][t],u.push(r(l[y],f[a]||{}));return this.collection=new D("joinData"),this.collection.insert(u),this.filteredrows=[],this.filterInitialized=!1,this},x.prototype.map=function(e,t){var n=this.data(t).map(e);return this.collection=new D("mappedData"),this.collection.insert(n),this.filteredrows=[],this.filterInitialized=!1,this},P.prototype=new w,P.prototype.constructor=P,P.prototype.getSort=function(){return this.sortFunction||this.sortCriteria||this.sortCriteriaSimple},P.prototype.rematerialize=function(e){var t,n,r;e=e||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new x(this.collection),(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple)&&(this.sortDirty=!0);var i=Object.isFrozen(this.filterPipeline);if(e.hasOwnProperty("removeWhereFilters"))for(i&&(this.filterPipeline=this.filterPipeline.slice()),n=t=this.filterPipeline.length;n--;)"where"===this.filterPipeline[n].type&&(n!==this.filterPipeline.length-1&&(this.filterPipeline[n]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var o=this.filterPipeline;for(this.filterPipeline=[],t=o.length,r=0;r<t;r++)this.applyFind(o[r].val,o[r].uid);return i&&Object.freeze(this.filterPipeline),this.data(),this.emit("rebuild",this),this},P.prototype.branchResultset=function(e,t){var n=this.resultset.branch();return void 0===e?n:n.transform(e,t)},P.prototype.toJSON=function(){var e=new P(this.collection,this.name,this.options);return e.resultset=this.resultset,e.resultdata=[],e.resultsdirty=!0,e.filterPipeline=this.filterPipeline,e.sortFunction=this.sortFunction,e.sortCriteria=this.sortCriteria,e.sortCriteriaSimple=this.sortCriteriaSimple||null,e.sortDirty=this.sortDirty,e.collection=null,e},P.prototype.removeFilters=function(e){e=e||{},this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!0,this.cachedresultset=null;var t=Object.isFrozen(this.filterPipeline),n=this.filterPipeline.length>0;this.filterPipeline=[],t&&Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,!0===e.queueSortPhase&&this.queueSortPhase(),n&&this.emit("filter")},P.prototype.applySort=function(e){return this.sortFunction=e,this.sortCriteria=null,this.sortCriteriaSimple=null,this.queueSortPhase(),this.emit("sort"),this},P.prototype.applySimpleSort=function(e,n){return this.sortCriteriaSimple={propname:e,options:n||!1},this.collection.disableFreeze||t(this.sortCriteriaSimple),this.sortCriteria=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this},P.prototype.applySortCriteria=function(e){return this.sortCriteria=e,this.collection.disableFreeze||t(this.sortCriteria),this.sortCriteriaSimple=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this},P.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},P.prototype.commit=function(){return this.cachedresultset=null,this},P.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this},P.prototype._indexOfFilterWithId=function(e){if("string"==typeof e||"number"==typeof e)for(var t=0,n=this.filterPipeline.length;t<n;t+=1)if(e===this.filterPipeline[t].uid)return t;return-1},P.prototype._addFilter=function(e){var n=Object.isFrozen(this.filterPipeline);n&&(this.filterPipeline=this.filterPipeline.slice()),this.collection.disableFreeze||t(e),this.filterPipeline.push(e),n&&Object.freeze(this.filterPipeline),this.resultset[e.type](e.val)},P.prototype.reapplyFilters=function(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);var e=this.filterPipeline,t=Object.isFrozen(e);this.filterPipeline=[];for(var n=0,r=e.length;n<r;n+=1)this._addFilter(e[n]);return t&&Object.freeze(this.filterPipeline),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this},P.prototype.applyFilter=function(e){var t=this._indexOfFilterWithId(e.uid);if(t>=0){var n=Object.isFrozen(this.filterPipeline);return n&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline[t]=e,n&&(r(e),Object.freeze(this.filterPipeline)),this.reapplyFilters()}return this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(e),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this},P.prototype.applyFind=function(e,t){return this.applyFilter({type:"find",val:e,uid:t}),this},P.prototype.applyWhere=function(e,t){return this.applyFilter({type:"where",val:e,uid:t}),this},P.prototype.removeFilter=function(e){var t=this._indexOfFilterWithId(e);if(t<0)throw new Error("Dynamic view does not contain a filter with ID: "+e);var n=Object.isFrozen(this.filterPipeline);return n&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline.splice(t,1),n&&Object.freeze(this.filterPipeline),this.reapplyFilters(),this},P.prototype.count=function(){return this.resultsdirty&&(this.resultdata=this.resultset.data()),this.resultset.count()},P.prototype.data=function(e){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data(e)},P.prototype.queueRebuildEvent=function(){if(!this.rebuildPending){this.rebuildPending=!0;var e=this;setTimeout((function(){e.rebuildPending&&(e.rebuildPending=!1,e.emit("rebuild",e))}),this.options.minRebuildInterval)}},P.prototype.queueSortPhase=function(){if(!this.sortDirty){this.sortDirty=!0;var e=this;"active"===this.options.sortPriority?setTimeout((function(){e.performSortPhase()}),this.options.minRebuildInterval):this.queueRebuildEvent()}},P.prototype.performSortPhase=function(e){(this.sortDirty||this.resultsdirty)&&(e=e||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria?this.resultset.compoundsort(this.sortCriteria):this.sortCriteriaSimple&&this.resultset.simplesort(this.sortCriteriaSimple.propname,this.sortCriteriaSimple.options),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),e.suppressRebuildEvent||this.emit("rebuild",this))},P.prototype.evaluateDocument=function(e,t){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());var n,r=this.resultset.filteredrows,i=t?-1:r.indexOf(+e),o=r.length,s=new x(this.collection);s.filteredrows=[e],s.filterInitialized=!0;for(var a=0,l=this.filterPipeline.length;a<l;a++)s[(n=this.filterPipeline[a]).type](n.val);var c=0===s.filteredrows.length?-1:0;return-1!==i||-1!==c?-1===i&&-1!==c?(r.push(e),this.options.persistent&&this.resultdata.push(this.collection.data[e]),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):-1!==i&&-1===c?(i<o-1?(r.splice(i,1),this.options.persistent&&this.resultdata.splice(i,1)):(r.length=o-1,this.options.persistent&&(this.resultdata.length=o-1)),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):-1!==i&&-1!==c?(this.options.persistent&&(this.resultdata[i]=this.collection.data[e]),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):void 0:void 0},P.prototype.removeDocument=function(e){var t,n,r,i={},o={},s=[],a=this.resultset,l=this.resultset.filteredrows,c=l.length;if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());for(Array.isArray(e)||(e=[e]),r=e.length,n=0;n<r;n++)i[e[n]]=!0;for(t=0;t<c;t++)i[l[t]]&&(o[t]=!0);Object.keys(o).length>0&&(this.resultset.filteredrows=this.resultset.filteredrows.filter((function(e,t){return!o[t]})),this.options.persistent&&(this.resultdata=this.resultdata.filter((function(e,t){return!o[t]}))),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());var u=function(e){return function(t){return t<a.filteredrows[e]}};for(c=a.filteredrows.length,t=0;t<c;t++)s=e.filter(u(t)),a.filteredrows[t]-=s.length},P.prototype.mapReduce=function(e,t){try{return t(this.data().map(e))}catch(e){throw e}},D.prototype=new w,D.prototype.contructor=D,D.prototype.createChange=function(e,t,n,r){this.changes.push({name:e,operation:t,obj:"U"!=t||this.disableDeltaChangesApi?JSON.parse(JSON.stringify(n)):this.getChangeDelta(n,r)})},D.prototype.insertMeta=function(e){var t,n;if(!this.disableMeta&&e)if(Array.isArray(e))for(t=e.length,n=0;n<t;n++)e[n].hasOwnProperty("meta")||(e[n].meta={}),e[n].meta.created=(new Date).getTime(),e[n].meta.revision=0;else e.meta||(e.meta={}),e.meta.created=(new Date).getTime(),e.meta.revision=0},D.prototype.updateMeta=function(e){return this.disableMeta||!e||(this.disableFreeze||((e=i(e)).meta=i(e.meta)),e.meta.updated=(new Date).getTime(),e.meta.revision+=1),e},D.prototype.createInsertChange=function(e){this.createChange(this.name,"I",e)},D.prototype.createUpdateChange=function(e,t){this.createChange(this.name,"U",e,t)},D.prototype.insertMetaWithChange=function(e){this.insertMeta(e),this.createInsertChange(e)},D.prototype.updateMetaWithChange=function(e,t,n){return e=this.updateMeta(e,n),this.createUpdateChange(e,t),e},D.prototype.lokiConsoleWrapper={log:function(){},warn:function(){},error:function(){}},D.prototype.addAutoUpdateObserver=function(e){this.autoupdate&&"function"==typeof Object.observe&&Object.observe(e,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])},D.prototype.removeAutoUpdateObserver=function(e){this.autoupdate&&"function"==typeof Object.observe&&Object.unobserve(e,this.observerCallback)},D.prototype.addTransform=function(e,t){if(this.transforms.hasOwnProperty(e))throw new Error("a transform by that name already exists");this.transforms[e]=t},D.prototype.getTransform=function(e){return this.transforms[e]},D.prototype.setTransform=function(e,t){this.transforms[e]=t},D.prototype.removeTransform=function(e){delete this.transforms[e]},D.prototype.byExample=function(e){var t,n,r;for(t in r=[],e)e.hasOwnProperty(t)&&r.push(((n={})[t]=e[t],n));return{$and:r}},D.prototype.findObject=function(e){return this.findOne(this.byExample(e))},D.prototype.findObjects=function(e){return this.find(this.byExample(e))},D.prototype.ttlDaemonFuncGen=function(){var e=this,t=this.ttl.age;return function(){var n=Date.now();e.chain().where((function(e){var r=e.meta.updated||e.meta.created;return t<n-r})).remove()}},D.prototype.setTTL=function(e,t){e<0?clearInterval(this.ttl.daemon):(this.ttl.age=e,this.ttl.ttlInterval=t,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),t))},D.prototype.prepareFullDocIndex=function(){for(var e=this.data.length,t=new Array(e),n=0;n<e;n+=1)t[n]=n;return t},D.prototype.configureOptions=function(e){(e=e||{}).hasOwnProperty("adaptiveBinaryIndices")&&(this.adaptiveBinaryIndices=e.adaptiveBinaryIndices,this.adaptiveBinaryIndices&&this.ensureAllIndexes())},D.prototype.ensureIndex=function(e,t){if(void 0===t&&(t=!1),null==e)throw new Error("Attempting to set index without an associated property");if((!this.binaryIndices[e]||t||this.binaryIndices[e].dirty)&&(!0!==this.adaptiveBinaryIndices||!this.binaryIndices.hasOwnProperty(e)||t)){var n={name:e,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[e]=n;var r,i,a,l,c,u=(r=e,i=this.data,c=!!~r.indexOf(".")&&r.split("."),function(e,t){if(c?(a=o.getIn(i[e],c,!0),l=o.getIn(i[t],c,!0)):(a=i[e][r],l=i[t][r]),a!==l){if(s.lt(a,l,!1))return-1;if(s.gt(a,l,!1))return 1}return 0});n.values.sort(u),n.dirty=!1,this.dirty=!0}},D.prototype.checkAllIndexes=function(t){var n,r=this.binaryIndices,i=[];for(n in r)e.call(r,n)&&(this.checkIndex(n,t)||i.push(n));return i},D.prototype.checkIndex=function(e,t){(t=t||{}).randomSamplingFactor&&!1!==t.randomSampling&&(t.randomSampling=!0),t.randomSamplingFactor=t.randomSamplingFactor||.1,(t.randomSamplingFactor<0||t.randomSamplingFactor>1)&&(t.randomSamplingFactor=.1);var n,r,i,s,a,l=!0;if(!this.binaryIndices.hasOwnProperty(e))throw new Error("called checkIndex on property without an index: "+e);if(this.adaptiveBinaryIndices||this.ensureIndex(e),(s=(a=this.binaryIndices[e].values).length)!==this.data.length)return t.repair&&this.ensureIndex(e,!0),!1;if(0===s)return!0;var c=-1!==e.indexOf(".");if(1===s)l=0===a[0];else if(t.randomSampling){if(y.$lte(o.getIn(this.data[a[0]],e,c),o.getIn(this.data[a[1]],e,c))||(l=!1),y.$lte(o.getIn(this.data[a[s-2]],e,c),o.getIn(this.data[a[s-1]],e,c))||(l=!1),l)for(r=Math.floor((s-1)*t.randomSamplingFactor),n=0;n<r-1;n++)if(i=Math.floor(Math.random()*(s-1)),!y.$lte(o.getIn(this.data[a[i]],e,c),o.getIn(this.data[a[i+1]],e,c))){l=!1;break}}else for(n=0;n<s-1;n++)if(!y.$lte(o.getIn(this.data[a[n]],e,c),o.getIn(this.data[a[n+1]],e,c))){l=!1;break}return!l&&t.repair&&this.ensureIndex(e,!0),l},D.prototype.getBinaryIndexValues=function(e){var t,n=this.binaryIndices[e].values,r=[];for(t=0;t<n.length;t++)r.push(o.getIn(this.data[n[t]],e,!0));return r},D.prototype.getUniqueIndex=function(e,t){var n=this.constraints.unique[e];return!n&&t?this.ensureUniqueIndex(e):n},D.prototype.ensureUniqueIndex=function(e){var t=this.constraints.unique[e];return t||-1==this.uniqueNames.indexOf(e)&&this.uniqueNames.push(e),this.constraints.unique[e]=t=new q(e),this.data.forEach((function(e){t.set(e)})),t},D.prototype.ensureAllIndexes=function(t){var n,r=this.binaryIndices;for(n in r)e.call(r,n)&&this.ensureIndex(n,t)},D.prototype.flagBinaryIndexesDirty=function(){var t,n=this.binaryIndices;for(t in n)e.call(n,t)&&(n[t].dirty=!0)},D.prototype.flagBinaryIndexDirty=function(e){this.binaryIndices[e]&&(this.binaryIndices[e].dirty=!0)},D.prototype.count=function(e){return e?this.chain().find(e).filteredrows.length:this.data.length},D.prototype.ensureId=function(){if(!this.idIndex){for(var e=this.data,t=0,n=e.length,r=new Array(n);t<n;t++)r[t]=e[t].$loki;this.idIndex=r}},D.prototype.ensureIdAsync=function(e){this.async((function(){this.ensureId()}),e)},D.prototype.addDynamicView=function(e,t){var n=new P(this,e,t);return this.DynamicViews.push(n),n},D.prototype.removeDynamicView=function(e){this.DynamicViews=this.DynamicViews.filter((function(t){return t.name!==e}))},D.prototype.getDynamicView=function(e){for(var t=0;t<this.DynamicViews.length;t++)if(this.DynamicViews[t].name===e)return this.DynamicViews[t];return null},D.prototype.findAndUpdate=function(e,t){"function"==typeof e?this.updateWhere(e,t):this.chain().find(e).update(t)},D.prototype.findAndRemove=function(e){this.chain().find(e).remove()},D.prototype.insert=function(e,t){if(!Array.isArray(e))return this.insertOne(e);var n,r=[],i=t&&!this.cloneObjects&&this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0;i&&(this.adaptiveBinaryIndices=!1);try{this.emit("pre-insert",e);for(var o=0,s=e.length;o<s;o++){if(!(n=this.insertOne(e[o],!0)))return;r.push(n)}}finally{i&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}return this.emit("insert",r),1===(r=this.cloneObjects?g(r,this.cloneMethod):r).length?r[0]:r},D.prototype.insertOne=function(e,n){var r,o=null;if("object"!=typeof e?o=new TypeError("Document needs to be an object"):null===e&&(o=new TypeError("Object cannot be null")),null!==o)throw this.emit("error",o),o;var s=this.cloneObjects?g(e,this.cloneMethod):e;if(this.disableFreeze||(s=i(s)),this.disableMeta||(void 0===s.meta?s.meta={revision:0,created:0}:this.disableFreeze||(s.meta=i(s.meta))),n||this.emit("pre-insert",s),this.add(s))return this.disableChangesApi?this.insertMeta(s):this.insertMetaWithChange(s),this.disableFreeze||t(s),r=this.cloneObjects?g(s,this.cloneMethod):s,n||this.emit("insert",r),this.addAutoUpdateObserver(r),r},D.prototype.clear=function(e){var t=this;e=e||{},this.data=[],this.idIndex=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0,this.constraints={unique:{},exact:{}},!0===e.removeIndices?(this.binaryIndices={},this.uniqueNames=[]):Object.keys(this.binaryIndices).forEach((function(e){t.binaryIndices[e].dirty=!1,t.binaryIndices[e].values=[]}))},D.prototype.update=function(n){var r,i,o;if(Array.isArray(n)){o=n.length,(r=!this.cloneObjects&&this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0)&&(this.adaptiveBinaryIndices=!1);try{for(i=0;i<o;i+=1)this.update(n[i])}finally{r&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}}else{if(!e.call(n,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();var s,a,l,c,u,h=this.get(n.$loki,!0),d=this;if(!h)throw new Error("Trying to update a document not in collection.");s=h[0],l=h[1],a=this.cloneObjects||!this.disableDeltaChangesApi&&this.disableFreeze?g(n,this.cloneMethod):n,this.emit("pre-update",n),this.uniqueNames.forEach((function(e){d.getUniqueIndex(e,!0).update(s,a)})),this.data[l]=a,a!==n&&this.addAutoUpdateObserver(n);for(var f=0;f<this.DynamicViews.length;f++)this.DynamicViews[f].evaluateDocument(l,!1);if(this.adaptiveBinaryIndices){var p=this.binaryIndices;for(c in p)this.adaptiveBinaryIndexUpdate(l,c)}else this.flagBinaryIndexesDirty();return this.idIndex[l]=a.$loki,this.isIncremental&&this.dirtyIds.push(a.$loki),this.commit(),this.dirty=!0,a=this.disableChangesApi?this.updateMeta(a):this.updateMetaWithChange(a,s),this.disableFreeze||t(a),u=this.cloneObjects?g(a,this.cloneMethod):a,this.emit("update",u,s),u}catch(e){throw this.rollback(),this.lokiConsoleWrapper.error(e.message),this.emit("error",e),e}}},D.prototype.add=function(e){if("object"!=typeof e)throw new TypeError("Object being added needs to be an object");if(void 0!==e.$loki)throw new Error("Document is already in collection, please use update()");try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1);var t=this.maxId;e.$loki=t,this.disableMeta||(e.meta.version=0);for(var n=0,r=this.uniqueNames.length;n<r;n++)this.getUniqueIndex(this.uniqueNames[n],!0).set(e);this.idIndex&&this.idIndex.push(t),this.isIncremental&&this.dirtyIds.push(t),this.data.push(e);var i=this.data.length-1,o=this.DynamicViews.length;for(n=0;n<o;n++)this.DynamicViews[n].evaluateDocument(i,!0);if(this.adaptiveBinaryIndices){var s=this.binaryIndices;for(var a in s)this.adaptiveBinaryIndexInsert(i,a)}else this.flagBinaryIndexesDirty();return this.commit(),this.dirty=!0,this.cloneObjects?g(e,this.cloneMethod):e}catch(e){throw this.rollback(),this.lokiConsoleWrapper.error(e.message),this.emit("error",e),e}},D.prototype.updateWhere=function(e,t){var n,r=this.where(e),i=0;try{for(;i<r.length;i++)n=t(r[i]),this.update(n)}catch(e){this.rollback(),this.lokiConsoleWrapper.error(e.message)}},D.prototype.removeWhere=function(e){var t;"function"==typeof e?(t=this.data.filter(e),this.remove(t)):this.chain().find(e).remove()},D.prototype.removeDataOnly=function(){this.remove(this.data.slice())},D.prototype.removeBatchByPositions=function(e){var t,n,r,i,o=e.length,s={},a=Object.keys(this.binaryIndices).length,l=Object.keys(this.constraints.unique).length,c=this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0,u=this;try{for(this.startTransaction(),this.ensureId(),r=0;r<o;r++)s[this.idIndex[e[r]]]=!0;if((t=this.DynamicViews.length)>0||a>0||l>0){if(t>0)for(n=0;n<t;n++)this.DynamicViews[n].removeDocument(e);if(this.adaptiveBinaryIndices&&!c){var h,d=this.binaryIndices;for(h in d)this.adaptiveBinaryIndexRemove(e,h)}else this.flagBinaryIndexesDirty();l&&this.uniqueNames.forEach((function(t){var n=u.getUniqueIndex(t);if(n)for(r=0;r<o;r++)null!==(i=u.data[e[r]])[t]&&void 0!==i[t]&&n.remove(i[t])}))}if(!this.disableChangesApi||this.events.delete.length>1)for(r=0;r<o;r++)this.emit("delete",this.data[e[r]]);if(this.data=this.data.filter((function(e){return!s[e.$loki]})),this.isIncremental)for(r=0;r<o;r++)this.dirtyIds.push(this.idIndex[e[r]]);this.idIndex=this.idIndex.filter((function(e){return!s[e]})),this.adaptiveBinaryIndices&&c&&(this.adaptiveBinaryIndices=!1,this.ensureAllIndexes(!0),this.adaptiveBinaryIndices=!0),this.commit(),this.dirty=!0}catch(e){return this.rollback(),c&&(this.adaptiveBinaryIndices=!0),this.lokiConsoleWrapper.error(e.message),this.emit("error",e),null}},D.prototype.removeBatch=function(e){var t,n=e.length,r=this.data.length,i={},o=[];for(t=0;t<r;t++)i[this.data[t].$loki]=t;for(t=0;t<n;t++)"object"==typeof e[t]?o.push(i[e[t].$loki]):o.push(i[e[t]]);this.removeBatchByPositions(o)},D.prototype.remove=function(t){if("number"==typeof t&&(t=this.get(t)),"object"!=typeof t)throw new Error("Parameter is not an object");if(Array.isArray(t))this.removeBatch(t);else{if(!e.call(t,"$loki"))throw new Error("Object is not a document stored in the collection");try{this.startTransaction();var n=this.get(t.$loki,!0),o=n[1],s=this;this.uniqueNames.forEach((function(e){if(null!==t[e]&&void 0!==t[e]){var n=s.getUniqueIndex(e);n&&n.remove(t[e])}}));for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].removeDocument(o);if(this.adaptiveBinaryIndices){var l,c=this.binaryIndices;for(l in c)this.adaptiveBinaryIndexRemove(o,l)}else this.flagBinaryIndexesDirty();return this.data.splice(o,1),this.removeAutoUpdateObserver(t),this.idIndex.splice(o,1),this.isIncremental&&this.dirtyIds.push(t.$loki),this.commit(),this.dirty=!0,this.emit("delete",n[0]),this.disableFreeze||(t=i(t)),delete t.$loki,delete t.meta,this.disableFreeze||r(t),t}catch(e){return this.rollback(),this.lokiConsoleWrapper.error(e.message),this.emit("error",e),null}}},D.prototype.get=function(e,t){this.idIndex||this.ensureId();var n=t||!1,r=this.idIndex,i=r.length-1,o=0,s=o+i>>1;if(e="number"==typeof e?e:parseInt(e,10),isNaN(e))throw new TypeError("Passed id is not an integer");for(;r[o]<r[i];)r[s=o+i>>1]<e?o=s+1:i=s;return i===o&&r[o]===e?n?[this.data[o],o]:this.data[o]:null},D.prototype.getBinaryIndexPosition=function(e,t){var n=o.getIn(this.data[e],t,!0),r=this.binaryIndices[t].values,i=this.calculateRange("$eq",t,n);if(0===i[0]&&-1===i[1])return null;for(var s=i[0],a=i[1],l=s;l<=a;l++)if(r[l]===e)return l;return null},D.prototype.adaptiveBinaryIndexInsert=function(e,t){var n=-1!==t.indexOf("."),r=this.binaryIndices[t].values,i=o.getIn(this.data[e],t,n);!0===this.serializableIndices&&i instanceof Date&&(this.data[e][t]=i.getTime(),i=o.getIn(this.data[e],t));var s=0===r.length?0:this.calculateRangeStart(t,i,!0,n);this.binaryIndices[t].values.splice(s,0,e)},D.prototype.adaptiveBinaryIndexUpdate=function(e,t){var n,r=this.binaryIndices[t].values,i=r.length;for(n=0;n<i&&r[n]!==e;n++);this.binaryIndices[t].values.splice(n,1),this.adaptiveBinaryIndexInsert(e,t)},D.prototype.adaptiveBinaryIndexRemove=function(e,t,n){var r,i,o,s,a,l,c,u=this.binaryIndices[t],h={};if(Array.isArray(e)){if(1!==(s=e.length)){for(o=0;o<s;o++)h[e[o]]=!0;if(u.values=u.values.filter((function(e){return!h[e]})),!0===n)return;var d=e.slice();for(d.sort((function(e,t){return e-t})),r=u.values.length,i=0;i<r;i++){for(a=u.values[i],l=0,o=0;o<s&&a>d[o];o++)l++;u.values[i]-=l}return}e=e[0]}if(null===(c=this.getBinaryIndexPosition(e,t)))return null;if(u.values.splice(c,1),!0!==n)for(r=u.values.length,i=0;i<r;i++)u.values[i]>e&&u.values[i]--},D.prototype.calculateRangeStart=function(e,t,n,r){var i=this.data,a=this.binaryIndices[e].values,l=0,c=a.length-1,u=0;if(0===a.length)return-1;for(o.getIn(i[a[l]],e,r),o.getIn(i[a[c]],e,r);l<c;)u=l+c>>1,s.lt(o.getIn(i[a[u]],e,r),t,!1)?l=u+1:c=u;var h=l;return s.aeq(t,o.getIn(i[a[h]],e,r))?h:s.lt(t,o.getIn(i[a[h]],e,r),!1)?n?h:h-1:n?h+1:h},D.prototype.calculateRangeEnd=function(e,t,n){var r=this.data,i=this.binaryIndices[e].values,a=0,l=i.length-1,c=0;if(0===i.length)return-1;for(o.getIn(r[i[a]],e,n),o.getIn(r[i[l]],e,n);a<l;)c=a+l>>1,s.lt(t,o.getIn(r[i[c]],e,n),!1)?l=c:a=c+1;var u=l;return s.aeq(t,o.getIn(r[i[u]],e,n))?u:s.gt(t,o.getIn(r[i[u]],e,n),!1)?u+1:s.aeq(t,o.getIn(r[i[u-1]],e,n))?u-1:u},D.prototype.calculateRange=function(e,t,n){var r,i,a,l=this.data,c=this.binaryIndices[t].values,u=0,h=c.length-1;if(0===l.length)return[0,-1];var d=-1!==t.indexOf("."),f=o.getIn(l[c[u]],t,d),p=o.getIn(l[c[h]],t,d);switch(e){case"$eq":case"$aeq":case"$dteq":if(s.lt(n,f,!1)||s.gt(n,p,!1))return[0,-1];break;case"$gt":if(s.gt(n,p,!0))return[0,-1];if(s.gt(f,n,!1))return[u,h];break;case"$gte":if(s.gt(n,p,!1))return[0,-1];if(s.gt(f,n,!0))return[u,h];break;case"$lt":if(s.lt(n,f,!0))return[0,-1];if(s.lt(p,n,!1))return[u,h];break;case"$lte":if(s.lt(n,f,!1))return[0,-1];if(s.lt(p,n,!0))return[u,h];break;case"$between":return s.gt(n[0],p,!1)||s.lt(n[1],f,!1)?[0,-1]:((r=this.calculateRangeStart(t,n[0],!1,d))<0&&r++,(a=this.calculateRangeEnd(t,n[1],d))>h&&a--,s.gt(o.getIn(l[c[r]],t,d),n[0],!0)||r++,s.lt(o.getIn(l[c[a]],t,d),n[1],!0)||a--,a<r?[0,-1]:[r,a]);case"$in":for(var y=[],v=[],g=0,b=n.length;g<b;g++)for(var m=this.calculateRange("$eq",t,n[g]),w=m[0];w<=m[1];w++)void 0===y[w]&&(y[w]=!0,v.push(w));return v}switch(e){case"$eq":case"$aeq":case"$dteq":case"$gte":case"$lt":r=this.calculateRangeStart(t,n,!1,d),i=o.getIn(l[c[r]],t,d)}switch(e){case"$eq":case"$aeq":case"$dteq":case"$lte":case"$gt":a=this.calculateRangeEnd(t,n,d),o.getIn(l[c[a]],t,d)}switch(e){case"$eq":case"$aeq":case"$dteq":return s.aeq(i,n)?[r,a]:[0,-1];case"$gt":return s.aeq(o.getIn(l[c[a]],t,d),n)?[a+1,h]:[a,h];case"$gte":return s.aeq(o.getIn(l[c[r]],t,d),n)?[r,h]:[r+1,h];case"$lt":return s.aeq(o.getIn(l[c[r]],t,d),n)?[u,r-1]:[u,r];case"$lte":return s.aeq(o.getIn(l[c[a]],t,d),n)?[u,a]:[u,a-1];default:return[0,l.length-1]}},D.prototype.by=function(e,t){var n;if(void 0===t)return n=this,function(t){return n.by(e,t)};var r=this.getUniqueIndex(e,!0).get(t);return this.cloneObjects?g(r,this.cloneMethod):r},D.prototype.findOne=function(e){e=e||{};var t=this.chain().find(e,!0).data();return Array.isArray(t)&&0===t.length?null:this.cloneObjects?g(t[0],this.cloneMethod):t[0]},D.prototype.chain=function(e,t){var n=new x(this);return void 0===e?n:n.transform(e,t)},D.prototype.find=function(e){return this.chain().find(e).data()},D.prototype.findOneUnindexed=function(e,t){for(var n=this.data.length;n--;)if(o.getIn(this.data[n],e,!0)===t)return this.data[n];return null},D.prototype.startTransaction=function(){if(this.transactional){this.cachedData=g(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices,this.cachedDirtyIds=this.dirtyIds;for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].startTransaction()}},D.prototype.commit=function(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedDirtyIds=null;for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].commit()}},D.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex,this.dirtyIds=this.cachedDirtyIds);for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].rollback()}},D.prototype.async=function(e,t){setTimeout((function(){if("function"!=typeof e)throw new TypeError("Argument passed for async execution is not a function");e(),t()}),0)},D.prototype.where=function(e){return this.chain().where(e).data()},D.prototype.mapReduce=function(e,t){try{return t(this.data.map(e))}catch(e){throw e}},D.prototype.eqJoin=function(e,t,n,r,i){return new x(this).eqJoin(e,t,n,r,i)},D.prototype.stages={},D.prototype.getStage=function(e){return this.stages[e]||(this.stages[e]={}),this.stages[e]},D.prototype.commitLog=[],D.prototype.stage=function(e,t){var n=JSON.parse(JSON.stringify(t));return this.getStage(e)[t.$loki]=n,n},D.prototype.commitStage=function(e,t){var n,r=this.getStage(e),i=(new Date).getTime();for(n in r)this.update(r[n]),this.commitLog.push({timestamp:i,message:t,data:JSON.parse(JSON.stringify(r[n]))});this.stages[e]={}},D.prototype.no_op=function(){},D.prototype.extract=function(e){for(var t=0,n=this.data.length,r=A(e),i=[];t<n;t+=1)i.push($(this.data[t],e,r));return i},D.prototype.max=function(e){return Math.max.apply(null,this.extract(e))},D.prototype.min=function(e){return Math.min.apply(null,this.extract(e))},D.prototype.maxRecord=function(e){for(var t,n=0,r=this.data.length,i=A(e),o={index:0,value:void 0};n<r;n+=1)void 0!==t?t<$(this.data[n],e,i)&&(t=$(this.data[n],e,i),o.index=this.data[n].$loki):(t=$(this.data[n],e,i),o.index=this.data[n].$loki);return o.value=t,o},D.prototype.minRecord=function(e){for(var t,n=0,r=this.data.length,i=A(e),o={index:0,value:void 0};n<r;n+=1)void 0!==t?t>$(this.data[n],e,i)&&(t=$(this.data[n],e,i),o.index=this.data[n].$loki):(t=$(this.data[n],e,i),o.index=this.data[n].$loki);return o.value=t,o},D.prototype.extractNumerical=function(e){return this.extract(e).map(E).filter(Number).filter((function(e){return!isNaN(e)}))},D.prototype.avg=function(e){return L(this.extractNumerical(e))},D.prototype.stdDev=function(e){return N(this.extractNumerical(e))},D.prototype.mode=function(e){var t,n,r,i={},o=this.extract(e);for(n in o.forEach((function(e){i[e]?i[e]+=1:i[e]=1})),i)t?t<i[n]&&(r=n):(r=n,t=i[n]);return r},D.prototype.median=function(e){var t=this.extractNumerical(e);t.sort(M);var n=Math.floor(t.length/2);return t.length%2?t[n]:(t[n-1]+t[n])/2},T.prototype={keys:[],values:[],sort:function(e,t){return e<t?-1:e>t?1:0},setSort:function(e){this.bs=new B(e)},bs:function(){return new B(this.sort)},set:function(e,t){var n=this.bs(this.keys,e);n.found?this.values[n.index]=t:(this.keys.splice(n.index,0,e),this.values.splice(n.index,0,t))},get:function(e){return this.values[z(this.keys,e,this.sort).index]}},q.prototype.keyMap={},q.prototype.lokiMap={},q.prototype.set=function(e){var t=e[this.field];if(null!=t){if(this.keyMap[t])throw new Error("Duplicate key for property "+this.field+": "+t);this.keyMap[t]=e,this.lokiMap[e.$loki]=t}},q.prototype.get=function(e){return this.keyMap[e]},q.prototype.byId=function(e){return this.keyMap[this.lokiMap[e]]},q.prototype.update=function(e,t){if(this.lokiMap[e.$loki]!==t[this.field]){var n=this.lokiMap[e.$loki];this.set(t),this.keyMap[n]=void 0}else this.keyMap[e[this.field]]=t},q.prototype.remove=function(e){var t=this.keyMap[e];if(null==t)throw new Error("Key is not in unique index: "+this.field);this.keyMap[e]=void 0,this.lokiMap[t.$loki]=void 0},q.prototype.clear=function(){this.keyMap=Object.create(null),this.lokiMap=Object.create(null)},F.prototype={set:function(e,t){this.index[e]?this.index[e].push(t):this.index[e]=[t]},remove:function(e,t){var n=this.index[e];for(var r in n)n[r]==t&&n.splice(r,1);n.length<1&&(this.index[e]=void 0)},get:function(e){return this.index[e]},clear:function(e){this.index={}}},R.prototype={keys:[],values:[],sort:function(e,t){return e<t?-1:e>t?1:0},bs:function(){return new B(this.sort)},setSort:function(e){this.bs=new B(e)},set:function(e,t){var n=z(this.keys,e,this.sort);n.found?this.values[n.index].push(t):(this.keys.splice(n.index,0,e),this.values.splice(n.index,0,[t]))},get:function(e){var t=z(this.keys,e,this.sort);return t.found?this.values[t.index]:[]},getLt:function(e){var t=z(this.keys,e,this.sort),n=t.index;return t.found&&n--,this.getAll(e,0,n)},getGt:function(e){var t=z(this.keys,e,this.sort),n=t.index;return t.found&&n++,this.getAll(e,n,this.keys.length)},getAll:function(e,t,n){for(var r=[],i=t;i<n;i++)r=r.concat(this.values[i]);return r},getPos:function(e){return z(this.keys,e,this.sort)},remove:function(e,t){var n=z(this.keys,e,this.sort).index,r=this.values[n];for(var i in r)r[i]==t&&r.splice(i,1);r.length<1&&(this.keys.splice(n,1),this.values.splice(n,1))},clear:function(){this.keys=[],this.values=[]}},I.deepFreeze=t,I.freeze=r,I.unFreeze=i,I.LokiOps=y,I.Collection=D,I.DynamicView=P,I.Resultset=x,I.KeyValueStore=T,I.LokiMemoryAdapter=k,I.LokiPartitioningAdapter=S,I.LokiLocalStorageAdapter=C,I.LokiFsAdapter=O,I.persistenceAdapters={fs:O,localStorage:C},I.aeq=a,I.lt=l,I.gt=c,I.Comparators=s,I}()},void 0===(o="function"==typeof r?r.apply(t,i):r)||(e.exports=o)},1528:function(e,t){var n,r,i;!function(o,s){"use strict";"object"==typeof e.exports?e.exports=s():(r=[],void 0===(i="function"==typeof(n=s)?n.apply(t,r):n)||(e.exports=i))}(0,(function(){"use strict";var e=Object.prototype.toString;function t(e,t){return null!=e&&Object.prototype.hasOwnProperty.call(e,t)}function n(e){if(!e)return!0;if(i(e)&&0===e.length)return!0;if("string"!=typeof e){for(var n in e)if(t(e,n))return!1;return!0}return!1}function r(t){return e.call(t)}var i=Array.isArray||function(t){return"[object Array]"===e.call(t)};function o(e){var t=parseInt(e);return t.toString()===e?t:e}function s(e){var s,a,l=function(e){return Object.keys(l).reduce((function(t,n){return"create"===n||"function"==typeof l[n]&&(t[n]=l[n].bind(l,e)),t}),{})};function c(e,t){if(s(e,t))return e[t]}function u(e,t,n,r){if("number"==typeof t&&(t=[t]),!t||0===t.length)return e;if("string"==typeof t)return u(e,t.split(".").map(o),n,r);var i=t[0],s=a(e,i);return 1===t.length?(void 0!==s&&r||(e[i]=n),s):(void 0===s&&("number"==typeof t[1]?e[i]=[]:e[i]={}),u(e[i],t.slice(1),n,r))}return s=(e=e||{}).includeInheritedProps?function(){return!0}:function(e,n){return"number"==typeof n&&Array.isArray(e)||t(e,n)},a=e.includeInheritedProps?function(e,t){"string"!=typeof t&&"number"!=typeof t&&(t=String(t));var n=c(e,t);if("__proto__"===t||"prototype"===t||"constructor"===t&&"function"==typeof n)throw new Error("For security reasons, object's magic properties cannot be set");return n}:function(e,t){return c(e,t)},l.has=function(n,r){if("number"==typeof r?r=[r]:"string"==typeof r&&(r=r.split(".")),!r||0===r.length)return!!n;for(var s=0;s<r.length;s++){var a=o(r[s]);if(!("number"==typeof a&&i(n)&&a<n.length||(e.includeInheritedProps?a in Object(n):t(n,a))))return!1;n=n[a]}return!0},l.ensureExists=function(e,t,n){return u(e,t,n,!0)},l.set=function(e,t,n,r){return u(e,t,n,r)},l.insert=function(e,t,n,r){var o=l.get(e,t);r=~~r,i(o)||(o=[],l.set(e,t,o)),o.splice(r,0,n)},l.empty=function(e,t){var o,a;if(!n(t)&&(null!=e&&(o=l.get(e,t)))){if("string"==typeof o)return l.set(e,t,"");if(function(e){return"boolean"==typeof e||"[object Boolean]"===r(e)}(o))return l.set(e,t,!1);if("number"==typeof o)return l.set(e,t,0);if(i(o))o.length=0;else{if(!function(e){return"object"==typeof e&&"[object Object]"===r(e)}(o))return l.set(e,t,null);for(a in o)s(o,a)&&delete o[a]}}},l.push=function(e,t){var n=l.get(e,t);i(n)||(n=[],l.set(e,t,n)),n.push.apply(n,Array.prototype.slice.call(arguments,2))},l.coalesce=function(e,t,n){for(var r,i=0,o=t.length;i<o;i++)if(void 0!==(r=l.get(e,t[i])))return r;return n},l.get=function(e,t,n){if("number"==typeof t&&(t=[t]),!t||0===t.length)return e;if(null==e)return n;if("string"==typeof t)return l.get(e,t.split("."),n);var r=o(t[0]),i=a(e,r);return void 0===i?n:1===t.length?i:l.get(e[r],t.slice(1),n)},l.del=function(e,t){if("number"==typeof t&&(t=[t]),null==e)return e;if(n(t))return e;if("string"==typeof t)return l.del(e,t.split("."));var r=o(t[0]);return a(e,r),s(e,r)?1!==t.length?l.del(e[r],t.slice(1)):(i(e)?e.splice(r,1):delete e[r],e):e},l}var a=s();return a.create=s,a.withInheritedProps=s({includeInheritedProps:!0}),a}))},1368:e=>{e.exports=function(e){"use strict";var t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function n(e,t){var n=e[0],r=e[1],i=e[2],o=e[3];r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&i|~r&o)+t[0]-680876936|0)<<7|n>>>25)+r|0)&r|~n&i)+t[1]-389564586|0)<<12|o>>>20)+n|0)&n|~o&r)+t[2]+606105819|0)<<17|i>>>15)+o|0)&o|~i&n)+t[3]-1044525330|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&i|~r&o)+t[4]-176418897|0)<<7|n>>>25)+r|0)&r|~n&i)+t[5]+1200080426|0)<<12|o>>>20)+n|0)&n|~o&r)+t[6]-1473231341|0)<<17|i>>>15)+o|0)&o|~i&n)+t[7]-45705983|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&i|~r&o)+t[8]+1770035416|0)<<7|n>>>25)+r|0)&r|~n&i)+t[9]-1958414417|0)<<12|o>>>20)+n|0)&n|~o&r)+t[10]-42063|0)<<17|i>>>15)+o|0)&o|~i&n)+t[11]-1990404162|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&i|~r&o)+t[12]+1804603682|0)<<7|n>>>25)+r|0)&r|~n&i)+t[13]-40341101|0)<<12|o>>>20)+n|0)&n|~o&r)+t[14]-1502002290|0)<<17|i>>>15)+o|0)&o|~i&n)+t[15]+1236535329|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&o|i&~o)+t[1]-165796510|0)<<5|n>>>27)+r|0)&i|r&~i)+t[6]-1069501632|0)<<9|o>>>23)+n|0)&r|n&~r)+t[11]+643717713|0)<<14|i>>>18)+o|0)&n|o&~n)+t[0]-373897302|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&o|i&~o)+t[5]-701558691|0)<<5|n>>>27)+r|0)&i|r&~i)+t[10]+38016083|0)<<9|o>>>23)+n|0)&r|n&~r)+t[15]-660478335|0)<<14|i>>>18)+o|0)&n|o&~n)+t[4]-405537848|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&o|i&~o)+t[9]+568446438|0)<<5|n>>>27)+r|0)&i|r&~i)+t[14]-1019803690|0)<<9|o>>>23)+n|0)&r|n&~r)+t[3]-187363961|0)<<14|i>>>18)+o|0)&n|o&~n)+t[8]+1163531501|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&o|i&~o)+t[13]-1444681467|0)<<5|n>>>27)+r|0)&i|r&~i)+t[2]-51403784|0)<<9|o>>>23)+n|0)&r|n&~r)+t[7]+1735328473|0)<<14|i>>>18)+o|0)&n|o&~n)+t[12]-1926607734|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r^i^o)+t[5]-378558|0)<<4|n>>>28)+r|0)^r^i)+t[8]-2022574463|0)<<11|o>>>21)+n|0)^n^r)+t[11]+1839030562|0)<<16|i>>>16)+o|0)^o^n)+t[14]-35309556|0)<<23|r>>>9)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r^i^o)+t[1]-1530992060|0)<<4|n>>>28)+r|0)^r^i)+t[4]+1272893353|0)<<11|o>>>21)+n|0)^n^r)+t[7]-155497632|0)<<16|i>>>16)+o|0)^o^n)+t[10]-1094730640|0)<<23|r>>>9)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r^i^o)+t[13]+681279174|0)<<4|n>>>28)+r|0)^r^i)+t[0]-358537222|0)<<11|o>>>21)+n|0)^n^r)+t[3]-722521979|0)<<16|i>>>16)+o|0)^o^n)+t[6]+76029189|0)<<23|r>>>9)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r^i^o)+t[9]-640364487|0)<<4|n>>>28)+r|0)^r^i)+t[12]-421815835|0)<<11|o>>>21)+n|0)^n^r)+t[15]+530742520|0)<<16|i>>>16)+o|0)^o^n)+t[2]-995338651|0)<<23|r>>>9)+i|0,r=((r+=((o=((o+=(r^((n=((n+=(i^(r|~o))+t[0]-198630844|0)<<6|n>>>26)+r|0)|~i))+t[7]+1126891415|0)<<10|o>>>22)+n|0)^((i=((i+=(n^(o|~r))+t[14]-1416354905|0)<<15|i>>>17)+o|0)|~n))+t[5]-57434055|0)<<21|r>>>11)+i|0,r=((r+=((o=((o+=(r^((n=((n+=(i^(r|~o))+t[12]+1700485571|0)<<6|n>>>26)+r|0)|~i))+t[3]-1894986606|0)<<10|o>>>22)+n|0)^((i=((i+=(n^(o|~r))+t[10]-1051523|0)<<15|i>>>17)+o|0)|~n))+t[1]-2054922799|0)<<21|r>>>11)+i|0,r=((r+=((o=((o+=(r^((n=((n+=(i^(r|~o))+t[8]+1873313359|0)<<6|n>>>26)+r|0)|~i))+t[15]-30611744|0)<<10|o>>>22)+n|0)^((i=((i+=(n^(o|~r))+t[6]-1560198380|0)<<15|i>>>17)+o|0)|~n))+t[13]+1309151649|0)<<21|r>>>11)+i|0,r=((r+=((o=((o+=(r^((n=((n+=(i^(r|~o))+t[4]-145523070|0)<<6|n>>>26)+r|0)|~i))+t[11]-1120210379|0)<<10|o>>>22)+n|0)^((i=((i+=(n^(o|~r))+t[2]+718787259|0)<<15|i>>>17)+o|0)|~n))+t[9]-343485551|0)<<21|r>>>11)+i|0,e[0]=n+e[0]|0,e[1]=r+e[1]|0,e[2]=i+e[2]|0,e[3]=o+e[3]|0}function r(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return n}function i(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return n}function o(e){var t,i,o,s,a,l,c=e.length,u=[1732584193,-271733879,-1732584194,271733878];for(t=64;t<=c;t+=64)n(u,r(e.substring(t-64,t)));for(i=(e=e.substring(t-64)).length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;t<i;t+=1)o[t>>2]|=e.charCodeAt(t)<<(t%4<<3);if(o[t>>2]|=128<<(t%4<<3),t>55)for(n(u,o),t=0;t<16;t+=1)o[t]=0;return s=(s=8*c).toString(16).match(/(.*?)(.{0,8})$/),a=parseInt(s[2],16),l=parseInt(s[1],16)||0,o[14]=a,o[15]=l,n(u,o),u}function s(e){var t,r,o,s,a,l,c=e.length,u=[1732584193,-271733879,-1732584194,271733878];for(t=64;t<=c;t+=64)n(u,i(e.subarray(t-64,t)));for(r=(e=t-64<c?e.subarray(t-64):new Uint8Array(0)).length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;t<r;t+=1)o[t>>2]|=e[t]<<(t%4<<3);if(o[t>>2]|=128<<(t%4<<3),t>55)for(n(u,o),t=0;t<16;t+=1)o[t]=0;return s=(s=8*c).toString(16).match(/(.*?)(.{0,8})$/),a=parseInt(s[2],16),l=parseInt(s[1],16)||0,o[14]=a,o[15]=l,n(u,o),u}function a(e){var n,r="";for(n=0;n<4;n+=1)r+=t[e>>8*n+4&15]+t[e>>8*n&15];return r}function l(e){var t;for(t=0;t<e.length;t+=1)e[t]=a(e[t]);return e.join("")}function c(e){return/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e))),e}function u(e,t){var n,r=e.length,i=new ArrayBuffer(r),o=new Uint8Array(i);for(n=0;n<r;n+=1)o[n]=e.charCodeAt(n);return t?o:i}function h(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function d(e,t,n){var r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e)),r.set(new Uint8Array(t),e.byteLength),n?r:r.buffer}function f(e){var t,n=[],r=e.length;for(t=0;t<r-1;t+=2)n.push(parseInt(e.substr(t,2),16));return String.fromCharCode.apply(String,n)}function p(){this.reset()}return l(o("hello")),"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function t(e,t){return(e=0|e||0)<0?Math.max(e+t,0):Math.min(e,t)}ArrayBuffer.prototype.slice=function(n,r){var i,o,s,a,l=this.byteLength,c=t(n,l),u=l;return r!==e&&(u=t(r,l)),c>u?new ArrayBuffer(0):(i=u-c,o=new ArrayBuffer(i),s=new Uint8Array(o),a=new Uint8Array(this,c,i),s.set(a),o)}}(),p.prototype.append=function(e){return this.appendBinary(c(e)),this},p.prototype.appendBinary=function(e){this._buff+=e,this._length+=e.length;var t,i=this._buff.length;for(t=64;t<=i;t+=64)n(this._hash,r(this._buff.substring(t-64,t)));return this._buff=this._buff.substring(t-64),this},p.prototype.end=function(e){var t,n,r=this._buff,i=r.length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)o[t>>2]|=r.charCodeAt(t)<<(t%4<<3);return this._finish(o,i),n=l(this._hash),e&&(n=f(n)),this.reset(),n},p.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},p.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},p.prototype.setState=function(e){return this._buff=e.buff,this._length=e.length,this._hash=e.hash,this},p.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},p.prototype._finish=function(e,t){var r,i,o,s=t;if(e[s>>2]|=128<<(s%4<<3),s>55)for(n(this._hash,e),s=0;s<16;s+=1)e[s]=0;r=(r=8*this._length).toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(r[2],16),o=parseInt(r[1],16)||0,e[14]=i,e[15]=o,n(this._hash,e)},p.hash=function(e,t){return p.hashBinary(c(e),t)},p.hashBinary=function(e,t){var n=l(o(e));return t?f(n):n},p.ArrayBuffer=function(){this.reset()},p.ArrayBuffer.prototype.append=function(e){var t,r=d(this._buff.buffer,e,!0),o=r.length;for(this._length+=e.byteLength,t=64;t<=o;t+=64)n(this._hash,i(r.subarray(t-64,t)));return this._buff=t-64<o?new Uint8Array(r.buffer.slice(t-64)):new Uint8Array(0),this},p.ArrayBuffer.prototype.end=function(e){var t,n,r=this._buff,i=r.length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)o[t>>2]|=r[t]<<(t%4<<3);return this._finish(o,i),n=l(this._hash),e&&(n=f(n)),this.reset(),n},p.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},p.ArrayBuffer.prototype.getState=function(){var e=p.prototype.getState.call(this);return e.buff=h(e.buff),e},p.ArrayBuffer.prototype.setState=function(e){return e.buff=u(e.buff,!0),p.prototype.setState.call(this,e)},p.ArrayBuffer.prototype.destroy=p.prototype.destroy,p.ArrayBuffer.prototype._finish=p.prototype._finish,p.ArrayBuffer.hash=function(e,t){var n=l(s(new Uint8Array(e)));return t?f(n):n},p}()},8322:e=>{e.exports=function(e){"use strict";var t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function n(e,t){var n=e[0],r=e[1],i=e[2],o=e[3];r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&i|~r&o)+t[0]-680876936|0)<<7|n>>>25)+r|0)&r|~n&i)+t[1]-389564586|0)<<12|o>>>20)+n|0)&n|~o&r)+t[2]+606105819|0)<<17|i>>>15)+o|0)&o|~i&n)+t[3]-1044525330|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&i|~r&o)+t[4]-176418897|0)<<7|n>>>25)+r|0)&r|~n&i)+t[5]+1200080426|0)<<12|o>>>20)+n|0)&n|~o&r)+t[6]-1473231341|0)<<17|i>>>15)+o|0)&o|~i&n)+t[7]-45705983|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&i|~r&o)+t[8]+1770035416|0)<<7|n>>>25)+r|0)&r|~n&i)+t[9]-1958414417|0)<<12|o>>>20)+n|0)&n|~o&r)+t[10]-42063|0)<<17|i>>>15)+o|0)&o|~i&n)+t[11]-1990404162|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&i|~r&o)+t[12]+1804603682|0)<<7|n>>>25)+r|0)&r|~n&i)+t[13]-40341101|0)<<12|o>>>20)+n|0)&n|~o&r)+t[14]-1502002290|0)<<17|i>>>15)+o|0)&o|~i&n)+t[15]+1236535329|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&o|i&~o)+t[1]-165796510|0)<<5|n>>>27)+r|0)&i|r&~i)+t[6]-1069501632|0)<<9|o>>>23)+n|0)&r|n&~r)+t[11]+643717713|0)<<14|i>>>18)+o|0)&n|o&~n)+t[0]-373897302|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&o|i&~o)+t[5]-701558691|0)<<5|n>>>27)+r|0)&i|r&~i)+t[10]+38016083|0)<<9|o>>>23)+n|0)&r|n&~r)+t[15]-660478335|0)<<14|i>>>18)+o|0)&n|o&~n)+t[4]-405537848|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&o|i&~o)+t[9]+568446438|0)<<5|n>>>27)+r|0)&i|r&~i)+t[14]-1019803690|0)<<9|o>>>23)+n|0)&r|n&~r)+t[3]-187363961|0)<<14|i>>>18)+o|0)&n|o&~n)+t[8]+1163531501|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r&o|i&~o)+t[13]-1444681467|0)<<5|n>>>27)+r|0)&i|r&~i)+t[2]-51403784|0)<<9|o>>>23)+n|0)&r|n&~r)+t[7]+1735328473|0)<<14|i>>>18)+o|0)&n|o&~n)+t[12]-1926607734|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r^i^o)+t[5]-378558|0)<<4|n>>>28)+r|0)^r^i)+t[8]-2022574463|0)<<11|o>>>21)+n|0)^n^r)+t[11]+1839030562|0)<<16|i>>>16)+o|0)^o^n)+t[14]-35309556|0)<<23|r>>>9)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r^i^o)+t[1]-1530992060|0)<<4|n>>>28)+r|0)^r^i)+t[4]+1272893353|0)<<11|o>>>21)+n|0)^n^r)+t[7]-155497632|0)<<16|i>>>16)+o|0)^o^n)+t[10]-1094730640|0)<<23|r>>>9)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r^i^o)+t[13]+681279174|0)<<4|n>>>28)+r|0)^r^i)+t[0]-358537222|0)<<11|o>>>21)+n|0)^n^r)+t[3]-722521979|0)<<16|i>>>16)+o|0)^o^n)+t[6]+76029189|0)<<23|r>>>9)+i|0,r=((r+=((i=((i+=((o=((o+=((n=((n+=(r^i^o)+t[9]-640364487|0)<<4|n>>>28)+r|0)^r^i)+t[12]-421815835|0)<<11|o>>>21)+n|0)^n^r)+t[15]+530742520|0)<<16|i>>>16)+o|0)^o^n)+t[2]-995338651|0)<<23|r>>>9)+i|0,r=((r+=((o=((o+=(r^((n=((n+=(i^(r|~o))+t[0]-198630844|0)<<6|n>>>26)+r|0)|~i))+t[7]+1126891415|0)<<10|o>>>22)+n|0)^((i=((i+=(n^(o|~r))+t[14]-1416354905|0)<<15|i>>>17)+o|0)|~n))+t[5]-57434055|0)<<21|r>>>11)+i|0,r=((r+=((o=((o+=(r^((n=((n+=(i^(r|~o))+t[12]+1700485571|0)<<6|n>>>26)+r|0)|~i))+t[3]-1894986606|0)<<10|o>>>22)+n|0)^((i=((i+=(n^(o|~r))+t[10]-1051523|0)<<15|i>>>17)+o|0)|~n))+t[1]-2054922799|0)<<21|r>>>11)+i|0,r=((r+=((o=((o+=(r^((n=((n+=(i^(r|~o))+t[8]+1873313359|0)<<6|n>>>26)+r|0)|~i))+t[15]-30611744|0)<<10|o>>>22)+n|0)^((i=((i+=(n^(o|~r))+t[6]-1560198380|0)<<15|i>>>17)+o|0)|~n))+t[13]+1309151649|0)<<21|r>>>11)+i|0,r=((r+=((o=((o+=(r^((n=((n+=(i^(r|~o))+t[4]-145523070|0)<<6|n>>>26)+r|0)|~i))+t[11]-1120210379|0)<<10|o>>>22)+n|0)^((i=((i+=(n^(o|~r))+t[2]+718787259|0)<<15|i>>>17)+o|0)|~n))+t[9]-343485551|0)<<21|r>>>11)+i|0,e[0]=n+e[0]|0,e[1]=r+e[1]|0,e[2]=i+e[2]|0,e[3]=o+e[3]|0}function r(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return n}function i(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return n}function o(e){var t,i,o,s,a,l,c=e.length,u=[1732584193,-271733879,-1732584194,271733878];for(t=64;t<=c;t+=64)n(u,r(e.substring(t-64,t)));for(i=(e=e.substring(t-64)).length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;t<i;t+=1)o[t>>2]|=e.charCodeAt(t)<<(t%4<<3);if(o[t>>2]|=128<<(t%4<<3),t>55)for(n(u,o),t=0;t<16;t+=1)o[t]=0;return s=(s=8*c).toString(16).match(/(.*?)(.{0,8})$/),a=parseInt(s[2],16),l=parseInt(s[1],16)||0,o[14]=a,o[15]=l,n(u,o),u}function s(e){var t,r,o,s,a,l,c=e.length,u=[1732584193,-271733879,-1732584194,271733878];for(t=64;t<=c;t+=64)n(u,i(e.subarray(t-64,t)));for(r=(e=t-64<c?e.subarray(t-64):new Uint8Array(0)).length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;t<r;t+=1)o[t>>2]|=e[t]<<(t%4<<3);if(o[t>>2]|=128<<(t%4<<3),t>55)for(n(u,o),t=0;t<16;t+=1)o[t]=0;return s=(s=8*c).toString(16).match(/(.*?)(.{0,8})$/),a=parseInt(s[2],16),l=parseInt(s[1],16)||0,o[14]=a,o[15]=l,n(u,o),u}function a(e){var n,r="";for(n=0;n<4;n+=1)r+=t[e>>8*n+4&15]+t[e>>8*n&15];return r}function l(e){var t;for(t=0;t<e.length;t+=1)e[t]=a(e[t]);return e.join("")}function c(e){return/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e))),e}function u(e,t){var n,r=e.length,i=new ArrayBuffer(r),o=new Uint8Array(i);for(n=0;n<r;n+=1)o[n]=e.charCodeAt(n);return t?o:i}function h(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function d(e,t,n){var r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e)),r.set(new Uint8Array(t),e.byteLength),n?r:r.buffer}function f(e){var t,n=[],r=e.length;for(t=0;t<r-1;t+=2)n.push(parseInt(e.substr(t,2),16));return String.fromCharCode.apply(String,n)}function p(){this.reset()}return l(o("hello")),"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function t(e,t){return(e=0|e||0)<0?Math.max(e+t,0):Math.min(e,t)}ArrayBuffer.prototype.slice=function(n,r){var i,o,s,a,l=this.byteLength,c=t(n,l),u=l;return r!==e&&(u=t(r,l)),c>u?new ArrayBuffer(0):(i=u-c,o=new ArrayBuffer(i),s=new Uint8Array(o),a=new Uint8Array(this,c,i),s.set(a),o)}}(),p.prototype.append=function(e){return this.appendBinary(c(e)),this},p.prototype.appendBinary=function(e){this._buff+=e,this._length+=e.length;var t,i=this._buff.length;for(t=64;t<=i;t+=64)n(this._hash,r(this._buff.substring(t-64,t)));return this._buff=this._buff.substring(t-64),this},p.prototype.end=function(e){var t,n,r=this._buff,i=r.length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)o[t>>2]|=r.charCodeAt(t)<<(t%4<<3);return this._finish(o,i),n=l(this._hash),e&&(n=f(n)),this.reset(),n},p.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},p.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},p.prototype.setState=function(e){return this._buff=e.buff,this._length=e.length,this._hash=e.hash,this},p.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},p.prototype._finish=function(e,t){var r,i,o,s=t;if(e[s>>2]|=128<<(s%4<<3),s>55)for(n(this._hash,e),s=0;s<16;s+=1)e[s]=0;r=(r=8*this._length).toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(r[2],16),o=parseInt(r[1],16)||0,e[14]=i,e[15]=o,n(this._hash,e)},p.hash=function(e,t){return p.hashBinary(c(e),t)},p.hashBinary=function(e,t){var n=l(o(e));return t?f(n):n},p.ArrayBuffer=function(){this.reset()},p.ArrayBuffer.prototype.append=function(e){var t,r=d(this._buff.buffer,e,!0),o=r.length;for(this._length+=e.byteLength,t=64;t<=o;t+=64)n(this._hash,i(r.subarray(t-64,t)));return this._buff=t-64<o?new Uint8Array(r.buffer.slice(t-64)):new Uint8Array(0),this},p.ArrayBuffer.prototype.end=function(e){var t,n,r=this._buff,i=r.length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)o[t>>2]|=r[t]<<(t%4<<3);return this._finish(o,i),n=l(this._hash),e&&(n=f(n)),this.reset(),n},p.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},p.ArrayBuffer.prototype.getState=function(){var e=p.prototype.getState.call(this);return e.buff=h(e.buff),e},p.ArrayBuffer.prototype.setState=function(e){return e.buff=u(e.buff,!0),p.prototype.setState.call(this,e)},p.ArrayBuffer.prototype.destroy=p.prototype.destroy,p.ArrayBuffer.prototype._finish=p.prototype._finish,p.ArrayBuffer.hash=function(e,t){var n=l(s(new Uint8Array(e)));return t?f(n):n},p}()},2467:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.serialize=t.deserialize=t.registerSerializer=void 0;const r=n(7381);let i=r.DefaultSerializer;t.registerSerializer=function(e){i=r.extendSerializer(i,e)},t.deserialize=function(e){return i.deserialize(e)},t.serialize=function(e){return i.serialize(e)}},7381:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultSerializer=t.extendSerializer=void 0,t.extendSerializer=function(e,t){const n=e.deserialize.bind(e),r=e.serialize.bind(e);return{deserialize:e=>t.deserialize(e,n),serialize:e=>t.serialize(e,r)}};const n={deserialize:e=>Object.assign(Error(e.message),{name:e.name,stack:e.stack}),serialize:e=>({__error_marker:"$$error",message:e.message,name:e.name,stack:e.stack})};t.DefaultSerializer={deserialize(e){return(t=e)&&"object"==typeof t&&"__error_marker"in t&&"$$error"===t.__error_marker?n.deserialize(e):e;var t},serialize:e=>e instanceof Error?n.serialize(e):e}},8258:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.$worker=t.$transferable=t.$terminate=t.$events=t.$errors=void 0,t.$errors=Symbol("thread.errors"),t.$events=Symbol("thread.events"),t.$terminate=Symbol("thread.terminate"),t.$transferable=Symbol("thread.transferable"),t.$worker=Symbol("thread.worker")},8180:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Transfer=t.isTransferDescriptor=void 0;const r=n(8258);t.isTransferDescriptor=function(e){return e&&"object"==typeof e&&e[r.$transferable]},t.Transfer=function(e,t){if(!t){if(!(n=e)||"object"!=typeof n)throw Error();t=[e]}var n;return{[r.$transferable]:!0,send:e,transferables:t}}},3229:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorkerMessageType=t.MasterMessageType=void 0,function(e){e.cancel="cancel",e.run="run"}(t.MasterMessageType||(t.MasterMessageType={})),function(e){e.error="error",e.init="init",e.result="result",e.running="running",e.uncaughtError="uncaughtError"}(t.WorkerMessageType||(t.WorkerMessageType={}))},3447:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default={isWorkerRuntime:function(){const e="undefined"!=typeof self&&"undefined"!=typeof Window&&self instanceof Window;return!("undefined"==typeof self||!self.postMessage||e)},postMessageToMaster:function(e,t){self.postMessage(e,t)},subscribeToMasterMessages:function(e){const t=t=>{e(t.data)};return self.addEventListener("message",t),()=>{self.removeEventListener("message",t)}}}},1934:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{l(r.next(e))}catch(e){o(e)}}function a(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((r=r.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.expose=t.isWorkerRuntime=t.Transfer=t.registerSerializer=void 0;const o=i(n(6898)),s=n(2467),a=n(8180),l=n(3229),c=i(n(3447));var u=n(2467);Object.defineProperty(t,"registerSerializer",{enumerable:!0,get:function(){return u.registerSerializer}});var h=n(8180);Object.defineProperty(t,"Transfer",{enumerable:!0,get:function(){return h.Transfer}}),t.isWorkerRuntime=c.default.isWorkerRuntime;let d=!1;const f=new Map,p=e=>e&&e.type===l.MasterMessageType.run,y=e=>o.default(e)||function(e){return e&&"object"==typeof e&&"function"==typeof e.subscribe}(e);function v(e){return a.isTransferDescriptor(e)?{payload:e.send,transferables:e.transferables}:{payload:e,transferables:void 0}}function g(e,t){const{payload:n,transferables:r}=v(t),i={type:l.WorkerMessageType.error,uid:e,error:s.serialize(n)};c.default.postMessageToMaster(i,r)}function b(e,t,n){const{payload:r,transferables:i}=v(n),o={type:l.WorkerMessageType.result,uid:e,complete:!!t||void 0,payload:r};c.default.postMessageToMaster(o,i)}function m(e){try{const t={type:l.WorkerMessageType.uncaughtError,error:s.serialize(e)};c.default.postMessageToMaster(t)}catch(t){console.error("Not reporting uncaught error back to master thread as it occured while reporting an uncaught error already.\nLatest error:",t,"\nOriginal error:",e)}}function w(e,t,n){return r(this,void 0,void 0,(function*(){let r;try{r=t(...n)}catch(t){return g(e,t)}const i=y(r)?"observable":"promise";if(function(e,t){const n={type:l.WorkerMessageType.running,uid:e,resultType:t};c.default.postMessageToMaster(n)}(e,i),y(r)){const t=r.subscribe((t=>b(e,!1,s.serialize(t))),(t=>{g(e,s.serialize(t)),f.delete(e)}),(()=>{b(e,!0),f.delete(e)}));f.set(e,t)}else try{const t=yield r;b(e,!0,s.serialize(t))}catch(t){g(e,s.serialize(t))}}))}t.expose=function(e){if(!c.default.isWorkerRuntime())throw Error("expose() called in the master thread.");if(d)throw Error("expose() called more than once. This is not possible. Pass an object to expose() if you want to expose multiple functions.");if(d=!0,"function"==typeof e)c.default.subscribeToMasterMessages((t=>{p(t)&&!t.method&&w(t.uid,e,t.args.map(s.deserialize))})),function(){const e={type:l.WorkerMessageType.init,exposed:{type:"function"}};c.default.postMessageToMaster(e)}();else{if("object"!=typeof e||!e)throw Error(`Invalid argument passed to expose(). Expected a function or an object, got: ${e}`);c.default.subscribeToMasterMessages((t=>{p(t)&&t.method&&w(t.uid,e[t.method],t.args.map(s.deserialize))}));!function(e){const t={type:l.WorkerMessageType.init,exposed:{type:"module",methods:e}};c.default.postMessageToMaster(t)}(Object.keys(e).filter((t=>"function"==typeof e[t])))}c.default.subscribeToMasterMessages((e=>{if((t=e)&&t.type===l.MasterMessageType.cancel){const t=e.uid,n=f.get(t);n&&(n.unsubscribe(),f.delete(t))}var t}))},"undefined"!=typeof self&&"function"==typeof self.addEventListener&&c.default.isWorkerRuntime()&&(self.addEventListener("error",(e=>{setTimeout((()=>m(e.error||e)),250)})),self.addEventListener("unhandledrejection",(e=>{const t=e.reason;t&&"string"==typeof t.message&&setTimeout((()=>m(t)),250)}))),"undefined"!=typeof process&&"function"==typeof process.on&&c.default.isWorkerRuntime()&&(process.on("uncaughtException",(e=>{setTimeout((()=>m(e)),250)})),process.on("unhandledRejection",(e=>{e&&"string"==typeof e.message&&setTimeout((()=>m(e)),250)})))},693:()=>{},199:()=>{}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var o=t[r]={exports:{}};return e[r].call(o.exports,o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";n(4063),n(1528);function e(e){return"string"==typeof e?e:e.key}var t=n(3050),r=n.n(t),i=(n(6313),n(8322)),o=n.n(i),s=n(9134),a=n.n(s);let l=0;function c(){let e=(new Date).getTime();return e<=l&&(e=l+1),l=e,e}function u(e=0){return new Promise((t=>setTimeout(t,e)))}Promise.resolve(!0),Promise.resolve(!1),Promise.resolve(null);const h=Promise.resolve();function d(e=null){return"object"==typeof window&&window.requestIdleCallback?new Promise((t=>window.requestIdleCallback(t,{timeout:e}))):u(0)}function f(e){if(!e)throw new Error("ensureNotFalsy() is falsy");return e}function p(e=10){let t="";const n="abcdefghijklmnopqrstuvwxyz";for(let r=0;r<e;r++)t+=n.charAt(Math.floor(Math.random()*n.length));return t}function y(e){return Object.assign({},e)}a()();function v(e){const t=e.split("-");return{height:parseInt(t[0],10),hash:t[1]}}function g(e){const t=Object.assign({},e,{_rev_tree:void 0}),n=JSON.stringify(t);return o().hash(n)}function b(e,t){const n=e.get(t);if(!n)throw new Error("missing value from map "+t);return n}var m=function(e,t){return m=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},m(e,t)};function w(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}m(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}Object.create;function I(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function k(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function S(e,t){for(var n=0,r=t.length,i=e.length;n<r;n++,i++)e[i]=t[n];return e}Object.create;function O(e){return"function"==typeof e}function C(e){var t=e((function(e){Error.call(e),e.stack=(new Error).stack}));return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var x=C((function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}}));function _(e,t){if(e){var n=e.indexOf(t);0<=n&&e.splice(n,1)}}var P=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._teardowns=null}var t;return e.prototype.unsubscribe=function(){var e,t,n,r,i;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var s=I(o),a=s.next();!a.done;a=s.next()){a.value.remove(this)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(t=s.return)&&t.call(s)}finally{if(e)throw e.error}}else o.remove(this);var l=this.initialTeardown;if(O(l))try{l()}catch(e){i=e instanceof x?e.errors:[e]}var c=this._teardowns;if(c){this._teardowns=null;try{for(var u=I(c),h=u.next();!h.done;h=u.next()){var d=h.value;try{E(d)}catch(e){i=null!=i?i:[],e instanceof x?i=S(S([],k(i)),k(e.errors)):i.push(e)}}}catch(e){n={error:e}}finally{try{h&&!h.done&&(r=u.return)&&r.call(u)}finally{if(n)throw n.error}}}if(i)throw new x(i)}},e.prototype.add=function(t){var n;if(t&&t!==this)if(this.closed)E(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._teardowns=null!==(n=this._teardowns)&&void 0!==n?n:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&_(t,e)},e.prototype.remove=function(t){var n=this._teardowns;n&&_(n,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}(),D=P.EMPTY;function A(e){return e instanceof P||e&&"closed"in e&&O(e.remove)&&O(e.add)&&O(e.unsubscribe)}function E(e){O(e)?e():e.unsubscribe()}var j={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},M={setTimeout:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=M.delegate;return((null==n?void 0:n.setTimeout)||setTimeout).apply(void 0,S([],k(e)))},clearTimeout:function(e){var t=M.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function L(e){M.setTimeout((function(){var t=j.onUnhandledError;if(!t)throw e;t(e)}))}function N(){}var $=z("C",void 0,void 0);function z(e,t,n){return{kind:e,value:t,error:n}}var B=null;function T(e){if(j.useDeprecatedSynchronousErrorHandling){var t=!B;if(t&&(B={errorThrown:!1,error:null}),e(),t){var n=B,r=n.errorThrown,i=n.error;if(B=null,r)throw i}}else e()}function q(e){j.useDeprecatedSynchronousErrorHandling&&B&&(B.errorThrown=!0,B.error=e)}var F=function(e){function t(t){var n=e.call(this)||this;return n.isStopped=!1,t?(n.destination=t,A(t)&&t.add(n)):n.destination=J,n}return w(t,e),t.create=function(e,t,n){return new R(e,t,n)},t.prototype.next=function(e){this.isStopped?W(function(e){return z("N",e,void 0)}(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?W(z("E",void 0,e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?W($,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(P),R=function(e){function t(t,n,r){var i,o=e.call(this)||this;if(O(t))i=t;else if(t){var s;i=t.next,n=t.error,r=t.complete,o&&j.useDeprecatedNextContext?(s=Object.create(t)).unsubscribe=function(){return o.unsubscribe()}:s=t,i=null==i?void 0:i.bind(s),n=null==n?void 0:n.bind(s),r=null==r?void 0:r.bind(s)}return o.destination={next:i?V(i,o):N,error:V(null!=n?n:U,o),complete:r?V(r,o):N},o}return w(t,e),t}(F);function V(e,t){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];try{e.apply(void 0,S([],k(t)))}catch(e){j.useDeprecatedSynchronousErrorHandling?q(e):L(e)}}}function U(e){throw e}function W(e,t){var n=j.onStoppedNotification;n&&M.setTimeout((function(){return n(e,t)}))}var J={closed:!0,next:N,error:U,complete:N},K="function"==typeof Symbol&&Symbol.observable||"@@observable";function Q(e){return e}function H(e){return 0===e.length?Q:1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)}}var G=function(){function e(e){e&&(this._subscribe=e)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(e,t,n){var r,i=this,o=(r=e)&&r instanceof F||function(e){return e&&O(e.next)&&O(e.error)&&O(e.complete)}(r)&&A(r)?e:new R(e,t,n);return T((function(){var e=i,t=e.operator,n=e.source;o.add(t?t.call(o,n):n?i._subscribe(o):i._trySubscribe(o))})),o},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},e.prototype.forEach=function(e,t){var n=this;return new(t=Y(t))((function(t,r){var i;i=n.subscribe((function(t){try{e(t)}catch(e){r(e),null==i||i.unsubscribe()}}),r,t)}))},e.prototype._subscribe=function(e){var t;return null===(t=this.source)||void 0===t?void 0:t.subscribe(e)},e.prototype[K]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return H(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=Y(e))((function(e,n){var r;t.subscribe((function(e){return r=e}),(function(e){return n(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e}();function Y(e){var t;return null!==(t=null!=e?e:j.Promise)&&void 0!==t?t:Promise}var X=C((function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})),Z=function(e){function t(){var t=e.call(this)||this;return t.closed=!1,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return w(t,e),t.prototype.lift=function(e){var t=new ee(this,this);return t.operator=e,t},t.prototype._throwIfClosed=function(){if(this.closed)throw new X},t.prototype.next=function(e){var t=this;T((function(){var n,r;if(t._throwIfClosed(),!t.isStopped){var i=t.observers.slice();try{for(var o=I(i),s=o.next();!s.done;s=o.next()){s.value.next(e)}}catch(e){n={error:e}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}}}))},t.prototype.error=function(e){var t=this;T((function(){if(t._throwIfClosed(),!t.isStopped){t.hasError=t.isStopped=!0,t.thrownError=e;for(var n=t.observers;n.length;)n.shift().error(e)}}))},t.prototype.complete=function(){var e=this;T((function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var t=e.observers;t.length;)t.shift().complete()}}))},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return(null===(e=this.observers)||void 0===e?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(t){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var t=this,n=t.hasError,r=t.isStopped,i=t.observers;return n||r?D:(i.push(e),new P((function(){return _(i,e)})))},t.prototype._checkFinalizedStatuses=function(e){var t=this,n=t.hasError,r=t.thrownError,i=t.isStopped;n?e.error(r):i&&e.complete()},t.prototype.asObservable=function(){var e=new G;return e.source=this,e},t.create=function(e,t){return new ee(e,t)},t}(G),ee=function(e){function t(t,n){var r=e.call(this)||this;return r.destination=t,r.source=n,r}return w(t,e),t.prototype.next=function(e){var t,n;null===(n=null===(t=this.destination)||void 0===t?void 0:t.next)||void 0===n||n.call(t,e)},t.prototype.error=function(e){var t,n;null===(n=null===(t=this.destination)||void 0===t?void 0:t.error)||void 0===n||n.call(t,e)},t.prototype.complete=function(){var e,t;null===(t=null===(e=this.destination)||void 0===e?void 0:e.complete)||void 0===t||t.call(e)},t.prototype._subscribe=function(e){var t,n;return null!==(n=null===(t=this.source)||void 0===t?void 0:t.subscribe(e))&&void 0!==n?n:D},t}(Z);const te={isDevMode:()=>!1,deepFreezeWhenDevMode:e=>e,validatePassword(e){throw function(e){const t=e.split("-");let n="RxDB";return t.forEach((e=>{var t;n+=(t=e,(t+="").charAt(0).toUpperCase()+t.substr(1))})),n+="Plugin",new Error(`You are using a function which must be overwritten by a plugin.\n        You should either prevent the usage of this function or add the plugin via:\n            import { ${n} } from 'rxdb/plugins/${e}';\n            addRxPlugin(${n});\n        `)}("encryption")},tunnelErrorMessage:e=>`RxDB Error-Code ${e}.\n        - To find out what this means, use the dev-mode-plugin https://pubkey.github.io/rxdb/custom-build.html#dev-mode\n        - Or search for this code https://github.com/pubkey/rxdb/search?q=${e}\n        `};function ne(e,t,n){return"RxError ("+t+"):\n"+e+"\n"+function(e){let t="";return 0===Object.keys(e).length||(t+="Given parameters: {\n",t+=Object.keys(e).map((t=>{let n="[object Object]";try{n=JSON.stringify(e[t],((e,t)=>void 0===t?null:t),2)}catch(e){}return t+":"+n})).join("\n"),t+="}"),t}(n)}class re extends Error{constructor(e,t,n={}){const r=ne(t,e,n);super(r),this.code=e,this.message=r,this.parameters=n,this.rxdb=!0}get name(){return"RxError ("+this.code+")"}toString(){return this.message}get typeError(){return!1}}TypeError;function ie(e,t){return new re(e,te.tunnelErrorMessage(e),t)}var oe=n(5643),se=n.n(oe);const ae={add:function(e){if("function"==typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope);else{if("function"!=typeof window.addEventListener)return;window.addEventListener("beforeunload",(function(){e()}),!0),window.addEventListener("unload",(function(){e()}),!0)}}};var le=n(199),ce=n.n(le),ue=se()?ce():ae,he=new Set,de=!1;function fe(e){if(de||(de=!0,ue.add(pe)),"function"!=typeof e)throw new Error("Listener is no function");return he.add(e),{remove:function(){return he.delete(e)},run:function(){return he.delete(e),e()}}}function pe(){var e=[];return he.forEach((function(t){e.push(t()),he.delete(t)})),Promise.all(e)}class ye{constructor(e,t){this.lokiDatabase=e,this.databaseSettings=t,this.writesSinceLastRun=0,this.saveQueue=h,this.saveQueueC=0}addWrite(){this.writesSinceLastRun=this.writesSinceLastRun+1,this.run()}async run(){return!this.databaseSettings.adapter||this.saveQueueC>2||(this.saveQueueC=this.saveQueueC+1,this.saveQueue=this.saveQueue.then((async()=>{if(await Promise.all([d(),u(100)]),0===this.writesSinceLastRun)return;if(await Promise.all([d(),u(100)]),await d(),0===this.writesSinceLastRun)return;const e=this.writesSinceLastRun;return this.writesSinceLastRun=0,new Promise(((t,n)=>{this.lokiDatabase.saveDatabase((r=>{r?(this.writesSinceLastRun=this.writesSinceLastRun+e,n(r)):(this.databaseSettings.autosaveCallback&&this.databaseSettings.autosaveCallback(),t())}))}))})).catch((()=>{})).then((()=>{this.saveQueueC=this.saveQueueC-1}))),this.saveQueue}}Promise.resolve(!1);var ve=Promise.resolve(!0),ge=Promise.resolve();function be(e,t){return e||(e=0),new Promise((function(n){return setTimeout((function(){return n(t)}),e)}))}function me(){return Math.random().toString(36).substring(2)}var we=0,Ie=0;function ke(){var e=(new Date).getTime();return e===we?1e3*e+ ++Ie:(we=e,Ie=0,1e3*e)}var Se="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);const Oe={create:function(e){var t={messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(e){t.messagesCallback&&t.messagesCallback(e.data)},t},close:function(e){e.bc.close(),e.subFns=[]},onMessage:function(e,t){e.messagesCallback=t},postMessage:function(e,t){try{return e.bc.postMessage(t,!1),ge}catch(e){return Promise.reject(e)}},canBeUsed:function(){if(Se&&"undefined"==typeof window)return!1;if("function"==typeof BroadcastChannel){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}return!1},type:"native",averageResponseTime:function(){return 150},microSeconds:ke};var Ce=function(){function e(e){this.ttl=e,this.set=new Set,this.timeMap=new Map}return e.prototype.has=function(e){return this.set.has(e)},e.prototype.add=function(e){var t=this;this.timeMap.set(e,xe()),this.set.add(e),setTimeout((function(){!function(e){var t=xe()-e.ttl,n=e.set[Symbol.iterator]();for(;;){var r=n.next().value;if(!r)return;if(!(e.timeMap.get(r)<t))return;e.timeMap.delete(r),e.set.delete(r)}}(t)}),0)},e.prototype.clear=function(){this.set.clear(),this.timeMap.clear()},e}();function xe(){return(new Date).getTime()}function _e(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return void 0===t.webWorkerSupport&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=45e3),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&"function"==typeof e.idb.onclose&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=6e4),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=12e4),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),void 0===t.node.useFastPath&&(t.node.useFastPath=!0),t}var Pe="messages";function De(){if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof window){if(void 0!==window.mozIndexedDB)return window.mozIndexedDB;if(void 0!==window.webkitIndexedDB)return window.webkitIndexedDB;if(void 0!==window.msIndexedDB)return window.msIndexedDB}return!1}function Ae(e,t){var n=e.transaction(Pe).objectStore(Pe),r=[];return new Promise((function(e){(function(){try{var e=IDBKeyRange.bound(t+1,1/0);return n.openCursor(e)}catch(e){return n.openCursor()}}()).onsuccess=function(n){var i=n.target.result;i?i.value.id<t+1?i.continue(t+1):(r.push(i.value),i.continue()):e(r)}}))}function Ee(e,t){return function(e,t){var n=(new Date).getTime()-t,r=e.transaction(Pe).objectStore(Pe),i=[];return new Promise((function(e){r.openCursor().onsuccess=function(t){var r=t.target.result;if(r){var o=r.value;if(!(o.time<n))return void e(i);i.push(o),r.continue()}else e(i)}}))}(e,t).then((function(t){return Promise.all(t.map((function(t){return function(e,t){var n=e.transaction([Pe],"readwrite").objectStore(Pe).delete(t);return new Promise((function(e){n.onsuccess=function(){return e()}}))}(e,t.id)})))}))}function je(e){e.closed||Me(e).then((function(){return be(e.options.idb.fallbackInterval)})).then((function(){return je(e)}))}function Me(e){return e.closed?ge:e.messagesCallback?Ae(e.db,e.lastCursorId).then((function(t){var n=t.filter((function(e){return!!e})).map((function(t){return t.id>e.lastCursorId&&(e.lastCursorId=t.id),t})).filter((function(t){return function(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}(t,e)})).sort((function(e,t){return e.time-t.time}));return n.forEach((function(t){e.messagesCallback&&(e.eMIs.add(t.id),e.messagesCallback(t.data))})),ge})):ge}const Le={create:function(e,t){return t=_e(t),function(e){var t="pubkey.broadcast-channel-0-"+e,n=De().open(t,1);return n.onupgradeneeded=function(e){e.target.result.createObjectStore(Pe,{keyPath:"id",autoIncrement:!0})},new Promise((function(e,t){n.onerror=function(e){return t(e)},n.onsuccess=function(){e(n.result)}}))}(e).then((function(n){var r={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:me(),eMIs:new Ce(2*t.idb.ttl),writeBlockPromise:ge,messagesCallback:null,readQueuePromises:[],db:n};return n.onclose=function(){r.closed=!0,t.idb.onclose&&t.idb.onclose()},je(r),r}))},close:function(e){e.closed=!0,e.db.close()},onMessage:function(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t,Me(e)},postMessage:function(e,t){return e.writeBlockPromise=e.writeBlockPromise.then((function(){return function(e,t,n){var r={uuid:t,time:(new Date).getTime(),data:n},i=e.transaction([Pe],"readwrite");return new Promise((function(e,t){i.oncomplete=function(){return e()},i.onerror=function(e){return t(e)},i.objectStore(Pe).add(r)}))}(e.db,e.uuid,t)})).then((function(){var t,n;0===(t=0,n=10,Math.floor(Math.random()*(n-t+1)+t))&&Ee(e.db,e.options.idb.ttl)})),e.writeBlockPromise},canBeUsed:function(){return!Se&&!!De()},type:"idb",averageResponseTime:function(e){return 2*e.idb.fallbackInterval},microSeconds:ke};function Ne(){var e;if("undefined"==typeof window)return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch(e){}return e}function $e(e){return"pubkey.broadcastChannel-"+e}function ze(){if(Se)return!1;var e=Ne();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch(e){return!1}return!0}const Be={create:function(e,t){if(t=_e(t),!ze())throw new Error("BroadcastChannel: localstorage cannot be used");var n=me(),r=new Ce(t.localstorage.removeTimeout),i={channelName:e,uuid:n,eMIs:r};return i.listener=function(e,t){var n=$e(e),r=function(e){e.key===n&&t(JSON.parse(e.newValue))};return window.addEventListener("storage",r),r}(e,(function(e){i.messagesCallback&&e.uuid!==n&&e.token&&!r.has(e.token)&&(e.data.time&&e.data.time<i.messagesCallbackTime||(r.add(e.token),i.messagesCallback(e.data)))})),i},close:function(e){var t;t=e.listener,window.removeEventListener("storage",t)},onMessage:function(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t},postMessage:function(e,t){return new Promise((function(n){be().then((function(){var r=$e(e.channelName),i={token:me(),time:(new Date).getTime(),data:t,uuid:e.uuid},o=JSON.stringify(i);Ne().setItem(r,o);var s=document.createEvent("Event");s.initEvent("storage",!0,!0),s.key=r,s.newValue=o,window.dispatchEvent(s),n()}))}))},canBeUsed:ze,type:"localstorage",averageResponseTime:function(){var e=navigator.userAgent.toLowerCase();return e.includes("safari")&&!e.includes("chrome")?240:120},microSeconds:ke};var Te=ke,qe=new Set;const Fe={create:function(e){var t={name:e,messagesCallback:null};return qe.add(t),t},close:function(e){qe.delete(e)},onMessage:function(e,t){e.messagesCallback=t},postMessage:function(e,t){return new Promise((function(n){return setTimeout((function(){Array.from(qe).filter((function(t){return t.name===e.name})).filter((function(t){return t!==e})).filter((function(e){return!!e.messagesCallback})).forEach((function(e){return e.messagesCallback(t)})),n()}),5)}))},canBeUsed:function(){return!0},type:"simulate",averageResponseTime:function(){return 5},microSeconds:Te};var Re=[Oe,Le,Be];var Ve,Ue=new Set,We=0,Je=function(e,t){var n,r,i;this.id=We++,Ue.add(this),this.name=e,Ve&&(t=Ve),this.options=_e(t),this.method=function(e){var t=[].concat(e.methods,Re).filter(Boolean);if(e.type){if("simulate"===e.type)return Fe;var n=t.find((function(t){return t.type===e.type}));if(n)return n;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||Se||(t=t.filter((function(e){return"idb"!==e.type})));var r=t.find((function(e){return e.canBeUsed()}));if(r)return r;throw new Error("No useable method found in "+JSON.stringify(Re.map((function(e){return e.type}))))}(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,r=(n=this).method.create(n.name,n.options),(i=r)&&"function"==typeof i.then?(n._prepP=r,r.then((function(e){n._state=e}))):n._state=r};function Ke(e,t,n){var r={time:e.method.microSeconds(),type:t,data:n};return(e._prepP?e._prepP:ge).then((function(){var t=e.method.postMessage(e._state,r);return e._uMP.add(t),t.catch().then((function(){return e._uMP.delete(t)})),t}))}function Qe(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function He(e,t,n){e._addEL[t].push(n),function(e){if(!e._iL&&Qe(e)){var t=function(t){e._addEL[t.type].forEach((function(e){t.time>=e.time&&e.fn(t.data)}))},n=e.method.microSeconds();e._prepP?e._prepP.then((function(){e._iL=!0,e.method.onMessage(e._state,t,n)})):(e._iL=!0,e.method.onMessage(e._state,t,n))}}(e)}function Ge(e,t,n){e._addEL[t]=e._addEL[t].filter((function(e){return e!==n})),function(e){if(e._iL&&!Qe(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}(e)}Je._pubkey=!0,Je.prototype={postMessage:function(e){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed");return Ke(this,"message",e)},postInternal:function(e){return Ke(this,"internal",e)},set onmessage(e){var t={time:this.method.microSeconds(),fn:e};Ge(this,"message",this._onML),e&&"function"==typeof e?(this._onML=t,He(this,"message",t)):this._onML=null},addEventListener:function(e,t){He(this,e,{time:this.method.microSeconds(),fn:t})},removeEventListener:function(e,t){Ge(this,e,this._addEL[e].find((function(e){return e.fn===t})))},close:function(){var e=this;if(!this.closed){Ue.delete(this),this.closed=!0;var t=this._prepP?this._prepP:ge;return this._onML=null,this._addEL.message=[],t.then((function(){return Promise.all(Array.from(e._uMP))})).then((function(){return Promise.all(e._befC.map((function(e){return e()})))})).then((function(){return e.method.close(e._state)}))}},get type(){return this.method.type},get isClosed(){return this.closed}};var Ye=function(e,t){var n=this;this.broadcastChannel=e,this._options=t,this.isLeader=!1,this.hasLeader=!1,this.isDead=!1,this.token=me(),this._aplQ=ge,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var r=function(e){"leader"===e.context&&("death"===e.action&&(n.hasLeader=!1),"tell"===e.action&&(n.hasLeader=!0))};this.broadcastChannel.addEventListener("internal",r),this._lstns.push(r)};function Xe(e,t){var n={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(n)}function Ze(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=function(e,t){return e||(e={}),(e=JSON.parse(JSON.stringify(e))).fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}(t,e);var n=new Ye(e,t);return e._befC.push((function(){return n.die()})),e._leaderElector=n,n}Ye.prototype={applyOnce:function(e){var t=this;if(this.isLeader)return be(0,!0);if(this.isDead)return be(0,!1);if(this._aplQC>1)return this._aplQ;var n=function(){if(t.isLeader)return ve;var n,r=!1,i=new Promise((function(e){n=function(){r=!0,e()}})),o=[],s=function(e){"leader"===e.context&&e.token!=t.token&&(o.push(e),"apply"===e.action&&e.token>t.token&&n(),"tell"===e.action&&(n(),t.hasLeader=!0))};t.broadcastChannel.addEventListener("internal",s);var a=e?4*t._options.responseTime:t._options.responseTime;return Xe(t,"apply").then((function(){return Promise.race([be(a),i.then((function(){return Promise.reject(new Error)}))])})).then((function(){return Xe(t,"apply")})).then((function(){return Promise.race([be(a),i.then((function(){return Promise.reject(new Error)}))])})).catch((function(){})).then((function(){return t.broadcastChannel.removeEventListener("internal",s),!r&&function(e){e.isLeader=!0,e.hasLeader=!0;var t=fe((function(){return e.die()}));e._unl.push(t);var n=function(t){"leader"===t.context&&"apply"===t.action&&Xe(e,"tell"),"leader"!==t.context||"tell"!==t.action||e._dpLC||(e._dpLC=!0,e._dpL(),Xe(e,"tell"))};return e.broadcastChannel.addEventListener("internal",n),e._lstns.push(n),Xe(e,"tell")}(t).then((function(){return!0}))}))};return this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then((function(){return n()})).then((function(){t._aplQC=t._aplQC-1})),this._aplQ.then((function(){return t.isLeader}))},awaitLeadership:function(){return this._aLP||(this._aLP=function(e){if(e.isLeader)return ge;return new Promise((function(t){var n=!1;function r(){n||(n=!0,e.broadcastChannel.removeEventListener("internal",i),t(!0))}e.applyOnce().then((function(){e.isLeader&&r()})),function t(){return be(e._options.fallbackInterval).then((function(){if(!e.isDead&&!n)return e.isLeader?void r():e.applyOnce(!0).then((function(){e.isLeader?r():t()}))}))}();var i=function(t){"leader"===t.context&&"death"===t.action&&(e.hasLeader=!1,e.applyOnce().then((function(){e.isLeader&&r()})))};e.broadcastChannel.addEventListener("internal",i),e._lstns.push(i)}))}(this)),this._aLP},set onduplicate(e){this._dpL=e},die:function(){var e=this;return this._lstns.forEach((function(t){return e.broadcastChannel.removeEventListener("internal",t)})),this._lstns=[],this._unl.forEach((function(e){return e.remove()})),this._unl=[],this.isLeader&&(this.hasLeader=!1,this.isLeader=!1),this.isDead=!0,Xe(this,"death")}};const et="-rxdb-changes",tt="rxdb-lokijs-remote-request",nt="rxdb-lokijs-remote-request-key-object";function rt(e){if(!e.$loki)return e;const t=y(e);return delete t.$loki,delete t.$lastWriteAt,t}function it(e,t,n){return(e?"local":"non-local")+"|"+t+"|"+n}const ot=new Set,st={disableChangesApi:!0,disableMeta:!0,disableDeltaChangesApi:!0,disableFreeze:!0,cloneMethod:"shallow-assign",clone:!1,transactional:!1,autoupdate:!1},at=new Map;function lt(e,t){let n=at.get(e);if(!n){const i=!!t.adapter;n=(async()=>{let n=i?"adapter":"memory";t.persistenceMethod&&(n=t.persistenceMethod);const o=Object.assign({autoload:i,persistenceMethod:n,verbose:!0},t,{autoload:!1,autosave:!1,throttledSaves:!1}),s=new(r())(e+".db",y(o)),a=new ye(s,o);if(i){const e=new Promise(((e,t)=>{s.loadDatabase({},(n=>{o.autoloadCallback&&o.autoloadCallback(n),n?t(n):e()}))}));a.saveQueue=a.saveQueue.then((()=>e)),await e}const l=[];i&&l.push(fe((()=>a.run())));return{database:s,databaseSettings:o,saveQueue:a,collections:{},unloads:l}})(),at.set(e,n)}return n}async function ct(e,t){const n=await at.get(e);n&&(await n.saveQueue.run(),t.forEach((e=>{const t=e.name;delete n.collections[t]})),0===Object.keys(n.collections).length&&(at.delete(e),n.unloads.forEach((e=>e.remove())),await new Promise(((e,t)=>{n.database.close((n=>{n?t(n):e()}))}))))}function ut(t,n){const r=e(t.primaryKey),i=n.sort?n.sort:[{[r]:"asc"}];return(e,t)=>{let r=0;if(i.find((n=>{const i=Object.keys(n)[0],o="asc"===Object.values(n)[0]?1:-1,s=e[i],a=t[i];return s!==a&&(s>a?(r=1*o,!0):(r=-1*o,!0))})),!r)throw ie("SNH",{args:{query:n,a:e,b:t}});return r}}function ht(e,t){let n=e.leaderElectorByLokiDbName.get(t);if(n)n.intancesCount=n.intancesCount+1;else{n={leaderElector:Ze(new Je("rxdb-lokijs-"+t)),intancesCount:1},e.leaderElectorByLokiDbName.set(t,n)}return n.leaderElector}function dt(e,t){const n=e.leaderElectorByLokiDbName.get(t);n&&(n.intancesCount=n.intancesCount-1,0===n.intancesCount&&(n.leaderElector.broadcastChannel.close(),e.leaderElectorByLokiDbName.delete(t)))}let ft=c();class pt{constructor(t,n,r,i,o,s,a){this.storage=t,this.databaseName=n,this.collectionName=r,this.schema=i,this.internals=o,this.options=s,this.databaseSettings=a,this.changes$=new Z,this.lastChangefeedSequence=0,this.instanceId=ft++,this.closed=!1,this.primaryPath=e(this.schema.primaryKey),ot.add(this),this.internals.leaderElector&&this.internals.leaderElector.awaitLeadership().then((()=>{f(this.internals.leaderElector).broadcastChannel.addEventListener("message",(async e=>{if(e.type===tt&&e.requestId&&e.databaseName===this.databaseName&&e.collectionName===this.collectionName&&!e.response){const t=e.operation,n=e.params;let r,i=!1;try{r=await this[t](...n)}catch(e){r=e,i=!0}const o={response:!0,requestId:e.requestId,databaseName:this.databaseName,collectionName:this.collectionName,result:r,isError:i,type:e.type};f(this.internals.leaderElector).broadcastChannel.postMessage(o)}}))}))}getLocalState(){return f(this.internals.localState)}async mustUseLocalState(){if(this.closed)return!1;if(this.internals.localState)return this.internals.localState;const e=f(this.internals.leaderElector);for(;!e.hasLeader;)await e.applyOnce(),await u(0);return this.internals.localState?this.internals.localState:!(!e.isLeader||this.internals.localState)&&(this.internals.localState=yt({databaseName:this.databaseName,collectionName:this.collectionName,options:this.options,schema:this.schema,multiInstance:!!this.internals.leaderElector},this.databaseSettings),this.getLocalState())}async requestRemoteInstance(e,t){const n=f(this.internals.leaderElector).broadcastChannel,r=p(12),i=new Promise(((e,t)=>{const i=o=>{o.type===tt&&!0===o.response&&o.requestId===r&&(o.isError?(n.removeEventListener("message",i),t(o.result)):(n.removeEventListener("message",i),e(o.result)))};n.addEventListener("message",i)}));n.postMessage({response:!1,type:tt,operation:e,params:t,requestId:r,databaseName:this.databaseName,collectionName:this.collectionName});return await i}async addChangeDocumentMeta(e){const t=await this.getLocalState();if(!this.lastChangefeedSequence){const e=t.changesCollection.chain().simplesort("sequence",!0).limit(1).data()[0];e&&(this.lastChangefeedSequence=e.sequence)}const n=this.lastChangefeedSequence+1;t.changesCollection.insert({id:e,sequence:n}),this.lastChangefeedSequence=n}async bulkWrite(e){if(0===e.length)throw ie("P2",{args:{documentWrites:e}});const t=await this.mustUseLocalState();if(!t)return this.requestRemoteInstance("bulkWrite",[e]);await u(0);const n={success:{},error:{}},r={id:p(10),events:[]};return e.forEach((e=>{const i=c(),o=e.document[this.primaryPath],s=t.collection.by(this.primaryPath,o);if(s){const a=s._rev;if(!e.previous&&s._deleted&&(e.previous=s),!e.previous&&!s._deleted||e.previous&&a!==e.previous._rev){const t={isError:!0,status:409,documentId:o,writeRow:e};n.error[o]=t}else{const l=v(a).height+1+"-"+g(e.document),u=!!e.document._deleted,h=Object.assign({},e.document,{$loki:s.$loki,$lastWriteAt:i,_rev:l,_deleted:u,_attachments:{}});t.collection.update(h),this.addChangeDocumentMeta(o);let d=null;if(e.previous&&e.previous._deleted&&!h._deleted)d={id:o,operation:"INSERT",previous:null,doc:rt(h)};else if(!e.previous||e.previous._deleted||h._deleted){if(e.previous&&!e.previous._deleted&&h._deleted){const t=y(e.previous);t._rev=l,d={id:o,operation:"DELETE",previous:t,doc:null}}}else d={id:o,operation:"UPDATE",previous:e.previous,doc:rt(h)};if(!d)throw ie("SNH",{args:{writeRow:e}});r.events.push({eventId:it(!1,o,l),documentId:o,change:d,startTime:i,endTime:c()}),n.success[o]=rt(h)}}else{const s="1-"+g(e.document),a=!!e.document._deleted,l=Object.assign({},e.document,{_rev:s,_deleted:a,_attachments:{}}),u=y(l);u.$lastWriteAt=i,t.collection.insert(u),a||(this.addChangeDocumentMeta(o),r.events.push({eventId:it(!1,o,s),documentId:o,change:{doc:l,id:o,operation:"INSERT",previous:null},startTime:i,endTime:c()})),n.success[o]=l}})),t.databaseState.saveQueue.addWrite(),this.changes$.next(r),n}async bulkAddRevisions(e){if(0===e.length)throw ie("P3",{args:{documents:e}});const t=await this.mustUseLocalState();if(!t)return this.requestRemoteInstance("bulkAddRevisions",[e]);await u(0);const n={id:p(10),events:[]};e.forEach((e=>{const r=c(),i=e[this.primaryPath],o=t.collection.by(this.primaryPath,i);if(o){const s=v(e._rev),a=v(o._rev);let l=!1;if(s.height!==a.height?s.height>a.height&&(l=!0):s.hash>a.hash&&(l=!0),l){const s=y(e);s.$loki=o.$loki,s.$lastWriteAt=r,t.collection.update(s);let a=null;o._deleted&&!e._deleted?a={id:i,operation:"INSERT",previous:null,doc:e}:o._deleted||e._deleted?!o._deleted&&e._deleted?a={id:i,operation:"DELETE",previous:rt(o),doc:null}:o._deleted&&e._deleted&&(a=null):a={id:i,operation:"UPDATE",previous:rt(o),doc:e},a&&(n.events.push({documentId:i,eventId:it(!1,i,e._rev),change:a,startTime:r,endTime:c()}),this.addChangeDocumentMeta(i))}}else{const o=y(e);o.$lastWriteAt=r,t.collection.insert(o),n.events.push({documentId:i,eventId:it(!1,i,e._rev),change:{doc:e,id:i,operation:"INSERT",previous:null},startTime:r,endTime:c()}),this.addChangeDocumentMeta(i)}})),t.databaseState.saveQueue.addWrite(),this.changes$.next(n)}async findDocumentsById(e,t){const n=await this.mustUseLocalState();if(!n)return this.requestRemoteInstance("findDocumentsById",[e,t]);const r={};return e.forEach((e=>{const i=n.collection.by(this.primaryPath,e);!i||i._deleted&&!t||(r[e]=rt(i))})),r}async query(e){const t=await this.mustUseLocalState();if(!t)return this.requestRemoteInstance("query",[e]);let n=t.collection.chain().find(e.selector);e.sort&&(n=n.sort(ut(this.schema,e))),e.skip&&(n=n.offset(e.skip)),e.limit&&(n=n.limit(e.limit));return{documents:n.data().map((e=>rt(e)))}}getAttachmentData(e,t){throw new Error("Attachments are not implemented in the lokijs RxStorage. Make a pull request.")}async getChangedDocuments(e){const t=await this.mustUseLocalState();if(!t)return this.requestRemoteInstance("getChangedDocuments",[e]);const n="before"===e.direction,r="after"===e.direction?"$gt":"$lt";let i=t.changesCollection.chain().find({sequence:{[r]:e.sinceSequence}}).simplesort("sequence",n);e.limit&&(i=i.limit(e.limit));const o=i.data().map((e=>({id:e.id,sequence:e.sequence}))),s=n?o[0]:(a=o)[a.length-1];var a;return{changedDocuments:o,lastSequence:s?s.sequence:e.sinceSequence}}changeStream(){return this.changes$.asObservable()}async close(){if(this.closed=!0,this.changes$.complete(),ot.delete(this),this.internals.localState){const e=await this.internals.localState,t=await lt(this.databaseName,this.databaseSettings);await t.saveQueue.run(),await ct(this.databaseName,[e.collection,e.changesCollection])}dt(this.storage,this.databaseName)}async remove(){const e=await this.mustUseLocalState();if(!e)return this.requestRemoteInstance("remove",[]);e.databaseState.database.removeCollection(this.collectionName),e.databaseState.database.removeCollection(e.changesCollection.name),this.close()}}async function yt(t,n){t.options||(t.options={});const r=await lt(t.databaseName,n),i=[];t.schema.indexes&&t.schema.indexes.forEach((e=>{Array.isArray(e)||i.push(e)}));const o=e(t.schema.primaryKey);i.push(o);const s=Object.assign({},t.options.collection,{indices:i,unique:[o]},st),a=r.database.addCollection(t.collectionName,s);r.collections[t.collectionName]=a;const l=t.collectionName+et,c=Object.assign({unique:["eventId"],indices:["sequence"]},st),u=r.database.addCollection(l,c);r.collections[t.collectionName]=u;return{databaseState:r,collection:a,changesCollection:u}}let vt=1;class gt{constructor(e,t,n,r,i,o){this.storage=e,this.databaseName=t,this.collectionName=n,this.internals=r,this.options=i,this.databaseSettings=o,this.changes$=new Z,this.instanceId=vt++,this.closed=!1,ot.add(this),this.internals.leaderElector&&this.internals.leaderElector.awaitLeadership().then((()=>{f(this.internals.leaderElector).broadcastChannel.addEventListener("message",(async e=>{if(e.type===nt&&e.requestId&&e.databaseName===this.databaseName&&e.collectionName===this.collectionName&&!e.response){const t=e.operation,n=e.params;let r,i=!1;try{r=await this[t](...n)}catch(e){i=!0,r=e}const o={response:!0,requestId:e.requestId,databaseName:this.databaseName,collectionName:this.collectionName,result:r,isError:i,type:e.type};f(this.internals.leaderElector).broadcastChannel.postMessage(o)}}))}))}getLocalState(){return f(this.internals.localState)}async mustUseLocalState(){if(this.closed)return!1;if(this.internals.localState)return this.internals.localState;const e=f(this.internals.leaderElector);for(;!e.hasLeader;)await e.applyOnce(),await u(0);return this.internals.localState?this.internals.localState:!(!e.isLeader||this.internals.localState)&&(this.internals.localState=bt({databaseName:this.databaseName,collectionName:this.collectionName,options:this.options,multiInstance:!!this.internals.leaderElector},this.databaseSettings),this.getLocalState())}async requestRemoteInstance(e,t){const n=f(this.internals.leaderElector).broadcastChannel,r=p(12),i=new Promise(((e,t)=>{const i=o=>{o.type===nt&&!0===o.response&&o.requestId===r&&(o.isError?(n.removeEventListener("message",i),t(o.result)):(n.removeEventListener("message",i),e(o.result)))};n.addEventListener("message",i)}));n.postMessage({response:!1,type:nt,operation:e,params:t,requestId:r,databaseName:this.databaseName,collectionName:this.collectionName});return await i}async bulkWrite(e){if(0===e.length)throw ie("P2",{args:{documentWrites:e}});const t=await this.mustUseLocalState();if(!t)return this.requestRemoteInstance("bulkWrite",[e]);const n=c();await u(0);const r={success:{},error:{}},i=new Map,o={id:p(10),events:[]};return e.forEach((e=>{const s=e.document._id;i.set(s,e);const a=y(e.document),l=t.collection.by("_id",s),u=e.previous?e.previous:t.collection.by("_id",s),h=(u?v(u._rev).height+1:1)+"-"+g(e.document);if(a._rev=h,l){if(!e.previous||l._rev!==e.previous._rev){const t={isError:!0,status:409,documentId:s,writeRow:e};return void(r.error[s]=t)}{const e=y(a);e.$loki=l.$loki,e.$lastWriteAt=n,t.collection.update(e)}}else{const e=y(a);e.$lastWriteAt=n,t.collection.insert(e)}r.success[s]=rt(a);const d=c();let f;if(e.previous)if(e.document._deleted){const t=y(e.previous);t._rev=h,f={operation:"DELETE",doc:null,id:s,previous:t}}else f={operation:"UPDATE",doc:a,id:s,previous:e.previous};else f={operation:"INSERT",doc:a,id:s,previous:null};if(!e.document._deleted||e.previous&&!e.previous._deleted){const e="DELETE"===f.operation?f.previous:f.doc,t={eventId:it(!0,e._id,e._rev?e._rev:""),documentId:s,change:f,startTime:n,endTime:d};o.events.push(t)}else;})),t.databaseState.saveQueue.addWrite(),this.changes$.next(o),r}async findLocalDocumentsById(e){const t=await this.mustUseLocalState();if(!t)return this.requestRemoteInstance("findLocalDocumentsById",[e]);await u(0);const n={};return e.forEach((e=>{const r=t.collection.by("_id",e);r&&!r._deleted&&(n[e]=rt(r))})),n}changeStream(){return this.changes$.asObservable()}async close(){if(this.closed=!0,this.changes$.complete(),ot.delete(this),this.internals.localState){const e=await this.getLocalState();await ct(this.databaseName,[f(e.collection),f(e.changesCollection)])}dt(this.storage,this.databaseName)}async remove(){const e=await this.mustUseLocalState();if(!e)return this.requestRemoteInstance("remove",[]);e.databaseState.database.removeCollection(e.collection.name),e.databaseState.database.removeCollection(e.changesCollection.name),this.close()}}async function bt(e,t){e.options||(e.options={});const n=await lt(e.databaseName,t),r=Object.assign({},e.options.collection,{indices:[],unique:["_id"]},st),i=n.database.addCollection(e.collectionName,r);n.collections[e.collectionName]=i;const o=e.collectionName+et,s=Object.assign({unique:["eventId"],indices:["sequence"]},st),a=n.database.addCollection(o,s);return n.collections[o]=i,{changesCollection:a,collection:i,databaseState:n}}var mt=function(e){return btoa(e)};var wt=n(1368),It=n.n(wt),kt=self.setImmediate||self.setTimeout;function St(e,t,n,r,i){(n>0||r<t.size)&&(t=function(e,t,n){return e.webkitSlice?e.webkitSlice(t,n):e.slice(t,n)}(t,n,r)),function(e,t){var n=new FileReader;n.onloadend=function(e){var n=e.target.result||new ArrayBuffer(0);t(n)},n.readAsArrayBuffer(e)}(t,(function(t){e.append(t),i()}))}function Ot(e,t,n,r,i){(n>0||r<t.length)&&(t=t.substring(n,r)),e.appendBinary(t),i()}function Ct(e,t){var n="string"==typeof e,r=n?e.length:e.size,i=Math.min(32768,r),o=Math.ceil(r/i),s=0,a=n?new(It()):new(It().ArrayBuffer),l=n?Ot:St;function c(){kt(h)}function u(){var e=function(e){return mt(e)}(a.end(!0));t(e),a.destroy()}function h(){var t=s*i,n=t+i;s++,l(a,e,t,n,s<o?c:u)}h()}const xt={hash:e=>new Promise((t=>{Ct(e,(e=>{t(e)}))})),hashKey:"md5",prepareQuery(t,n){const r=e(t.primaryKey);if(Object.keys(n.selector).length>0?n.selector={$and:[{_deleted:!1},n.selector]}:n.selector={_deleted:!1},n.sort){n.sort.find((e=>{return t=e,Object.keys(t)[0]===r;var t}))||n.sort.push({[r]:"asc"})}else n.sort=[{[r]:"asc"}];return n},getSortComparator:(e,t)=>ut(e,t),getQueryMatcher:(e,t)=>e=>{const n=y(e);n._deleted=!!n._deleted;const i={data:[n],binaryIndices:{}};Object.setPrototypeOf(i,r().Collection.prototype);const o={collection:i};Object.setPrototypeOf(o,r().Resultset.prototype),o.find(t.selector,!0);return o.filteredrows.length>0}};class _t{constructor(e){this.databaseSettings=e,this.name="lokijs",this.statics=xt,this.leaderElectorByLokiDbName=new Map}async createStorageInstance(e){return async function(e,t,n){const r={};if(t.multiInstance){const n=ht(e,t.databaseName);r.leaderElector=n}else r.localState=yt(t,n),await r.localState;const i=new pt(e,t.databaseName,t.collectionName,t.schema,r,t.options,n);return t.multiInstance&&f(r.leaderElector).awaitLeadership().then((()=>{i.mustUseLocalState()})),i}(this,e,this.databaseSettings)}async createKeyObjectStorageInstance(e){return y(e).collectionName=e.collectionName+"-key-object",async function(e,t,n){const r={};if(t.multiInstance){const n=ht(e,t.databaseName);r.leaderElector=n}else r.localState=bt(t,n),await r.localState;const i=new gt(e,t.databaseName,t.collectionName,r,t.options,n);return t.multiInstance&&f(r.leaderElector).awaitLeadership().then((()=>i.mustUseLocalState())),i}(this,e,this.databaseSettings)}}var Pt=n(1934);const Dt=Pt.expose;Pt.registerSerializer,Pt.Transfer;!function(e){let t=0;const n=new Map,r={async createStorageInstance(r){const i=t++,o=await e.storage.createStorageInstance(r);return n.set(i,o),i},bulkWrite:(e,t)=>b(n,e).bulkWrite(t),bulkAddRevisions:(e,t)=>b(n,e).bulkAddRevisions(t),findDocumentsById:(e,t,r)=>b(n,e).findDocumentsById(t,r),query:(e,t)=>b(n,e).query(t),getAttachmentData:(e,t,r)=>b(n,e).getAttachmentData(t,r),getChangedDocuments:(e,t)=>b(n,e).getChangedDocuments(t),changeStream:e=>b(n,e).changeStream(),close:e=>b(n,e).close(),remove:e=>b(n,e).remove(),async createKeyObjectStorageInstance(r){const i=t++,o=await e.storage.createKeyObjectStorageInstance(r);return n.set(i,o),i},bulkWriteLocal:(e,t)=>b(n,e).bulkWrite(t),findLocalDocumentsById:(e,t)=>b(n,e).findLocalDocumentsById(t)};Dt(r)}({storage:function(e={}){return new _t(e)}({adapter:new(n(8930))})})})()})();
//# sourceMappingURL=lokijs-incremental-indexeddb.worker.js.map