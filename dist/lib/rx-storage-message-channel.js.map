{"version":3,"file":"rx-storage-message-channel.js","names":["body","recover","result","e","then","RxStorageMessageChannel","settings","messageChannelByPort","WeakMap","requestIdSeed","randomCouchString","lastRequestId","name","statics","getRequestId","newId","createStorageInstance","params","requestId","waitForOkPromise","firstValueFrom","messages$","pipe","filter","msg","answerTo","send","isCreate","waitForOkResult","error","Error","toString","RxStorageInstanceMessageChannel","databaseName","collectionName","schema","connectionId","ensureNotFalsy","options","storage","internals","changes$","Subject","conflicts$","subs","closed","push","subscribe","method","next","requestRemote","methodName","responsePromise","message","response","bulkWrite","documentWrites","context","findDocumentsById","ids","deleted","query","preparedQuery","count","getAttachmentData","documentId","attachmentId","getChangedDocumentsSince","limit","checkpoint","changeStream","asObservable","cleanup","minDeletedTime","close","PROMISE_RESOLVE_VOID","forEach","sub","unsubscribe","complete","remove","conflictResultionTasks","resolveConflictResultionTask","taskSolution","getRxStorageMessageChannel","exposeRxStorageMessageChannel","instanceByFullName","Map","stateByPort","plainMsg","state","connectionIds","add","storageInstance","changes","conflicts","subMsg","plainMessage","size","closeBreakResponse","fullName","err","errorResponse","version","join","get","newRxStorageInstance","Set","set"],"sources":["../../src/rx-storage-message-channel.ts"],"sourcesContent":["/**\n * This file contains helpers\n * that are in use when the RxStorage run in another JavaScript process,\n * like electron ipcMain/Renderer, WebWorker and so on\n * where we communicate with the main process with the MessageChannel API.\n */\n\nimport {\n    filter,\n    firstValueFrom,\n    Observable,\n    Subject,\n    Subscription\n} from 'rxjs';\nimport type {\n    BulkWriteRow,\n    EventBulk,\n    RxConflictResultionTask,\n    RxConflictResultionTaskSolution,\n    RxDocumentData,\n    RxDocumentDataById,\n    RxJsonSchema,\n    RxStorage,\n    RxStorageBulkWriteResponse,\n    RxStorageChangeEvent,\n    RxStorageCountResult,\n    RxStorageInstance,\n    RxStorageInstanceCreationParams,\n    RxStorageQueryResult,\n    RxStorageStatics\n} from './types';\nimport {\n    ensureNotFalsy,\n    PROMISE_RESOLVE_VOID,\n    randomCouchString\n} from './util';\n\nexport type RxStorageMessageFromRemote = {\n    connectionId: string;\n    answerTo: string; // id of the request\n    method: keyof RxStorageInstance<any, any, any> | 'createRxStorageInstance';\n    error?: any;\n    return?: any;\n};\n\nexport type RxStorageMessageToRemote = {\n    connectionId: string;\n    /**\n     * Unique ID of the request\n     */\n    requestId: string;\n    method: keyof RxStorageInstance<any, any, any>;\n    params: any[];\n};\n\nexport type RxStorageCreateConnectionMessage = {\n    isCreate: true;\n    requestId: string;\n    params: RxStorageInstanceCreationParams<any, any>;\n};\n\nexport type RxStorageMessageChannelInternals = {\n    params: RxStorageInstanceCreationParams<any, any>;\n    connectionId: string;\n};\n\nexport type CreateRemoteRxStorageMethod = (\n    port: MessagePort,\n    params: RxStorageInstanceCreationParams<any, any>\n) => void;\n\nexport type RxStorageMessageChannelSettings = {\n    name: string;\n    statics: RxStorageStatics;\n    send(msg: RxStorageMessageToRemote | RxStorageCreateConnectionMessage): void;\n    messages$: Observable<RxStorageMessageFromRemote>;\n};\n\nexport type RxMessageChannelExposeSettings = {\n    send(msg: RxStorageMessageFromRemote): void;\n    messages$: Observable<RxStorageMessageToRemote | RxStorageCreateConnectionMessage>;\n    /**\n     * The original storage\n     * which actually stores the data.\n     */\n    storage: RxStorage<any, any>;\n};\n\nexport class RxStorageMessageChannel implements RxStorage<RxStorageMessageChannelInternals, any> {\n    public readonly statics: RxStorageStatics;\n    public readonly name: string;\n    public readonly messageChannelByPort = new WeakMap<MessagePort, MessageChannel>();\n    private requestIdSeed: string = randomCouchString(10);\n    private lastRequestId: number = 0;\n    constructor(\n        public readonly settings: RxStorageMessageChannelSettings\n    ) {\n        this.name = settings.name;\n        this.statics = settings.statics;\n    }\n\n    public getRequestId() {\n        const newId = this.lastRequestId++;\n        return this.requestIdSeed + '|' + newId;\n    }\n\n    async createStorageInstance<RxDocType>(\n        params: RxStorageInstanceCreationParams<RxDocType, any>\n    ): Promise<RxStorageInstanceMessageChannel<RxDocType>> {\n\n        const requestId = this.getRequestId();\n        const waitForOkPromise = firstValueFrom(this.settings.messages$.pipe(\n            filter(msg => msg.answerTo === requestId)\n        ));\n        this.settings.send({\n            isCreate: true,\n            requestId,\n            params\n        });\n\n        const waitForOkResult = await waitForOkPromise;\n        if (waitForOkResult.error) {\n            throw new Error('could not create instance ' + waitForOkResult.error.toString());\n        }\n        return new RxStorageInstanceMessageChannel(\n            this,\n            params.databaseName,\n            params.collectionName,\n            params.schema,\n            {\n                params,\n                connectionId: ensureNotFalsy(waitForOkResult.connectionId)\n            },\n            params.options\n        );\n    }\n}\n\nexport class RxStorageInstanceMessageChannel<RxDocType> implements RxStorageInstance<RxDocType, RxStorageMessageChannelInternals, any, any> {\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, any>> = new Subject();\n    private conflicts$: Subject<RxConflictResultionTask<RxDocType>> = new Subject();\n    private subs: Subscription[] = [];\n\n    private closed: boolean = false;\n    messages$: Observable<RxStorageMessageFromRemote>;\n\n    constructor(\n        public readonly storage: RxStorageMessageChannel,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<RxDocumentData<RxDocType>>>,\n        public readonly internals: RxStorageMessageChannelInternals,\n        public readonly options: Readonly<any>\n    ) {\n        this.messages$ = this.storage.settings.messages$.pipe(\n            filter(msg => msg.connectionId === this.internals.connectionId)\n        );\n        this.subs.push(\n            this.messages$.subscribe(msg => {\n                if (msg.method === 'changeStream') {\n                    this.changes$.next(msg.return);\n                }\n                if (msg.method === 'conflictResultionTasks') {\n                    this.conflicts$.next(msg.return);\n                }\n            })\n        );\n    }\n\n    private async requestRemote(\n        methodName: keyof RxStorageInstance<any, any, any>,\n        params: any\n    ) {\n        const requestId = this.storage.getRequestId();\n        const responsePromise = firstValueFrom(\n            this.messages$.pipe(\n                filter(msg => msg.answerTo === requestId)\n            )\n        );\n        const message: RxStorageMessageToRemote = {\n            connectionId: this.internals.connectionId,\n            requestId,\n            method: methodName,\n            params\n        };\n        this.storage.settings.send(message);\n        const response = await responsePromise;\n        if (response.error) {\n            throw new Error(response.error);\n        } else {\n            return response.return;\n        }\n    }\n    bulkWrite(\n        documentWrites: BulkWriteRow<RxDocType>[],\n        context: string\n    ): Promise<RxStorageBulkWriteResponse<RxDocType>> {\n        return this.requestRemote('bulkWrite', [documentWrites, context]);\n    }\n    findDocumentsById(ids: string[], deleted: boolean): Promise<RxDocumentDataById<RxDocType>> {\n        return this.requestRemote('findDocumentsById', [ids, deleted]);\n    }\n    query(preparedQuery: any): Promise<RxStorageQueryResult<RxDocType>> {\n        return this.requestRemote('query', [preparedQuery]);\n    }\n    count(preparedQuery: any): Promise<RxStorageCountResult> {\n        return this.requestRemote('count', [preparedQuery]);\n    }\n    getAttachmentData(documentId: string, attachmentId: string): Promise<string> {\n        return this.requestRemote('getAttachmentData', [documentId, attachmentId]);\n    }\n    getChangedDocumentsSince(\n        limit: number,\n        checkpoint?: any\n    ): Promise<\n        {\n            documents: RxDocumentData<RxDocType>[];\n            checkpoint: any;\n        }> {\n        return this.requestRemote('getChangedDocumentsSince', [limit, checkpoint]);\n    }\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, any>> {\n        return this.changes$.asObservable();\n    }\n    cleanup(minDeletedTime: number): Promise<boolean> {\n        return this.requestRemote('cleanup', [minDeletedTime]);\n    }\n    async close(): Promise<void> {\n        if (this.closed) {\n            return PROMISE_RESOLVE_VOID;\n        }\n        this.closed = true;\n        this.subs.forEach(sub => sub.unsubscribe());\n        this.changes$.complete();\n        await this.requestRemote('close', []);\n    }\n    async remove(): Promise<void> {\n        await this.requestRemote('remove', []);\n        return this.close();\n    }\n    conflictResultionTasks(): Observable<RxConflictResultionTask<RxDocType>> {\n        return this.conflicts$;\n    }\n    async resolveConflictResultionTask(taskSolution: RxConflictResultionTaskSolution<RxDocType>): Promise<void> {\n        await this.requestRemote('resolveConflictResultionTask', [taskSolution]);\n    }\n}\n\nexport function getRxStorageMessageChannel(settings: RxStorageMessageChannelSettings) {\n    return new RxStorageMessageChannel(settings);\n}\n\n/**\n * Run this on the 'remote' part,\n * so that RxStorageMessageChannel can connect to it.\n */\nexport function exposeRxStorageMessageChannel(settings: RxMessageChannelExposeSettings) {\n    type InstanceState = {\n        storageInstance: RxStorageInstance<any, any, any>;\n        connectionIds: Set<string>;\n        params: RxStorageInstanceCreationParams<any, any>;\n    };\n    const instanceByFullName: Map<string, InstanceState> = new Map();\n    const stateByPort: Map<MessagePort, {\n        subs: Subscription[];\n        state: InstanceState;\n    }> = new Map();\n\n\n\n    settings.messages$.pipe(\n        filter(msg => !!(msg as RxStorageCreateConnectionMessage).isCreate)\n    ).subscribe(async (plainMsg) => {\n        const msg: RxStorageCreateConnectionMessage = plainMsg as any;\n        const connectionId = randomCouchString(10);\n        const params = msg.params;\n        /**\n         * We de-duplicate the storage instances.\n         * This makes sense in many environments like\n         * electron where on main process contains the storage\n         * for multiple renderer processes. Same goes for SharedWorkers etc.\n         */\n        const fullName = [\n            params.databaseName,\n            params.collectionName,\n            params.schema.version\n        ].join('|');\n        let state = instanceByFullName.get(fullName);\n        if (!state) {\n            try {\n                const newRxStorageInstance = await settings.storage.createStorageInstance(params);\n                state = {\n                    storageInstance: newRxStorageInstance,\n                    connectionIds: new Set(),\n                    params\n                };\n                instanceByFullName.set(fullName, state);\n            } catch (err: any) {\n                settings.send({\n                    answerTo: msg.requestId,\n                    connectionId,\n                    method: 'createRxStorageInstance',\n                    error: err.toString()\n                });\n                return;\n            }\n        }\n        state.connectionIds.add(connectionId);\n        const subs: Subscription[] = [];\n        /**\n         * Automatically subscribe to the streams$\n         * because we always need them.\n         */\n        subs.push(\n            state.storageInstance.changeStream().subscribe(changes => {\n                const message: RxStorageMessageFromRemote = {\n                    connectionId,\n                    answerTo: 'changestream',\n                    method: 'changeStream',\n                    return: changes\n                };\n\n                settings.send(message);\n            })\n        );\n        subs.push(\n            state.storageInstance.conflictResultionTasks().subscribe(conflicts => {\n                const message: RxStorageMessageFromRemote = {\n                    connectionId,\n                    answerTo: 'conflictResultionTasks',\n                    method: 'conflictResultionTasks',\n                    return: conflicts\n                };\n                settings.send(message);\n            })\n        );\n        subs.push(\n            settings.messages$.pipe(\n                filter(subMsg => (subMsg as RxStorageMessageToRemote).connectionId === connectionId)\n            ).subscribe(async (plainMessage) => {\n                const message: RxStorageMessageToRemote = plainMessage as any;\n                let result;\n                try {\n                    /**\n                     * On calls to 'close()',\n                     * we only close the main instance if there are no other\n                     * ports connected.\n                     */\n                    if (\n                        message.method === 'close' &&\n                        ensureNotFalsy(state).connectionIds.size > 1\n                    ) {\n                        const closeBreakResponse: RxStorageMessageFromRemote = {\n                            connectionId,\n                            answerTo: message.requestId,\n                            method: message.method,\n                            return: null\n                        };\n                        settings.send(closeBreakResponse);\n                        ensureNotFalsy(state).connectionIds.delete(connectionId);\n                        subs.forEach(sub => sub.unsubscribe());\n                        return;\n                    }\n\n                    result = await (ensureNotFalsy(state).storageInstance as any)[message.method](...message.params);\n                    if (\n                        message.method === 'close' ||\n                        message.method === 'remove'\n                    ) {\n                        subs.forEach(sub => sub.unsubscribe());\n                        ensureNotFalsy(state).connectionIds.delete(connectionId);\n                        instanceByFullName.delete(fullName);\n                        /**\n                         * TODO how to notify the other ports on remove() ?\n                         */\n                    }\n                    const response: RxStorageMessageFromRemote = {\n                        connectionId,\n                        answerTo: message.requestId,\n                        method: message.method,\n                        return: result\n                    };\n                    settings.send(response);\n                } catch (err) {\n                    const errorResponse: RxStorageMessageFromRemote = {\n                        connectionId,\n                        answerTo: message.requestId,\n                        method: message.method,\n                        error: (err as any).toString()\n                    };\n                    settings.send(errorResponse);\n                }\n            })\n        );\n\n        settings.send({\n            answerTo: msg.requestId,\n            connectionId,\n            method: 'createRxStorageInstance'\n        });\n    });\n\n    return {\n        instanceByFullName,\n        stateByPort\n    };\n}\n"],"mappings":"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"}