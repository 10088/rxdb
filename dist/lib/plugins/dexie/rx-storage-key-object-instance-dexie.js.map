{"version":3,"sources":["../../../../src/plugins/dexie/rx-storage-key-object-instance-dexie.ts"],"names":["createDexieKeyObjectStorageInstance","storage","params","settings","internals","databaseName","collectionName","version","primaryKey","type","properties","instance","RxStorageKeyObjectInstanceDexie","options","instanceId","changes$","Subject","closed","bulkWrite","documentWrites","state","ret","success","error","eventBulk","id","events","documentKeys","map","writeRow","document","_id","bulkPutData","dexieDb","transaction","dexieTable","startTime","bulkGet","docsInDb","successDocs","forEach","writeRowIdx","writeDoc","docInDb","previous","newRevHeight","_rev","height","newRevision","err","isError","status","documentId","push","bulkPut","endTime","sucessRow","event","operation","doc","_deleted","previousDoc","eventId","storageChangeEvent","change","next","findLocalDocumentsById","ids","withDeleted","idx","documentInDb","changeStream","asObservable","close","complete","remove","Promise","all","dexieChangesTable","clear"],"mappings":"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","sourcesContent":["import type { ChangeEvent } from 'event-reduce-js';\nimport { Observable, Subject } from 'rxjs';\nimport type {\n    BulkWriteLocalRow,\n    DexieSettings,\n    DexieStorageInternals,\n    EventBulk,\n    RxKeyObjectStorageInstanceCreationParams,\n    RxLocalDocumentData,\n    RxLocalStorageBulkWriteResponse,\n    RxStorageBulkWriteLocalError,\n    RxStorageChangeEvent,\n    RxStorageKeyObjectInstance\n} from '../../types';\nimport {\n    createRevision,\n    flatClone,\n    now,\n    parseRevision,\n    randomCouchString\n} from '../../util';\nimport {\n    closeDexieDb,\n    getDexieDbWithTables,\n    getDexieEventKey\n} from './dexie-helper';\nimport { RxStorageDexie } from './rx-storage-dexie';\n\nlet instanceId = 1;\nexport class RxStorageKeyObjectInstanceDexie implements RxStorageKeyObjectInstance<DexieStorageInternals, DexieSettings> {\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxLocalDocumentData>>> = new Subject();\n\n    public instanceId = instanceId++;\n    public closed = false;\n\n    constructor(\n        public readonly storage: RxStorageDexie,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly internals: DexieStorageInternals,\n        public readonly options: Readonly<DexieSettings>,\n        public readonly settings: DexieSettings\n    ) {\n\n    }\n\n    async bulkWrite<RxDocType>(\n        documentWrites: BulkWriteLocalRow<RxDocType>[]\n    ): Promise<RxLocalStorageBulkWriteResponse<RxDocType>> {\n        const state = await this.internals;\n        const ret: RxLocalStorageBulkWriteResponse<RxDocType> = {\n            success: {},\n            error: {}\n        };\n        const eventBulk: EventBulk<RxStorageChangeEvent<RxLocalDocumentData>> = {\n            id: randomCouchString(10),\n            events: []\n        };\n        const documentKeys: string[] = documentWrites.map(writeRow => writeRow.document._id);\n        const bulkPutData: any[] = [];\n        await state.dexieDb.transaction(\n            'rw',\n            state.dexieTable,\n            async () => {\n                const startTime = now();\n                const docsInDb = await state.dexieTable.bulkGet(documentKeys);\n\n                const successDocs: {\n                    writeRow: BulkWriteLocalRow<RxDocType>;\n                    previous: any;\n                    newRevision: string;\n                }[] = [];\n                documentWrites.forEach((writeRow, writeRowIdx) => {\n                    const writeDoc = flatClone(writeRow.document);\n                    const id = writeDoc._id;\n                    const docInDb = docsInDb[writeRowIdx];\n                    const previous = writeRow.previous ? writeRow.previous : docInDb;\n                    const newRevHeight = previous ? parseRevision(previous._rev).height + 1 : 1;\n                    const newRevision = newRevHeight + '-' + createRevision(writeRow.document);\n                    writeDoc._rev = newRevision;\n\n                    if (docInDb) {\n                        if (\n                            !writeRow.previous ||\n                            docInDb._rev !== writeRow.previous._rev\n                        ) {\n                            // conflict error\n                            const err: RxStorageBulkWriteLocalError<RxDocType> = {\n                                isError: true,\n                                status: 409,\n                                documentId: id,\n                                writeRow: writeRow\n                            };\n                            ret.error[id] = err;\n                            return;\n                        } else {\n                            bulkPutData.push(writeDoc);\n                        }\n                    } else {\n                        bulkPutData.push(writeDoc);\n                    }\n\n                    ret.success[id] = writeDoc;\n                    successDocs.push({\n                        writeRow,\n                        previous,\n                        newRevision\n                    });\n                });\n\n                await state.dexieTable.bulkPut(bulkPutData);\n                const endTime = now();\n\n                successDocs.forEach(sucessRow => {\n                    const writeRow = sucessRow.writeRow;\n                    const writeDoc = writeRow.document;\n                    const id = writeDoc._id;\n\n                    let event: ChangeEvent<RxLocalDocumentData<RxDocType>>;\n                    if (!writeRow.previous) {\n                        // was insert\n                        event = {\n                            operation: 'INSERT',\n                            doc: writeDoc,\n                            id: id,\n                            previous: null\n                        };\n                    } else if (writeRow.document._deleted) {\n                        // was delete\n\n                        // we need to add the new revision to the previous doc\n                        // so that the eventkey is calculated correctly.\n                        // Is this a hack? idk.\n                        const previousDoc = flatClone(writeRow.previous);\n                        previousDoc._rev = sucessRow.newRevision;\n\n                        event = {\n                            operation: 'DELETE',\n                            doc: null,\n                            id,\n                            previous: previousDoc\n                        };\n                    } else {\n                        // was update\n                        event = {\n                            operation: 'UPDATE',\n                            doc: writeDoc,\n                            id: id,\n                            previous: writeRow.previous\n                        };\n                    }\n\n                    if (\n                        writeRow.document._deleted &&\n                        (\n                            !writeRow.previous ||\n                            writeRow.previous._deleted\n                        )\n                    ) {\n                        /**\n                         * An already deleted document was added to the storage engine,\n                         * do not emit an event because it does not affect anything.\n                         */\n                    } else {\n                        const doc: RxLocalDocumentData<RxDocType> = event.operation === 'DELETE' ? event.previous as any : event.doc as any;\n                        const eventId = getDexieEventKey(true, doc._id, doc._rev ? doc._rev : '');\n                        const storageChangeEvent: RxStorageChangeEvent<RxLocalDocumentData<RxDocType>> = {\n                            eventId,\n                            documentId: id,\n                            change: event,\n                            startTime,\n                            endTime\n                        };\n                        eventBulk.events.push(storageChangeEvent);\n                    }\n                });\n            }\n        );\n        this.changes$.next(eventBulk);\n        return ret;\n    }\n\n    async findLocalDocumentsById<RxDocType = any>(\n        ids: string[],\n        withDeleted: boolean\n    ): Promise<{ [documentId: string]: RxLocalDocumentData<RxDocType> }> {\n        const state = await this.internals;\n        const ret: { [documentId: string]: RxLocalDocumentData<RxDocType> } = {};\n        const docsInDb = await state.dexieTable.bulkGet(ids);\n        ids.forEach((id, idx) => {\n            const documentInDb = docsInDb[idx];\n            if (\n                documentInDb &&\n                (\n                    withDeleted ||\n                    !documentInDb._deleted\n                )\n            ) {\n                ret[id] = documentInDb;\n            }\n        });\n        return ret;\n    }\n\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxLocalDocumentData<{ [key: string]: any; }>>>> {\n        return this.changes$.asObservable();\n    }\n\n    async close(): Promise<void> {\n        this.closed = true;\n        this.changes$.complete();\n        closeDexieDb(this.internals);\n    }\n\n    async remove(): Promise<void> {\n        const state = await this.internals;\n        await Promise.all([\n            state.dexieChangesTable.clear(),\n            state.dexieTable.clear()\n        ]);\n        return this.close();\n    }\n}\n\n\nexport async function createDexieKeyObjectStorageInstance(\n    storage: RxStorageDexie,\n    params: RxKeyObjectStorageInstanceCreationParams<DexieSettings>,\n    settings: DexieSettings\n): Promise<RxStorageKeyObjectInstanceDexie> {\n    const internals = getDexieDbWithTables(\n        params.databaseName,\n        params.collectionName,\n        settings,\n        {\n            version: 0,\n            primaryKey: '_id',\n            type: 'object',\n            properties: {}\n        }\n    );\n\n    const instance = new RxStorageKeyObjectInstanceDexie(\n        storage,\n        params.databaseName,\n        params.collectionName,\n        internals,\n        params.options,\n        settings\n    );\n\n    return instance;\n}\n"],"file":"rx-storage-key-object-instance-dexie.js"}