{"version":3,"file":"nosql-query-builder.js","names":["NoSqlQueryBuilderClass","mangoQuery","options","_conditions","_fields","queryBuilder","selector","find","limit","skip","sort","forEach","s","where","_path","_val","arguments","length","type","Array","isArray","merge","newRxTypeError","path","equals","val","_ensurePath","eq","or","array","$or","push","apply","nor","$nor","and","$and","mod","slice","conds","$mod","exists","$exists","elemMatch","_criteria","fn","criteria","isObject","$elemMatch","arg","len","i","_pushArr","split","field","ascend","substring","keys","Object","args","source","canMerge","_distinct","method","newRxError","toJSON","query","mQuerySortToRxDBSort","entries","map","k","v","direction","part","OTHER_MANGO_ATTRIBUTES","prototype","OTHER_MANGO_OPERATORS","$conditional","opts","value","$meta","String","toLowerCase","test","valueStr","toString","replace","parseInt","createQueryBuilder"],"sources":["../../../../../src/plugins/query-builder/mquery/nosql-query-builder.ts"],"sourcesContent":["/**\n * this is based on\n * @link https://github.com/aheckmann/mquery/blob/master/lib/mquery.js\n */\nimport {\n    isObject,\n    merge\n} from './mquery-utils';\nimport {\n    newRxTypeError,\n    newRxError\n} from '../../../rx-error';\nimport type {\n    MangoQuery,\n    MangoQuerySelector,\n    MangoQuerySortPart,\n    MangoQuerySortDirection\n} from '../../../types';\n\n\ndeclare type MQueryOptions = {\n    limit?: number;\n    skip?: number;\n    sort?: any;\n};\n\nexport class NoSqlQueryBuilderClass<DocType> {\n\n    public options: MQueryOptions = {};\n    public _conditions: MangoQuerySelector<DocType> = {};\n    public _fields: any = {};\n    public _path?: any;\n    private _distinct: any;\n\n    /**\n     * MQuery constructor used for building queries.\n     *\n     * ####Example:\n     *     var query = new MQuery({ name: 'mquery' });\n     *     query.where('age').gte(21).exec(callback);\n     *\n     */\n    constructor(\n        mangoQuery?: MangoQuery<DocType>\n    ) {\n        if (mangoQuery) {\n            const queryBuilder: NoSqlQueryBuilder<DocType> = this as any;\n\n            if (mangoQuery.selector) {\n                queryBuilder.find(mangoQuery.selector);\n            }\n            if (mangoQuery.limit) {\n                queryBuilder.limit(mangoQuery.limit);\n            }\n            if (mangoQuery.skip) {\n                queryBuilder.skip(mangoQuery.skip);\n            }\n            if (mangoQuery.sort) {\n                mangoQuery.sort.forEach(s => queryBuilder.sort(s));\n            }\n        }\n    }\n\n    /**\n     * Specifies a `path` for use with chaining.\n     */\n    where(_path: string, _val?: MangoQuerySelector<DocType>): NoSqlQueryBuilder<DocType> {\n        if (!arguments.length) return this as any;\n        const type = typeof arguments[0];\n        if ('string' === type) {\n            this._path = arguments[0];\n            if (2 === arguments.length) {\n                this._conditions[this._path] = arguments[1];\n            }\n            return this as any;\n        }\n\n        if ('object' === type && !Array.isArray(arguments[0])) {\n            return this.merge(arguments[0]);\n        }\n\n        throw newRxTypeError('MQ1', {\n            path: arguments[0]\n        });\n    }\n\n    /**\n     * Specifies the complementary comparison value for paths specified with `where()`\n     * ####Example\n     *     User.where('age').equals(49);\n     */\n    equals(val: any): NoSqlQueryBuilder<DocType> {\n        this._ensurePath('equals');\n        const path = this._path;\n        this._conditions[path] = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies the complementary comparison value for paths specified with `where()`\n     * This is alias of `equals`\n     */\n    eq(val: any): NoSqlQueryBuilder<DocType> {\n        this._ensurePath('eq');\n        const path = this._path;\n        this._conditions[path] = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies arguments for an `$or` condition.\n     * ####Example\n     *     query.or([{ color: 'red' }, { status: 'emergency' }])\n     */\n    or(array: any[]): NoSqlQueryBuilder<DocType> {\n        const or = this._conditions.$or || (this._conditions.$or = []);\n        if (!Array.isArray(array)) array = [array];\n        or.push.apply(or, array);\n        return this as any;\n    }\n\n    /**\n     * Specifies arguments for a `$nor` condition.\n     * ####Example\n     *     query.nor([{ color: 'green' }, { status: 'ok' }])\n     */\n    nor(array: any[]): NoSqlQueryBuilder<DocType> {\n        const nor = this._conditions.$nor || (this._conditions.$nor = []);\n        if (!Array.isArray(array)) array = [array];\n        nor.push.apply(nor, array);\n        return this as any;\n    }\n\n    /**\n     * Specifies arguments for a `$and` condition.\n     * ####Example\n     *     query.and([{ color: 'green' }, { status: 'ok' }])\n     * @see $and http://docs.mongodb.org/manual/reference/operator/and/\n     */\n    and(array: any[]): NoSqlQueryBuilder<DocType> {\n        const and = this._conditions.$and || (this._conditions.$and = []);\n        if (!Array.isArray(array)) array = [array];\n        and.push.apply(and, array);\n        return this as any;\n    }\n\n    /**\n     * Specifies a `$mod` condition\n     */\n    mod(_path: string, _val: number): NoSqlQueryBuilder<DocType> {\n        let val;\n        let path;\n\n        if (1 === arguments.length) {\n            this._ensurePath('mod');\n            val = arguments[0];\n            path = this._path;\n        } else if (2 === arguments.length && !Array.isArray(arguments[1])) {\n            this._ensurePath('mod');\n            val = (arguments as any).slice();\n            path = this._path;\n        } else if (3 === arguments.length) {\n            val = (arguments as any).slice(1);\n            path = arguments[0];\n        } else {\n            val = arguments[1];\n            path = arguments[0];\n        }\n\n        const conds = this._conditions[path] || (this._conditions[path] = {});\n        conds.$mod = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies an `$exists` condition\n     * ####Example\n     *     // { name: { $exists: true }}\n     *     Thing.where('name').exists()\n     *     Thing.where('name').exists(true)\n     *     Thing.find().exists('name')\n     */\n    exists(_path: string, _val: number): NoSqlQueryBuilder<DocType> {\n        let path;\n        let val;\n        if (0 === arguments.length) {\n            this._ensurePath('exists');\n            path = this._path;\n            val = true;\n        } else if (1 === arguments.length) {\n            if ('boolean' === typeof arguments[0]) {\n                this._ensurePath('exists');\n                path = this._path;\n                val = arguments[0];\n            } else {\n                path = arguments[0];\n                val = true;\n            }\n        } else if (2 === arguments.length) {\n            path = arguments[0];\n            val = arguments[1];\n        }\n\n        const conds = this._conditions[path] || (this._conditions[path] = {});\n        conds.$exists = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies an `$elemMatch` condition\n     * ####Example\n     *     query.elemMatch('comment', { author: 'autobot', votes: {$gte: 5}})\n     *     query.where('comment').elemMatch({ author: 'autobot', votes: {$gte: 5}})\n     *     query.elemMatch('comment', function (elem) {\n     *       elem.where('author').equals('autobot');\n     *       elem.where('votes').gte(5);\n     *     })\n     *     query.where('comment').elemMatch(function (elem) {\n     *       elem.where({ author: 'autobot' });\n     *       elem.where('votes').gte(5);\n     *     })\n     */\n    elemMatch(_path: string, _criteria: any): NoSqlQueryBuilder<DocType> {\n        if (null === arguments[0])\n            throw newRxTypeError('MQ2');\n\n        let fn;\n        let path;\n        let criteria;\n\n        if ('function' === typeof arguments[0]) {\n            this._ensurePath('elemMatch');\n            path = this._path;\n            fn = arguments[0];\n        } else if (isObject(arguments[0])) {\n            this._ensurePath('elemMatch');\n            path = this._path;\n            criteria = arguments[0];\n        } else if ('function' === typeof arguments[1]) {\n            path = arguments[0];\n            fn = arguments[1];\n        } else if (arguments[1] && isObject(arguments[1])) {\n            path = arguments[0];\n            criteria = arguments[1];\n        } else\n            throw newRxTypeError('MQ2');\n\n        if (fn) {\n            criteria = new NoSqlQueryBuilderClass;\n            fn(criteria);\n            criteria = criteria._conditions;\n        }\n\n        const conds = this._conditions[path] || (this._conditions[path] = {});\n        conds.$elemMatch = criteria;\n        return this as any;\n    }\n\n    /**\n     * Sets the sort order\n     * If an object is passed, values allowed are 'asc', 'desc', 'ascending', 'descending', 1, and -1.\n     * If a string is passed, it must be a space delimited list of path names.\n     * The sort order of each path is ascending unless the path name is prefixed with `-` which will be treated as descending.\n     * ####Example\n     *     query.sort({ field: 'asc', test: -1 });\n     *     query.sort('field -test');\n     *     query.sort([['field', 1], ['test', -1]]);\n     */\n    sort(arg: any): NoSqlQueryBuilder<DocType> {\n        if (!arg) return this as any;\n        let len;\n        const type = typeof arg;\n        // .sort([['field', 1], ['test', -1]])\n        if (Array.isArray(arg)) {\n            len = arg.length;\n            for (let i = 0; i < arg.length; ++i) {\n                _pushArr(this.options, arg[i][0], arg[i][1]);\n            }\n\n            return this as any;\n        }\n\n        // .sort('field -test')\n        if (1 === arguments.length && 'string' === type) {\n            arg = arg.split(/\\s+/);\n            len = arg.length;\n            for (let i = 0; i < len; ++i) {\n                let field = arg[i];\n                if (!field) continue;\n                const ascend = '-' === field[0] ? -1 : 1;\n                if (ascend === -1) field = field.substring(1);\n                push(this.options, field, ascend);\n            }\n\n            return this as any;\n        }\n\n        // .sort({ field: 1, test: -1 })\n        if (isObject(arg)) {\n            const keys = Object.keys(arg);\n            keys.forEach(field => push(this.options, field, arg[field]));\n            return this as any;\n        }\n\n        throw newRxTypeError('MQ3', {\n            args: arguments\n        });\n    }\n\n    /**\n     * Merges another MQuery or conditions object into this one.\n     *\n     * When a MQuery is passed, conditions, field selection and options are merged.\n     *\n     */\n    merge(source: any): NoSqlQueryBuilder<DocType> {\n        if (!source) {\n            return this as any;\n        }\n\n        if (!canMerge(source)) {\n            throw newRxTypeError('MQ4', {\n                source\n            });\n        }\n\n        if (source instanceof NoSqlQueryBuilderClass) {\n            // if source has a feature, apply it to ourselves\n\n            if (source._conditions)\n                merge(this._conditions, source._conditions);\n\n            if (source._fields) {\n                if (!this._fields) this._fields = {};\n                merge(this._fields, source._fields);\n            }\n\n            if (source.options) {\n                if (!this.options) this.options = {};\n                merge(this.options, source.options);\n            }\n\n            if (source._distinct)\n                this._distinct = source._distinct;\n\n            return this as any;\n        }\n\n        // plain object\n        merge(this._conditions, source);\n\n        return this as any;\n    }\n\n    /**\n     * Finds documents.\n     * ####Example\n     *     query.find()\n     *     query.find({ name: 'Burning Lights' })\n     */\n    find(criteria: any): NoSqlQueryBuilder<DocType> {\n        if (canMerge(criteria)) {\n            this.merge(criteria);\n        }\n\n        return this as any;\n    }\n\n    /**\n     * Make sure _path is set.\n     *\n     * @parmam {String} method\n     */\n    _ensurePath(method: any) {\n        if (!this._path) {\n            throw newRxError('MQ5', {\n                method\n            });\n        }\n    }\n\n    toJSON(): {\n        query: MangoQuery<DocType>,\n        path?: string\n    } {\n        const query: MangoQuery<DocType> = {\n            selector: this._conditions,\n        };\n\n        if (this.options.skip) {\n            query.skip = this.options.skip;\n        }\n        if (this.options.limit) {\n            query.limit = this.options.limit;\n        }\n        if (this.options.sort) {\n            query.sort = mQuerySortToRxDBSort(this.options.sort);\n        }\n\n        return {\n            query,\n            path: this._path\n        };\n    }\n}\n\nexport function mQuerySortToRxDBSort<DocType>(\n    sort: { [k: string]: 1 | -1 }\n): MangoQuerySortPart<DocType>[] {\n    return Object.entries(sort).map(([k, v]) => {\n        const direction: MangoQuerySortDirection = v === 1 ? 'asc' : 'desc';\n        const part: MangoQuerySortPart<DocType> = { [k]: direction } as any;\n        return part;\n    });\n}\n\n/**\n * Because some prototype-methods are generated,\n * we have to define the type of NoSqlQueryBuilder here\n */\n\nexport interface NoSqlQueryBuilder<DocType = any> extends NoSqlQueryBuilderClass<DocType> {\n    maxScan: ReturnSelfNumberFunction<DocType>;\n    batchSize: ReturnSelfNumberFunction<DocType>;\n    limit: ReturnSelfNumberFunction<DocType>;\n    skip: ReturnSelfNumberFunction<DocType>;\n    comment: ReturnSelfFunction<DocType>;\n\n    gt: ReturnSelfFunction<DocType>;\n    gte: ReturnSelfFunction<DocType>;\n    lt: ReturnSelfFunction<DocType>;\n    lte: ReturnSelfFunction<DocType>;\n    ne: ReturnSelfFunction<DocType>;\n    in: ReturnSelfFunction<DocType>;\n    nin: ReturnSelfFunction<DocType>;\n    all: ReturnSelfFunction<DocType>;\n    regex: ReturnSelfFunction<DocType>;\n    size: ReturnSelfFunction<DocType>;\n\n}\n\ndeclare type ReturnSelfFunction<DocType> = (v: any) => NoSqlQueryBuilder<DocType>;\ndeclare type ReturnSelfNumberFunction<DocType> = (v: number | null) => NoSqlQueryBuilder<DocType>;\n\n/**\n * limit, skip, maxScan, batchSize, comment\n *\n * Sets these associated options.\n *\n *     query.comment('feed query');\n */\nexport const OTHER_MANGO_ATTRIBUTES = ['limit', 'skip', 'maxScan', 'batchSize', 'comment'];\nOTHER_MANGO_ATTRIBUTES.forEach(function (method) {\n    (NoSqlQueryBuilderClass.prototype as any)[method] = function (v: any) {\n        this.options[method] = v;\n        return this;\n    };\n});\n\n\n/**\n * gt, gte, lt, lte, ne, in, nin, all, regex, size, maxDistance\n *\n *     Thing.where('type').nin(array)\n */\nexport const OTHER_MANGO_OPERATORS = [\n    'gt', 'gte', 'lt', 'lte', 'ne',\n    'in', 'nin', 'all', 'regex', 'size'\n];\nOTHER_MANGO_OPERATORS.forEach(function ($conditional) {\n    (NoSqlQueryBuilderClass.prototype as any)[$conditional] = function () {\n        let path;\n        let val;\n        if (1 === arguments.length) {\n            this._ensurePath($conditional);\n            val = arguments[0];\n            path = this._path;\n        } else {\n            val = arguments[1];\n            path = arguments[0];\n        }\n\n        const conds = this._conditions[path] === null || typeof this._conditions[path] === 'object' ?\n            this._conditions[path] :\n            (this._conditions[path] = {});\n        conds['$' + $conditional] = val;\n        return this;\n    };\n});\n\n\nfunction push(opts: any, field: string, value: any) {\n    if (Array.isArray(opts.sort)) {\n        throw newRxTypeError('MQ6', {\n            opts,\n            field,\n            value\n        });\n    }\n\n    if (value && value.$meta) {\n        const sort = opts.sort || (opts.sort = {});\n        sort[field] = {\n            $meta: value.$meta\n        };\n        return;\n    }\n\n    const val = String(value || 1).toLowerCase();\n    if (!/^(?:ascending|asc|descending|desc|1|-1)$/.test(val)) {\n        if (Array.isArray(value)) value = '[' + value + ']';\n        throw newRxTypeError('MQ7', {\n            field,\n            value\n        });\n    }\n    // store `sort` in a sane format\n    const s = opts.sort || (opts.sort = {});\n    const valueStr = value.toString()\n        .replace('asc', '1')\n        .replace('ascending', '1')\n        .replace('desc', '-1')\n        .replace('descending', '-1');\n    s[field] = parseInt(valueStr, 10);\n}\n\nfunction _pushArr(opts: any, field: string, value: any) {\n    opts.sort = opts.sort || [];\n    if (!Array.isArray(opts.sort)) {\n        throw newRxTypeError('MQ8', {\n            opts,\n            field,\n            value\n        });\n    }\n\n    /*    const valueStr = value.toString()\n            .replace('asc', '1')\n            .replace('ascending', '1')\n            .replace('desc', '-1')\n            .replace('descending', '-1');*/\n    opts.sort.push([field, value]);\n}\n\n\n/**\n * Determines if `conds` can be merged using `mquery().merge()`\n */\nexport function canMerge(conds: any): boolean {\n    return conds instanceof NoSqlQueryBuilderClass || isObject(conds);\n}\n\n\nexport function createQueryBuilder<DocType>(query?: MangoQuery<DocType>): NoSqlQueryBuilder<DocType> {\n    return new NoSqlQueryBuilderClass(query) as NoSqlQueryBuilder<DocType>;\n}\n"],"mappings":"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"}