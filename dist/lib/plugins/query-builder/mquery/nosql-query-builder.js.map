{"version":3,"sources":["../../../../../src/plugins/query-builder/mquery/nosql-query-builder.ts"],"names":["NoSqlQueryBuilderClass","mangoQuery","options","_conditions","_fields","queryBuilder","selector","find","limit","skip","sort","forEach","s","where","_path","_val","arguments","length","type","Array","isArray","merge","path","equals","val","_ensurePath","eq","or","array","$or","push","apply","nor","$nor","and","$and","mod","slice","conds","$mod","exists","$exists","elemMatch","_criteria","fn","criteria","$elemMatch","arg","len","i","_pushArr","split","field","ascend","substring","keys","Object","args","source","canMerge","_distinct","method","toJSON","query","mQuerySortToRxDBSort","entries","map","k","v","direction","part","OTHER_MANGO_ATTRIBUTES","prototype","OTHER_MANGO_OPERATORS","$conditional","opts","value","$meta","String","toLowerCase","test","valueStr","toString","replace","parseInt","createQueryBuilder"],"mappings":"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","sourcesContent":["/**\n * this is based on\n * @link https://github.com/aheckmann/mquery/blob/master/lib/mquery.js\n */\nimport {\n    isObject,\n    merge\n} from './mquery-utils';\nimport {\n    newRxTypeError,\n    newRxError\n} from '../../../rx-error';\nimport type {\n    MangoQuery,\n    MangoQuerySelector,\n    MangoQuerySortPart,\n    MangoQuerySortDirection\n} from '../../../types';\n\n\ndeclare type MQueryOptions = {\n    limit?: number;\n    skip?: number;\n    sort?: any;\n};\n\nexport class NoSqlQueryBuilderClass<DocType> {\n\n    public options: MQueryOptions = {};\n    public _conditions: MangoQuerySelector<DocType> = {};\n    public _fields: any = {};\n    public _path?: any;\n    private _distinct: any;\n\n    /**\n     * MQuery constructor used for building queries.\n     *\n     * ####Example:\n     *     var query = new MQuery({ name: 'mquery' });\n     *     query.where('age').gte(21).exec(callback);\n     *\n     */\n    constructor(\n        mangoQuery?: MangoQuery<DocType>\n    ) {\n        if (mangoQuery) {\n            const queryBuilder: NoSqlQueryBuilder<DocType> = this as any;\n\n            if (mangoQuery.selector) {\n                queryBuilder.find(mangoQuery.selector);\n            }\n            if (mangoQuery.limit) {\n                queryBuilder.limit(mangoQuery.limit);\n            }\n            if (mangoQuery.skip) {\n                queryBuilder.skip(mangoQuery.skip);\n            }\n            if (mangoQuery.sort) {\n                mangoQuery.sort.forEach(s => queryBuilder.sort(s));\n            }\n        }\n    }\n\n    /**\n     * Specifies a `path` for use with chaining.\n     */\n    where(_path: string, _val?: MangoQuerySelector<DocType>): NoSqlQueryBuilder<DocType> {\n        if (!arguments.length) return this as any;\n        const type = typeof arguments[0];\n        if ('string' === type) {\n            this._path = arguments[0];\n            if (2 === arguments.length) {\n                this._conditions[this._path] = arguments[1];\n            }\n            return this as any;\n        }\n\n        if ('object' === type && !Array.isArray(arguments[0])) {\n            return this.merge(arguments[0]);\n        }\n\n        throw newRxTypeError('MQ1', {\n            path: arguments[0]\n        });\n    }\n\n    /**\n     * Specifies the complementary comparison value for paths specified with `where()`\n     * ####Example\n     *     User.where('age').equals(49);\n     */\n    equals(val: any): NoSqlQueryBuilder<DocType> {\n        this._ensurePath('equals');\n        const path = this._path;\n        this._conditions[path] = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies the complementary comparison value for paths specified with `where()`\n     * This is alias of `equals`\n     */\n    eq(val: any): NoSqlQueryBuilder<DocType> {\n        this._ensurePath('eq');\n        const path = this._path;\n        this._conditions[path] = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies arguments for an `$or` condition.\n     * ####Example\n     *     query.or([{ color: 'red' }, { status: 'emergency' }])\n     */\n    or(array: any[]): NoSqlQueryBuilder<DocType> {\n        const or = this._conditions.$or || (this._conditions.$or = []);\n        if (!Array.isArray(array)) array = [array];\n        or.push.apply(or, array);\n        return this as any;\n    }\n\n    /**\n     * Specifies arguments for a `$nor` condition.\n     * ####Example\n     *     query.nor([{ color: 'green' }, { status: 'ok' }])\n     */\n    nor(array: any[]): NoSqlQueryBuilder<DocType> {\n        const nor = this._conditions.$nor || (this._conditions.$nor = []);\n        if (!Array.isArray(array)) array = [array];\n        nor.push.apply(nor, array);\n        return this as any;\n    }\n\n    /**\n     * Specifies arguments for a `$and` condition.\n     * ####Example\n     *     query.and([{ color: 'green' }, { status: 'ok' }])\n     * @see $and http://docs.mongodb.org/manual/reference/operator/and/\n     */\n    and(array: any[]): NoSqlQueryBuilder<DocType> {\n        const and = this._conditions.$and || (this._conditions.$and = []);\n        if (!Array.isArray(array)) array = [array];\n        and.push.apply(and, array);\n        return this as any;\n    }\n\n    /**\n     * Specifies a `$mod` condition\n     */\n    mod(_path: string, _val: number): NoSqlQueryBuilder<DocType> {\n        let val;\n        let path;\n\n        if (1 === arguments.length) {\n            this._ensurePath('mod');\n            val = arguments[0];\n            path = this._path;\n        } else if (2 === arguments.length && !Array.isArray(arguments[1])) {\n            this._ensurePath('mod');\n            val = (arguments as any).slice();\n            path = this._path;\n        } else if (3 === arguments.length) {\n            val = (arguments as any).slice(1);\n            path = arguments[0];\n        } else {\n            val = arguments[1];\n            path = arguments[0];\n        }\n\n        const conds = this._conditions[path] || (this._conditions[path] = {});\n        conds.$mod = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies an `$exists` condition\n     * ####Example\n     *     // { name: { $exists: true }}\n     *     Thing.where('name').exists()\n     *     Thing.where('name').exists(true)\n     *     Thing.find().exists('name')\n     */\n    exists(_path: string, _val: number): NoSqlQueryBuilder<DocType> {\n        let path;\n        let val;\n        if (0 === arguments.length) {\n            this._ensurePath('exists');\n            path = this._path;\n            val = true;\n        } else if (1 === arguments.length) {\n            if ('boolean' === typeof arguments[0]) {\n                this._ensurePath('exists');\n                path = this._path;\n                val = arguments[0];\n            } else {\n                path = arguments[0];\n                val = true;\n            }\n        } else if (2 === arguments.length) {\n            path = arguments[0];\n            val = arguments[1];\n        }\n\n        const conds = this._conditions[path] || (this._conditions[path] = {});\n        conds.$exists = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies an `$elemMatch` condition\n     * ####Example\n     *     query.elemMatch('comment', { author: 'autobot', votes: {$gte: 5}})\n     *     query.where('comment').elemMatch({ author: 'autobot', votes: {$gte: 5}})\n     *     query.elemMatch('comment', function (elem) {\n     *       elem.where('author').equals('autobot');\n     *       elem.where('votes').gte(5);\n     *     })\n     *     query.where('comment').elemMatch(function (elem) {\n     *       elem.where({ author: 'autobot' });\n     *       elem.where('votes').gte(5);\n     *     })\n     */\n    elemMatch(_path: string, _criteria: any): NoSqlQueryBuilder<DocType> {\n        if (null === arguments[0])\n            throw newRxTypeError('MQ2');\n\n        let fn;\n        let path;\n        let criteria;\n\n        if ('function' === typeof arguments[0]) {\n            this._ensurePath('elemMatch');\n            path = this._path;\n            fn = arguments[0];\n        } else if (isObject(arguments[0])) {\n            this._ensurePath('elemMatch');\n            path = this._path;\n            criteria = arguments[0];\n        } else if ('function' === typeof arguments[1]) {\n            path = arguments[0];\n            fn = arguments[1];\n        } else if (arguments[1] && isObject(arguments[1])) {\n            path = arguments[0];\n            criteria = arguments[1];\n        } else\n            throw newRxTypeError('MQ2');\n\n        if (fn) {\n            criteria = new NoSqlQueryBuilderClass;\n            fn(criteria);\n            criteria = criteria._conditions;\n        }\n\n        const conds = this._conditions[path] || (this._conditions[path] = {});\n        conds.$elemMatch = criteria;\n        return this as any;\n    }\n\n    /**\n     * Sets the sort order\n     * If an object is passed, values allowed are 'asc', 'desc', 'ascending', 'descending', 1, and -1.\n     * If a string is passed, it must be a space delimited list of path names.\n     * The sort order of each path is ascending unless the path name is prefixed with `-` which will be treated as descending.\n     * ####Example\n     *     query.sort({ field: 'asc', test: -1 });\n     *     query.sort('field -test');\n     *     query.sort([['field', 1], ['test', -1]]);\n     */\n    sort(arg: any): NoSqlQueryBuilder<DocType> {\n        if (!arg) return this as any;\n        let len;\n        const type = typeof arg;\n        // .sort([['field', 1], ['test', -1]])\n        if (Array.isArray(arg)) {\n            len = arg.length;\n            for (let i = 0; i < arg.length; ++i) {\n                _pushArr(this.options, arg[i][0], arg[i][1]);\n            }\n\n            return this as any;\n        }\n\n        // .sort('field -test')\n        if (1 === arguments.length && 'string' === type) {\n            arg = arg.split(/\\s+/);\n            len = arg.length;\n            for (let i = 0; i < len; ++i) {\n                let field = arg[i];\n                if (!field) continue;\n                const ascend = '-' === field[0] ? -1 : 1;\n                if (ascend === -1) field = field.substring(1);\n                push(this.options, field, ascend);\n            }\n\n            return this as any;\n        }\n\n        // .sort({ field: 1, test: -1 })\n        if (isObject(arg)) {\n            const keys = Object.keys(arg);\n            keys.forEach(field => push(this.options, field, arg[field]));\n            return this as any;\n        }\n\n        throw newRxTypeError('MQ3', {\n            args: arguments\n        });\n    }\n\n    /**\n     * Merges another MQuery or conditions object into this one.\n     *\n     * When a MQuery is passed, conditions, field selection and options are merged.\n     *\n     */\n    merge(source: any): NoSqlQueryBuilder<DocType> {\n        if (!source) {\n            return this as any;\n        }\n\n        if (!canMerge(source)) {\n            throw newRxTypeError('MQ4', {\n                source\n            });\n        }\n\n        if (source instanceof NoSqlQueryBuilderClass) {\n            // if source has a feature, apply it to ourselves\n\n            if (source._conditions)\n                merge(this._conditions, source._conditions);\n\n            if (source._fields) {\n                if (!this._fields) this._fields = {};\n                merge(this._fields, source._fields);\n            }\n\n            if (source.options) {\n                if (!this.options) this.options = {};\n                merge(this.options, source.options);\n            }\n\n            if (source._distinct)\n                this._distinct = source._distinct;\n\n            return this as any;\n        }\n\n        // plain object\n        merge(this._conditions, source);\n\n        return this as any;\n    }\n\n    /**\n     * Finds documents.\n     * ####Example\n     *     query.find()\n     *     query.find({ name: 'Burning Lights' })\n     */\n    find(criteria: any): NoSqlQueryBuilder<DocType> {\n        if (canMerge(criteria)) {\n            this.merge(criteria);\n        }\n\n        return this as any;\n    }\n\n    /**\n     * Make sure _path is set.\n     *\n     * @parmam {String} method\n     */\n    _ensurePath(method: any) {\n        if (!this._path) {\n            throw newRxError('MQ5', {\n                method\n            });\n        }\n    }\n\n    toJSON(): {\n        query: MangoQuery<DocType>,\n        path?: string\n    } {\n        const query: MangoQuery<DocType> = {\n            selector: this._conditions,\n        };\n\n        if (this.options.skip) {\n            query.skip = this.options.skip;\n        }\n        if (this.options.limit) {\n            query.limit = this.options.limit;\n        }\n        if (this.options.sort) {\n            query.sort = mQuerySortToRxDBSort(this.options.sort);\n        }\n\n        return {\n            query,\n            path: this._path\n        };\n    }\n}\n\nexport function mQuerySortToRxDBSort<DocType>(\n    sort: { [k: string]: 1 | -1 }\n): MangoQuerySortPart<DocType>[] {\n    return Object.entries(sort).map(([k, v]) => {\n        const direction: MangoQuerySortDirection = v === 1 ? 'asc' : 'desc';\n        const part: MangoQuerySortPart<DocType> = { [k]: direction } as any;\n        return part;\n    });\n}\n\n/**\n * Because some prototype-methods are generated,\n * we have to define the type of NoSqlQueryBuilder here\n */\n\nexport interface NoSqlQueryBuilder<DocType = any> extends NoSqlQueryBuilderClass<DocType> {\n    maxScan: ReturnSelfNumberFunction<DocType>;\n    batchSize: ReturnSelfNumberFunction<DocType>;\n    limit: ReturnSelfNumberFunction<DocType>;\n    skip: ReturnSelfNumberFunction<DocType>;\n    comment: ReturnSelfFunction<DocType>;\n\n    gt: ReturnSelfFunction<DocType>;\n    gte: ReturnSelfFunction<DocType>;\n    lt: ReturnSelfFunction<DocType>;\n    lte: ReturnSelfFunction<DocType>;\n    ne: ReturnSelfFunction<DocType>;\n    in: ReturnSelfFunction<DocType>;\n    nin: ReturnSelfFunction<DocType>;\n    all: ReturnSelfFunction<DocType>;\n    regex: ReturnSelfFunction<DocType>;\n    size: ReturnSelfFunction<DocType>;\n\n}\n\ndeclare type ReturnSelfFunction<DocType> = (v: any) => NoSqlQueryBuilder<DocType>;\ndeclare type ReturnSelfNumberFunction<DocType> = (v: number | null) => NoSqlQueryBuilder<DocType>;\n\n/**\n * limit, skip, maxScan, batchSize, comment\n *\n * Sets these associated options.\n *\n *     query.comment('feed query');\n */\nexport const OTHER_MANGO_ATTRIBUTES = ['limit', 'skip', 'maxScan', 'batchSize', 'comment'];\nOTHER_MANGO_ATTRIBUTES.forEach(function (method) {\n    (NoSqlQueryBuilderClass.prototype as any)[method] = function (v: any) {\n        this.options[method] = v;\n        return this;\n    };\n});\n\n\n/**\n * gt, gte, lt, lte, ne, in, nin, all, regex, size, maxDistance\n *\n *     Thing.where('type').nin(array)\n */\nexport const OTHER_MANGO_OPERATORS = [\n    'gt', 'gte', 'lt', 'lte', 'ne',\n    'in', 'nin', 'all', 'regex', 'size'\n];\nOTHER_MANGO_OPERATORS.forEach(function ($conditional) {\n    (NoSqlQueryBuilderClass.prototype as any)[$conditional] = function () {\n        let path;\n        let val;\n        if (1 === arguments.length) {\n            this._ensurePath($conditional);\n            val = arguments[0];\n            path = this._path;\n        } else {\n            val = arguments[1];\n            path = arguments[0];\n        }\n\n        const conds = this._conditions[path] === null || typeof this._conditions[path] === 'object' ?\n            this._conditions[path] :\n            (this._conditions[path] = {});\n        conds['$' + $conditional] = val;\n        return this;\n    };\n});\n\n\nfunction push(opts: any, field: string, value: any) {\n    if (Array.isArray(opts.sort)) {\n        throw newRxTypeError('MQ6', {\n            opts,\n            field,\n            value\n        });\n    }\n\n    if (value && value.$meta) {\n        const sort = opts.sort || (opts.sort = {});\n        sort[field] = {\n            $meta: value.$meta\n        };\n        return;\n    }\n\n    const val = String(value || 1).toLowerCase();\n    if (!/^(?:ascending|asc|descending|desc|1|-1)$/.test(val)) {\n        if (Array.isArray(value)) value = '[' + value + ']';\n        throw newRxTypeError('MQ7', {\n            field,\n            value\n        });\n    }\n    // store `sort` in a sane format\n    const s = opts.sort || (opts.sort = {});\n    const valueStr = value.toString()\n        .replace('asc', '1')\n        .replace('ascending', '1')\n        .replace('desc', '-1')\n        .replace('descending', '-1');\n    s[field] = parseInt(valueStr, 10);\n}\n\nfunction _pushArr(opts: any, field: string, value: any) {\n    opts.sort = opts.sort || [];\n    if (!Array.isArray(opts.sort)) {\n        throw newRxTypeError('MQ8', {\n            opts,\n            field,\n            value\n        });\n    }\n\n    /*    const valueStr = value.toString()\n            .replace('asc', '1')\n            .replace('ascending', '1')\n            .replace('desc', '-1')\n            .replace('descending', '-1');*/\n    opts.sort.push([field, value]);\n}\n\n\n/**\n * Determines if `conds` can be merged using `mquery().merge()`\n */\nexport function canMerge(conds: any): boolean {\n    return conds instanceof NoSqlQueryBuilderClass || isObject(conds);\n}\n\n\nexport function createQueryBuilder<DocType>(query?: MangoQuery<DocType>): NoSqlQueryBuilder<DocType> {\n    return new NoSqlQueryBuilderClass(query) as NoSqlQueryBuilder<DocType>;\n}\n"],"file":"nosql-query-builder.js"}