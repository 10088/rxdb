{"version":3,"file":"non-worker.js","names":["WORKER_BY_INPUT","Map","RxStorageWorker","settings","statics","name","workerInput","workerPromise","get","Worker","set","createStorageInstance","params","worker","instanceId","RxStorageInstanceWorker","databaseName","collectionName","schema","rxStorage","options","storage","internals","changes$","Subject","subs","push","changeStream","subscribe","ev","next","bulkWrite","documentWrites","findDocumentsById","ids","deleted","query","preparedQuery","getAttachmentData","documentId","attachmentId","getChangedDocumentsSince","limit","checkpoint","asObservable","cleanup","minDeletedTime","close","forEach","sub","unsubscribe","remove","getRxStorageWorker"],"sources":["../../../../src/plugins/worker/non-worker.ts"],"sourcesContent":["import { Observable, Subject, Subscription } from 'rxjs';\nimport { spawn, Worker } from 'threads';\nimport type {\n    RxJsonSchema,\n    RxStorage,\n    RxStorageInstanceCreationParams,\n    RxStorageInstance,\n    BulkWriteRow,\n    RxDocumentData,\n    RxStorageBulkWriteResponse,\n    RxStorageChangeEvent,\n    RxStorageQueryResult,\n    EventBulk,\n    RxStorageStatics\n} from '../../types';\nimport { InWorkerStorage } from './in-worker';\n\ndeclare type WorkerStorageInternals = {\n    rxStorage: RxStorageWorker;\n    instanceId: number;\n    worker: InWorkerStorage;\n}\ndeclare type RxStorageWorkerSettings = {\n    statics: RxStorageStatics;\n    workerInput: any;\n}\n\n/**\n * We have no way to detect if a worker is no longer needed.\n * Instead we reuse open workers so that creating many databases,\n * does not flood the OS by opening many threads.\n */\nconst WORKER_BY_INPUT: Map<any, Promise<InWorkerStorage>> = new Map();\n\nexport class RxStorageWorker implements RxStorage<WorkerStorageInternals, any> {\n    public name = 'worker';\n\n    public readonly workerPromise: Promise<InWorkerStorage>;\n    constructor(\n        public readonly settings: RxStorageWorkerSettings,\n        public readonly statics: RxStorageStatics\n    ) {\n        const workerInput = this.settings.workerInput;\n        let workerPromise = WORKER_BY_INPUT.get(workerInput);\n        if (!workerPromise) {\n            workerPromise = spawn<InWorkerStorage>(new Worker(this.settings.workerInput)) as any;\n            WORKER_BY_INPUT.set(workerInput, workerPromise as any);\n        }\n        this.workerPromise = workerPromise as any;\n    }\n\n    async createStorageInstance<RxDocType>(\n        params: RxStorageInstanceCreationParams<RxDocType, any>\n    ): Promise<RxStorageInstanceWorker<RxDocType>> {\n        const worker = await this.workerPromise;\n        const instanceId = await worker.createStorageInstance(params);\n        return new RxStorageInstanceWorker(\n            this,\n            params.databaseName,\n            params.collectionName,\n            params.schema,\n            {\n                rxStorage: this,\n                instanceId,\n                worker\n            },\n            params.options\n        );\n    }\n}\n\n\nexport class RxStorageInstanceWorker<RxDocType> implements RxStorageInstance<RxDocType, WorkerStorageInternals, any> {\n\n    /**\n     * threads.js uses observable-fns instead of rxjs\n     * so we have to transform it.\n     */\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>>> = new Subject();\n    private subs: Subscription[] = [];\n\n    constructor(\n        public readonly storage: RxStorage<WorkerStorageInternals, any>,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<RxDocumentData<RxDocType>>>,\n        public readonly internals: WorkerStorageInternals,\n        public readonly options: Readonly<any>\n    ) {\n        this.subs.push(\n            this.internals.worker.changeStream(\n                this.internals.instanceId\n            ).subscribe(ev => this.changes$.next(ev as any))\n        );\n\n    }\n\n    bulkWrite(documentWrites: BulkWriteRow<RxDocType>[]): Promise<RxStorageBulkWriteResponse<RxDocType>> {\n        return this.internals.worker.bulkWrite(\n            this.internals.instanceId,\n            documentWrites\n        );\n    }\n    findDocumentsById(ids: string[], deleted: boolean): Promise<{ [documentId: string]: RxDocumentData<RxDocType> }> {\n        return this.internals.worker.findDocumentsById(\n            this.internals.instanceId,\n            ids,\n            deleted\n        );\n    }\n    query(preparedQuery: any): Promise<RxStorageQueryResult<RxDocType>> {\n        return this.internals.worker.query(\n            this.internals.instanceId,\n            preparedQuery\n        );\n    }\n    getAttachmentData(documentId: string, attachmentId: string): Promise<string> {\n        return this.internals.worker.getAttachmentData(\n            this.internals.instanceId,\n            documentId,\n            attachmentId\n        );\n    }\n    async getChangedDocumentsSince(\n        limit: number,\n        checkpoint?: any\n    ): Promise<{\n        document: RxDocumentData<RxDocType>;\n        checkpoint: any;\n    }[]> {\n        return this.internals.worker.getChangedDocumentsSince(\n            this.internals.instanceId,\n            limit,\n            checkpoint\n        );\n    }\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>>> {\n        return this.changes$.asObservable();\n    }\n    cleanup(minDeletedTime: number) {\n        return this.internals.worker.cleanup(\n            this.internals.instanceId,\n            minDeletedTime\n        );\n    }\n    close(): Promise<void> {\n        this.subs.forEach(sub => sub.unsubscribe());\n        return this.internals.worker.close(\n            this.internals.instanceId\n        );\n    }\n    remove(): Promise<void> {\n        return this.internals.worker.remove(\n            this.internals.instanceId\n        );\n    }\n}\n\nexport function getRxStorageWorker(\n    settings: RxStorageWorkerSettings\n): RxStorageWorker {\n    const storage = new RxStorageWorker(settings, settings.statics);\n    return storage;\n}\n"],"mappings":"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"}