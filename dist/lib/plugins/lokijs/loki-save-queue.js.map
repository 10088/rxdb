{"version":3,"sources":["../../../../src/plugins/lokijs/loki-save-queue.ts"],"names":[],"mappings":";;;;;;;;;;;;;AAAA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;IACa,a;AAIT,yBACoB,YADpB,EAEoB,gBAFpB,EAGoB,mBAHpB,EAIE;AAAA,SAPK,kBAOL,GAPkC,CAOlC;AAAA,SANc,qBAMd,GANiD,IAAI,0BAAJ,CAAc,CAAd,CAMjD;AAAA,SAHkB,YAGlB,GAHkB,YAGlB;AAAA,SAFkB,gBAElB,GAFkB,gBAElB;AAAA,SADkB,mBAClB,GADkB,mBAClB;AAED;;;;SAEM,Q,GAAP,oBAAkB;AACd,SAAK,kBAAL,GAA0B,KAAK,kBAAL,GAA0B,CAApD;AACA,SAAK,GAAL;AACH,G;;SAEY,G;6FAAb;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AACU,cAAA,CADV,GACc,gBADd;;AAAA,oBAEQ,KAAK,kBAAL,KAA4B,CAFpC;AAAA;AAAA;AAAA;;AAAA,+CAGe,KAAK,qBAAL,CAA2B,kBAA3B,EAHf;;AAAA;AAAA;AAAA,qBAMU,OAAO,CAAC,GAAR,CAAY,CACd,+BADc,EAEd,uBAAY,GAAZ,CAFc,CAAZ,CANV;;AAAA;AAAA,oBAWQ,CACI,CAAC,KAAK,mBAAL,CAAyB,MAAzB,EAAD,IACA,CAAC,KAAK,qBAAL,CAA2B,MAA3B,EAFL,KAGK,KAAK,kBAAL,KAA4B,CAdzC;AAAA;AAAA;AAAA;;AAAA;AAAA,qBAgBc,+BAhBd;;AAAA;AAAA;AAAA,qBAiBc,OAAO,CAAC,GAAR,CAAY,CACd,KAAK,mBAAL,CAAyB,kBAAzB,EADc,EAEd,KAAK,qBAAL,CAA2B,kBAA3B,EAFc,EAGd,uBAAY,GAAZ,CAHc,CAAZ,CAjBd;;AAAA;AAAA;AAAA;;AAAA;AAAA,oBAwBQ,KAAK,kBAAL,KAA4B,CAxBpC;AAAA;AAAA;AAAA;;AAAA;;AAAA;AA2BU,cAAA,WA3BV,GA2BwB,KAAK,kBA3B7B;AA4BI,mBAAK,kBAAL,GAA0B,CAA1B;AA5BJ,+CA8BW,KAAK,qBAAL,CAA2B,kBAA3B,GAAgD,IAAhD,CAAqD,YAAM;AAC9D,uBAAO,KAAI,CAAC,qBAAL,CAA2B,QAA3B,CACH,YAAM;AACF,yBAAO,IAAI,OAAJ,CAAkB,UAAC,GAAD,EAAM,GAAN,EAAc;AACnC,oBAAA,KAAI,CAAC,YAAL,CAAkB,YAAlB,CAA+B,UAAA,GAAG,EAAI;AAClC,0BAAI,GAAJ,EAAS;AACL,wBAAA,KAAI,CAAC,kBAAL,GAA0B,KAAI,CAAC,kBAAL,GAA0B,WAApD;AACA,wBAAA,GAAG,CAAC,GAAD,CAAH;AACH,uBAHD,MAGO;AACH,4BAAI,KAAI,CAAC,gBAAL,CAAsB,gBAA1B,EAA4C;AACxC,0BAAA,KAAI,CAAC,gBAAL,CAAsB,gBAAtB;AACH;;AACD,wBAAA,GAAG;AACN;AACJ,qBAVD;AAWH,mBAZM,CAAP;AAaH,iBAfE,CAAP;AAiBH,eAlBM,CA9BX;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,K","file":"loki-save-queue.js","sourcesContent":["import { IdleQueue } from 'custom-idle-queue';\nimport { LokiDatabaseSettings } from '../../types';\nimport { now, promiseWait, requestIdlePromise } from '../../util';\n\n/**\n * The autosave feature of lokijs has strange behaviors\n * and often runs a save in critical moments when other\n * more important tasks are running.\n * So instead we use a custom save queue that ensures we\n * only run loki.saveDatabase() when nothing else is running.\n */\nexport class LokiSaveQueue {\n    public writesSinceLastRun: number = 0;\n    public readonly runningSavesIdleQueue: IdleQueue = new IdleQueue(1);\n\n    constructor(\n        public readonly lokiDatabase: Loki,\n        public readonly databaseSettings: LokiDatabaseSettings,\n        public readonly rxDatabaseIdleQueue: IdleQueue\n    ) {\n\n    }\n\n    public addWrite() {\n        this.writesSinceLastRun = this.writesSinceLastRun + 1;\n        this.run();\n    }\n\n    public async run() {\n        const t = now();\n        if (this.writesSinceLastRun === 0) {\n            return this.runningSavesIdleQueue.requestIdlePromise();\n        }\n\n        await Promise.all([\n            requestIdlePromise(),\n            promiseWait(100)\n        ]);\n        while (\n            (\n                !this.rxDatabaseIdleQueue.isIdle() ||\n                !this.runningSavesIdleQueue.isIdle()\n            ) && this.writesSinceLastRun !== 0\n        ) {\n            await requestIdlePromise();\n            await Promise.all([\n                this.rxDatabaseIdleQueue.requestIdlePromise(),\n                this.runningSavesIdleQueue.requestIdlePromise(),\n                promiseWait(100)\n            ]);\n        }\n\n        if (this.writesSinceLastRun === 0) {\n            return;\n        }\n        const writeAmount = this.writesSinceLastRun;\n        this.writesSinceLastRun = 0;\n\n        return this.runningSavesIdleQueue.requestIdlePromise().then(() => {\n            return this.runningSavesIdleQueue.wrapCall(\n                () => {\n                    return new Promise<void>((res, rej) => {\n                        this.lokiDatabase.saveDatabase(err => {\n                            if (err) {\n                                this.writesSinceLastRun = this.writesSinceLastRun + writeAmount;\n                                rej(err);\n                            } else {\n                                if (this.databaseSettings.autosaveCallback) {\n                                    this.databaseSettings.autosaveCallback();\n                                }\n                                res();\n                            }\n                        });\n                    })\n                }\n            );\n        })\n    }\n}\n"]}