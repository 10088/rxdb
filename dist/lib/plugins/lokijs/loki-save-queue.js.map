{"version":3,"sources":["../../../../src/plugins/lokijs/loki-save-queue.ts"],"names":["LokiSaveQueue","lokiDatabase","databaseSettings","rxDatabaseIdleQueue","writesSinceLastRun","runningSavesIdleQueue","IdleQueue","addWrite","run","t","requestIdlePromise","Promise","all","isIdle","writeAmount","then","wrapCall","res","rej","saveDatabase","err","autosaveCallback"],"mappings":";;;;;;;;;;;;;AAAA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;IACaA,a;AAIT,yBACoBC,YADpB,EAEoBC,gBAFpB,EAGoBC,mBAHpB,EAIE;AAAA,SAPKC,kBAOL,GAPkC,CAOlC;AAAA,SANcC,qBAMd,GANiD,IAAIC,0BAAJ,CAAc,CAAd,CAMjD;AAAA,SAHkBL,YAGlB,GAHkBA,YAGlB;AAAA,SAFkBC,gBAElB,GAFkBA,gBAElB;AAAA,SADkBC,mBAClB,GADkBA,mBAClB;AAED;;;;SAEMI,Q,GAAP,oBAAkB;AACd,SAAKH,kBAAL,GAA0B,KAAKA,kBAAL,GAA0B,CAApD;AACA,SAAKI,GAAL;AACH,G;;SAEYA,G;6FAAb;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AACUC,cAAAA,CADV,GACc,gBADd;;AAAA,oBAEQ,KAAKL,kBAAL,KAA4B,CAFpC;AAAA;AAAA;AAAA;;AAAA,+CAGe,KAAKC,qBAAL,CAA2BK,kBAA3B,EAHf;;AAAA;AAAA;AAAA,qBAMUC,OAAO,CAACC,GAAR,CAAY,CACd,+BADc,EAEd,uBAAY,GAAZ,CAFc,CAAZ,CANV;;AAAA;AAAA,oBAWQ,CACI,CAAC,KAAKT,mBAAL,CAAyBU,MAAzB,EAAD,IACA,CAAC,KAAKR,qBAAL,CAA2BQ,MAA3B,EAFL,KAGK,KAAKT,kBAAL,KAA4B,CAdzC;AAAA;AAAA;AAAA;;AAAA;AAAA,qBAgBc,+BAhBd;;AAAA;AAAA;AAAA,qBAiBcO,OAAO,CAACC,GAAR,CAAY,CACd,KAAKT,mBAAL,CAAyBO,kBAAzB,EADc,EAEd,KAAKL,qBAAL,CAA2BK,kBAA3B,EAFc,EAGd,uBAAY,GAAZ,CAHc,CAAZ,CAjBd;;AAAA;AAAA;AAAA;;AAAA;AAAA,oBAwBQ,KAAKN,kBAAL,KAA4B,CAxBpC;AAAA;AAAA;AAAA;;AAAA;;AAAA;AA2BUU,cAAAA,WA3BV,GA2BwB,KAAKV,kBA3B7B;AA4BI,mBAAKA,kBAAL,GAA0B,CAA1B;AA5BJ,+CA8BW,KAAKC,qBAAL,CAA2BK,kBAA3B,GAAgDK,IAAhD,CAAqD,YAAM;AAC9D,uBAAO,KAAI,CAACV,qBAAL,CAA2BW,QAA3B,CACH,YAAM;AACF,yBAAO,IAAIL,OAAJ,CAAkB,UAACM,GAAD,EAAMC,GAAN,EAAc;AACnC,oBAAA,KAAI,CAACjB,YAAL,CAAkBkB,YAAlB,CAA+B,UAAAC,GAAG,EAAI;AAClC,0BAAIA,GAAJ,EAAS;AACL,wBAAA,KAAI,CAAChB,kBAAL,GAA0B,KAAI,CAACA,kBAAL,GAA0BU,WAApD;AACAI,wBAAAA,GAAG,CAACE,GAAD,CAAH;AACH,uBAHD,MAGO;AACH,4BAAI,KAAI,CAAClB,gBAAL,CAAsBmB,gBAA1B,EAA4C;AACxC,0BAAA,KAAI,CAACnB,gBAAL,CAAsBmB,gBAAtB;AACH;;AACDJ,wBAAAA,GAAG;AACN;AACJ,qBAVD;AAWH,mBAZM,CAAP;AAaH,iBAfE,CAAP;AAiBH,eAlBM,CA9BX;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,K","sourcesContent":["import { IdleQueue } from 'custom-idle-queue';\nimport { LokiDatabaseSettings } from '../../types';\nimport { now, promiseWait, requestIdlePromise } from '../../util';\n\n/**\n * The autosave feature of lokijs has strange behaviors\n * and often runs a save in critical moments when other\n * more important tasks are running.\n * So instead we use a custom save queue that ensures we\n * only run loki.saveDatabase() when nothing else is running.\n */\nexport class LokiSaveQueue {\n    public writesSinceLastRun: number = 0;\n    public readonly runningSavesIdleQueue: IdleQueue = new IdleQueue(1);\n\n    constructor(\n        public readonly lokiDatabase: Loki,\n        public readonly databaseSettings: LokiDatabaseSettings,\n        public readonly rxDatabaseIdleQueue: IdleQueue\n    ) {\n\n    }\n\n    public addWrite() {\n        this.writesSinceLastRun = this.writesSinceLastRun + 1;\n        this.run();\n    }\n\n    public async run() {\n        const t = now();\n        if (this.writesSinceLastRun === 0) {\n            return this.runningSavesIdleQueue.requestIdlePromise();\n        }\n\n        await Promise.all([\n            requestIdlePromise(),\n            promiseWait(100)\n        ]);\n        while (\n            (\n                !this.rxDatabaseIdleQueue.isIdle() ||\n                !this.runningSavesIdleQueue.isIdle()\n            ) && this.writesSinceLastRun !== 0\n        ) {\n            await requestIdlePromise();\n            await Promise.all([\n                this.rxDatabaseIdleQueue.requestIdlePromise(),\n                this.runningSavesIdleQueue.requestIdlePromise(),\n                promiseWait(100)\n            ]);\n        }\n\n        if (this.writesSinceLastRun === 0) {\n            return;\n        }\n        const writeAmount = this.writesSinceLastRun;\n        this.writesSinceLastRun = 0;\n\n        return this.runningSavesIdleQueue.requestIdlePromise().then(() => {\n            return this.runningSavesIdleQueue.wrapCall(\n                () => {\n                    return new Promise<void>((res, rej) => {\n                        this.lokiDatabase.saveDatabase(err => {\n                            if (err) {\n                                this.writesSinceLastRun = this.writesSinceLastRun + writeAmount;\n                                rej(err);\n                            } else {\n                                if (this.databaseSettings.autosaveCallback) {\n                                    this.databaseSettings.autosaveCallback();\n                                }\n                                res();\n                            }\n                        });\n                    })\n                }\n            );\n        })\n    }\n}\n"],"file":"loki-save-queue.js"}