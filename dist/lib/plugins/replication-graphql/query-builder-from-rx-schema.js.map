{"version":3,"file":"query-builder-from-rx-schema.js","names":["pullQueryBuilderFromRxSchema","collectionName","input","batchSize","fillUpOptionals","schema","prefixes","ucCollectionName","ucfirst","queryName","feed","outputFields","Object","keys","properties","filter","k","ignoreOutputKeys","includes","push","deletedFlag","builder","doc","queryKeys","feedKeys","map","key","subSchema","newRxError","document","args","type","value","keyString","query","SPACING","join","variables","pushQueryBuilderFromRxSchema","primaryKey","getPrimaryFieldOfPrimaryKey","set","docs","sendDocs","forEach","sendDoc","entries","v","ignoreInputKeys"],"sources":["../../../../src/plugins/replication-graphql/query-builder-from-rx-schema.ts"],"sourcesContent":["import {\n    GraphQLSchemaFromRxSchemaInputSingleCollection,\n    fillUpOptionals,\n    Prefixes,\n    SPACING\n} from './graphql-schema-from-rx-schema';\nimport { ucfirst } from '../../util';\nimport type {\n    RxGraphQLReplicationPullQueryBuilder,\n    RxGraphQLReplicationPushQueryBuilder\n} from '../../types';\nimport { newRxError } from '../../rx-error';\nimport { getPrimaryFieldOfPrimaryKey } from '../../rx-schema-helper';\n\nexport function pullQueryBuilderFromRxSchema(\n    collectionName: string,\n    input: GraphQLSchemaFromRxSchemaInputSingleCollection,\n    batchSize: number\n): RxGraphQLReplicationPullQueryBuilder<any> {\n    input = fillUpOptionals(input);\n    const schema = input.schema;\n    const prefixes: Prefixes = input.prefixes as any;\n\n    const ucCollectionName = ucfirst(collectionName);\n    const queryName = prefixes.feed + ucCollectionName;\n\n    const outputFields = Object.keys(schema.properties).filter(k => !(input.ignoreOutputKeys as string[]).includes(k));\n    outputFields.push(input.deletedFlag);\n\n    const builder: RxGraphQLReplicationPullQueryBuilder<any> = (doc: any) => {\n\n        const queryKeys = input.feedKeys.map(key => {\n            const subSchema: any = schema.properties[key];\n            if (!subSchema) {\n                throw newRxError('GQL1', {\n                    document: doc,\n                    schema,\n                    key,\n                    args: {\n                        feedKeys: input.feedKeys\n                    }\n                });\n            }\n            const type = subSchema.type;\n            const value = doc ? doc[key] : null;\n            let keyString = key + ': ';\n            if (type === 'number' || type === 'integer' || !value) {\n                keyString += value;\n            } else {\n                keyString += '\"' + value + '\"';\n            }\n            return keyString;\n        });\n        queryKeys.push('limit: ' + batchSize);\n\n        const query = '' +\n            '{\\n' +\n            SPACING + queryName + '(' + queryKeys.join(', ') + ') {\\n' +\n            SPACING + SPACING + outputFields.join('\\n' + SPACING + SPACING) + '\\n' +\n            SPACING + '}\\n' +\n            '}';\n        return {\n            query,\n            variables: {}\n        };\n    };\n\n    return builder;\n}\n\n\nexport function pushQueryBuilderFromRxSchema(\n    collectionName: string,\n    input: GraphQLSchemaFromRxSchemaInputSingleCollection\n): RxGraphQLReplicationPushQueryBuilder {\n    const primaryKey = getPrimaryFieldOfPrimaryKey(input.schema.primaryKey);\n    input = fillUpOptionals(input);\n    const prefixes: Prefixes = input.prefixes as any;\n\n    const ucCollectionName = ucfirst(collectionName);\n    const queryName = prefixes.set + ucCollectionName;\n\n    const builder: RxGraphQLReplicationPushQueryBuilder = (docs: any[]) => {\n        const query = '' +\n            'mutation Set' + ucCollectionName + '($' + collectionName + ': [' + ucCollectionName + 'Input]) {\\n' +\n            SPACING + queryName + '(' + collectionName + ': $' + collectionName + ') {\\n' +\n            SPACING + SPACING + primaryKey + '\\n' + // GraphQL enforces to return at least one field\n            SPACING + '}\\n' +\n            '}';\n\n        const sendDocs: any[] = [];\n        docs.forEach(doc => {\n            const sendDoc: any = {};\n            Object.entries(doc).forEach(([k, v]) => {\n                if (\n                    // skip if in ignoreInputKeys list\n                    !(input.ignoreInputKeys as string[]).includes(k) &&\n                    // only use properties that are in the schema\n                    input.schema.properties[k]\n                ) {\n                    sendDoc[k] = v;\n                }\n            });\n            sendDocs.push(sendDoc);\n        });\n        const variables = {\n            [collectionName]: sendDocs\n        };\n        return {\n            query,\n            variables\n        };\n    };\n\n    return builder;\n}\n"],"mappings":"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"}