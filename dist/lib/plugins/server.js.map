{"version":3,"file":"server.js","names":["pact","state","value","s","v","o","bind","then","observer","prototype","onFulfilled","onRejected","result","callback","e","_this","thenable","test","update","body","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","recover","spawnServer","path","port","cors","startServer","pouchdbExpressOptions","db","collectionsPath","SERVERS_OF_DB","has","set","storage","adapter","Error","adapterObj","pouchDBOptions","Object","assign","prefix","getPrefix","log","pseudo","PouchDB","defaults","app","APP_OF_DB","keys","collections","forEach","colName","tunnelCollectionPath","DBS_WITH_SERVER","add","use","origin","originToSend","usePouchExpressOptions","inMemoryConfig","logPath","nodePath","join","os","tmpdir","pouchApp","ExpressPouchDB","server","startupPromise","PROMISE_RESOLVE_VOID","Promise","res","rej","answered","listen","on","err","get","push","all","values","map","collection","url","name","pingDb","info","close","response","require","error","console","PouchdbAllDbs","WeakMap","WeakSet","normalizeDbName","splitted","split","filter","str","pop","length","ret","startsWith","pathWithSlash","endsWith","collectionPath","req","next","baseUrl","to","schema","version","toFull","originalUrl","replace","res1","setTimeout","ensureNoMoreCollections","args","database","onDestroy","RxDBServerPlugin","rxdb","init","PouchAdapterHttp","RxDBReplicationCouchDBPlugin","prototypes","RxDatabase","proto","overwritable","hooks","preDestroyRxDatabase","after","preCreateRxCollection"],"sources":["../../../src/plugins/server.ts"],"sourcesContent":["import * as os from 'os';\nimport * as nodePath from 'path';\n\nimport express from 'express';\nimport type { Express } from 'express';\nimport corsFn from 'cors';\n\nimport {\n    addPouchPlugin,\n    PouchDB,\n    RxStoragePouch\n} from '../plugins/pouchdb';\nimport {\n    newRxError\n} from '../rx-error';\nimport type {\n    PouchDBExpressServerOptions,\n    RxDatabase,\n    RxPlugin,\n    ServerResponse\n} from '../types';\n\nimport { RxDBReplicationCouchDBPlugin } from './replication-couchdb';\n\nimport PouchAdapterHttp from 'pouchdb-adapter-http';\nimport { adapterObject, addRxPlugin } from '../index';\nimport {\n    flatClone, PROMISE_RESOLVE_VOID\n} from '../util';\n\nlet ExpressPouchDB: any;\ntry {\n    ExpressPouchDB = require('express-pouchdb');\n} catch (error) {\n    console.error(\n        'Since version 8.4.0 the module \\'express-pouchdb\\' is not longer delivered with RxDB.\\n' +\n        'You can install it with \\'npm install express-pouchdb\\''\n    );\n}\n\n// we have to clean up after tests so there is no stupid logging\n// @link https://github.com/pouchdb/pouchdb-server/issues/226\nconst PouchdbAllDbs = require('pouchdb-all-dbs');\nPouchdbAllDbs(PouchDB);\n\nconst APP_OF_DB: WeakMap<RxDatabase, Express> = new WeakMap();\nconst SERVERS_OF_DB = new WeakMap();\nconst DBS_WITH_SERVER = new WeakSet();\n\n\nconst normalizeDbName = function (db: RxDatabase) {\n    const splitted = db.name.split('/').filter((str: string) => str !== '');\n    return splitted.pop();\n};\n\nconst getPrefix = function (db: RxDatabase) {\n    const splitted = db.name.split('/').filter((str: string) => str !== '');\n    splitted.pop(); // last was the name\n    if (splitted.length === 0) {\n        return '';\n    }\n    let ret = splitted.join('/') + '/';\n    if (db.name.startsWith('/')) {\n        ret = '/' + ret;\n    }\n    return ret;\n};\n\n/**\n * tunnel requests so collection-names can be used as paths\n */\nfunction tunnelCollectionPath(\n    db: RxDatabase,\n    path: string,\n    app: Express,\n    colName: string\n) {\n    const pathWithSlash = path.endsWith('/') ? path : path + '/';\n    const collectionPath = pathWithSlash + colName;\n    app.use(collectionPath, async function (req: any, res: any, next: any) {\n        if (req.baseUrl.endsWith(collectionPath)) {\n\n            while (!db[colName]) {\n                // if the collection is migrated,\n                // it can happen that it does not exist at this moment\n                await new Promise(res1 => setTimeout(res1, 50));\n            }\n            const to = normalizeDbName(db) + '-rxdb-' + db[colName].schema.version + '-' + colName;\n            const toFull = req.originalUrl.replace(collectionPath, pathWithSlash + to);\n            req.originalUrl = toFull;\n        }\n        next();\n    });\n}\n\nexport async function spawnServer(\n    this: RxDatabase,\n    {\n        path = '/db',\n        port = 3000,\n        cors = false,\n        startServer = true,\n        pouchdbExpressOptions = {}\n    }\n): Promise<ServerResponse> {\n    const db: RxDatabase = this;\n    const collectionsPath = startServer ? path : '/';\n    if (!SERVERS_OF_DB.has(db)) {\n        SERVERS_OF_DB.set(db, []);\n    }\n\n    const storage: RxStoragePouch = db.storage as any;\n    if (!storage.adapter) {\n        throw new Error('The RxDB server plugin only works with pouchdb storage.');\n    }\n\n    const adapterObj = adapterObject(storage.adapter);\n    const pouchDBOptions = Object.assign(\n        { prefix: getPrefix(db), log: false },\n        adapterObj,\n    );\n\n    const pseudo = PouchDB.defaults(pouchDBOptions);\n\n    const app = express();\n    APP_OF_DB.set(db, app);\n\n    Object.keys(db.collections).forEach(colName => {\n        // tunnel requests so collection-names can be used as paths\n        tunnelCollectionPath(db, collectionsPath, app, colName);\n    });\n\n\n\n    // remember to throw error if collection is created after the server is already there\n    DBS_WITH_SERVER.add(db);\n\n    if (cors) {\n        app.use(corsFn({\n            'origin': function (origin, callback) {\n                const originToSend: any = origin || '*';\n                callback(null, originToSend);\n            },\n            'credentials': true,\n            'methods': 'DELETE,GET,HEAD,OPTIONS,PATCH,POST,PUT',\n        }));\n    }\n\n    /**\n     * Overwrite the defaults of PouchDBExpressServerOptions.\n     * In RxDB the defaults should not polute anything with folders so we store the config in memory\n     * and the logs in the tmp folder of the os.\n     */\n    const usePouchExpressOptions: PouchDBExpressServerOptions = flatClone(pouchdbExpressOptions);\n    if (typeof usePouchExpressOptions.inMemoryConfig === 'undefined') {\n        usePouchExpressOptions.inMemoryConfig = true;\n    }\n    if (typeof usePouchExpressOptions.logPath === 'undefined') {\n        usePouchExpressOptions.logPath = nodePath.join(\n            os.tmpdir(),\n            'rxdb-server-log.txt'\n        );\n    }\n\n    const pouchApp = ExpressPouchDB(pseudo, usePouchExpressOptions);\n\n    app.use(collectionsPath, pouchApp);\n\n    let server = null;\n    let startupPromise: Promise<void> = PROMISE_RESOLVE_VOID;\n    if (startServer) {\n        /**\n         * Listen for errors on server startup.\n         * and properly handle the error instead of returning a startupPromise\n         */\n        startupPromise = new Promise((res, rej) => {\n            let answered = false;\n            server = app.listen(port, () => {\n                if (!answered) {\n                    answered = true;\n                    res();\n                }\n            });\n            server.on('error', (err) => {\n                if (!answered) {\n                    answered = true;\n                    rej(err);\n                }\n            });\n        });\n        SERVERS_OF_DB.get(db).push(server);\n\n        /**\n         * When the database has no documents, there is no db file\n         * and so the replication would not work.\n         * This is a hack which ensures that the couchdb instance exists\n         * and we can replicate even if there is no document in the beginning.\n         */\n        Promise.all(\n            Object.values(db.collections).map(async (collection) => {\n                const url = 'http://localhost:' + port + collectionsPath + '/' + collection.name;\n                try {\n                    const pingDb = new PouchDB(url);\n                    await pingDb.info();\n                    await pingDb.close();\n                } catch (_err) { }\n            })\n        );\n    }\n\n\n    await startupPromise;\n    const response: ServerResponse = {\n        app,\n        pouchApp,\n        server\n    };\n    return response;\n}\n\n/**\n * when a server is created, no more collections can be spawned\n */\nfunction ensureNoMoreCollections(args: any) {\n    if (DBS_WITH_SERVER.has(args.database)) {\n        const err = newRxError(\n            'S1', {\n            collection: args.name,\n            database: args.database.name\n        }\n        );\n        throw err;\n    }\n}\n\n/**\n * runs when the database gets destroyed\n */\nexport function onDestroy(db: RxDatabase) {\n    if (SERVERS_OF_DB.has(db)) {\n        SERVERS_OF_DB.get(db).forEach((server: any) => server.close());\n    }\n}\n\nexport const RxDBServerPlugin: RxPlugin = {\n    name: 'server',\n    rxdb: true,\n    init() {\n        addPouchPlugin(PouchAdapterHttp);\n        addRxPlugin(RxDBReplicationCouchDBPlugin);\n    },\n    prototypes: {\n        RxDatabase: (proto: any) => {\n            proto.server = spawnServer;\n        }\n    },\n    overwritable: {},\n    hooks: {\n        preDestroyRxDatabase: {\n            after: onDestroy\n        },\n        preCreateRxCollection: {\n            after: ensureNoMoreCollections\n        }\n    }\n};\n"],"mappings":"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"}