{"version":3,"file":"index.js","names":["incrementalUpdate","updateObj","incrementalModify","docData","newDocData","modifyjs","update","oldDocData","_data","_saveData","RxQueryUpdate","exec","then","docs","Array","isArray","Promise","all","map","doc","RxDBUpdatePlugin","name","rxdb","prototypes","RxDocument","proto","RxQuery"],"sources":["../../../../src/plugins/update/index.ts"],"sourcesContent":["/**\n * this plugin allows delta-updates with mongo-like-syntax\n * It's using modifyjs internally\n * @link https://github.com/lgandecki/modifyjs\n */\nimport modifyjs from 'modifyjs';\nimport type {\n    RxDocument,\n    RxQuery,\n    RxPlugin,\n    UpdateQuery\n} from '../../types';\n\nexport function incrementalUpdate<RxDocType>(\n    this: RxDocument<RxDocType>,\n    updateObj: UpdateQuery<RxDocType>\n): Promise<RxDocument<RxDocType>> {\n    return this.incrementalModify((docData) => {\n        const newDocData = modifyjs(docData, updateObj);\n        return newDocData;\n    });\n}\n\nexport function update<RxDocType>(\n    this: RxDocument<RxDocType>,\n    updateObj: UpdateQuery<RxDocType>\n): Promise<RxDocument<RxDocType>> {\n    const oldDocData = this._data;\n    const newDocData = modifyjs(oldDocData, updateObj);\n    return this._saveData(newDocData, oldDocData);\n}\n\nexport function RxQueryUpdate(\n    this: RxQuery,\n    updateObj: UpdateQuery<any>\n): Promise<any> {\n    return this.exec()\n        .then(docs => {\n            if (!docs) {\n                return null;\n            }\n            if (Array.isArray(docs)) {\n                return Promise.all(\n                    docs.map(doc => doc.update(updateObj))\n                ).then(() => docs);\n            } else {\n                // via findOne()\n                return docs.update(updateObj).then(() => docs);\n            }\n        });\n}\n\n\nexport const RxDBUpdatePlugin: RxPlugin = {\n    name: 'update',\n    rxdb: true,\n    prototypes: {\n        RxDocument: (proto: any) => {\n            proto.update = update;\n            proto.incrementalUpdate = incrementalUpdate;\n        },\n        RxQuery: (proto: any) => {\n            proto.update = RxQueryUpdate;\n        }\n    }\n};\n"],"mappings":";;;;;;;;;;AAKA;AALA;AACA;AACA;AACA;AACA;;AASO,SAASA,iBAAiB,CAE7BC,SAAiC,EACH;EAC9B,OAAO,IAAI,CAACC,iBAAiB,CAAC,UAACC,OAAO,EAAK;IACvC,IAAMC,UAAU,GAAG,IAAAC,oBAAQ,EAACF,OAAO,EAAEF,SAAS,CAAC;IAC/C,OAAOG,UAAU;EACrB,CAAC,CAAC;AACN;AAEO,SAASE,MAAM,CAElBL,SAAiC,EACH;EAC9B,IAAMM,UAAU,GAAG,IAAI,CAACC,KAAK;EAC7B,IAAMJ,UAAU,GAAG,IAAAC,oBAAQ,EAACE,UAAU,EAAEN,SAAS,CAAC;EAClD,OAAO,IAAI,CAACQ,SAAS,CAACL,UAAU,EAAEG,UAAU,CAAC;AACjD;AAEO,SAASG,aAAa,CAEzBT,SAA2B,EACf;EACZ,OAAO,IAAI,CAACU,IAAI,EAAE,CACbC,IAAI,CAAC,UAAAC,IAAI,EAAI;IACV,IAAI,CAACA,IAAI,EAAE;MACP,OAAO,IAAI;IACf;IACA,IAAIC,KAAK,CAACC,OAAO,CAACF,IAAI,CAAC,EAAE;MACrB,OAAOG,OAAO,CAACC,GAAG,CACdJ,IAAI,CAACK,GAAG,CAAC,UAAAC,GAAG;QAAA,OAAIA,GAAG,CAACb,MAAM,CAACL,SAAS,CAAC;MAAA,EAAC,CACzC,CAACW,IAAI,CAAC;QAAA,OAAMC,IAAI;MAAA,EAAC;IACtB,CAAC,MAAM;MACH;MACA,OAAOA,IAAI,CAACP,MAAM,CAACL,SAAS,CAAC,CAACW,IAAI,CAAC;QAAA,OAAMC,IAAI;MAAA,EAAC;IAClD;EACJ,CAAC,CAAC;AACV;AAGO,IAAMO,gBAA0B,GAAG;EACtCC,IAAI,EAAE,QAAQ;EACdC,IAAI,EAAE,IAAI;EACVC,UAAU,EAAE;IACRC,UAAU,EAAE,oBAACC,KAAU,EAAK;MACxBA,KAAK,CAACnB,MAAM,GAAGA,MAAM;MACrBmB,KAAK,CAACzB,iBAAiB,GAAGA,iBAAiB;IAC/C,CAAC;IACD0B,OAAO,EAAE,iBAACD,KAAU,EAAK;MACrBA,KAAK,CAACnB,MAAM,GAAGI,aAAa;IAChC;EACJ;AACJ,CAAC;AAAC"}