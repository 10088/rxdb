{"version":3,"sources":["../../../../src/plugins/pouchdb/rx-storage-instance-pouch.ts"],"names":["RxStorageInstancePouch","databaseName","collectionName","schema","internals","options","changes$","Subject","subs","OPEN_POUCHDB_STORAGE_INSTANCES","add","primaryPath","primaryKey","emitter","pouch","emittedEventIds","obliviousSet","eventSub","subject","subscribe","ev","writeOptions","hasOwnProperty","new_edits","Promise","all","writeDocs","map","writeDoc","id","_id","_attachments","previousDoc","previousDocs","get","_rev","_deleted","event","operation","doc","previous","args","addEventToChangeStream","startTime","endTime","custom","writeDocsById","Map","forEach","set","writeResult","resultRow","startsWith","POUCHDB_DESIGN_PREFIX","POUCHDB_LOCAL_PREFIX","rev","writeMap","writeRowById","error","writeRow","newDoc","document","push","change","primary","eventId","has","storageChangeEvent","documentId","next","close","sub","unsubscribe","PROMISE_RESOLVE_VOID","remove","destroy","getSortComparator","query","sortOptions","sort","inMemoryFields","Object","keys","selector","fun","a","b","rows","sortedRows","length","getQueryMatcher","massagedSelector","cloned","row","rowsMatched","ret","prepareQuery","mutateableQuery","sortPart","key","comparisonOperators","keyUsed","some","op","includes","schemaObj","type","$gt","$regex","path","sortArray","part","direction","values","useKey","newPart","entries","k","v","Array","isArray","bulkAddRevisions","documents","writeData","bulkDocs","set_new_edit_as_latest_revision","bulkWrite","documentWrites","insertDocs","storeDocumentData","pouchResult","success","err","isError","status","pushObj","preparedQuery","find","findResult","docs","pouchDoc","useDoc","getAttachmentData","attachmentId","getAttachment","attachmentData","findDocumentsById","ids","deleted","changes","live","since","doc_ids","style","viaChanges","retDocs","results","result","firstDoc","useFirstDoc","allDocs","include_docs","filter","docData","changeStream","asObservable","getChangedDocuments","pouchChangesOpts","limit","sinceSequence","descending","pouchResults","changedDocuments","sequence","seq","lastSequence","last_seq"],"mappings":"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","sourcesContent":["import type {\n    ChangeEvent,\n    DeterministicSortComparator,\n    QueryMatcher\n} from 'event-reduce-js';\nimport { ObliviousSet } from 'oblivious-set';\nimport {\n    Observable,\n    Subject,\n    Subscription\n} from 'rxjs';\nimport { newRxError } from '../../rx-error';\nimport { getPrimaryFieldOfPrimaryKey } from '../../rx-schema';\nimport type {\n    BlobBuffer,\n    BulkWriteRow,\n    ChangeStreamOnceOptions,\n    MangoQuery,\n    MangoQuerySortDirection,\n    MangoQuerySortPart,\n    PouchBulkDocResultRow,\n    PouchChangesOptionsNonLive,\n    PouchSettings,\n    PouchWriteError,\n    PreparedQuery,\n    RxDocumentData,\n    RxDocumentWriteData,\n    RxJsonSchema,\n    RxStorageBulkWriteError,\n    RxStorageBulkWriteResponse,\n    RxStorageChangeEvent,\n    RxStorageInstance,\n    RxStorageQueryResult\n} from '../../types';\nimport {\n    getEventKey,\n    OPEN_POUCHDB_STORAGE_INSTANCES,\n    pouchChangeRowToChangeEvent,\n    POUCHDB_DESIGN_PREFIX,\n    POUCHDB_LOCAL_PREFIX,\n    pouchDocumentDataToRxDocumentData,\n    PouchStorageInternals,\n    pouchSwapIdToPrimary,\n    pouchSwapPrimaryToId,\n    primarySwapPouchDbQuerySelector,\n    rxDocumentDataToPouchDocumentData,\n    writeAttachmentsToAttachments\n} from './pouchdb-helper';\nimport {\n    filterInMemoryFields,\n    massageSelector\n} from 'pouchdb-selector-core';\nimport {\n    flatClone,\n    getFromMapOrThrow,\n    getHeightOfRevision,\n    PROMISE_RESOLVE_VOID\n} from '../../util';\nimport {\n    getCustomEventEmitterByPouch\n} from './custom-events-plugin';\nimport { getSchemaByObjectPath } from '../../rx-schema-helper';\n\nexport class RxStorageInstancePouch<RxDocType> implements RxStorageInstance<\n    RxDocType,\n    PouchStorageInternals,\n    PouchSettings\n> {\n\n    private changes$: Subject<RxStorageChangeEvent<RxDocumentData<RxDocType>>> = new Subject();\n    private subs: Subscription[] = [];\n    private emittedEventIds: ObliviousSet<string>;\n    private primaryPath: keyof RxDocType;\n\n    constructor(\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<RxDocType>>,\n        public readonly internals: Readonly<PouchStorageInternals>,\n        public readonly options: Readonly<PouchSettings>\n    ) {\n        OPEN_POUCHDB_STORAGE_INSTANCES.add(this);\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\n\n        /**\n         * Instead of listening to pouch.changes,\n         * we have overwritten pouchdbs bulkDocs()\n         * and create our own event stream, this will work more relyable\n         * and does not mix up with write events from other sources.\n         */\n        const emitter = getCustomEventEmitterByPouch(this.internals.pouch);\n        this.emittedEventIds = emitter.obliviousSet;\n        const eventSub = emitter.subject.subscribe(async (ev) => {\n            if (ev.writeOptions.hasOwnProperty('new_edits') && !ev.writeOptions.new_edits) {\n                await Promise.all(\n                    ev.writeDocs.map(async (writeDoc) => {\n                        const id = writeDoc._id;\n\n                        writeDoc = pouchDocumentDataToRxDocumentData(\n                            this.primaryPath,\n                            writeDoc\n                        );\n\n                        writeDoc._attachments = await writeAttachmentsToAttachments(writeDoc._attachments);\n\n                        let previousDoc = ev.previousDocs.get(id);\n                        if (previousDoc) {\n                            previousDoc = pouchDocumentDataToRxDocumentData(\n                                this.primaryPath,\n                                previousDoc\n                            );\n                        }\n\n                        if (\n                            previousDoc &&\n                            getHeightOfRevision(previousDoc._rev) > getHeightOfRevision(writeDoc._rev)\n                        ) {\n                            // not the newest revision was added\n                            // TODO is comparing the height enough to compare revisions?\n                            return;\n                        }\n                        if (!previousDoc && writeDoc._deleted) {\n                            // deleted document was added as revision\n                            return;\n                        }\n\n                        if (previousDoc && previousDoc._deleted && writeDoc._deleted) {\n                            // delete document was deleted again\n                            return;\n                        }\n\n                        let event: ChangeEvent<RxDocumentData<RxDocType>>;\n                        if ((!previousDoc || previousDoc._deleted) && !writeDoc._deleted) {\n                            // was insert\n                            event = {\n                                operation: 'INSERT',\n                                doc: writeDoc,\n                                id: id,\n                                previous: null\n                            };\n                        } else if (writeDoc._deleted && previousDoc && !previousDoc._deleted) {\n                            // was delete\n                            previousDoc._rev = writeDoc._rev;\n                            event = {\n                                operation: 'DELETE',\n                                doc: null,\n                                id: id,\n                                previous: previousDoc\n                            };\n                        } else if (\n                            previousDoc\n                        ) {\n                            // was update\n                            event = {\n                                operation: 'UPDATE',\n                                doc: writeDoc,\n                                id: id,\n                                previous: previousDoc\n                            };\n                        } else {\n                            throw newRxError('SNH', { args: { writeDoc } });\n                        }\n                        this.addEventToChangeStream(\n                            event,\n                            ev.startTime,\n                            ev.endTime\n                        );\n                    })\n                );\n                return;\n            }\n\n\n            /**\n             * There is no write map given for internal pouchdb document writes\n             * like it is done with replication.\n             */\n            if (!ev.writeOptions.custom) {\n                const writeDocsById: Map<string, any> = new Map();\n                ev.writeDocs.forEach(writeDoc => writeDocsById.set(writeDoc._id, writeDoc));\n\n                await Promise.all(\n                    ev.writeResult.map(async (resultRow) => {\n                        const id = resultRow.id;\n                        if (\n                            id.startsWith(POUCHDB_DESIGN_PREFIX) ||\n                            id.startsWith(POUCHDB_LOCAL_PREFIX)\n                        ) {\n                            return;\n                        }\n                        let writeDoc = getFromMapOrThrow(writeDocsById, resultRow.id);\n                        writeDoc._attachments = await writeAttachmentsToAttachments(writeDoc._attachments);\n\n                        writeDoc = flatClone(writeDoc);\n                        writeDoc._rev = (resultRow as any).rev;\n                        const event = pouchChangeRowToChangeEvent<RxDocType>(\n                            this.primaryPath,\n                            writeDoc\n                        );\n                        this.addEventToChangeStream(event);\n                    })\n                );\n\n                return;\n            }\n\n            const writeMap: Map<string, BulkWriteRow<RxDocType>> = ev.writeOptions.custom.writeRowById;\n            await Promise.all(\n                ev.writeResult.map(async (resultRow) => {\n                    if ((resultRow as PouchWriteError).error) {\n                        return;\n                    }\n\n                    const id = resultRow.id;\n                    const writeRow = getFromMapOrThrow(writeMap, id);\n                    const newDoc = pouchDocumentDataToRxDocumentData(\n                        this.primaryPath,\n                        writeRow.document as any\n                    );\n                    newDoc._attachments = await writeAttachmentsToAttachments(newDoc._attachments);\n                    newDoc._rev = (resultRow as PouchBulkDocResultRow).rev;\n\n                    let event: ChangeEvent<RxDocumentData<RxDocType>>;\n                    if (!writeRow.previous || writeRow.previous._deleted) {\n                        // was insert\n                        event = {\n                            operation: 'INSERT',\n                            doc: newDoc,\n                            id: id,\n                            previous: null\n                        };\n                    } else if (writeRow.document._deleted) {\n                        // was delete\n\n                        // we need to add the new revision to the previous doc\n                        // so that the eventkey is calculated correctly.\n                        // Is this a hack? idk.\n                        const previousDoc = pouchDocumentDataToRxDocumentData(\n                            this.primaryPath,\n                            writeRow.previous as any\n                        );\n                        previousDoc._attachments = await writeAttachmentsToAttachments(previousDoc._attachments);\n                        previousDoc._rev = (resultRow as PouchBulkDocResultRow).rev;\n\n                        event = {\n                            operation: 'DELETE',\n                            doc: null,\n                            id: resultRow.id,\n                            previous: previousDoc\n                        };\n                    } else {\n                        // was update\n                        event = {\n                            operation: 'UPDATE',\n                            doc: newDoc,\n                            id: resultRow.id,\n                            previous: writeRow.previous\n                        };\n                    }\n\n                    if (\n                        writeRow.document._deleted &&\n                        (\n                            !writeRow.previous ||\n                            writeRow.previous._deleted\n                        )\n                    ) {\n                        /**\n                         * A deleted document was newly added to the storage engine,\n                         * do not emit an event.\n                         */\n                    } else {\n                        this.addEventToChangeStream(\n                            event,\n                            ev.startTime,\n                            ev.endTime\n                        );\n                    }\n\n                })\n            );\n        });\n        this.subs.push(eventSub);\n    }\n\n    private addEventToChangeStream(\n        change: ChangeEvent<RxDocumentData<RxDocType>>,\n        startTime?: number,\n        endTime?: number\n    ) {\n        const doc: RxDocumentData<RxDocType> = change.operation === 'DELETE' ? change.previous as any : change.doc as any;\n        const primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\n        const primary: string = (doc as any)[primaryPath];\n\n        const eventId = getEventKey(false, primary, doc._rev);\n\n        if (this.emittedEventIds.has(eventId)) {\n            return;\n        }\n\n        this.emittedEventIds.add(eventId);\n        const storageChangeEvent: RxStorageChangeEvent<RxDocumentData<RxDocType>> = {\n            eventId,\n            documentId: primary,\n            change,\n            startTime,\n            endTime\n        };\n\n        this.changes$.next(storageChangeEvent);\n    }\n\n    close() {\n        this.subs.forEach(sub => sub.unsubscribe());\n        OPEN_POUCHDB_STORAGE_INSTANCES.delete(this);\n\n        // TODO this did not work because a closed pouchdb cannot be recreated in the same process run\n        // await this.internals.pouch.close();\n        return PROMISE_RESOLVE_VOID;\n    }\n\n    async remove() {\n        this.subs.forEach(sub => sub.unsubscribe());\n\n        OPEN_POUCHDB_STORAGE_INSTANCES.delete(this);\n        await this.internals.pouch.destroy();\n    }\n\n    getSortComparator(\n        query: MangoQuery<RxDocType>\n    ): DeterministicSortComparator<RxDocType> {\n        const primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\n        const sortOptions: MangoQuerySortPart[] = query.sort ? (query.sort as any) : [{\n            [primaryPath]: 'asc'\n        }];\n        const inMemoryFields = Object.keys(query.selector);\n        const fun: DeterministicSortComparator<RxDocType> = (a: RxDocType, b: RxDocType) => {\n            /**\n             * Sorting on two documents with the same primary is not allowed\n             * because it might end up in a non-deterministic result.\n             */\n            if (a[primaryPath] === b[primaryPath]) {\n                throw newRxError('SNH', { args: { a, b }, primaryPath: primaryPath as any });\n            }\n\n            // TODO use createFieldSorter\n            // TODO make a performance test\n            const rows = [a, b].map(doc => ({\n                doc: pouchSwapPrimaryToId<RxDocType>(this.primaryPath, doc)\n            }));\n            const sortedRows: { doc: any }[] = filterInMemoryFields(\n                rows,\n                {\n                    selector: {},\n                    sort: sortOptions\n                },\n                inMemoryFields\n            );\n            if (sortedRows.length !== 2) {\n                throw newRxError('SNH', {\n                    query,\n                    primaryPath: this.primaryPath as any,\n                    args: {\n                        rows,\n                        sortedRows\n                    }\n                });\n            }\n            if (sortedRows[0].doc._id === rows[0].doc._id) {\n                return -1;\n            } else {\n                return 1;\n            }\n        };\n        return fun;\n    }\n\n\n    /**\n     * @link https://github.com/pouchdb/pouchdb/blob/master/packages/node_modules/pouchdb-selector-core/src/matches-selector.js\n     */\n    getQueryMatcher(\n        query: MangoQuery<RxDocType>\n    ): QueryMatcher<RxDocumentWriteData<RxDocType>> {\n        const massagedSelector = massageSelector(query.selector);\n\n        const fun: QueryMatcher<RxDocumentWriteData<RxDocType>> = (doc: RxDocType) => {\n            const cloned = pouchSwapPrimaryToId(this.primaryPath, doc);\n            const row = {\n                doc: cloned\n            };\n            const rowsMatched = filterInMemoryFields(\n                [row],\n                { selector: massagedSelector },\n                Object.keys(query.selector)\n            );\n            const ret = rowsMatched && rowsMatched.length === 1;\n            return ret;\n        };\n        return fun;\n    }\n\n\n    /**\n     * pouchdb has many bugs and strange behaviors\n     * this functions takes a normal mango query\n     * and transforms it to one that fits for pouchdb\n     */\n    prepareQuery(\n        mutateableQuery: MangoQuery<RxDocType>\n    ): PreparedQuery<RxDocType> {\n        const primaryKey = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\n        const query = mutateableQuery;\n\n        /**\n         * because sort wont work on unused keys we have to workaround\n         * so we add the key to the selector if necessary\n         * @link https://github.com/nolanlawson/pouchdb-find/issues/204\n         */\n        if (query.sort) {\n            query.sort.forEach(sortPart => {\n                const key = Object.keys(sortPart)[0];\n                const comparisonOperators = ['$gt', '$gte', '$lt', '$lte'];\n                const keyUsed = query.selector[key] && Object.keys(query.selector[key]).some(op => comparisonOperators.includes(op)) || false;\n                if (!keyUsed) {\n                    const schemaObj = getSchemaByObjectPath(this.schema, key);\n                    if (!schemaObj) {\n                        throw newRxError('QU5', {\n                            query,\n                            key\n                        });\n                    }\n                    if (!query.selector[key]) {\n                        query.selector[key] = {};\n                    }\n                    switch (schemaObj.type) {\n                        case 'number':\n                        case 'integer':\n                            // TODO change back to -Infinity when issue resolved\n                            // @link https://github.com/pouchdb/pouchdb/issues/6454\n                            // -Infinity does not work since pouchdb 6.2.0\n                            query.selector[key].$gt = -9999999999999999999999999999;\n                            break;\n                        case 'string':\n                            /**\n                             * strings need an empty string, see\n                             * @link https://github.com/pubkey/rxdb/issues/585\n                             */\n                            if (typeof query.selector[key] !== 'string') {\n                                query.selector[key].$gt = '';\n                            }\n                            break;\n                        default:\n                            query.selector[key].$gt = null;\n                            break;\n                    }\n                }\n            });\n        }\n\n        // regex does not work over the primary key\n        // TODO move this to dev mode\n        if (query.selector[primaryKey as any] && query.selector[primaryKey as any].$regex) {\n            throw newRxError('QU4', {\n                path: primaryKey as any,\n                query: mutateableQuery\n            });\n        }\n\n        // primary-swap sorting\n        if (query.sort) {\n            const sortArray: MangoQuerySortPart<RxDocType>[] = query.sort.map(part => {\n                const key = Object.keys(part)[0];\n                const direction: MangoQuerySortDirection = Object.values(part)[0];\n                const useKey = key === primaryKey ? '_id' : key;\n                const newPart = { [useKey]: direction };\n                return newPart as any;\n            });\n            query.sort = sortArray;\n        }\n\n        // strip empty selectors\n        Object.entries(query.selector).forEach(([k, v]) => {\n            if (\n                typeof v === 'object' &&\n                v !== null &&\n                !Array.isArray(v) &&\n                Object.keys((v as any)).length === 0\n            ) {\n                delete query.selector[k];\n            }\n        });\n\n        query.selector = primarySwapPouchDbQuerySelector(query.selector, this.primaryPath);\n\n        /**\n         * To ensure a deterministic sorting,\n         * we have to ensure the primary key is always part\n         * of the sort query.\n\n        * TODO This should be done but will not work with pouchdb\n         * because it will throw\n         * 'Cannot sort on field(s) \"key\" when using the default index'\n         * So we likely have to modify the indexes so that this works. \n         */\n        /*\n        if (!mutateableQuery.sort) {\n            mutateableQuery.sort = [{ [this.primaryPath]: 'asc' }] as any;\n        } else {\n            const isPrimaryInSort = mutateableQuery.sort\n                .find(p => firstPropertyNameOfObject(p) === this.primaryPath);\n            if (!isPrimaryInSort) {\n                mutateableQuery.sort.push({ [this.primaryPath]: 'asc' } as any);\n            }\n        }\n        */\n\n        return query;\n    }\n\n    public async bulkAddRevisions(\n        documents: RxDocumentData<RxDocType>[]\n    ): Promise<void> {\n        if (documents.length === 0) {\n            throw newRxError('P3', {\n                args: {\n                    documents\n                }\n            });\n        }\n\n        const writeData = documents.map(doc => {\n            return rxDocumentDataToPouchDocumentData(\n                this.primaryPath,\n                doc\n            );\n        });\n\n        // we do not need the response here because pouchdb returns an empty array on new_edits: false\n        await this.internals.pouch.bulkDocs(\n            writeData,\n            {\n                new_edits: false,\n                set_new_edit_as_latest_revision: true\n            }\n        );\n    }\n\n    public async bulkWrite(\n        documentWrites: BulkWriteRow<RxDocType>[]\n    ): Promise<\n        RxStorageBulkWriteResponse<RxDocType>\n    > {\n        if (documentWrites.length === 0) {\n            throw newRxError('P2', {\n                args: {\n                    documentWrites\n                }\n            });\n        }\n\n        const writeRowById: Map<string, BulkWriteRow<RxDocType>> = new Map();\n\n        const insertDocs: (RxDocType & { _id: string; _rev: string })[] = documentWrites.map(writeData => {\n            const primary: string = (writeData.document as any)[this.primaryPath];\n            writeRowById.set(primary, writeData);\n\n            const storeDocumentData: any = rxDocumentDataToPouchDocumentData<RxDocType>(\n                this.primaryPath,\n                writeData.document\n            );\n\n\n            // if previous document exists, we have to send the previous revision to pouchdb.\n            if (writeData.previous) {\n                storeDocumentData._rev = writeData.previous._rev;\n            }\n\n            return storeDocumentData;\n        });\n\n        const pouchResult = await this.internals.pouch.bulkDocs(insertDocs, {\n            custom: {\n                writeRowById\n            }\n        } as any);\n\n        const ret: RxStorageBulkWriteResponse<RxDocType> = {\n            success: new Map(),\n            error: new Map()\n        };\n\n        await Promise.all(\n            pouchResult.map(async (resultRow) => {\n                const writeRow = getFromMapOrThrow(writeRowById, resultRow.id);\n                if ((resultRow as PouchWriteError).error) {\n                    const err: RxStorageBulkWriteError<RxDocType> = {\n                        isError: true,\n                        status: 409,\n                        documentId: resultRow.id,\n                        writeRow\n                    };\n                    ret.error.set(resultRow.id, err);\n                } else {\n                    let pushObj: RxDocumentData<RxDocType> = flatClone(writeRow.document) as any;\n                    pushObj = pouchSwapIdToPrimary(this.primaryPath, pushObj);\n                    pushObj._rev = (resultRow as PouchBulkDocResultRow).rev;\n\n                    // replace the inserted attachments with their diggest\n                    pushObj._attachments = {};\n                    if (!writeRow.document._attachments) {\n                        writeRow.document._attachments = {};\n                    } else {\n                        pushObj._attachments = await writeAttachmentsToAttachments(writeRow.document._attachments);\n                    }\n                    ret.success.set(resultRow.id, pushObj);\n                }\n            })\n        );\n\n        return ret;\n    }\n\n    public async query(\n        preparedQuery: PreparedQuery<RxDocType>\n    ): Promise<RxStorageQueryResult<RxDocType>> {\n        const findResult = await this.internals.pouch.find<RxDocType>(preparedQuery);\n        const ret: RxStorageQueryResult<RxDocType> = {\n            documents: findResult.docs.map(pouchDoc => {\n                const useDoc = pouchDocumentDataToRxDocumentData(\n                    this.primaryPath,\n                    pouchDoc\n                );\n                return useDoc;\n            })\n        };\n        return ret;\n    }\n\n    async getAttachmentData(\n        documentId: string,\n        attachmentId: string\n    ): Promise<BlobBuffer> {\n        const attachmentData = await this.internals.pouch.getAttachment(\n            documentId,\n            attachmentId\n        );\n        return attachmentData;\n    }\n\n    async findDocumentsById(ids: string[], deleted: boolean): Promise<Map<string, RxDocumentData<RxDocType>>> {\n        /**\n         * On deleted documents, pouchdb will only return the tombstone.\n         * So we have to get the properties directly for each document\n         * with the hack of getting the changes and then make one request per document\n         * with the latest revision.\n         * TODO create an issue at pouchdb on how to get the document data of deleted documents,\n         * when one past revision was written via new_edits=false\n         * @link https://stackoverflow.com/a/63516761/3443137\n         */\n        if (deleted) {\n            const viaChanges = await this.internals.pouch.changes({\n                live: false,\n                since: 0,\n                doc_ids: ids,\n                style: 'all_docs'\n            });\n\n            const retDocs = new Map();\n            await Promise.all(\n                viaChanges.results.map(async (result) => {\n                    const firstDoc = await this.internals.pouch.get(\n                        result.id,\n                        {\n                            rev: result.changes[0].rev,\n                            deleted: 'ok',\n                            style: 'all_docs'\n                        }\n                    );\n                    const useFirstDoc = pouchDocumentDataToRxDocumentData(\n                        this.primaryPath,\n                        firstDoc\n                    );\n                    retDocs.set(result.id, useFirstDoc);\n                })\n            );\n            return retDocs;\n        }\n\n\n        const pouchResult = await this.internals.pouch.allDocs({\n            include_docs: true,\n            keys: ids\n        });\n\n        const ret = new Map();\n        pouchResult.rows\n            .filter(row => !!row.doc)\n            .forEach(row => {\n                let docData = row.doc;\n                docData = pouchDocumentDataToRxDocumentData(\n                    this.primaryPath,\n                    docData\n                );\n                ret.set(row.id, docData);\n            });\n\n        return ret;\n    }\n\n    changeStream(): Observable<RxStorageChangeEvent<RxDocumentData<RxDocType>>> {\n        return this.changes$.asObservable();\n    }\n\n    async getChangedDocuments(\n        options: ChangeStreamOnceOptions\n    ): Promise<{\n        changedDocuments: {\n            id: string;\n            sequence: number;\n        }[];\n        lastSequence: number;\n    }> {\n        const pouchChangesOpts: PouchChangesOptionsNonLive = {\n            live: false,\n            limit: options.limit,\n            include_docs: false,\n            since: options.sinceSequence,\n            descending: options.direction === 'before' ? true : false\n        };\n        const pouchResults = await this.internals.pouch.changes(pouchChangesOpts);\n\n        /**\n         * TODO stripping the internal docs\n         * results in having a non-full result set that maybe no longer\n         * reaches the options.limit. We should fill up again\n         * to ensure pagination works correctly.\n         */\n        const changedDocuments = pouchResults.results\n            .filter(row => !row.id.startsWith(POUCHDB_DESIGN_PREFIX))\n            .map(row => ({\n                id: row.id,\n                sequence: row.seq\n            }));\n        const lastSequence = pouchResults.last_seq;\n        return {\n            changedDocuments,\n            lastSequence\n        };\n    }\n}\n"],"file":"rx-storage-instance-pouch.js"}