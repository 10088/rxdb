{"version":3,"file":"rx-local-document.js","names":["body","recover","result","e","then","pact","state","value","s","v","o","bind","observer","prototype","onFulfilled","onRejected","callback","_this","thenable","test","update","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","RxDocumentParent","RxLocalDocumentClass","id","jsonData","parent","RxLocalDocumentPrototype","isLocal","_handleChangeEvent","changeEvent","documentId","primary","operation","newData","documentData","_dataSync$","next","docCache","_isDeleted$","allAttachments$","document","primaryPath","$","asObservable","$emit","get","objPath","_data","undefined","valueObj","objectPath","overwritable","deepFreezeWhenDevMode","get$","includes","pipe","data","atomicUpdate","mutationFunction","Promise","res","rej","_atomicQueue","done","oldDocData","getValue","newDocData","_saveData","err","atomicPatch","patch","docData","Object","entries","forEach","k","oldData","storageInstance","bulkWrite","previous","docResult","success","error","_rev","remove","writeData","_deleted","_meta","_attachments","INIT_DONE","_init","docBaseProto","basePrototype","props","getOwnPropertyNames","key","exists","getOwnPropertyDescriptor","desc","defineProperty","getThrowingFun","functionName","createRxLocalDocument","newDoc","__proto__","set"],"sources":["../../../../src/plugins/local-documents/rx-local-document.ts"],"sourcesContent":["import objectPath from 'object-path';\nimport { distinctUntilChanged, map } from 'rxjs/operators';\nimport { overwritable } from '../../overwritable';\nimport { basePrototype, createRxDocumentConstructor } from '../../rx-document';\nimport { isPouchdbConflictError, newRxError, newRxTypeError } from '../../rx-error';\nimport { writeSingle } from '../../rx-storage-helper';\nimport type {\n    LocalDocumentAtomicUpdateFunction,\n    LocalDocumentState,\n    RxChangeEvent,\n    RxCollection,\n    RxDatabase,\n    RxDocument,\n    RxDocumentData,\n    RxDocumentWriteData,\n    RxLocalDocument,\n    RxLocalDocumentData\n} from '../../types';\nimport { clone, flatClone, getDefaultRevision, getDefaultRxDocumentMeta, getFromObjectOrThrow } from '../../util';\nimport { getLocalDocStateByParent } from './local-documents-helper';\n\nconst RxDocumentParent = createRxDocumentConstructor() as any;\n\nclass RxLocalDocumentClass<DocData = any> extends RxDocumentParent {\n    constructor(\n        public readonly id: string,\n        jsonData: DocData,\n        public readonly parent: RxCollection | RxDatabase,\n        public readonly state: LocalDocumentState\n    ) {\n        super(null, jsonData);\n    }\n}\n\n\n\nconst RxLocalDocumentPrototype: any = {\n    get isLocal() {\n        return true;\n    },\n\n    //\n    // overwrites\n    //\n\n    _handleChangeEvent(\n        this: any,\n        changeEvent: RxChangeEvent<RxLocalDocumentData>\n    ) {\n        if (changeEvent.documentId !== this.primary) {\n            return;\n        }\n        switch (changeEvent.operation) {\n            case 'UPDATE':\n                const newData = changeEvent.documentData;\n                this._dataSync$.next(newData);\n                break;\n            case 'DELETE':\n                // remove from docCache to assure new upserted RxDocuments will be a new instance\n                const docCache = this.state.docCache;\n                docCache.delete(this.primary);\n                this._isDeleted$.next(true);\n                break;\n        }\n    },\n\n    get allAttachments$() {\n        // this is overwritten here because we cannot re-set getters on the prototype\n        throw newRxError('LD1', {\n            document: this\n        });\n    },\n    get primaryPath() {\n        return 'id';\n    },\n    get primary() {\n        return this.id;\n    },\n    get $() {\n        return (this as RxDocument)._dataSync$.asObservable();\n    },\n    $emit(this: any, changeEvent: RxChangeEvent<RxLocalDocumentData>) {\n        return this.parent.$emit(changeEvent);\n    },\n    get(this: RxDocument, objPath: string) {\n        objPath = 'data.' + objPath;\n\n        if (!this._data) {\n            return undefined;\n        }\n        if (typeof objPath !== 'string') {\n            throw newRxTypeError('LD2', {\n                objPath\n            });\n        }\n\n        let valueObj = objectPath.get(this._data, objPath);\n        valueObj = overwritable.deepFreezeWhenDevMode(valueObj);\n        return valueObj;\n    },\n    get$(this: RxDocument, objPath: string) {\n        objPath = 'data.' + objPath;\n\n        if (objPath.includes('.item.')) {\n            throw newRxError('LD3', {\n                objPath\n            });\n        }\n        if (objPath === this.primaryPath) {\n            throw newRxError('LD4');\n        }\n\n        return this._dataSync$\n            .pipe(\n                map(data => objectPath.get(data, objPath)),\n                distinctUntilChanged()\n            );\n    },\n    atomicUpdate(mutationFunction: LocalDocumentAtomicUpdateFunction<any>) {\n        return new Promise((res, rej) => {\n            this._atomicQueue = this._atomicQueue\n                .then(async () => {\n                    let done = false;\n                    // we need a hacky while loop to stay incide the chain-link of _atomicQueue\n                    // while still having the option to run a retry on conflicts\n                    while (!done) {\n                        const oldDocData = this._dataSync$.getValue();\n                        try {\n                            // always await because mutationFunction might be async\n                            const newData = await mutationFunction(clone(oldDocData.data), this);\n\n                            const newDocData = flatClone(oldDocData);\n                            newDocData.data = newData;\n\n                            await this._saveData(newDocData, oldDocData);\n                            done = true;\n                        } catch (err) {\n                            /**\n                             * conflicts cannot happen by just using RxDB in one process\n                             * There are two ways they still can appear which is\n                             * replication and multi-tab usage\n                             * Because atomicUpdate has a mutation function,\n                             * we can just re-run the mutation until there is no conflict\n                             */\n                            if (isPouchdbConflictError(err as any)) {\n                                // pouchdb conflict error -> retrying\n                            } else {\n                                rej(err);\n                                return;\n                            }\n                        }\n                    }\n                    res(this);\n                });\n        });\n    },\n    atomicPatch(patch: Partial<any>) {\n        return this.atomicUpdate((docData: any) => {\n            Object\n                .entries(patch)\n                .forEach(([k, v]) => {\n                    docData[k] = v;\n                });\n            return docData;\n        });\n    },\n    async _saveData(this: RxLocalDocument<any>, newData: RxDocumentData<RxLocalDocumentData>) {\n        const state = await getLocalDocStateByParent(this.parent);\n        const oldData: RxDocumentData<RxLocalDocumentData> = this._dataSync$.getValue() as any;\n        newData.id = (this as any).id;\n        return state.storageInstance.bulkWrite([{\n            previous: oldData,\n            document: newData\n        }])\n            .then((res) => {\n                const docResult = res.success[newData.id];\n                if (!docResult) {\n                    throw getFromObjectOrThrow(res.error, newData.id);\n                }\n                newData = flatClone(newData);\n                newData._rev = docResult._rev;\n            });\n    },\n\n    async remove(this: any): Promise<void> {\n        const state = await getLocalDocStateByParent(this.parent);\n        const writeData: RxDocumentWriteData<RxLocalDocumentData> = {\n            id: this.id,\n            data: {},\n            _deleted: true,\n            _meta: getDefaultRxDocumentMeta(),\n            _rev: getDefaultRevision(),\n            _attachments: {}\n        };\n        return writeSingle(state.storageInstance, {\n            previous: this._data,\n            document: writeData\n        })\n            .then(() => {\n                this.state.docCache.delete(this.id);\n            });\n    }\n};\n\n\n\nlet INIT_DONE = false;\nconst _init = () => {\n    if (INIT_DONE) return;\n    else INIT_DONE = true;\n\n    // add functions of RxDocument\n    const docBaseProto = basePrototype;\n    const props = Object.getOwnPropertyNames(docBaseProto);\n    props.forEach(key => {\n        const exists = Object.getOwnPropertyDescriptor(RxLocalDocumentPrototype, key);\n        if (exists) return;\n        const desc: any = Object.getOwnPropertyDescriptor(docBaseProto, key);\n        Object.defineProperty(RxLocalDocumentPrototype, key, desc);\n    });\n\n\n    /**\n     * Overwrite things that do not work on local documents\n     * with a throwing function.\n     */\n    const getThrowingFun = (k: string) => () => {\n        throw newRxError('LD6', {\n            functionName: k\n        });\n    };\n    [\n        'populate',\n        'update',\n        'putAttachment',\n        'getAttachment',\n        'allAttachments'\n    ].forEach((k: string) => RxLocalDocumentPrototype[k] = getThrowingFun(k));\n};\n\n\n\nexport function createRxLocalDocument<DocData>(\n    id: string,\n    data: RxDocumentData<RxLocalDocumentData<DocData>>,\n    parent: any,\n    state: LocalDocumentState\n): RxLocalDocument<DocData> {\n    _init();\n    const newDoc = new RxLocalDocumentClass(id, data, parent, state);\n    newDoc.__proto__ = RxLocalDocumentPrototype;\n    state.docCache.set(id, newDoc as any);\n    return newDoc as any;\n}\n"],"mappings":"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"}