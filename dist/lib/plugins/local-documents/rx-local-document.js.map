{"version":3,"sources":["../../../../src/plugins/local-documents/rx-local-document.ts"],"names":["RxDocumentParent","RxLocalDocumentClass","id","jsonData","parent","state","RxLocalDocumentPrototype","isLocal","_handleChangeEvent","changeEvent","documentId","primary","operation","newData","documentData","_dataSync$","next","docCache","_isDeleted$","allAttachments$","document","primaryPath","$","asObservable","$emit","get","objPath","_data","undefined","valueObj","objectPath","overwritable","deepFreezeWhenDevMode","get$","includes","pipe","data","atomicPatch","patch","atomicUpdate","docData","Object","entries","forEach","k","v","_saveData","oldData","getValue","storageInstance","bulkWrite","previous","then","res","docResult","success","error","_rev","remove","writeData","_deleted","_meta","_attachments","INIT_DONE","_init","docBaseProto","basePrototype","props","getOwnPropertyNames","key","exists","getOwnPropertyDescriptor","desc","defineProperty","getThrowingFun","functionName","createRxLocalDocument","newDoc","__proto__","set"],"mappings":"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","sourcesContent":["import objectPath from 'object-path';\nimport { distinctUntilChanged, map } from 'rxjs/operators';\nimport { overwritable } from '../../overwritable';\nimport { basePrototype, createRxDocumentConstructor } from '../../rx-document';\nimport { newRxError, newRxTypeError } from '../../rx-error';\nimport { writeSingle } from '../../rx-storage-helper';\nimport type {\n    LocalDocumentState,\n    RxChangeEvent,\n    RxCollection,\n    RxDatabase,\n    RxDocument,\n    RxDocumentData,\n    RxDocumentWriteData,\n    RxLocalDocument,\n    RxLocalDocumentData\n} from '../../types';\nimport { flatClone, getDefaultRevision, getDefaultRxDocumentMeta, getFromObjectOrThrow } from '../../util';\nimport { getLocalDocStateByParent } from './local-documents-helper';\n\nconst RxDocumentParent = createRxDocumentConstructor() as any;\n\nclass RxLocalDocumentClass<DocData = any> extends RxDocumentParent {\n    constructor(\n        public readonly id: string,\n        jsonData: DocData,\n        public readonly parent: RxCollection | RxDatabase,\n        public readonly state: LocalDocumentState\n    ) {\n        super(null, jsonData);\n    }\n}\n\n\n\nconst RxLocalDocumentPrototype: any = {\n    get isLocal() {\n        return true;\n    },\n\n    //\n    // overwrites\n    //\n\n    _handleChangeEvent(\n        this: any,\n        changeEvent: RxChangeEvent<RxLocalDocumentData>\n    ) {\n        if (changeEvent.documentId !== this.primary) {\n            return;\n        }\n        switch (changeEvent.operation) {\n            case 'UPDATE':\n                const newData = changeEvent.documentData;\n                this._dataSync$.next(newData);\n                break;\n            case 'DELETE':\n                // remove from docCache to assure new upserted RxDocuments will be a new instance\n                const docCache = this.state.docCache;\n                docCache.delete(this.primary);\n                this._isDeleted$.next(true);\n                break;\n        }\n    },\n\n    get allAttachments$() {\n        // this is overwritten here because we cannot re-set getters on the prototype\n        throw newRxError('LD1', {\n            document: this\n        });\n    },\n    get primaryPath() {\n        return 'id';\n    },\n    get primary() {\n        return this.id;\n    },\n    get $() {\n        return (this as RxDocument)._dataSync$.asObservable();\n    },\n    $emit(this: any, changeEvent: RxChangeEvent<RxLocalDocumentData>) {\n        return this.parent.$emit(changeEvent);\n    },\n    get(this: RxDocument, objPath: string) {\n        objPath = 'data.' + objPath;\n\n        if (!this._data) {\n            return undefined;\n        }\n        if (typeof objPath !== 'string') {\n            throw newRxTypeError('LD2', {\n                objPath\n            });\n        }\n\n        let valueObj = objectPath.get(this._data, objPath);\n        valueObj = overwritable.deepFreezeWhenDevMode(valueObj);\n        return valueObj;\n    },\n    get$(this: RxDocument, objPath: string) {\n        objPath = 'data.' + objPath;\n\n        if (objPath.includes('.item.')) {\n            throw newRxError('LD3', {\n                objPath\n            });\n        }\n        if (objPath === this.primaryPath) {\n            throw newRxError('LD4');\n        }\n\n        return this._dataSync$\n            .pipe(\n                map(data => objectPath.get(data, objPath)),\n                distinctUntilChanged()\n            );\n    },\n    atomicPatch(patch: Partial<any>) {\n        return this.atomicUpdate((docData: any) => {\n            Object\n                .entries(patch)\n                .forEach(([k, v]) => {\n                    (docData as any).data[k] = v;\n                });\n            return docData;\n        });\n    },\n    async _saveData(this: RxLocalDocument<any>, newData: RxDocumentData<RxLocalDocumentData>) {\n        const state = await getLocalDocStateByParent(this.parent);\n        const oldData: RxDocumentData<RxLocalDocumentData> = this._dataSync$.getValue() as any;\n        newData.id = (this as any).id;\n        return state.storageInstance.bulkWrite([{\n            previous: oldData,\n            document: newData\n        }])\n            .then((res) => {\n                const docResult = res.success[newData.id];\n                if (!docResult) {\n                    throw getFromObjectOrThrow(res.error, newData.id);\n                }\n                newData = flatClone(newData);\n                newData._rev = docResult._rev;\n            });\n    },\n\n    async remove(this: any): Promise<void> {\n        const state = await getLocalDocStateByParent(this.parent);\n        const writeData: RxDocumentWriteData<RxLocalDocumentData> = {\n            id: this.id,\n            data: {},\n            _deleted: true,\n            _meta: getDefaultRxDocumentMeta(),\n            _rev: getDefaultRevision(),\n            _attachments: {}\n        };\n        return writeSingle(state.storageInstance, {\n            previous: this._data,\n            document: writeData\n        })\n            .then(() => {\n                this.state.docCache.delete(this.id);\n            });\n    }\n};\n\n\n\nlet INIT_DONE = false;\nconst _init = () => {\n    if (INIT_DONE) return;\n    else INIT_DONE = true;\n\n    // add functions of RxDocument\n    const docBaseProto = basePrototype;\n    const props = Object.getOwnPropertyNames(docBaseProto);\n    props.forEach(key => {\n        const exists = Object.getOwnPropertyDescriptor(RxLocalDocumentPrototype, key);\n        if (exists) return;\n        const desc: any = Object.getOwnPropertyDescriptor(docBaseProto, key);\n        Object.defineProperty(RxLocalDocumentPrototype, key, desc);\n    });\n\n\n    /**\n     * Overwrite things that do not work on local documents\n     * with a throwing function.\n     */\n    const getThrowingFun = (k: string) => () => {\n        throw newRxError('LD6', {\n            functionName: k\n        });\n    };\n    [\n        'populate',\n        'update',\n        'putAttachment',\n        'getAttachment',\n        'allAttachments'\n    ].forEach((k: string) => RxLocalDocumentPrototype[k] = getThrowingFun(k));\n};\n\n\n\nexport function createRxLocalDocument<DocData>(\n    id: string,\n    data: RxDocumentData<RxLocalDocumentData<DocData>>,\n    parent: any,\n    state: LocalDocumentState\n): RxLocalDocument<DocData> {\n    _init();\n    const newDoc = new RxLocalDocumentClass(id, data, parent, state);\n    newDoc.__proto__ = RxLocalDocumentPrototype;\n    state.docCache.set(id, newDoc as any);\n    return newDoc as any;\n}\n"],"file":"rx-local-document.js"}